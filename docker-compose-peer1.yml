# Crosstown Peer #1
# Auto-generated by deploy-peers.sh

networks:
  crosstown-network:
    external: true

volumes:
  peer1-crosstown-data:
  peer1-connector-data:
  peer1-forgejo-data:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # ILP Connector for Peer #1
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector-peer1:
    image: connector:1.20.0
    container_name: connector-peer1
    labels:
      - "crosstown.group=peer-1"
      - "crosstown.role=connector"
      - "crosstown.tier=application"
    environment:
      ENVIRONMENT: development
      LOCAL_DELIVERY_URL: http://crosstown-peer1:3110

      # Payment channels
      BASE_ENABLED: "true"
      BASE_RPC_URL: http://crosstown-anvil:8545
      BASE_CHAIN_ID: "31337"
      BASE_PRIVATE_KEY: "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
      BASE_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
      BASE_REGISTRY_ADDRESS: "0xe7f1725e7734ce288f8367e1bb143e90bb3f0512"

      EXPLORER_ENABLED: "true"

    ports:
      - "3010:3000"
      - "8090:8080"
      - "8091:8081"
      - "3011:3001"
    volumes:
      - peer1-connector-data:/data
      - ./config/connector-config-with-base.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Forgejo for Peer #1
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  forgejo-peer1:
    image: codeberg.org/forgejo/forgejo:14
    container_name: forgejo-peer1
    labels:
      - "crosstown.group=peer-1"
      - "crosstown.role=git"
      - "crosstown.tier=application"
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=sqlite3
      - FORGEJO__server__DOMAIN=localhost
      - FORGEJO__server__HTTP_PORT=3000
      - FORGEJO__server__ROOT_URL=http://localhost:3014/
      - FORGEJO__security__INSTALL_LOCK=true

      # Read-only public access
      - FORGEJO__service__REQUIRE_SIGNIN_VIEW=false
      - FORGEJO__repository__DISABLE_HTTP_GIT=false
      - FORGEJO__repository__ENABLE_PUSH_CREATE_USER=false
      - FORGEJO__repository__ENABLE_PUSH_CREATE_ORG=false
      - FORGEJO__repository__ENABLE_EDITOR_UPLOAD=false
      - FORGEJO__repository__DISABLE_DOWNLOAD_SOURCE_ARCHIVES=false
      - FORGEJO__service__DISABLE_REGISTRATION=true
      - FORGEJO__service__SHOW_REGISTRATION_BUTTON=false
      - FORGEJO__api__ENABLE_SWAGGER=false
      - FORGEJO__repository__DEFAULT_PRIVATE=false

    ports:
      - "3014:3000"
    volumes:
      - peer1-forgejo-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Crosstown Node for Peer #1
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  crosstown-peer1:
    image: crosstown:optimized
    container_name: crosstown-peer1
    labels:
      - "crosstown.group=peer-1"
      - "crosstown.role=relay"
      - "crosstown.tier=application"
    environment:
      # Identity
      NODE_ID: peer-1
      NOSTR_SECRET_KEY: aa6aa3ee00f58a67bfc5f7c76269de2fe6df2a6c00b5049bd45646423c9e4697
      ILP_ADDRESS: g.crosstown.peer1

      # Connector integration
      CONNECTOR_ADMIN_URL: http://connector-peer1:8081
      CONNECTOR_URL: http://connector-peer1:8080
      BTP_ENDPOINT: ws://connector-peer1:3000

      # Service ports
      BLS_PORT: 3110
      WS_PORT: 7110

      # Pricing
      BASE_PRICE_PER_BYTE: 10
      SPSP_MIN_PRICE: 5
      ASSET_CODE: USD
      ASSET_SCALE: 6

      # Bootstrap from genesis (use Docker network hostnames)
      BOOTSTRAP_RELAYS: "ws://crosstown-node:7100"
      BOOTSTRAP_PEERS: '[{"pubkey":"aa1857d0ff1fcb1aeb1907b3b98290f3ecb5545473c0b9296fb0b44481deb572","ilpAddress":"g.crosstown.genesis","btpEndpoint":"ws://crosstown-connector:3000","relay":"ws://crosstown-node:7100"}]'
      ARDRIVE_ENABLED: "true"

      # Payment channels
      PEER_EVM_ADDRESS: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC"
      M2M_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"

      # Settlement configuration for Anvil
      SUPPORTED_CHAINS: "evm:anvil:31337"
      SETTLEMENT_ADDRESS_EVM_ANVIL_31337: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC"

      # NIP-34 Git integration (token will be set by init script)
      FORGEJO_URL: http://forgejo-peer1:3000
      FORGEJO_OWNER: crosstown

      # Storage
      DATA_DIR: /data

    ports:
      - "3110:3110"
      - "7110:7110"
    volumes:
      - peer1-crosstown-data:/data
    networks:
      - crosstown-network
    depends_on:
      connector-peer1:
        condition: service_healthy
      forgejo-peer1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3110/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
