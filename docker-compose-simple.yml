# Simplified Crosstown + Agent-Runtime Deployment
# (TigerBeetle optional - for settlement only)
#
# Quick deployment without TigerBeetle for testing the ILP packet flow.
# TigerBeetle is only needed if you're using payment channels for settlement.

version: '3.8'

networks:
  crosstown-network:
    driver: bridge

volumes:
  crosstown-data:
  agent-runtime-data:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Agent-Runtime Connector - ILP Packet Routing
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  agent-runtime:
    image: agent-runtime:patched
    container_name: crosstown-agent-runtime
    environment:
      # Environment mode for connector
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # Local delivery to Crosstown BLS (required when localDelivery.enabled in config)
      LOCAL_DELIVERY_URL: http://crosstown:3100

      # Enable BASE blockchain for payment channels (development mode uses in-memory mock)
      BASE_ENABLED: "false"

      # Enable in-memory balance tracking without blockchain
      BALANCE_TRACKING_ENABLED: "true"

      # Optional: Enable Explorer UI (default: true)
      EXPLORER_ENABLED: ${EXPLORER_ENABLED:-true}
    ports:
      - "3000:3000"   # BTP Server
      - "8080:8080"   # Health check
      - "8081:8081"   # Admin API
      - "3001:3001"   # Explorer UI
    volumes:
      - agent-runtime-data:/data
      - ./config/agent-runtime-config.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Crosstown Full Node - BLS + Nostr Relay + Bootstrap
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  crosstown:
    image: crosstown:optimized
    container_name: crosstown-node
    environment:
      # Required Configuration
      NODE_ID: ${NODE_ID:-crosstown-node}
      NOSTR_SECRET_KEY: ${NOSTR_SECRET_KEY}
      ILP_ADDRESS: ${ILP_ADDRESS:-g.crosstown.node}

      # Connector Integration (External Mode via HTTP)
      CONNECTOR_ADMIN_URL: http://agent-runtime:8081
      AGENT_RUNTIME_URL: http://agent-runtime:8080
      BTP_ENDPOINT: ${BTP_ENDPOINT:-ws://agent-runtime:3000}

      # Service Ports
      BLS_PORT: 3100
      WS_PORT: 7100

      # Pricing
      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}

      # Asset
      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # Bootstrap
      ARDRIVE_ENABLED: ${ARDRIVE_ENABLED:-true}

      # Storage
      DATA_DIR: /data

    ports:
      - "3100:3100"   # BLS HTTP API
      - "7100:7100"   # Nostr Relay WebSocket
    volumes:
      - crosstown-data:/data
    networks:
      - crosstown-network
    depends_on:
      agent-runtime:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
