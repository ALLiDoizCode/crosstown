# Crosstown + Agent-Runtime Full Stack Deployment
#
# Architecture:
#   TigerBeetle (settlement DB)
#      ↓
#   Agent-Runtime Connector (ILP routing, packet forwarding)
#      ↓
#   Crosstown Full Node (BLS + Relay + Bootstrap)
#
# This is the External Mode deployment using HTTP between services.
#
# Usage:
#   1. Copy .env.example to .env and configure:
#      cp .env.example .env
#
#   2. Build images:
#      docker build -f docker/Dockerfile -t crosstown:latest .
#      cd ../agent-runtime && docker build -t agent-runtime:latest .
#      cd ../crosstown
#
#   3. Start stack:
#      docker compose -f docker-compose-full-stack.yml up -d
#
#   4. View logs:
#      docker compose -f docker-compose-full-stack.yml logs -f
#
#   5. Stop stack:
#      docker compose -f docker-compose-full-stack.yml down

version: '3.8'

networks:
  crosstown-network:
    driver: bridge

volumes:
  tigerbeetle-data:
  crosstown-data:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # TigerBeetle - Settlement Accounting Database
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  tigerbeetle:
    image: ghcr.io/tigerbeetle/tigerbeetle:latest
    container_name: crosstown-tigerbeetle
    security_opt:
      - seccomp=unconfined
    command: >
      sh -c '
        if [ ! -f /data/0_0.tigerbeetle ]; then
          tigerbeetle format --cluster=0 --replica=0 --replica-count=1 /data/0_0.tigerbeetle;
        fi;
        exec tigerbeetle start --addresses=0.0.0.0:3000 /data/0_0.tigerbeetle
      '
    ports:
      - "3002:3000"
    volumes:
      - tigerbeetle-data:/data
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep tigerbeetle || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Agent-Runtime Connector - ILP Packet Routing
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  agent-runtime:
    image: agent-runtime:latest
    container_name: crosstown-agent-runtime
    environment:
      # Connector Identity
      NODE_ID: ${NODE_ID:-crosstown-node}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Local Delivery (forward packets to Crosstown BLS)
      LOCAL_DELIVERY_ENABLED: "true"
      LOCAL_DELIVERY_URL: http://crosstown:3100
      LOCAL_DELIVERY_TIMEOUT: "30000"

      # Ports
      BTP_SERVER_PORT: 3000
      HEALTH_CHECK_PORT: 8080
      EXPLORER_UI_PORT: 3001

      # TigerBeetle Connection
      TIGERBEETLE_PORT: 3000
      TIGERBEETLE_CLUSTER_ID: ${TIGERBEETLE_CLUSTER_ID:-0}

      # Settlement (optional - configure if using payment channels)
      # SETTLEMENT_ENABLED: "true"
      # SUPPORTED_CHAINS: "evm:base:8453,evm:polygon:137"
    ports:
      - "3000:3000"   # BTP Server (for peer connections)
      - "8080:8080"   # Health check
      - "8081:8081"   # Admin API (for Crosstown bootstrap to register peers)
      - "3001:3001"   # Explorer UI (monitoring dashboard)
    networks:
      - crosstown-network
    depends_on:
      tigerbeetle:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Crosstown Full Node - BLS + Nostr Relay + Bootstrap
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  crosstown:
    image: crosstown:optimized
    container_name: crosstown-node
    environment:
      # ──────────────────────────────────────────────────────────────
      # Required Configuration
      # ──────────────────────────────────────────────────────────────
      NODE_ID: ${NODE_ID:-crosstown-node}
      NOSTR_SECRET_KEY: ${NOSTR_SECRET_KEY}  # Generate: openssl rand -hex 32
      ILP_ADDRESS: ${ILP_ADDRESS:-g.crosstown.node}

      # ──────────────────────────────────────────────────────────────
      # Connector Integration (External Mode via HTTP)
      # ──────────────────────────────────────────────────────────────
      CONNECTOR_ADMIN_URL: http://agent-runtime:8081
      AGENT_RUNTIME_URL: http://agent-runtime:3100
      BTP_ENDPOINT: ${BTP_ENDPOINT:-ws://crosstown-node:3000}

      # ──────────────────────────────────────────────────────────────
      # Service Ports
      # ──────────────────────────────────────────────────────────────
      BLS_PORT: 3100       # HTTP API (connector calls /handle-packet here)
      WS_PORT: 7100        # Nostr Relay WebSocket

      # ──────────────────────────────────────────────────────────────
      # Pricing Configuration
      # ──────────────────────────────────────────────────────────────
      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}  # Lower price for SPSP requests

      # ──────────────────────────────────────────────────────────────
      # Asset Configuration
      # ──────────────────────────────────────────────────────────────
      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # ──────────────────────────────────────────────────────────────
      # Bootstrap & Discovery
      # ──────────────────────────────────────────────────────────────
      ARDRIVE_ENABLED: ${ARDRIVE_ENABLED:-true}
      # ADDITIONAL_PEERS: ${ADDITIONAL_PEERS}  # JSON array of known peers

      # ──────────────────────────────────────────────────────────────
      # Settlement (Optional - for payment channels)
      # ──────────────────────────────────────────────────────────────
      # SUPPORTED_CHAINS: "evm:base:8453,evm:polygon:137"
      # SETTLEMENT_ADDRESS_EVM_BASE_8453: "0x..."
      # SETTLEMENT_ADDRESS_EVM_POLYGON_137: "0x..."
      # PREFERRED_TOKEN_EVM_BASE_8453: "USDC"
      # TOKEN_NETWORK_EVM_BASE_8453: "0x..."
      # SETTLEMENT_TIMEOUT: 86400
      # INITIAL_DEPOSIT: 1000000

      # ──────────────────────────────────────────────────────────────
      # Owner Configuration (Optional - events from this key bypass payment)
      # ──────────────────────────────────────────────────────────────
      # OWNER_PUBKEY: ${OWNER_PUBKEY}

      # ──────────────────────────────────────────────────────────────
      # Storage
      # ──────────────────────────────────────────────────────────────
      DATA_DIR: /data

    ports:
      - "3100:3100"   # BLS HTTP API
      - "7100:7100"   # Nostr Relay WebSocket
    volumes:
      - crosstown-data:/data
    networks:
      - crosstown-network
    depends_on:
      agent-runtime:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Health Check & Monitoring
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# After starting, verify all services are healthy:
#
#   docker compose -f docker-compose-full-stack.yml ps
#
# Check individual service health:
#
#   curl http://localhost:8080/health  # Agent-Runtime
#   curl http://localhost:3100/health  # Crosstown BLS
#
# View Explorer UI:
#
#   http://localhost:3001
#
# Monitor logs:
#
#   docker compose -f docker-compose-full-stack.yml logs -f crosstown
#   docker compose -f docker-compose-full-stack.yml logs -f agent-runtime
#
