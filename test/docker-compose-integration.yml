# Docker Compose for Crosstown Integration Test
#
# Services:
# - anvil: Local EVM blockchain for payment channels
# - connector: ILP connector that acts as the peer
# - relay: Nostr relay for event publication/discovery

version: '3.8'

networks:
  crosstown-test:
    driver: bridge

volumes:
  connector-data:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Anvil - Local EVM Blockchain
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: crosstown-test-anvil
    entrypoint: []
    command:
      - sh
      - -c
      - |
        echo "Starting Anvil..."
        anvil --host 0.0.0.0 --port 8545 --chain-id 31337 --accounts 10 --balance 10000 &
        ANVIL_PID=$$!
        echo "Waiting for Anvil..."
        until cast client --rpc-url http://localhost:8545 2>/dev/null | grep -q 'anvil'; do sleep 1; done
        echo "Deploying contracts..."
        cd /contracts
        forge script script/DeployLocal.s.sol:DeployLocalScript --rpc-url http://localhost:8545 --broadcast --skip-simulation
        echo "Anvil ready!"
        wait $$ANVIL_PID
    volumes:
      - ../../connector/packages/contracts:/contracts
    ports:
      - "8545:8545"
    networks:
      - crosstown-test
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cast client --rpc-url http://localhost:8545 2>&1 | grep -q 'anvil' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Connector - ILP Connector
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector:
    image: connector:1.20.0
    container_name: crosstown-test-connector
    environment:
      ENVIRONMENT: development
      SETTLEMENT_ENABLED: "true"
      BASE_L2_RPC_URL: http://anvil:8545
      TOKEN_NETWORK_REGISTRY: "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
      M2M_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
      TREASURY_EVM_PRIVATE_KEY: "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
      EXPLORER_ENABLED: "false"
      LOG_LEVEL: debug
    ports:
      - "13000:3000"   # BTP endpoint
      - "13001:3001"   # Admin API
      - "13100:3100"   # ILP endpoint
    networks:
      - crosstown-test
    depends_on:
      anvil:
        condition: service_healthy
    volumes:
      - connector-data:/data
      - ./connector-test-config.yaml:/app/config.yaml:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3001/admin/peers || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Nostr Relay
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  relay:
    image: scsibug/nostr-rs-relay:latest
    container_name: crosstown-test-relay
    ports:
      - "17000:8080"
    networks:
      - crosstown-test
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
