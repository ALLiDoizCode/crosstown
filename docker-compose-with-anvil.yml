# Crosstown + Agent-Runtime + Anvil (Local Ethereum)
# Full Payment Channel Testing Stack
#
# This deployment includes Anvil for local BASE blockchain,
# enabling payment channel creation, claims, and settlement testing.

version: '3.8'

networks:
  crosstown-network:
    driver: bridge

volumes:
  crosstown-data:
  agent-runtime-data:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Anvil - Local Ethereum Node for Payment Channels
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: crosstown-anvil
    command: >
      anvil
      --host 0.0.0.0
      --port 8545
      --chain-id 31337
      --accounts 10
      --balance 10000
    ports:
      - "8545:8545"
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cast client --rpc-url http://localhost:8545 2>&1 | grep -q 'anvil' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Agent-Runtime Connector - ILP Packet Routing + Payment Channels
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  agent-runtime:
    image: agent-runtime:patched
    container_name: crosstown-agent-runtime
    environment:
      # Environment mode
      ENVIRONMENT: development

      # Local delivery to Crosstown BLS
      LOCAL_DELIVERY_URL: http://crosstown:3100

      # Enable BASE blockchain for payment channels
      BASE_ENABLED: "true"
      BASE_RPC_URL: http://anvil:8545
      BASE_CHAIN_ID: "31337"

      # Anvil test account #0 private key (well-known)
      BASE_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

      # Optional: Enable Explorer UI
      EXPLORER_ENABLED: ${EXPLORER_ENABLED:-true}

    ports:
      - "3000:3000"   # BTP Server
      - "8080:8080"   # Health check
      - "8081:8081"   # Admin API
      - "3001:3001"   # Explorer UI
    volumes:
      - agent-runtime-data:/data
      - ./config/agent-runtime-config-with-base.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Crosstown Full Node - BLS + Nostr Relay + Bootstrap
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  crosstown:
    image: crosstown:optimized
    container_name: crosstown-node
    environment:
      # Required Configuration
      NODE_ID: ${NODE_ID:-my-crosstown-node}
      NOSTR_SECRET_KEY: ${NOSTR_SECRET_KEY}
      ILP_ADDRESS: ${ILP_ADDRESS:-g.crosstown.my-node}

      # Connector Integration (External Mode via HTTP)
      CONNECTOR_ADMIN_URL: http://agent-runtime:8081
      AGENT_RUNTIME_URL: http://agent-runtime:8080
      BTP_ENDPOINT: ${BTP_ENDPOINT:-ws://agent-runtime:3000}

      # Service Ports
      BLS_PORT: 3100
      WS_PORT: 7100

      # Pricing
      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}

      # Asset
      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # Bootstrap
      ARDRIVE_ENABLED: ${ARDRIVE_ENABLED:-true}

      # Storage
      DATA_DIR: /data

    ports:
      - "3100:3100"   # BLS HTTP API
      - "7100:7100"   # Nostr Relay WebSocket
    volumes:
      - crosstown-data:/data
    networks:
      - crosstown-network
    depends_on:
      agent-runtime:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
