# Crosstown Multi-Peer Test Network
#
# This stack creates a complete test network with:
# - 1 Anvil (shared Ethereum blockchain for payment channels)
# - 1 Token Faucet (shared)
# - 1 Genesis Peer (bootstrap node)
# - 3 Additional Peers (peer with genesis via Nostr SPSP)
#
# Peers discover each other via Nostr relay and establish payment channels
# on the shared BASE blockchain (Anvil).

networks:
  crosstown-network:
    driver: bridge

volumes:
  crosstown-data-peer1:
  crosstown-data-peer2:
  crosstown-data-peer3:
  crosstown-data-peer4:
  connector-data-peer1:
  connector-data-peer2:
  connector-data-peer3:
  connector-data-peer4:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Anvil - Shared Ethereum Node for Payment Channels
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: crosstown-anvil
    entrypoint: []
    command:
      - sh
      - -c
      - |
        echo "Starting Anvil..."
        anvil --host 0.0.0.0 --port 8545 --chain-id 31337 --accounts 10 --balance 10000 &
        ANVIL_PID=$$!

        echo "Waiting for Anvil to be ready..."
        until cast client --rpc-url http://localhost:8545 2>/dev/null | grep -q 'anvil'; do
          sleep 1
        done

        echo "Deploying contracts..."
        cd /contracts
        forge script script/DeployLocal.s.sol:DeployLocalScript --rpc-url http://localhost:8545 --broadcast --skip-simulation || echo "Deployment failed (non-fatal)"

        echo "Anvil ready with contracts deployed!"
        wait $$ANVIL_PID
    volumes:
      - ../connector/packages/contracts:/contracts
    ports:
      - "8545:8545"
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cast client --rpc-url http://localhost:8545 2>&1 | grep -q 'anvil' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Token Faucet - Shared ETH and AGENT tokens
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  faucet:
    build:
      context: ./packages/faucet
      dockerfile: Dockerfile
    container_name: crosstown-faucet
    environment:
      PORT: 3500
      RPC_URL: http://anvil:8545
      ETH_PRIVATE_KEY: "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"
      TOKEN_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
      TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}
      ETH_AMOUNT: ${FAUCET_ETH_AMOUNT:-100}
      TOKEN_AMOUNT: ${FAUCET_TOKEN_AMOUNT:-10000}
      RATE_LIMIT_HOURS: ${FAUCET_RATE_LIMIT_HOURS:-1}
    ports:
      - "3500:3500"
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3500/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PEER 1 - Genesis Node (Bootstrap)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector-peer1:
    image: connector:1.19.2
    container_name: crosstown-connector-peer1
    environment:
      ENVIRONMENT: development
      LOCAL_DELIVERY_URL: http://crosstown-peer1:3100

      # Settlement Infrastructure (correct env var names)
      SETTLEMENT_ENABLED: "true"
      BASE_L2_RPC_URL: http://anvil:8545
      TOKEN_NETWORK_REGISTRY: ${BASE_REGISTRY_ADDRESS:-0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512}
      M2M_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}
      TREASURY_EVM_PRIVATE_KEY: "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"

      # Peer EVM address mapping
      PEER1_EVM_ADDRESS: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC"
      PEER2_EVM_ADDRESS: "0x90F79bf6EB2c4f870365E785982E1f101E93b906"
      PEER3_EVM_ADDRESS: "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65"
      PEER4_EVM_ADDRESS: "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc"

      # BTP Peer Secrets for authentication
      BTP_PEER_PEER2_SECRET: "crosstown-network-secret-2026"
      BTP_PEER_PEER3_SECRET: "crosstown-network-secret-2026"
      BTP_PEER_PEER4_SECRET: "crosstown-network-secret-2026"

      EXPLORER_ENABLED: ${EXPLORER_ENABLED:-true}
    ports:
      - "3001:3000"   # BTP
      - "8081:8080"   # Health
      - "8091:8081"   # Admin
      - "3011:3001"   # Explorer
    volumes:
      - connector-data-peer1:/data
      - ./config/connector-config-peer.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  crosstown-peer1:
    image: crosstown:optimized
    container_name: crosstown-peer1
    environment:
      NODE_ID: peer1
      # Genesis peer Nostr key (from .env or generate)
      NOSTR_SECRET_KEY: ${PEER1_NOSTR_SECRET:-d5c4f02f7c0f9c8e7a6b5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0a9b8c7d6e5f4a}
      ILP_ADDRESS: g.crosstown.peer1

      CONNECTOR_ADMIN_URL: http://connector-peer1:8081
      CONNECTOR_URL: http://connector-peer1:8080
      BTP_ENDPOINT: ws://connector-peer1:3000

      BLS_PORT: 3100
      WS_PORT: 7100

      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}

      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # Genesis peer - no bootstrap needed
      ARDRIVE_ENABLED: "false"

      DATA_DIR: /data
    ports:
      - "3101:3100"   # BLS
      - "7101:7100"   # Nostr Relay
    volumes:
      - crosstown-data-peer1:/data
    networks:
      - crosstown-network
    depends_on:
      connector-peer1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PEER 2 - Follows Peer1
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector-peer2:
    image: connector:1.19.2
    container_name: crosstown-connector-peer2
    environment:
      ENVIRONMENT: development
      LOCAL_DELIVERY_URL: http://crosstown-peer2:3100
      SETTLEMENT_ENABLED: "true"
      BASE_L2_RPC_URL: http://anvil:8545
      BASE_CHAIN_ID: "31337"
      # Anvil account #3 for peer2
      TREASURY_EVM_PRIVATE_KEY: "0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6"
      M2M_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}
      TOKEN_NETWORK_REGISTRY: ${BASE_REGISTRY_ADDRESS:-0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512}
      # BTP Peer Secrets
      BTP_PEER_PEER1_SECRET: "crosstown-network-secret-2026"
      BTP_PEER_PEER3_SECRET: "crosstown-network-secret-2026"
      BTP_PEER_PEER4_SECRET: "crosstown-network-secret-2026"
      EXPLORER_ENABLED: ${EXPLORER_ENABLED:-true}
    ports:
      - "3002:3000"
      - "8082:8080"
      - "8092:8081"
      - "3012:3001"
    volumes:
      - connector-data-peer2:/data
      - ./config/connector-config-peer.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  crosstown-peer2:
    image: crosstown:optimized
    container_name: crosstown-peer2
    environment:
      NODE_ID: peer2
      NOSTR_SECRET_KEY: ${PEER2_NOSTR_SECRET:-a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2}
      ILP_ADDRESS: g.crosstown.peer2

      CONNECTOR_ADMIN_URL: http://connector-peer2:8081
      CONNECTOR_URL: http://connector-peer2:8080
      BTP_ENDPOINT: ws://connector-peer2:3000

      BLS_PORT: 3100
      WS_PORT: 7100

      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}

      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # Bootstrap via peer1
      ADDITIONAL_PEERS: '[{"pubkey":"719705df863f0190e0c124bbb11dd84b6374d077f66c4912a039324c98dc25e3","relayUrl":"ws://crosstown-peer1:7100","ilpAddress":"g.crosstown.peer1","btpEndpoint":"ws://connector-peer1:3000"}]'
      ARDRIVE_ENABLED: "false"

      DATA_DIR: /data
    ports:
      - "3102:3100"
      - "7102:7100"
    volumes:
      - crosstown-data-peer2:/data
    networks:
      - crosstown-network
    depends_on:
      connector-peer2:
        condition: service_healthy
      crosstown-peer1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PEER 3 - Follows Peer1 and Peer2
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector-peer3:
    image: connector:1.19.2
    container_name: crosstown-connector-peer3
    environment:
      ENVIRONMENT: development
      LOCAL_DELIVERY_URL: http://crosstown-peer3:3100
      SETTLEMENT_ENABLED: "true"
      BASE_L2_RPC_URL: http://anvil:8545
      TOKEN_NETWORK_REGISTRY: ${BASE_REGISTRY_ADDRESS:-0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512}
      M2M_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}
      TREASURY_EVM_PRIVATE_KEY: "0x47e179ec197488593b187f80a00eb0da91f1b9d0b13f8733639f19c30a34926a"
      PEER1_EVM_ADDRESS: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC"
      PEER2_EVM_ADDRESS: "0x90F79bf6EB2c4f870365E785982E1f101E93b906"
      PEER3_EVM_ADDRESS: "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65"
      PEER4_EVM_ADDRESS: "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc"
      # BTP Peer Secrets
      BTP_PEER_PEER1_SECRET: "crosstown-network-secret-2026"
      BTP_PEER_PEER2_SECRET: "crosstown-network-secret-2026"
      BTP_PEER_PEER4_SECRET: "crosstown-network-secret-2026"
      EXPLORER_ENABLED: ${EXPLORER_ENABLED:-true}
    ports:
      - "3003:3000"
      - "8083:8080"
      - "8093:8081"
      - "3013:3001"
    volumes:
      - connector-data-peer3:/data
      - ./config/connector-config-peer.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  crosstown-peer3:
    image: crosstown:optimized
    container_name: crosstown-peer3
    environment:
      NODE_ID: peer3
      NOSTR_SECRET_KEY: ${PEER3_NOSTR_SECRET:-b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3}
      ILP_ADDRESS: g.crosstown.peer3

      CONNECTOR_ADMIN_URL: http://connector-peer3:8081
      CONNECTOR_URL: http://connector-peer3:8080
      BTP_ENDPOINT: ws://connector-peer3:3000

      BLS_PORT: 3100
      WS_PORT: 7100

      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}

      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # Bootstrap via peer1 and peer2 relays
      BOOTSTRAP_RELAYS: "ws://crosstown-peer1:7100,ws://crosstown-peer2:7100"
      BOOTSTRAP_PEERS: ${PEER1_NOSTR_PUBKEY:-},${PEER2_NOSTR_PUBKEY:-}
      ARDRIVE_ENABLED: "false"

      DATA_DIR: /data
    ports:
      - "3103:3100"
      - "7103:7100"
    volumes:
      - crosstown-data-peer3:/data
    networks:
      - crosstown-network
    depends_on:
      connector-peer3:
        condition: service_healthy
      crosstown-peer1:
        condition: service_healthy
      crosstown-peer2:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PEER 4 - Follows Peer1, Peer2, Peer3
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector-peer4:
    image: connector:1.19.2
    container_name: crosstown-connector-peer4
    environment:
      ENVIRONMENT: development
      LOCAL_DELIVERY_URL: http://crosstown-peer4:3100
      SETTLEMENT_ENABLED: "true"
      BASE_L2_RPC_URL: http://anvil:8545
      TOKEN_NETWORK_REGISTRY: ${BASE_REGISTRY_ADDRESS:-0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512}
      M2M_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}
      TREASURY_EVM_PRIVATE_KEY: "0x8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba"
      PEER1_EVM_ADDRESS: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC"
      PEER2_EVM_ADDRESS: "0x90F79bf6EB2c4f870365E785982E1f101E93b906"
      PEER3_EVM_ADDRESS: "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65"
      PEER4_EVM_ADDRESS: "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc"
      EXPLORER_ENABLED: ${EXPLORER_ENABLED:-true}
    ports:
      - "3004:3000"
      - "8084:8080"
      - "8094:8081"
      - "3014:3001"
    volumes:
      - connector-data-peer4:/data
      - ./config/connector-config-peer.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  crosstown-peer4:
    image: crosstown:optimized
    container_name: crosstown-peer4
    environment:
      NODE_ID: peer4
      NOSTR_SECRET_KEY: ${PEER4_NOSTR_SECRET:-c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4}
      ILP_ADDRESS: g.crosstown.peer4

      CONNECTOR_ADMIN_URL: http://connector-peer4:8081
      CONNECTOR_URL: http://connector-peer4:8080
      BTP_ENDPOINT: ws://connector-peer4:3000

      BLS_PORT: 3100
      WS_PORT: 7100

      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}

      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # Bootstrap via all peer relays
      BOOTSTRAP_RELAYS: "ws://crosstown-peer1:7100,ws://crosstown-peer2:7100,ws://crosstown-peer3:7100"
      BOOTSTRAP_PEERS: ${PEER1_NOSTR_PUBKEY:-},${PEER2_NOSTR_PUBKEY:-},${PEER3_NOSTR_PUBKEY:-}
      ARDRIVE_ENABLED: "false"

      DATA_DIR: /data
    ports:
      - "3104:3100"
      - "7104:7100"
    volumes:
      - crosstown-data-peer4:/data
    networks:
      - crosstown-network
    depends_on:
      connector-peer4:
        condition: service_healthy
      crosstown-peer1:
        condition: service_healthy
      crosstown-peer2:
        condition: service_healthy
      crosstown-peer3:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Quick Start Guide
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# 1. Start the multi-peer network:
#    docker compose -f docker-compose-multi-peer.yml up -d
#
# 2. Access services:
#    - Token Faucet:       http://localhost:3500
#    - Anvil RPC:          http://localhost:8545
#
#    Peer 1 (Genesis):
#      - Connector Admin:  http://localhost:8091
#      - Connector Health: http://localhost:8081
#      - Explorer UI:      http://localhost:3011
#      - BLS:              http://localhost:3101
#      - Nostr Relay:      ws://localhost:7101
#
#    Peer 2:
#      - Connector Admin:  http://localhost:8092
#      - Connector Health: http://localhost:8082
#      - Explorer UI:      http://localhost:3012
#      - BLS:              http://localhost:3102
#      - Nostr Relay:      ws://localhost:7102
#
#    Peer 3:
#      - Connector Admin:  http://localhost:8093
#      - Connector Health: http://localhost:8083
#      - Explorer UI:      http://localhost:3013
#      - BLS:              http://localhost:3103
#      - Nostr Relay:      ws://localhost:7103
#
#    Peer 4:
#      - Connector Admin:  http://localhost:8094
#      - Connector Health: http://localhost:8084
#      - Explorer UI:      http://localhost:3014
#      - BLS:              http://localhost:3104
#      - Nostr Relay:      ws://localhost:7104
#
# 3. Test the network:
#    # Send events from peer1 to peer2
#    node test-multi-peer-settlement.mjs
#
# 4. Monitor settlement:
#    # Check peer balances
#    curl http://localhost:8091/admin/settlement/states
#    curl http://localhost:8092/admin/settlement/states
#
#    # Check payment channels on blockchain
#    cast logs --address 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512 --rpc-url http://localhost:8545
#
# 5. View Explorer UIs:
#    - Peer 1: http://localhost:3011
#    - Peer 2: http://localhost:3012
#    - Peer 3: http://localhost:3013
#    - Peer 4: http://localhost:3014
#
# 6. Stop the network:
#    docker compose -f docker-compose-multi-peer.yml down
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Network Topology
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
#       Peer 1 (Genesis)
#      /   |   \
#     /    |    \
#  Peer2  Peer3  Peer4
#    \     |     /
#     \    |    /
#      Payment Channels via BASE (Anvil)
#
# - Peer1 is the genesis/bootstrap node
# - Peer2, Peer3, Peer4 discover Peer1 via Nostr relay
# - Payment channels established on shared BASE blockchain
# - Settlement happens when thresholds are reached
#
