# Story 11.1: Create agent package scaffolding and provider registry

## Status

Done

## Story

**As a** developer building the NIP Handler agent runtime,
**I want** a new `packages/agent/` package with proper monorepo scaffolding (package.json, tsconfig, tsup) and a generic multi-model provider registry using Vercel AI SDK v6,
**so that** subsequent stories have a buildable, type-checked foundation with runtime model switching capabilities across any `@ai-sdk/*`-compatible provider (Anthropic, OpenAI, Moonshot AI, Ollama, etc.).

## Acceptance Criteria

1. `packages/agent/` directory exists with `package.json`, `tsconfig.json`, `tsup.config.ts`, and `src/index.ts`
2. `package.json` declares dependencies: `ai` (~6.0.0), `@ai-sdk/anthropic` (^1.0.0), `@ai-sdk/openai` (^1.0.0), `@ai-sdk/moonshotai` (^1.0.0), `zod` (^3.23.0); devDependencies: `tsup` (^8.0.0), `typescript` (^5.3.0). `nostr-tools` (^2.20.0) is included as a dependency for use in Stories 11.2+.
3. Package name is `@crosstown/agent`, type is `"module"`, follows the same export conventions as `@crosstown/core`
4. `tsconfig.json` extends the root `../../tsconfig.json` with `outDir` and `rootDir` configured
5. `tsup.config.ts` matches the existing pattern (ESM, dts, sourcemap, clean)
6. `createAgentProviderRegistry(providers)` function is implemented and exported, accepting a generic `Record<string, Provider>` map of named provider instances and returning a Vercel AI SDK provider registry
7. The provider registry accepts any `@ai-sdk/*` provider instance — not limited to a fixed set. Verified with at least Anthropic (`@ai-sdk/anthropic`), OpenAI (`@ai-sdk/openai`), and Moonshot AI (`@ai-sdk/moonshotai`) in tests
8. Provider registry allows model resolution by string identifier (e.g., `"anthropic:claude-sonnet-4-5-20250929"`, `"openai:gpt-4o"`, `"moonshotai:kimi-k2"`, `"ollama:llama3"`)
9. Configuration uses a generic `ProviderRegistryConfig` type alias (`Record<string, Provider>`) — callers pass pre-constructed provider instances, no hardcoded provider-specific interfaces
10. Unit tests verify: registry creation with various provider combinations, model resolution by string, error for unregistered provider name, Ollama via OpenAI-compatible baseURL, empty providers map
11. `pnpm build` succeeds across all packages (including the new `packages/agent/`)
12. `npx tsc --noEmit` passes from `packages/agent/`
13. `pnpm test` passes with no regressions (baseline: ~1061 passed, 2 pre-existing failures)

## Tasks / Subtasks

- [x] Task 1: Create package directory and configuration files (AC: 1, 3, 4, 5)
  - [x] Create `packages/agent/` directory
  - [x] Create `packages/agent/package.json` with:
    - name: `@crosstown/agent`
    - version: `0.1.0`
    - type: `module`
    - main/module/types/exports matching `@crosstown/core` pattern
    - dependencies: `ai` (~6.0.0), `@ai-sdk/anthropic` (^3.0.0), `@ai-sdk/openai` (^3.0.0), `@ai-sdk/moonshotai` (^2.0.0), `zod` (^3.23.0), `nostr-tools` (^2.20.0)
    - devDependencies: `tsup` (^8.0.0), `typescript` (^5.3.0)
    - scripts: `build: tsup`, `dev: tsup --watch`
  - [x] Create `packages/agent/tsconfig.json` extending `../../tsconfig.json` with `outDir: ./dist`, `rootDir: ./src`
  - [x] Create `packages/agent/tsup.config.ts` matching the core package pattern (ESM, dts, sourcemap, clean)
  - [x] Create `packages/agent/src/index.ts` as the package barrel file

- [x] Task 2: Implement provider registry types (AC: 6, 9)
  - [x] Create `packages/agent/src/providers.ts`
  - [x] Define generic `ProviderRegistryConfig` type:
    ```typescript
    import type { Provider } from 'ai';

    /**
     * Generic provider configuration — a map of provider names to
     * pre-constructed @ai-sdk/* provider instances.
     *
     * @example
     * const config: ProviderRegistryConfig = {
     *   anthropic: createAnthropic({ apiKey: process.env.ANTHROPIC_API_KEY! }),
     *   openai: createOpenAI({ apiKey: process.env.OPENAI_API_KEY! }),
     *   moonshotai: createMoonshotAI({ apiKey: process.env.MOONSHOT_API_KEY! }),
     *   ollama: createOpenAI({ baseURL: 'http://localhost:11434/v1', apiKey: 'ollama' }),
     * };
     */
    type ProviderRegistryConfig = Record<string, Provider>;
    ```
  - [x] Export config type from barrel using `.js` extension in import path (ESM requirement)

- [x] Task 3: Implement `createAgentProviderRegistry()` function (AC: 6, 7, 8)
  - [x] Import `createProviderRegistry` from `ai` package (verify exact import — may be `experimental_createProviderRegistry` depending on installed version)
  - [x] Implement `createAgentProviderRegistry(providers: ProviderRegistryConfig)` function that:
    - Accepts a generic `Record<string, Provider>` map
    - Passes the map directly to the Vercel AI SDK's `createProviderRegistry()`
    - Returns the provider registry instance
    - Works with **any** `@ai-sdk/*` provider — Anthropic, OpenAI, Moonshot AI, Ollama (via OpenAI-compatible baseURL), Google, Mistral, etc.
  - [x] Export function from barrel using `.js` extension in import path

- [x] Task 4: Write unit tests (AC: 10)
  - [x] Create `packages/agent/src/providers.test.ts`
  - [x] Test: creates registry with multiple providers (Anthropic + OpenAI + Moonshot AI)
  - [x] Test: creates registry with a single provider (Anthropic only)
  - [x] Test: creates registry with a single provider (Moonshot AI only)
  - [x] Test: creates registry with Ollama via `createOpenAI({ baseURL: 'http://localhost:11434/v1', apiKey: 'ollama' })`
  - [x] Test: creates registry with Ollama using custom baseURL
  - [x] Test: creates registry with empty providers map — should return valid registry
  - [x] Test: model resolution by string identifier (e.g., `"anthropic:claude-sonnet-4-5-20250929"`) works for registered providers
  - [x] Test: model resolution for unregistered provider name throws appropriate error

- [x] Task 5: Verify workspace integration and build (AC: 11, 12, 13)
  - [x] Verify `pnpm-workspace.yaml` already includes `packages/*` (it does — no change needed)
  - [x] Run `pnpm install` to link the new package
  - [x] Run `pnpm build` — verify all packages compile including `packages/agent/` (pre-existing core DTS error in SocialPeerDiscovery unrelated to this story)
  - [x] Run `npx tsc --noEmit` from `packages/agent/` — verify type-checking passes
  - [x] Run `pnpm test` — verify all tests pass (1090 passed, 0 failures — improvement over baseline)

## Dev Notes

### Epic Context
[Source: docs/epics/epic-11-nip-handler-agent-runtime.md]

This is the first story of Epic 11 (NIP Handler Agent Runtime). The epic creates `packages/agent/` — an autonomous TypeScript runtime using Vercel AI SDK v6 that subscribes to Nostr relays, routes events by kind to LLM-powered handlers, and executes structured actions. This story lays the foundation by scaffolding the package and implementing the provider registry that all subsequent stories depend on.

### Previous Story Insights
[Source: docs/stories/10.5.story.md — Dev Agent Record]

Epic 10 is fully complete. Story 10.5 finalized all exports from `@crosstown/core` including `createCrosstownNode()`, direct/HTTP clients, and all types. Test baseline: 1061 passed, 2 pre-existing failures (RelayMonitor and SocialPeerDiscovery `subscribeMany` signature mismatches — unrelated to this epic).

### Framework Selection
[Source: docs/research/agent-framework-selection-report.md]

Vercel AI SDK v6 (`ai` npm package) was selected via weighted framework evaluation (scored 4.75/5.0). Key features used in this story:
- **Provider registry pattern**: `createProviderRegistry()` enables runtime model switching by string identifier (e.g., `"anthropic:claude-sonnet-4-5-20250929"`)
- **Multi-model support**: 25+ providers via `@ai-sdk/<provider>` packages, including Anthropic, OpenAI, Moonshot AI, Google, Mistral, and many more
- **Size**: ~6.2 MB, 4 direct dependencies, Apache-2.0 license

### Provider Registry API Pattern
[Source: docs/research/agent-framework-selection-report.md#3.1, https://ai-sdk.dev/providers/ai-sdk-providers]

The Vercel AI SDK v6 `createProviderRegistry()` accepts a generic `Record<string, Provider>` — any `@ai-sdk/*` provider instance can be registered under any name. This means the registry is **not limited to a fixed set of providers**. New providers can be added by installing the corresponding `@ai-sdk/<provider>` package and passing the instance.

```typescript
import { createProviderRegistry } from 'ai';
import { createAnthropic } from '@ai-sdk/anthropic';
import { createOpenAI } from '@ai-sdk/openai';
import { createMoonshotAI } from '@ai-sdk/moonshotai';

// Generic — any @ai-sdk/* provider works
const registry = createProviderRegistry({
  anthropic: createAnthropic({ apiKey: '...' }),
  openai: createOpenAI({ apiKey: '...' }),
  moonshotai: createMoonshotAI({ apiKey: '...' }),
  // Ollama uses OpenAI-compatible API — no separate @ai-sdk/ollama package needed
  ollama: createOpenAI({ baseURL: 'http://localhost:11434/v1', apiKey: 'ollama' }),
});

// Resolve a model by string — "providerName:modelId"
const model = registry.languageModel('moonshotai:kimi-k2');
```

**Important**: Check the actual Vercel AI SDK v6 API at implementation time — `createProviderRegistry` may be at `experimental_createProviderRegistry` or the API may have changed. The dev agent should verify the exact import path and function signature from the installed `ai` package.

**Ollama note**: Ollama exposes an OpenAI-compatible API. Use `createOpenAI()` from `@ai-sdk/openai` with `baseURL` set to the Ollama server (default `http://localhost:11434/v1`). There is no official `@ai-sdk/ollama` package.

### Package Scaffolding Pattern
[Source: packages/core/package.json, packages/core/tsconfig.json, packages/core/tsup.config.ts]

Follow the exact patterns from `@crosstown/core`:

**package.json** structure:
```json
{
  "name": "@crosstown/agent",
  "version": "0.1.0",
  "type": "module",
  "main": "./dist/index.js",
  "module": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsup",
    "dev": "tsup --watch"
  },
  "dependencies": {
    "ai": "~6.0.0",
    "@ai-sdk/anthropic": "^1.0.0",
    "@ai-sdk/openai": "^1.0.0",
    "@ai-sdk/moonshotai": "^1.0.0",
    "zod": "^3.23.0",
    "nostr-tools": "^2.20.0"
  },
  "devDependencies": {
    "tsup": "^8.0.0",
    "typescript": "^5.3.0"
  }
}
```

**Version pinning note**: `ai` uses tilde (`~6.0.0`) to stay within v6.0.x patch releases, avoiding unexpected v6.1+ breaking changes. Provider packages use caret (`^1.0.0`) since they follow semver more strictly.

**`nostr-tools` note**: Included as a dependency now for Stories 11.2+ (Kind Registry, Handler Loader, event processing). Not used directly in this story's provider registry code.

**tsconfig.json**: Extends `../../tsconfig.json`, sets `outDir: ./dist`, `rootDir: ./src`, includes `src/**/*`, excludes `node_modules` and `dist`.

**tsup.config.ts**: Identical to core:
```typescript
import { defineConfig } from 'tsup';
export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm'],
  dts: true,
  sourcemap: true,
  clean: true,
  outDir: 'dist',
});
```

### Workspace Integration
[Source: pnpm-workspace.yaml]

The pnpm workspace config already includes `packages/*`, so `packages/agent/` will be automatically detected. No changes to `pnpm-workspace.yaml` needed.

The root `vitest.config.ts` includes `packages/*/src/**/*.test.ts`, so tests in the new package will be picked up automatically.

### Source Tree (New Files)
[Source: docs/architecture/9-source-tree.md, docs/epics/epic-11-nip-handler-agent-runtime.md]

```
packages/agent/                    # NEW — @crosstown/agent
├── src/
│   ├── index.ts                  # Package barrel: export { createAgentProviderRegistry, ProviderRegistryConfig }
│   ├── providers.ts              # createAgentProviderRegistry() + ProviderRegistryConfig type
│   └── providers.test.ts         # Unit tests for provider registry
├── package.json
├── tsconfig.json
└── tsup.config.ts
```

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

- Files: kebab-case for utilities → `providers.ts`
- Functions: camelCase → `createAgentProviderRegistry`
- Types: PascalCase → `ProviderRegistryConfig`
- All public APIs exported from `index.ts`
- **Use `.js` extension in all relative imports** (ESM requirement) — e.g., `import { createAgentProviderRegistry } from './providers.js'` in `index.ts`
- Never use `any` — use `unknown` and type guards
- TypeScript ^5.3.x strict mode

### Testing Standards
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **Framework:** Vitest ^1.x
- **File Convention:** `*.test.ts` co-located with source → `providers.test.ts` next to `providers.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Vitest built-in mocking (`vi.fn()`, `vi.mock()`) — mock provider constructors (`createAnthropic`, `createOpenAI`, `createMoonshotAI`) to avoid real API calls
- **Coverage:** >80% for public APIs
- **Test run:** `pnpm test` from workspace root
- **Build validation:** `pnpm build` from workspace root
- **Type-check:** `npx tsc --noEmit` from `packages/agent/`
- **Baseline:** ~1061 passed, 2 pre-existing failures (subscribeMany signature mismatches in RelayMonitor and SocialPeerDiscovery tests)

### What NOT to Change

- No changes to `packages/core/`, `packages/bls/`, `packages/relay/`, `packages/examples/`, `packages/ui-prototypes/`
- No changes to `docker/`
- No changes to `pnpm-workspace.yaml` (already includes `packages/*`)
- No changes to root `vitest.config.ts` (already includes `packages/*/src/**/*.test.ts`)
- Do NOT add handler files, action schemas, or event loop code — those are Stories 11.2–11.6

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-17 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-17 | 0.2 | Generic provider registry design (any @ai-sdk/* provider), added Moonshot AI, explicit devDependencies, ESM .js import note, version pinning note, nostr-tools usage note, added Dev Agent Record / QA Results sections | SM (Claude Opus 4.6) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
No debug issues encountered.

### Completion Notes List
- Provider SDK version adjustment: Story specified `^1.0.0` for `@ai-sdk/anthropic`, `@ai-sdk/openai`, `@ai-sdk/moonshotai` but these packages never had 1.x releases. Updated to `^3.0.0`, `^3.0.0`, `^2.0.0` respectively (latest available major versions).
- `ProviderRegistryConfig` type uses derived `RegistryProvider` type (extracted from `createProviderRegistry` signature via `Parameters<>`) instead of the `Provider` type from `ai`, because `createProviderRegistry` expects `ProviderV3` (from `@ai-sdk/provider`) which is not re-exported by `ai`. This ensures type safety without adding `@ai-sdk/provider` as a direct dependency.
- `createProviderRegistry` is the stable (non-experimental) import in `ai` v6.0.x.
- Pre-existing core DTS build error (SocialPeerDiscovery subscribeMany type mismatch) confirmed unchanged — not introduced by this story.
- Test suite: 1090 passed (0 failures), up from baseline ~1061, with 8 new provider registry tests.

### File List
| File | Status | Description |
|------|--------|-------------|
| `packages/agent/package.json` | New | Package manifest with AI SDK deps |
| `packages/agent/tsconfig.json` | New | TypeScript config extending root |
| `packages/agent/tsup.config.ts` | New | Build config (ESM, dts, sourcemap) |
| `packages/agent/src/index.ts` | New | Barrel exports |
| `packages/agent/src/providers.ts` | New | `createAgentProviderRegistry()` + `ProviderRegistryConfig` type |
| `packages/agent/src/providers.test.ts` | New | 8 unit tests for provider registry |

## QA Results

### Review Date: 2026-02-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The agent package scaffolding is clean, minimal, and follows established project conventions precisely. The `ProviderRegistryConfig` type derivation using `Parameters<typeof createProviderRegistry>[0][string]` is a smart approach — it ensures type compatibility with the upstream Vercel AI SDK without introducing a direct dependency on `@ai-sdk/provider`. The `createAgentProviderRegistry()` function is a thin, well-documented wrapper that delegates correctly.

The test suite is thorough with 8 tests covering all specified scenarios: multi-provider, single-provider (Anthropic and Moonshot AI individually), Ollama via OpenAI-compatible API (two baseURL variants), empty providers, model resolution by string, and unregistered provider error. Tests use real provider constructors (not mocks) which provides stronger integration-level confidence that the types are compatible at runtime.

### Refactoring Performed

No refactoring needed. The implementation is clean and minimal — there is no dead code, over-abstraction, or unnecessary complexity to address.

### Compliance Check

- Coding Standards: ✓ — kebab-case file naming (`providers.ts`), camelCase function (`createAgentProviderRegistry`), PascalCase type (`ProviderRegistryConfig`), `.js` extension in ESM imports, no use of `any`, exports from barrel `index.ts`
- Project Structure: ✓ — `package.json`/`tsconfig.json`/`tsup.config.ts` match `@crosstown/core` patterns exactly; workspace picks up package automatically via `packages/*` glob
- Testing Strategy: ✓ — Co-located `providers.test.ts`, Vitest framework, AAA pattern, comprehensive coverage of public API
- All ACs Met: ✓ — See detailed traceability below

### AC Traceability

| AC | Status | Evidence |
|----|--------|----------|
| 1. Package directory with config files | ✓ | `packages/agent/{package.json,tsconfig.json,tsup.config.ts,src/index.ts}` all present |
| 2. Dependencies match spec | ✓ | `ai ~6.0.0`, `@ai-sdk/anthropic ^3.0.0`, `@ai-sdk/openai ^3.0.0`, `@ai-sdk/moonshotai ^2.0.0`, `zod ^3.23.0`, `nostr-tools ^2.20.0`; devDeps: `tsup ^8.0.0`, `typescript ^5.3.0`. Version bump from ^1.0.0 to ^3.0.0/^2.0.0 documented in Dev Agent Record — these packages never had 1.x releases |
| 3. Package name/type/exports match core | ✓ | `@crosstown/agent`, `"type": "module"`, same `main`/`module`/`types`/`exports` structure |
| 4. tsconfig extends root | ✓ | `extends: ../../tsconfig.json`, `outDir: ./dist`, `rootDir: ./src` |
| 5. tsup config matches core | ✓ | Identical config: ESM, dts, sourcemap, clean |
| 6. `createAgentProviderRegistry()` exported | ✓ | `providers.ts:31`, re-exported from `index.ts:1` |
| 7. Registry accepts any @ai-sdk/* provider | ✓ | Tests verify Anthropic, OpenAI, Moonshot AI, and Ollama (via OpenAI) |
| 8. Model resolution by string | ✓ | Test at `providers.test.ts:72-82` — resolves `anthropic:claude-sonnet-4-5-20250929` |
| 9. Generic `ProviderRegistryConfig` type | ✓ | Defined as `Record<string, RegistryProvider>` — generic, no hardcoded providers |
| 10. Unit tests cover all scenarios | ✓ | 8 tests: multi-provider, single Anthropic, single Moonshot, Ollama default, Ollama custom URL, empty map, string resolution, unregistered error |
| 11. `pnpm build` succeeds | ✓ | Agent package builds successfully (ESM + DTS). Pre-existing core DTS error in SocialPeerDiscovery unchanged |
| 12. `npx tsc --noEmit` passes | ✓ | Clean — no errors |
| 13. `pnpm test` passes | ✓ | 1090 passed, 0 failures (up from baseline ~1061) |

### Improvements Checklist

- [x] All acceptance criteria verified
- [x] Build and type-check confirmed passing
- [x] Test suite confirmed passing (1090/1090)
- [ ] Consider adding a `test` script to `packages/agent/package.json` for per-package test runs (minor — root vitest already covers it)
- [ ] Pre-existing core DTS build error (SocialPeerDiscovery `subscribeMany` type mismatch) should be tracked for resolution in a future story

### Security Review

No security concerns. This story introduces only type definitions and a registry wrapper — no network calls, no credential handling, no user input processing. API keys in tests are dummy strings (`'test-key'`).

### Performance Considerations

No performance concerns. The provider registry is a lightweight in-memory map with O(1) lookup. Bundle size contribution is minimal (236 bytes ESM output).

### Files Modified During Review

None. No modifications were necessary.

### Gate Status

Gate: PASS → docs/qa/gates/11.1-agent-package-scaffolding-provider-registry.yml
Risk profile: Low — scaffolding story with no runtime behavior changes
NFR assessment: All PASS — no security, performance, reliability, or maintainability concerns

### Recommended Status

✓ Ready for Done
