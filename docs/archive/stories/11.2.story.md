# Story 11.2: Implement Kind Registry, Handler Loader, and Zod action schemas

## Status

Done

## Story

**As a** developer building the NIP Handler agent runtime,
**I want** a `KindRegistry` class that maps Nostr event kinds to handler file paths, a `HandlerLoader` that reads markdown handler files as system prompts, and Zod-validated action schemas with per-kind allowlists,
**so that** the core handler function (Story 11.3) can deterministically route events to the correct handler and validate LLM action outputs against type-safe schemas.

## Acceptance Criteria

1. `KindRegistry` class is implemented in `packages/agent/src/kind-registry.ts` with a `resolve(kind: number)` method that returns the handler file path or `null`
2. Kind registry supports exact-match lookup (kinds 1, 1059) and range-match lookup (kinds 5000-5999)
3. Kind registry returns `null` for unhandled kinds (0, 3, 6, 7, 6000-6999, 7000, 10032, 23194, 23195, and any unknown kind)
4. Kind registry exposes a `classify(kind: number)` method returning the NIP-01 kind classification (`regular`, `replaceable`, `ephemeral`, `parameterized-replaceable`)
5. `HandlerLoader` class is implemented in `packages/agent/src/handler-loader.ts` with a `load(handlerPath: string)` method that reads a markdown file and returns its content as a string (the system prompt)
6. `HandlerLoader` caches loaded handlers in memory to avoid repeated filesystem reads
7. `HandlerLoader` throws a descriptive error if the handler file does not exist
8. All action types from `action-schema.md` are implemented as Zod schemas in `packages/agent/src/schemas/actions.ts`: `reply`, `react`, `repost`, `zap`, `unwrap`, `fulfill_job`, `publish_job_feedback`, `store`, `forward`, `ignore`, `escalate`
9. A `ActionSchema` discriminated union (`z.discriminatedUnion('action', [...])`) validates any single action, and an `ActionsResponseSchema` validates either a single action or an array of 1-5 actions
10. Per-kind action allowlists are defined in `packages/agent/src/schemas/allowlists.ts`, mapping kind categories to their permitted action types (matching the table in action-schema.md)
11. Allowlist validation function `validateActionForKind(action, kind)` rejects actions not in the kind's allowed set
12. Unit tests verify: registry exact match, registry range match, registry unhandled kinds, kind classification, handler loading, handler caching, handler missing file error, each Zod action schema validates correct input, each Zod action schema rejects invalid input, discriminated union validation, multi-action array validation (1-5 actions), allowlist enforcement (valid and invalid actions per kind)
13. `pnpm build` succeeds across all packages
14. `npx tsc --noEmit` passes from `packages/agent/`
15. `pnpm test` passes with no regressions

## Tasks / Subtasks

- [x] Task 1: Implement Kind Registry (AC: 1, 2, 3, 4)
  - [x] Create `packages/agent/src/kind-registry.ts`
  - [x] Define `KindClassification` type: `'regular' | 'replaceable' | 'ephemeral' | 'parameterized-replaceable'`
  - [x] Define `KindRegistryEntry` interface: `{ handlerPath: string }`
  - [x] Implement `KindRegistry` class with:
    - Constructor accepting `handlersDir: string` (base directory for handler files)
    - Private exact-match map: `Map<number, KindRegistryEntry>` pre-populated with kinds 1 and 1059
    - Private range-match array: `Array<{ min: number; max: number; entry: KindRegistryEntry }>` pre-populated with 5000-5999
    - `resolve(kind: number): string | null` — exact match first, then range match, then `null`. Returns the full joined path (`path.join(handlersDir, entry.handlerPath)`) so callers can pass it directly to `HandlerLoader.load()`
    - `classify(kind: number): KindClassification` — implements NIP-01 kind classification rules (kinds >= 40000 or any kind not matching other ranges default to `regular`)
    - `getAllRegisteredKinds(): Array<{ kind: number | string; handlerPath: string }>` — returns all registered entries (for diagnostics)
  - [x] Pre-populate the registry with the three existing handlers:
    - `1` → `kind-1-text-note.md`
    - `1059` → `kind-1059-gift-wrap.md`
    - `5000-5999` → `kind-5xxx-dvm-request.md`
  - [x] Export `KindRegistry`, `KindClassification` from barrel

- [x] Task 2: Implement Handler Loader (AC: 5, 6, 7)
  - [x] Copy handler markdown files from `.claude/skills/nip-handler/references/handlers/` to `packages/agent/handlers/`:
    - `kind-1-text-note.md`
    - `kind-1059-gift-wrap.md`
    - `kind-5xxx-dvm-request.md`
  - [x] Create `packages/agent/src/handler-loader.ts`
  - [x] Implement `HandlerLoader` class with:
    - Private cache: `Map<string, string>` mapping file paths to their string content
    - `load(handlerPath: string): Promise<string>` — reads the file using `fs/promises`, returns content, caches result
    - `clearCache(): void` — clears the in-memory cache
    - `getCacheSize(): number` — returns number of cached entries (for diagnostics)
  - [x] Define `HandlerNotFoundError` class extending `Error` with a `path: string` property and descriptive message (e.g., `Handler file not found: {path}`)
  - [x] Throw `HandlerNotFoundError` if the file does not exist (catch `ENOENT`)
  - [x] Return cached content on subsequent calls for the same path (avoid re-reading file)
  - [x] Export `HandlerLoader` and `HandlerNotFoundError` from barrel

- [x] Task 3: Implement Zod action schemas (AC: 8, 9)
  - [x] Create `packages/agent/src/schemas/actions.ts`
  - [x] Define individual action schemas:
    - `ReplyActionSchema`: `{ action: "reply", content: z.string().min(1), reply_to: z.string().regex(/^[0-9a-f]{64}$/) }`
    - `ReactActionSchema`: `{ action: "react", emoji: z.string().min(1), event_id: z.string().regex(/^[0-9a-f]{64}$/) }`
    - `RepostActionSchema`: `{ action: "repost", event_id: z.string().regex(/^[0-9a-f]{64}$/) }`
    - `ZapActionSchema`: `{ action: "zap", amount_msats: z.number().int().positive(), event_id: z.string().regex(/^[0-9a-f]{64}$/), comment: z.string().optional() }`
    - `UnwrapActionSchema`: `{ action: "unwrap", event_id: z.string().regex(/^[0-9a-f]{64}$/), note: z.string().optional() }`
    - `FulfillJobActionSchema`: `{ action: "fulfill_job", job_id: z.string().regex(/^[0-9a-f]{64}$/), result_content: z.string().min(1), result_kind: z.number().int().min(6000).max(6999) }`
    - `PublishJobFeedbackActionSchema`: `{ action: "publish_job_feedback", job_id: z.string().regex(/^[0-9a-f]{64}$/), status: z.enum(["processing", "success", "error", "partial"]), content: z.string().min(1) }`
    - `StoreActionSchema`: `{ action: "store", event_id: z.string().regex(/^[0-9a-f]{64}$/), note: z.string().optional() }`
    - `ForwardActionSchema`: `{ action: "forward", event_id: z.string().regex(/^[0-9a-f]{64}$/), destination: z.string().min(1) }`
    - `IgnoreActionSchema`: `{ action: "ignore", reason: z.string().min(1) }`
    - `EscalateActionSchema`: `{ action: "escalate", reason: z.string().min(1), event_id: z.string().regex(/^[0-9a-f]{64}$/) }`
  - [x] Define `ActionSchema` as `z.discriminatedUnion('action', [ReplyActionSchema, ReactActionSchema, ...all schemas])`
  - [x] Define `ActionsResponseSchema` as `z.union([ActionSchema, z.array(ActionSchema).min(1).max(5)])` to allow single action or array of 1-5 actions
  - [x] Export all individual schemas, `ActionSchema`, `ActionsResponseSchema`, and inferred types (`Action`, `ActionsResponse`)
  - [x] Export from barrel

- [x] Task 4: Implement per-kind action allowlists (AC: 10, 11)
  - [x] Create `packages/agent/src/schemas/allowlists.ts`
  - [x] Define `ActionType` type as the union of all action string literals: `'reply' | 'react' | 'repost' | 'zap' | 'unwrap' | 'fulfill_job' | 'publish_job_feedback' | 'store' | 'forward' | 'ignore' | 'escalate'`
  - [x] Define `KindCategory` type: `'social' | 'repost' | 'reaction' | 'gift_wrap' | 'dvm_request' | 'dvm_result' | 'dvm_feedback' | 'ilp_peer_info' | 'spsp_request' | 'spsp_response' | 'unknown'`
  - [x] Define allowlist map `KIND_ACTION_ALLOWLISTS: Record<KindCategory, ReadonlySet<ActionType>>` matching the table from action-schema.md:
    - `social`: reply, react, repost, zap, ignore, escalate
    - `repost`: react, ignore, escalate
    - `reaction`: ignore, escalate
    - `gift_wrap`: unwrap, ignore, escalate
    - `dvm_request`: fulfill_job, publish_job_feedback, ignore, escalate
    - `dvm_result`: store, ignore, escalate
    - `dvm_feedback`: ignore, escalate
    - `ilp_peer_info`: store, forward, ignore, escalate
    - `spsp_request`: store, forward, ignore, escalate
    - `spsp_response`: store, ignore, escalate
    - `unknown`: ignore, escalate
  - [x] Implement `getKindCategory(kind: number): KindCategory` — maps a numeric kind to its category:
    - Exact: `1` → `social`, `6` → `repost`, `7` → `reaction`, `1059` → `gift_wrap`, `7000` → `dvm_feedback`, `10032` → `ilp_peer_info`, `23194` → `spsp_request`, `23195` → `spsp_response`, `30023` → `social`
    - Range: `5000-5999` → `dvm_request`, `6000-6999` → `dvm_result`
    - Default: `unknown`
  - [x] Implement `validateActionForKind(action: { action: string }, kind: number): { valid: boolean; reason?: string }` — checks if the action type is in the kind's allowlist
  - [x] Export all types, constants, and functions from barrel

- [x] Task 5: Write unit tests for Kind Registry (AC: 12)
  - [x] Create `packages/agent/src/kind-registry.test.ts`
  - [x] Test: exact match for kind 1 returns `kind-1-text-note.md` handler path
  - [x] Test: exact match for kind 1059 returns `kind-1059-gift-wrap.md` handler path
  - [x] Test: range match for kind 5001 returns `kind-5xxx-dvm-request.md` handler path
  - [x] Test: range match for kind 5999 returns `kind-5xxx-dvm-request.md` handler path
  - [x] Test: unhandled kinds (0, 3, 6, 7, 6000, 7000, 10032, 23194, 23195, 99999) return `null`
  - [x] Test: classify returns `regular` for kinds 1, 7, 1059, 5001
  - [x] Test: classify returns `regular` for kinds >= 40000 (e.g., 40000, 50000) as fallback
  - [x] Test: classify returns `replaceable` for kinds 0, 3, 10032
  - [x] Test: classify returns `ephemeral` for kinds 20000, 23194, 23195
  - [x] Test: classify returns `parameterized-replaceable` for kind 30023
  - [x] Test: `getAllRegisteredKinds()` returns all entries

- [x] Task 6: Write unit tests for Handler Loader (AC: 12)
  - [x] Create `packages/agent/src/handler-loader.test.ts`
  - [x] Test: loads a handler file and returns its content as a string
  - [x] Test: second load of same file returns cached content (mock `fs/promises` to verify only one read)
  - [x] Test: `clearCache()` causes next load to re-read from filesystem
  - [x] Test: throws `HandlerNotFoundError` for non-existent file path
  - [x] Test: `getCacheSize()` reflects number of unique loaded handlers

- [x] Task 7: Write unit tests for action schemas (AC: 12)
  - [x] Create `packages/agent/src/schemas/actions.test.ts`
  - [x] Test: each of the 11 action schemas validates a correct input
  - [x] Test: each action schema rejects missing required fields
  - [x] Test: hex string fields reject non-hex, wrong-length strings
  - [x] Test: `amount_msats` rejects negative, zero, and non-integer values
  - [x] Test: `result_kind` rejects values outside 6000-6999
  - [x] Test: `ActionSchema` discriminated union validates any valid action
  - [x] Test: `ActionSchema` rejects unknown action types
  - [x] Test: `ActionsResponseSchema` validates a single action
  - [x] Test: `ActionsResponseSchema` validates an array of 1-5 actions
  - [x] Test: `ActionsResponseSchema` rejects an empty array
  - [x] Test: `ActionsResponseSchema` rejects an array with >5 actions

- [x] Task 8: Write unit tests for allowlists (AC: 12)
  - [x] Create `packages/agent/src/schemas/allowlists.test.ts`
  - [x] Test: `getKindCategory()` correctly categorizes kinds 1, 6, 7, 1059, 5001, 6001, 7000, 10032, 23194, 23195, 99999
  - [x] Test: `validateActionForKind()` allows `reply` for kind 1 (social)
  - [x] Test: `validateActionForKind()` rejects `reply` for kind 1059 (gift_wrap)
  - [x] Test: `validateActionForKind()` allows `unwrap` for kind 1059
  - [x] Test: `validateActionForKind()` allows `fulfill_job` for kind 5001
  - [x] Test: `validateActionForKind()` rejects `zap` for kind 5001
  - [x] Test: `validateActionForKind()` allows `ignore` for all kind categories (universal action)
  - [x] Test: `validateActionForKind()` allows `escalate` for all kind categories (universal action)

- [x] Task 9: Update barrel exports and verify build (AC: 13, 14, 15)
  - [x] Update `packages/agent/src/index.ts` to export all new public APIs:
    - `KindRegistry`, `KindClassification` from `./kind-registry.js`
    - `HandlerLoader`, `HandlerNotFoundError` from `./handler-loader.js`
    - All action schemas and types from `./schemas/actions.js`
    - Allowlist types, constants, and functions from `./schemas/allowlists.js`
  - [x] Update `packages/agent/package.json` `files` field to include `"handlers"` alongside `"dist"` so handler markdown files are available when the package is consumed
  - [x] Run `pnpm build` — verify all packages compile
  - [x] Run `npx tsc --noEmit` from `packages/agent/` — verify type-checking passes
  - [x] Run `pnpm test` — verify all tests pass with no regressions

## Dev Notes

### Epic Context
[Source: docs/epics/epic-11-nip-handler-agent-runtime.md]

This is the second story of Epic 11 (NIP Handler Agent Runtime). It builds upon the package scaffolding from Story 11.1 to implement the deterministic dispatch layer: kind-based routing, handler loading, and action schema validation. These components are consumed by `handleNostrEvent()` in Story 11.3.

**Key architectural decision**: Deterministic dispatch, not LLM routing. The event kind number determines the handler — the LLM decides *what action to take within a handler*, not *which handler to use*.

### Previous Story Insights
[Source: docs/stories/11.1.story.md — Dev Agent Record]

- Provider SDK version adjustment: `@ai-sdk/anthropic` and `@ai-sdk/openai` are at `^3.0.0`, `@ai-sdk/moonshotai` at `^2.0.0` (not ^1.0.0 as originally spec'd)
- `ProviderRegistryConfig` uses a derived `RegistryProvider` type (extracted via `Parameters<>`) to stay in sync with Vercel AI SDK without importing `@ai-sdk/provider` directly
- Pre-existing core DTS build error (SocialPeerDiscovery `subscribeMany` type mismatch) is unchanged — not introduced by Story 11.1
- Test baseline after 11.1: **1090 passed, 0 failures**, with 8 provider registry tests
- `.js` extension in all ESM relative imports is required (e.g., `import { ... } from './kind-registry.js'`)

### Kind Registry Reference
[Source: .claude/skills/nip-handler/references/kind-registry.md]

The registry table maps kinds to handler files:

| Kind | Handler File | Category |
|------|-------------|----------|
| 1 | `kind-1-text-note.md` | regular |
| 1059 | `kind-1059-gift-wrap.md` | regular |
| 5000-5999 | `kind-5xxx-dvm-request.md` | regular |

All other kinds (0, 3, 6, 7, 6000-6999, 7000, 10032, 23194, 23195) are currently `_unhandled_`.

**Routing algorithm**: Exact match first → range match → return `null` (fallback).

**NIP-01 Kind Classification**:
```
Regular:                kind < 10000 (except 0, 3) OR kind >= 40000 (fallback)
Replaceable:            kind == 0 || kind == 3 || (10000 <= kind < 20000)
Ephemeral:              20000 <= kind < 30000
Parameterized-Replaceable: 30000 <= kind < 40000
```

### Handler Files Location
[Source: docs/epics/epic-11-nip-handler-agent-runtime.md — Target Architecture]

Handler markdown files will be located in `packages/agent/handlers/`:
- `kind-1-text-note.md`
- `kind-1059-gift-wrap.md`
- `kind-5xxx-dvm-request.md`

These are copies of the files currently at `.claude/skills/nip-handler/references/handlers/`. The `HandlerLoader` reads these files and returns their content as system prompt strings for the LLM.

**Important**: Story 11.2 implements the loading mechanism. The actual handler files should be copied into `packages/agent/handlers/` as part of this story so that tests can verify loading works end-to-end. Tests should also use mock/temp files for unit testing the loader in isolation.

### Action Schema Reference
[Source: .claude/skills/nip-handler/references/action-schema.md]

All 11 action types:

| Action | Required Fields | Optional Fields |
|--------|----------------|-----------------|
| `reply` | `content` (non-empty string), `reply_to` (64-char hex) | — |
| `react` | `emoji` (non-empty string), `event_id` (64-char hex) | — |
| `repost` | `event_id` (64-char hex) | — |
| `zap` | `amount_msats` (positive int), `event_id` (64-char hex) | `comment` (string) |
| `unwrap` | `event_id` (64-char hex) | `note` (string) |
| `fulfill_job` | `job_id` (64-char hex), `result_content` (non-empty string), `result_kind` (6000-6999 int) | — |
| `publish_job_feedback` | `job_id` (64-char hex), `status` (enum: processing/success/error/partial), `content` (non-empty string) | — |
| `store` | `event_id` (64-char hex) | `note` (string) |
| `forward` | `event_id` (64-char hex), `destination` (non-empty string) | — |
| `ignore` | `reason` (non-empty string) | — |
| `escalate` | `reason` (non-empty string), `event_id` (64-char hex) | — |

**Validation rules**:
- `event_id`, `reply_to`, `job_id` MUST be 64-character lowercase hex strings
- `amount_msats` MUST be a positive integer
- `result_kind` MUST be in range 6000-6999
- Multi-action arrays: 1-5 actions (no empty arrays, no unbounded lists)

### Action Allowlists by Kind
[Source: .claude/skills/nip-handler/references/action-schema.md#action-allowlists-by-kind-category]

| Kind Category | Kinds | Allowed Actions |
|--------------|-------|----------------|
| Social | 1, 30023 | reply, react, repost, zap, ignore, escalate |
| Repost | 6 | react, ignore, escalate |
| Reaction | 7 | ignore, escalate |
| Gift Wrap | 1059 | unwrap, ignore, escalate |
| DVM Request | 5000-5999 | fulfill_job, publish_job_feedback, ignore, escalate |
| DVM Result | 6000-6999 | store, ignore, escalate |
| DVM Feedback | 7000 | ignore, escalate |
| ILP Peer Info | 10032 | store, forward, ignore, escalate |
| SPSP Request | 23194 | store, forward, ignore, escalate |
| SPSP Response | 23195 | store, ignore, escalate |
| Unknown | any other | ignore, escalate |

### Source Tree (New Files)
[Source: docs/architecture/9-source-tree.md, docs/epics/epic-11-nip-handler-agent-runtime.md]

```
packages/agent/
├── src/
│   ├── index.ts                    # Updated: add new exports
│   ├── providers.ts                # Existing (Story 11.1)
│   ├── providers.test.ts           # Existing (Story 11.1)
│   ├── kind-registry.ts            # NEW: KindRegistry class
│   ├── kind-registry.test.ts       # NEW: Kind registry tests
│   ├── handler-loader.ts           # NEW: HandlerLoader class
│   ├── handler-loader.test.ts      # NEW: Handler loader tests
│   └── schemas/
│       ├── actions.ts              # NEW: Zod action schemas
│       ├── actions.test.ts         # NEW: Action schema tests
│       ├── allowlists.ts           # NEW: Per-kind action allowlists
│       └── allowlists.test.ts      # NEW: Allowlist tests
├── handlers/                       # NEW: Handler markdown files
│   ├── kind-1-text-note.md         # Copy from .claude/skills/nip-handler/references/handlers/
│   ├── kind-1059-gift-wrap.md      # Copy from .claude/skills/nip-handler/references/handlers/
│   └── kind-5xxx-dvm-request.md    # Copy from .claude/skills/nip-handler/references/handlers/
├── package.json
├── tsconfig.json
└── tsup.config.ts
```

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

- Files: PascalCase for classes (`KindRegistry.ts` if single-class), kebab-case for utilities (`kind-registry.ts`, `handler-loader.ts`)
- Classes: PascalCase → `KindRegistry`, `HandlerLoader`
- Functions: camelCase → `validateActionForKind`, `getKindCategory`
- Constants: UPPER_SNAKE_CASE → `KIND_ACTION_ALLOWLISTS`
- Types: PascalCase → `KindClassification`, `ActionType`, `KindCategory`
- All public APIs exported from `index.ts`
- **Use `.js` extension in all relative imports** (ESM requirement)
- Never use `any` — use `unknown` and type guards
- TypeScript ^5.3.x strict mode

### Testing Standards
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **Framework:** Vitest ^1.x
- **File Convention:** `*.test.ts` co-located with source
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Vitest built-in mocking (`vi.fn()`, `vi.mock()`) — mock `fs/promises` for handler loader tests to verify caching behavior
- **Coverage:** >80% for public APIs
- **Test run:** `pnpm test` from workspace root
- **Build validation:** `pnpm build` from workspace root
- **Type-check:** `npx tsc --noEmit` from `packages/agent/`
- **Baseline:** 1090 passed, 0 failures (after Story 11.1)

### What NOT to Change

- No changes to `packages/core/`, `packages/bls/`, `packages/relay/`, `packages/examples/`, `packages/ui-prototypes/`
- No changes to `docker/`
- No changes to `pnpm-workspace.yaml` or root `vitest.config.ts`
- Do NOT implement `handleNostrEvent()`, action executor, event loop, security defense stack, rate limiter, or audit logger — those are Stories 11.3–11.6
- Do NOT add the `ai` import or LLM call logic to any of these files — this story is pure routing + validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-17 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-17 | 0.2 | Fix: added handler file copy subtask to Task 2, added `>= 40000` fallback to kind classification rules and test coverage | SM (Claude Opus 4.6) |
| 2026-02-17 | 0.3 | Fix: specify `HandlerNotFoundError` class + export, clarify `resolve()` returns full joined path, add explicit `getKindCategory()` mapping, add `handlers` to package.json `files` | SM (Claude Opus 4.6) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- No debug issues encountered. Pre-existing `packages/core` DTS build error (SocialPeerDiscovery `subscribeMany` type mismatch) unchanged from Story 11.1.

### Completion Notes List
- All 9 tasks completed with 92 new tests (1182 total, up from 1090 baseline)
- `packages/agent` builds and type-checks cleanly
- `pnpm build` succeeds for all packages except pre-existing core DTS error (not introduced by this story)
- Handler markdown files copied to `packages/agent/handlers/`
- `package.json` `files` field updated to include `handlers` directory

### File List
- `packages/agent/src/kind-registry.ts` — NEW: KindRegistry class with resolve/classify/getAllRegisteredKinds
- `packages/agent/src/kind-registry.test.ts` — NEW: 21 tests for kind registry
- `packages/agent/src/handler-loader.ts` — NEW: HandlerLoader class with caching, HandlerNotFoundError
- `packages/agent/src/handler-loader.test.ts` — NEW: 7 tests for handler loader
- `packages/agent/src/schemas/actions.ts` — NEW: 11 Zod action schemas, ActionSchema union, ActionsResponseSchema
- `packages/agent/src/schemas/actions.test.ts` — NEW: 39 tests for action schemas
- `packages/agent/src/schemas/allowlists.ts` — NEW: KIND_ACTION_ALLOWLISTS, getKindCategory, validateActionForKind
- `packages/agent/src/schemas/allowlists.test.ts` — NEW: 25 tests for allowlists
- `packages/agent/src/index.ts` — MODIFIED: added barrel exports for all new public APIs
- `packages/agent/package.json` — MODIFIED: added "handlers" to files field
- `packages/agent/handlers/kind-1-text-note.md` — NEW: copied from .claude/skills/nip-handler/references/handlers/
- `packages/agent/handlers/kind-1059-gift-wrap.md` — NEW: copied from .claude/skills/nip-handler/references/handlers/
- `packages/agent/handlers/kind-5xxx-dvm-request.md` — NEW: copied from .claude/skills/nip-handler/references/handlers/

## QA Results

### Review Date: 2026-02-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. All four source modules (kind-registry, handler-loader, actions schemas, allowlists) are clean, focused, and follow project conventions precisely. Code is well-structured with clear separation of concerns — the KindRegistry handles routing, HandlerLoader handles file I/O with caching, Zod schemas handle validation, and allowlists enforce per-kind action policies. No dead code, no over-engineering, no shortcuts.

Key quality highlights:
- DRY hex ID pattern reused across all schemas
- Proper error hierarchy (HandlerNotFoundError extends Error with name + path)
- ReadonlySet for allowlists prevents accidental mutation
- Descriptive error messages in validateActionForKind include category and allowed actions
- Diagnostics methods (getAllRegisteredKinds, getCacheSize) support observability

### Refactoring Performed

None required. Code is clean and well-organized.

### Compliance Check

- Coding Standards: ✓ kebab-case files, PascalCase classes, camelCase functions, UPPER_SNAKE_CASE constants, .js ESM imports, no `any`, strict mode
- Project Structure: ✓ Source co-located with tests, schemas in subdirectory, handlers in dedicated directory, barrel exports from index.ts
- Testing Strategy: ✓ Vitest, AAA pattern, co-located .test.ts files, fs/promises properly mocked, >80% coverage of public APIs
- All ACs Met: ✓ All 15 acceptance criteria verified (see traceability below)

### AC Traceability

| AC | Validation | Evidence |
|----|-----------|----------|
| 1 | ✓ KindRegistry.resolve() in kind-registry.ts | kind-registry.test.ts: exact match tests |
| 2 | ✓ Exact-match (1, 1059) + range-match (5000-5999) | kind-registry.test.ts: 5 resolve tests |
| 3 | ✓ Returns null for 10 unhandled kinds | kind-registry.test.ts: `it.each` with [0,3,6,7,6000,7000,10032,23194,23195,99999] |
| 4 | ✓ classify() with NIP-01 rules | kind-registry.test.ts: regular/replaceable/ephemeral/parameterized-replaceable tests |
| 5 | ✓ HandlerLoader.load() reads markdown | handler-loader.test.ts: load test |
| 6 | ✓ In-memory cache avoids re-reads | handler-loader.test.ts: caching test (mockReadFile called once) |
| 7 | ✓ HandlerNotFoundError on missing file | handler-loader.test.ts: ENOENT → custom error, re-throws others |
| 8 | ✓ All 11 Zod action schemas | actions.test.ts: individual schema validation |
| 9 | ✓ ActionSchema discriminated union + ActionsResponseSchema | actions.test.ts: union + single/array tests |
| 10 | ✓ KIND_ACTION_ALLOWLISTS per-kind map | allowlists.ts: 11 categories with correct allowed sets |
| 11 | ✓ validateActionForKind() enforcement | allowlists.test.ts: valid/invalid action tests |
| 12 | ✓ 92 unit tests across 4 test files | 21 registry + 7 loader + 39 schema + 25 allowlist |
| 13 | ✓ pnpm build succeeds | Verified: ESM 6.71KB, DTS 16.98KB |
| 14 | ✓ npx tsc --noEmit passes | Verified: clean |
| 15 | ✓ pnpm test passes, 1182 total (was 1090) | Verified: 50 test files, 0 failures |

### Improvements Checklist

- [x] All acceptance criteria met — no code changes needed
- [ ] Add per-package `test` script to packages/agent/package.json (carried over from 11.1 gate recommendation)

### Security Review

No security concerns. No network calls, no credential handling, no user-controlled input paths in production code. Handler file paths are constructed from a trusted `handlersDir` base + pre-defined handler filenames. Zod schemas enforce strict validation on all fields.

### Performance Considerations

No performance concerns. In-memory Map-based registry and cache are O(1) for lookups. Range matching iterates a single-element array (negligible). Handler loader cache prevents redundant filesystem reads.

### Files Modified During Review

None. No refactoring was necessary.

### Gate Status

Gate: PASS → docs/qa/gates/11.2-kind-registry-handler-loader-zod-action-schemas.yml

### Recommended Status

✓ Ready for Done
