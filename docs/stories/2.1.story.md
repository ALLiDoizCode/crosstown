# Story 2.1: Static SPSP Info Query

## Status

Done

## Story

**As an** agent developer,
**I want** to query a peer's published SPSP parameters,
**so that** I can set up payments without a request/response handshake.

## Acceptance Criteria

1. `NostrSpspClient` class created with constructor accepting relay URLs and optional SimplePool
2. `getSpspInfo(pubkey: string): Promise<SpspInfo | null>` method queries kind:10047 events
3. Returns parsed SpspInfo or null if peer has no published SPSP info
4. Method queries multiple relays and returns most recent event (by created_at)
5. Unit tests verify query construction, parsing, and null handling

## Tasks / Subtasks

- [x] Task 1: Create SpspError class (AC: 2, 3)
  - [x] Add `SpspError` class to `packages/core/src/errors.ts` extending `CrosstownError`
  - [x] Use error code `SPSP_FAILED`
  - [x] Export `SpspError` from `packages/core/src/index.ts`

- [x] Task 2: Create spsp directory structure (AC: 1)
  - [x] Create `packages/core/src/spsp/` directory
  - [x] Create `packages/core/src/spsp/index.ts` for module exports
  - [x] Create empty `packages/core/src/spsp/NostrSpspClient.ts`
  - [x] Create empty `packages/core/src/spsp/NostrSpspClient.test.ts`

- [x] Task 3: Implement NostrSpspClient class structure (AC: 1)
  - [x] Define `NostrSpspClient` class with private `relayUrls` and `pool` fields
  - [x] Constructor accepts `relayUrls: string[]` and optional `pool?: SimplePool`
  - [x] Create `SimplePool` instance if not provided (same pattern as `NostrPeerDiscovery`)
  - [x] Export class from `packages/core/src/spsp/index.ts`

- [x] Task 4: Add pubkey validation (AC: 2)
  - [x] Reuse `PUBKEY_REGEX` pattern from discovery module (or define shared constant)
  - [x] Validate pubkey in `getSpspInfo` before relay queries
  - [x] Throw `SpspError` for invalid pubkey format

- [x] Task 5: Implement getSpspInfo method (AC: 2, 3, 4)
  - [x] Method signature: `async getSpspInfo(pubkey: string): Promise<SpspInfo | null>`
  - [x] Create filter: `{ kinds: [SPSP_INFO_KIND], authors: [pubkey] }`
  - [x] Query using `pool.querySync(relayUrls, filter)`
  - [x] Return `null` if no events found (AC: 3)
  - [x] Sort events by `created_at` descending, select most recent (AC: 4)
  - [x] Parse event using existing `parseSpspInfo()` function
  - [x] Return parsed `SpspInfo` on success

- [x] Task 6: Handle parse failures gracefully (AC: 2, 3)
  - [x] Wrap `parseSpspInfo` in try-catch
  - [x] On `InvalidEventError`, return `null` (malformed event = no valid SPSP info)
  - [x] On other errors, re-throw as `SpspError` with original as cause

- [x] Task 7: Update module exports (AC: 1)
  - [x] Export `NostrSpspClient` from `packages/core/src/index.ts`
  - [x] Export `SpspError` from `packages/core/src/index.ts`

- [x] Task 8: Write unit tests for class instantiation (AC: 1, 5)
  - [x] Test NostrSpspClient can be instantiated with relay URLs
  - [x] Test NostrSpspClient can be instantiated with custom SimplePool
  - [x] Test constructor stores relays correctly

- [x] Task 9: Write unit tests for getSpspInfo happy path (AC: 2, 4, 5)
  - [x] Test returns SpspInfo when kind:10047 event exists
  - [x] Test returns most recent event when multiple exist (AC: 4)
  - [x] Test correctly parses destinationAccount and sharedSecret fields

- [x] Task 10: Write unit tests for getSpspInfo null cases (AC: 3, 5)
  - [x] Test returns null when no events found
  - [x] Test returns null when event content is malformed
  - [x] Test returns null when required fields missing

- [x] Task 11: Write unit tests for error handling (AC: 2, 5)
  - [x] Test throws SpspError for invalid pubkey format
  - [x] Test wraps relay errors in SpspError

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.6.story.md#dev-agent-record]

From Epic 1 completion:
- Package uses ESM (`"type": "module"`) - use `.js` extension in imports
- TypeScript strict mode is enabled
- 91 tests currently pass in core package
- Test helpers cast through `unknown` for `VerifiedEvent` type: `as unknown as VerifiedEvent`
- `NostrPeerDiscovery` class provides established pattern for constructor and relay querying
- `parseSpspInfo()` function already exists in `packages/core/src/events/parsers.ts`
- `SpspInfo` type already defined in `packages/core/src/types.ts`
- `SPSP_INFO_KIND = 10047` constant already exported from `packages/core/src/constants.ts`

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create/modify for this story:
```
packages/core/src/
├── errors.ts                           # Add SpspError class (modify)
├── index.ts                            # Add exports (modify)
├── spsp/                               # New directory (create)
│   ├── index.ts                        # Module exports (create)
│   ├── NostrSpspClient.ts              # Main class (create)
│   └── NostrSpspClient.test.ts         # Tests (create)
```

### Data Models
[Source: docs/architecture/4-data-models.md]

**SpspInfo (kind:10047):**
```typescript
export interface SpspInfo {
  /** ILP address to send payment to */
  destinationAccount: string;
  /** Base64-encoded shared secret for STREAM protocol */
  sharedSecret: string;
}
```

This interface already exists in `packages/core/src/types.ts` [Source: packages/core/src/types.ts:26-31]

### Event Parsing
[Source: packages/core/src/events/parsers.ts]

The `parseSpspInfo` function already exists and validates:
- Event kind is 10047
- Content is valid JSON object
- `destinationAccount` is non-empty string
- `sharedSecret` is non-empty string

Usage:
```typescript
import { parseSpspInfo } from '../events/index.js';
import { SPSP_INFO_KIND } from '../constants.js';

try {
  const info = parseSpspInfo(event);
  return info;
} catch (error) {
  if (error instanceof InvalidEventError) {
    return null; // Malformed event = no valid SPSP info
  }
  throw new SpspError('Failed to parse SPSP info', error);
}
```

### nostr-tools SimplePool Query API
[Source: docs/architecture/3-tech-stack.md, packages/core/src/discovery/NostrPeerDiscovery.ts]

**SimplePool.querySync() for one-time queries:**
```typescript
import { SimplePool } from 'nostr-tools/pool';
import type { Filter } from 'nostr-tools/filter';

const filter: Filter = {
  kinds: [SPSP_INFO_KIND],
  authors: [pubkey],
};

const events = await pool.querySync(relayUrls, filter);
```

**Replaceable event handling (kind 10000-19999):**
```typescript
// Sort by created_at descending and use most recent
const sortedEvents = events.sort((a, b) => b.created_at - a.created_at);
const mostRecent = sortedEvents[0];
if (!mostRecent) {
  return null;
}
```

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

**SpspError class to create:**
```typescript
export class SpspError extends CrosstownError {
  constructor(message: string, cause?: Error) {
    super(message, 'SPSP_FAILED', cause);
    this.name = 'SpspError';
  }
}
```

**Error scenarios:**
- Invalid pubkey → throw `SpspError`
- No events found → return `null`
- Malformed event (InvalidEventError) → return `null`
- Relay failure → throw `SpspError` with cause

### Pubkey Validation Pattern
[Source: packages/core/src/discovery/NostrPeerDiscovery.ts:13]

The regex pattern used in `NostrPeerDiscovery`:
```typescript
const PUBKEY_REGEX = /^[0-9a-f]{64}$/;

if (!PUBKEY_REGEX.test(pubkey)) {
  throw new SpspError(
    'Invalid pubkey format: must be 64-character lowercase hex string'
  );
}
```

Note: Consider extracting this to a shared validation utility if we're duplicating it.

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case | (but we use PascalCase for class files per existing pattern) |
| Classes | PascalCase | `NostrSpspClient` |
| Methods | camelCase | `getSpspInfo` |
| Constants | UPPER_SNAKE_CASE | `SPSP_INFO_KIND` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards
- Always mock SimplePool in tests - no live relay dependencies
- Export from index.ts - all public APIs exported from package index
- Use nostr-tools types - don't redefine event types

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**File:** `packages/core/src/spsp/NostrSpspClient.test.ts`

**Test pattern from NostrPeerDiscovery.test.ts:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import type { SimplePool } from 'nostr-tools/pool';
import type { VerifiedEvent } from 'nostr-tools/pure';
import { NostrSpspClient } from './NostrSpspClient.js';
import { SPSP_INFO_KIND } from '../constants.js';
import { SpspError } from '../errors.js';

const MOCK_RELAY_URLS = ['wss://relay1.example.com', 'wss://relay2.example.com'];

const mockPool = {
  querySync: vi.fn(),
} as unknown as SimplePool;

function createSpspInfoEvent(
  pubkey: string,
  info: { destinationAccount?: string; sharedSecret?: string } = {},
  created_at = Math.floor(Date.now() / 1000)
): VerifiedEvent {
  return {
    id: `mock-id-${pubkey.slice(0, 8)}`,
    pubkey,
    kind: SPSP_INFO_KIND,
    content: JSON.stringify({
      destinationAccount: info.destinationAccount ?? 'g.test.receiver',
      sharedSecret: info.sharedSecret ?? 'dGVzdC1zZWNyZXQ=', // base64 "test-secret"
    }),
    tags: [],
    created_at,
    sig: 'mock-sig',
  } as unknown as VerifiedEvent;
}

describe('NostrSpspClient', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  // Tests here...
});
```

**Test Requirements:**
- Follow AAA pattern (Arrange, Act, Assert)
- Mock all SimplePool calls
- Test success, null returns, and error paths
- >80% coverage for new class

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
None - no blocking issues encountered.

### Completion Notes
- Implemented `NostrSpspClient` class following the established `NostrPeerDiscovery` pattern
- Created `SpspError` class with `SPSP_FAILED` error code
- PUBKEY_REGEX duplicated locally (same pattern as NostrPeerDiscovery) - consider extracting to shared utility in future
- 21 new unit tests added covering constructor, happy path, null cases, and error handling
- All 112 tests pass (91 original + 21 new)
- Linting passes with no errors

### File List
| File | Action |
|------|--------|
| `packages/core/src/errors.ts` | Modified - added SpspError class |
| `packages/core/src/index.ts` | Modified - added SpspError and NostrSpspClient exports |
| `packages/core/src/spsp/index.ts` | Created - module exports |
| `packages/core/src/spsp/NostrSpspClient.ts` | Created - main client class |
| `packages/core/src/spsp/NostrSpspClient.test.ts` | Created - 21 unit tests |

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is **excellent**. The `NostrSpspClient` class follows the established `NostrPeerDiscovery` pattern precisely, demonstrating strong architectural consistency. Code is clean, well-documented, and properly typed without any use of `any`. Error handling correctly differentiates between invalid events (returns null) and relay failures (throws SpspError with cause chain).

### Refactoring Performed

None required. Code quality meets all standards without modification.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, no `any`, proper naming conventions (PascalCase class, camelCase methods, UPPER_SNAKE_CASE constants)
- Project Structure: ✓ Co-located tests, proper module exports, follows `spsp/` directory structure from source tree
- Testing Strategy: ✓ 21 unit tests with mocked SimplePool, AAA pattern, >80% coverage for new class
- All ACs Met: ✓ All 5 acceptance criteria have corresponding test coverage

### Requirements Traceability

| AC | Test Coverage |
|----|---------------|
| 1 | `constructor` suite (4 tests) - instantiation with/without pool |
| 2 | `happy path` suite (5 tests) - query construction and parsing |
| 3 | `null cases` suite (6 tests) - no events, malformed, missing fields |
| 4 | "returns most recent event when multiple exist" test |
| 5 | All 21 tests combined cover query, parsing, null, and error handling |

### Improvements Checklist

- [x] All required exports in place (`packages/core/src/index.ts`)
- [x] SpspError class properly defined with SPSP_FAILED code
- [x] Tests mock SimplePool (no live relay dependencies)
- [x] Error cause chaining preserved
- [ ] Consider extracting PUBKEY_REGEX to shared validation utility (minor, optional - noted by dev)

### Security Review

No security concerns. Pubkey validation prevents malformed input. Error messages are informative without leaking sensitive data.

### Performance Considerations

No concerns. Implementation uses efficient single-query pattern with SimplePool.querySync().

### Files Modified During Review

None - no changes required.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.1-static-spsp-info-query.yml

### Recommended Status

✓ Ready for Done

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM |
| 2026-02-06 | 0.2 | Implementation complete | Dev Agent (James) |
| 2026-02-06 | 0.3 | QA review complete - PASS | Quinn (Test Architect) |
