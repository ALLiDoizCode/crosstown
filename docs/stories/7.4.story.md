# Story 7.4: Configurable 0-Amount SPSP Acceptance for Bootstrap

## Status

Done

## Story

**As a** bootstrap node operator,
**I want** to accept 0-amount ILP packets for SPSP events,
**so that** new peers can perform their initial SPSP handshake without needing a pre-existing payment channel.

## Acceptance Criteria

1. `SPSP_MIN_PRICE=0` env var makes BLS accept 0-amount SPSP packets (kind:23194)
2. Non-SPSP events still require standard pricing even when `SPSP_MIN_PRICE=0`
3. Default behavior (no env var): SPSP requires standard pricing
4. Accepted 0-amount SPSP requests logged at INFO level
5. Unit tests for pricing bypass on SPSP events

## Tasks / Subtasks

- [x] Task 1: Add `spspMinPrice` field to `BlsConfig` and local SPSP kind constant in `packages/bls/src/bls/types.ts` (AC: 1, 3)
  - [x]Add `export const SPSP_REQUEST_KIND = 23194;` constant (BLS does not import from `@crosstown/core`, so define locally)
  - [x]Add optional `spspMinPrice?: bigint` field to the `BlsConfig` interface
  - [x]JSDoc: "Optional minimum price for SPSP request events (kind:23194). When set to 0n, SPSP requests are accepted without payment. Defaults to standard pricing when undefined."
  - [x]No changes to other existing `BlsConfig` fields

- [x] Task 2: Add `SPSP_MIN_PRICE` to `loadBlsConfigFromEnv()` in `packages/bls/src/config.ts` (AC: 1, 3)
  - [x]Read `SPSP_MIN_PRICE` env var (optional)
  - [x]Parse value as `bigint` (same pattern as `BASE_PRICE_PER_BYTE`)
  - [x]Validate value is non-negative (`>= 0n`)
  - [x]If not set, leave `spspMinPrice` as `undefined` in returned config (default: standard pricing)
  - [x]If set, add `spspMinPrice` to returned `BlsEnvConfig`
  - [x]Throw `ConfigError` for invalid values (non-integer, negative)
  - [x]Add `spspMinPrice?: bigint` to `BlsEnvConfig` interface

- [x] Task 3: Update `BusinessLogicServer.handlePayment()` to apply SPSP minimum price in `packages/bls/src/bls/BusinessLogicServer.ts` (AC: 1, 2, 3, 4)
  - [x]After calculating the standard price and before the `amount < price` comparison, check if SPSP min price applies:
    - If `this.config.spspMinPrice !== undefined` AND `event.kind === SPSP_REQUEST_KIND`:
      - Use `this.config.spspMinPrice` as the effective price instead of the calculated price (if it's lower)
      - Use bigint conditional: `const effectivePrice = spspMinPrice < price ? spspMinPrice : price` (Note: `Math.min` does not work with `bigint`)
    - Otherwise: use the standard calculated price (existing behavior)
  - [x]When `spspMinPrice` is `0n` and event is `SPSP_REQUEST_KIND`, effectively makes SPSP free
  - [x]When `spspMinPrice` is `undefined` or event is NOT `SPSP_REQUEST_KIND`, existing pricing logic applies unchanged (AC: 2, 3)
  - [x]Log at INFO level when an SPSP request is accepted with 0-amount payment: `console.log('INFO: Accepted 0-amount SPSP request from pubkey:', event.pubkey.slice(0, 16))` (AC: 4)
    - Only log when `amount === 0n` AND `event.kind === SPSP_REQUEST_KIND` AND the SPSP min price bypass was applied

- [x] Task 4: Update `createBlsServer()` in `packages/bls/src/server.ts` to pass `spspMinPrice` (AC: 1)
  - [x]Add optional `spspMinPrice?: bigint` to `CreateBlsServerConfig` interface
  - [x]Pass `spspMinPrice` to `BusinessLogicServer` constructor via `BlsConfig`

- [x] Task 5: Update entrypoint to pass `spspMinPrice` from config in `packages/bls/src/entrypoint.ts` (AC: 1)
  - [x]Pass `spspMinPrice` from loaded `BlsEnvConfig` to the `BusinessLogicServer` `BlsConfig`
  - [x]Log `spspMinPrice` in the startup configuration summary if set: `console.log('  SPSP Min Price:     ${spspMinPrice}');`

- [x] Task 6: Mirror changes to `packages/relay/src/bls/types.ts` (AC: 1, 3)
  - [x]Add `export const SPSP_REQUEST_KIND = 23194;` constant (mirrors `packages/bls` definition)
  - [x]Add optional `spspMinPrice?: bigint` field to the relay package's `BlsConfig` interface
  - [x]Maintains consistency between `packages/bls` and `packages/relay` BLS implementations
  - [x]Note: The relay package has no `config.ts` or `entrypoint.ts` — its BLS is embedded in the relay server, which provides config externally. Only `types.ts` and `BusinessLogicServer.ts` are mirrored here (no equivalents to Tasks 2, 4, 5 needed for relay).

- [x] Task 7: Mirror `handlePayment()` changes to `packages/relay/src/bls/BusinessLogicServer.ts` (AC: 1, 2, 3, 4)
  - [x]Apply the same SPSP min price logic from Task 3 to the relay package's BLS
  - [x]Same logging behavior for 0-amount SPSP acceptance

- [x] Task 8: Write unit tests for `SPSP_MIN_PRICE` config loading in `packages/bls/src/config.test.ts` (AC: 1, 3)
  - [x]Add `delete process.env['SPSP_MIN_PRICE'];` to the existing `beforeEach` cleanup block (alongside the other env var deletions) to prevent test state leakage
  - [x]Test: `SPSP_MIN_PRICE=0` sets `spspMinPrice` to `0n` in config
  - [x]Test: `SPSP_MIN_PRICE=100` sets `spspMinPrice` to `100n`
  - [x]Test: no `SPSP_MIN_PRICE` env var leaves `spspMinPrice` undefined
  - [x]Test: `SPSP_MIN_PRICE=-1` throws `ConfigError`
  - [x]Test: `SPSP_MIN_PRICE=not-a-number` throws `ConfigError`

- [x] Task 9: Write unit tests for SPSP pricing bypass in `packages/bls/src/bls/BusinessLogicServer.test.ts` (AC: 1, 2, 3, 4, 5)
  - [x]Test: with `spspMinPrice: 0n`, kind:23194 events accepted with amount=0
  - [x]Test: with `spspMinPrice: 0n`, non-SPSP events (kind:1) still require standard payment
  - [x]Test: with `spspMinPrice: 0n`, kind:23195 (SPSP response) still requires standard payment (only kind:23194 bypassed)
  - [x]Test: without `spspMinPrice`, kind:23194 events require standard payment (default behavior)
  - [x]Test: with `spspMinPrice: 0n`, kind:23194 events are stored successfully
  - [x]Test: with `spspMinPrice: 0n`, fulfillment is returned correctly for 0-amount SPSP
  - [x]Test: with `spspMinPrice: 50n`, kind:23194 events accepted with amount matching spspMinPrice calculation (but less than standard price)
  - [x]Test: verify INFO log when 0-amount SPSP request is accepted (mock console.log)

- [x] Task 10: Write unit tests for relay package's SPSP pricing bypass in `packages/relay/src/bls/BusinessLogicServer.test.ts` (AC: 1, 2, 5)
  - [x]Test: with `spspMinPrice: 0n`, kind:23194 events accepted with amount=0
  - [x]Test: with `spspMinPrice: 0n`, non-SPSP events (kind:1) still require standard payment
  - [x]Test: without `spspMinPrice`, kind:23194 events require standard payment

- [x] Task 11: Run full test suite and lint (AC: 5)
  - [x]Run `pnpm test` — all existing tests must pass plus new tests
  - [x]Run `pnpm lint` — no new lint errors
  - [x]Verify no regressions in existing BLS tests in both `packages/bls` and `packages/relay`

## Dev Notes

### Previous Story Insights
[Source: docs/stories/7.3.story.md#dev-agent-record]

From Story 7.3 (Implement Settlement Negotiation in SPSP Server):
- 919 tests passing (29 new tests added), 0 failures
- ESLint: 3 pre-existing errors (none introduced by Story 7.3)
- The `@crosstown/core` package has the SPSP event kind constants: `SPSP_REQUEST_KIND = 23194` and `SPSP_RESPONSE_KIND = 23195` in `packages/core/src/constants.ts`
- However, the BLS packages (`packages/bls` and `packages/relay`) do NOT import from `@crosstown/core` — they use raw kind numbers. The BLS treats events generically (any Nostr event kind). For this story, use the literal `23194` in BLS code rather than importing the constant from core.

### Data Models
[Source: packages/bls/src/bls/types.ts, packages/relay/src/bls/types.ts]

**Current `BlsConfig` interface (both packages):**
```typescript
export interface BlsConfig {
  basePricePerByte: bigint;
  pricingService?: PricingService;
  ownerPubkey?: string;
}
```

**After this story:**
```typescript
export interface BlsConfig {
  basePricePerByte: bigint;
  pricingService?: PricingService;
  ownerPubkey?: string;
  spspMinPrice?: bigint;  // NEW — minimum price for kind:23194 events
}
```

**Current `BlsEnvConfig` interface:**
```typescript
export interface BlsEnvConfig {
  nodeId: string;
  nostrSecretKey: string;
  pubkey: string;
  ilpAddress: string;
  port: number;
  basePricePerByte: bigint;
  ownerPubkey?: string;
  dataDir: string;
  kindOverrides?: Map<number, bigint>;
}
```

**After this story:**
```typescript
export interface BlsEnvConfig {
  // ... existing fields ...
  spspMinPrice?: bigint;  // NEW
}
```

[Source: packages/bls/src/config.ts]

### API Specifications
No specific guidance found in architecture docs — this story introduces a new env var (`SPSP_MIN_PRICE`) following the established env var pattern in `packages/bls/src/config.ts`.

### Component Specifications

**`BusinessLogicServer` (`packages/bls/src/bls/BusinessLogicServer.ts` and `packages/relay/src/bls/BusinessLogicServer.ts`):**
- The `handlePayment()` method (private) processes all incoming events
- Current pricing flow: decode TOON → verify signature → (owner bypass) → calculate price → compare amount → store event
- This story inserts an SPSP min price check between "calculate price" and "compare amount"
- The check: if `spspMinPrice` is configured AND event is kind 23194, use `spspMinPrice` as the effective price (when it's lower than calculated price)
- This is analogous to the existing `ownerPubkey` bypass but scoped to a specific event kind and configurable minimum (not full bypass)
[Source: packages/bls/src/bls/BusinessLogicServer.ts:82-197]

**Two BLS implementations exist:**
1. `packages/bls/src/bls/` — Standalone BLS Docker package (primary, with `BlsBaseError` base class)
2. `packages/relay/src/bls/` — Relay-embedded BLS (with `RelayError` base class)
Both have identical `BusinessLogicServer` logic and must be updated in parallel.
[Source: packages/bls/src/bls/BusinessLogicServer.ts, packages/relay/src/bls/BusinessLogicServer.ts]

**`loadBlsConfigFromEnv()` (`packages/bls/src/config.ts`):**
- Loads all BLS env vars, validates them, returns `BlsEnvConfig`
- Existing pattern for optional env vars: read, parse, validate, add to config if set
- `SPSP_MIN_PRICE` follows the same pattern (no prefix cascading needed — single env var name)
[Source: packages/bls/src/config.ts:51-115]

**`createBlsServer()` (`packages/bls/src/server.ts`):**
- Factory function that wires up EventStore, PricingService, and BusinessLogicServer
- Accepts `CreateBlsServerConfig`, creates `BlsConfig` from it
- Must pass `spspMinPrice` through to `BlsConfig`
[Source: packages/bls/src/server.ts:43-86]

**`entrypoint.ts` (`packages/bls/src/entrypoint.ts`):**
- Docker entrypoint that calls `loadBlsConfigFromEnv()` and creates the server
- Must pass `spspMinPrice` from config to `BusinessLogicServer` constructor
- Should log the SPSP min price in the startup summary
[Source: packages/bls/src/entrypoint.ts:25-126]

### File Locations
[Source: docs/architecture/9-source-tree.md, packages/bls/src/, packages/relay/src/]

Files to modify:
- `packages/bls/src/bls/types.ts` — Add `spspMinPrice` to `BlsConfig`
- `packages/bls/src/bls/BusinessLogicServer.ts` — Add SPSP min price logic to `handlePayment()`
- `packages/bls/src/bls/BusinessLogicServer.test.ts` — Add tests for SPSP pricing bypass
- `packages/bls/src/config.ts` — Add `SPSP_MIN_PRICE` env var parsing, add to `BlsEnvConfig`
- `packages/bls/src/config.test.ts` — Add tests for `SPSP_MIN_PRICE` config loading
- `packages/bls/src/server.ts` — Add `spspMinPrice` to `CreateBlsServerConfig`
- `packages/bls/src/entrypoint.ts` — Pass `spspMinPrice` from config, log in startup summary
- `packages/relay/src/bls/types.ts` — Add `spspMinPrice` to relay's `BlsConfig`
- `packages/relay/src/bls/BusinessLogicServer.ts` — Mirror SPSP min price logic
- `packages/relay/src/bls/BusinessLogicServer.test.ts` — Add tests for relay BLS

Files NOT modified:
- `packages/core/src/constants.ts` — SPSP kind constants exist here but are not imported by BLS packages
- `packages/core/src/spsp/` — No changes (SPSP protocol logic is unchanged)
- `packages/bls/src/pricing/` — No changes (PricingService itself is unchanged; the override happens in BLS)
- `packages/relay/src/pricing/` — No changes
- `packages/bls/src/errors.ts` — No new error classes needed
- `packages/bls/src/index.ts` — No new exports needed (existing exports cover BlsConfig, CreateBlsServerConfig)

### Technical Constraints

**SPSP event kind:**
The SPSP request event kind is `23194` (defined as `SPSP_REQUEST_KIND` in `packages/core/src/constants.ts`). The BLS packages do not depend on `@crosstown/core`, so the literal number `23194` should be used. Consider defining a local constant `const SPSP_REQUEST_KIND = 23194` in `types.ts` for clarity.
[Source: packages/core/src/constants.ts:18]

**SPSP response events (kind:23195) are NOT free:**
The SPSP min price bypass applies ONLY to kind:23194 (SPSP requests). SPSP responses (kind:23195) are published by the server (relay owner) via the owner bypass mechanism, not via this pricing override. This distinction is important for AC:2.
[Source: docs/epics/epic-7-spsp-settlement-negotiation.md#story-74]

**Two BLS packages must stay in sync:**
Both `packages/bls` and `packages/relay` contain functionally identical BLS implementations. Changes must be mirrored to both. The `packages/bls` version is the primary (standalone Docker package), while `packages/relay` version is embedded in the relay server.
[Source: packages/bls/src/bls/BusinessLogicServer.ts, packages/relay/src/bls/BusinessLogicServer.ts]

**Pricing logic insertion point:**
The SPSP min price check must be inserted AFTER the standard price calculation (line ~149-151 in both `BusinessLogicServer.ts` files) but BEFORE the `amount < price` comparison (line ~165). It must NOT interfere with the owner pubkey bypass (which returns early before price calculation). The flow is:
1. Decode event, verify signature
2. Owner bypass check (returns early if owner)
3. Calculate standard price (via PricingService or simple calc)
4. **NEW: Apply SPSP min price override if applicable**
5. Parse amount, compare to effective price
6. Store event
[Source: packages/bls/src/bls/BusinessLogicServer.ts:82-197]

**Logging pattern:**
The BLS uses `console.log` for startup logging (see `entrypoint.ts`). For runtime event acceptance logging (AC:4), use `console.log` with an `INFO:` prefix to match the relay package's logging convention (Section 11.2 of architecture: "Relay Package: Uses console with structured output").
[Source: docs/architecture/11-error-handling-strategy.md#112-logging-standards]

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md, packages/bls/src/errors.ts]

- `SPSP_MIN_PRICE` env var validation follows the same pattern as other env vars in `config.ts`
- Invalid value: throw `ConfigError` with variable name and reason
- Negative value: throw `ConfigError` — min price must be non-negative
- Non-integer: throw `ConfigError`
- No new error classes needed — existing `ConfigError` handles config validation

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x

**Test Standards:**
- Co-located test files in the same directory as source
- Follow AAA pattern (Arrange, Act, Assert) — same as existing tests
- Use `generateSecretKey()` and `finalizeEvent()` from `nostr-tools/pure` for creating test events
- Use `createValidSignedEvent()` helper (already defined in existing test files) with `kind: 23194` override
- Mock `console.log` with `vi.spyOn(console, 'log')` for testing INFO log output

**Test fixtures:**
```typescript
// Create SPSP request event (kind:23194)
const spspEvent = createValidSignedEvent({ kind: 23194, content: 'encrypted-spsp-request' });

// Create non-SPSP event (kind:1)
const normalEvent = createValidSignedEvent({ kind: 1, content: 'regular note' });

// BLS with SPSP min price enabled
const blsWithSpspFree = new BusinessLogicServer(
  { basePricePerByte: 10n, spspMinPrice: 0n },
  mockEventStore
);

// BLS without SPSP min price (default behavior)
const blsDefault = new BusinessLogicServer(
  { basePricePerByte: 10n },
  mockEventStore
);
```

**Existing test helpers (do NOT modify):**
- `createValidSignedEvent()` — creates signed event with optional overrides (supports `kind` override)
- `eventToBase64Toon()` — converts event to base64-encoded TOON
- `createMockEventStore()` — creates mock EventStore with vi.fn() methods
- `createEventFromKey()` — creates event from specific secret key

**Test count expectation:** ~16 new tests across `config.test.ts` (~5), `packages/bls/src/bls/BusinessLogicServer.test.ts` (~8), `packages/relay/src/bls/BusinessLogicServer.test.ts` (~3)

### Scope Boundaries

**In Scope:**
- `SPSP_MIN_PRICE` environment variable for BLS configuration
- `spspMinPrice` field on `BlsConfig` and `BlsEnvConfig`
- Pricing override logic in `handlePayment()` for kind:23194 events
- INFO-level logging when 0-amount SPSP accepted
- Unit tests for config loading and pricing bypass
- Mirroring changes to both `packages/bls` and `packages/relay`

**Out of Scope:**
- Changes to SPSP protocol (core package) — this is purely a BLS pricing concern
- Changes to PricingService — the override happens in BLS, not in the pricing layer
- SPSP response events (kind:23195) — only requests (kind:23194) get the min price override
- Integration tests with actual ILP connector
- Any changes to the `packages/core` package

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/bls/src/bls/types.ts` | Modified | Add `spspMinPrice?: bigint` to `BlsConfig` |
| `packages/bls/src/bls/BusinessLogicServer.ts` | Modified | Add SPSP min price logic to `handlePayment()` |
| `packages/bls/src/bls/BusinessLogicServer.test.ts` | Modified | Add tests for SPSP pricing bypass |
| `packages/bls/src/config.ts` | Modified | Add `SPSP_MIN_PRICE` env var parsing, add to `BlsEnvConfig` |
| `packages/bls/src/config.test.ts` | Modified | Add tests for `SPSP_MIN_PRICE` config loading |
| `packages/bls/src/server.ts` | Modified | Add `spspMinPrice` to `CreateBlsServerConfig`, pass to BLS |
| `packages/bls/src/entrypoint.ts` | Modified | Pass `spspMinPrice` from config, log in startup summary |
| `packages/relay/src/bls/types.ts` | Modified | Add `spspMinPrice?: bigint` to relay's `BlsConfig` |
| `packages/relay/src/bls/BusinessLogicServer.ts` | Modified | Mirror SPSP min price logic |
| `packages/relay/src/bls/BusinessLogicServer.test.ts` | Modified | Add tests for relay BLS SPSP bypass |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-08 | 0.2 | Fix Math.min/bigint confusion in Task 3; add local SPSP_REQUEST_KIND constant to Tasks 1, 3, 6, 7 | SM (Claude Opus 4.6) |
| 2026-02-08 | 0.3 | Post-validation fixes: add SPSP_MIN_PRICE cleanup to Task 8 beforeEach; clarify relay has no config/entrypoint in Task 6; fix test count to ~16 | SM (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

High-quality implementation. The SPSP min price feature is clean, well-scoped, and correctly mirrors between both BLS packages. The pricing override logic is correctly placed in the `handlePayment()` flow — after standard price calculation but before the amount comparison — preserving the owner bypass early-return path. The use of destructuring (`const { spspMinPrice } = this.config`) to avoid non-null assertion is a good pattern. The `spspMinPriceApplied` boolean flag cleanly gates both the price override and the INFO log.

Key strengths:
- Both `packages/bls` and `packages/relay` implementations are identical (correct mirroring)
- SPSP_REQUEST_KIND constant defined locally in both packages' `types.ts` (avoids cross-package dependency)
- Config validation properly uses existing `ConfigError` pattern with clear error messages
- BigInt comparison (`spspMinPrice < price`) correctly avoids `Math.min` which doesn't work with bigint
- INFO log fires only when all 3 conditions met (amount===0n, kind===23194, spspMinPriceApplied)
- `SPSP_MIN_PRICE` env var cleanup added to `beforeEach` in config tests (prevents state leakage)

### Refactoring Performed

None required. The implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ — Follows naming conventions (UPPER_SNAKE_CASE for constants, PascalCase for interfaces, camelCase for functions). No `any` usage. Uses `nostr-tools` types correctly.
- Project Structure: ✓ — Co-located test files. Changes mirrored to both BLS packages as required.
- Testing Strategy: ✓ — AAA pattern used. Mock EventStore for unit tests. Real signed events via `nostr-tools/pure`. Console.log spy for INFO log verification.
- All ACs Met: ✓ — See detailed traceability below.

### AC Traceability

| AC | Description | Implementation | Tests |
|----|-------------|---------------|-------|
| AC1 | `SPSP_MIN_PRICE=0` makes BLS accept 0-amount SPSP packets | `config.ts:102-120` parses env var; `BusinessLogicServer.ts:153-161` applies override | config.test.ts: "should set spspMinPrice to 0n"; BLS.test.ts: "should accept kind:23194 events with amount=0 when spspMinPrice is 0n" |
| AC2 | Non-SPSP events still require standard pricing | `BusinessLogicServer.ts:157` — `event.kind === SPSP_REQUEST_KIND` guard | BLS.test.ts: "should still require standard payment for non-SPSP events"; "should still require standard payment for kind:23195" |
| AC3 | Default behavior (no env var): SPSP requires standard pricing | `BusinessLogicServer.ts:156` — `spspMinPrice !== undefined` guard; `config.ts` leaves undefined when not set | config.test.ts: "should leave spspMinPrice undefined when SPSP_MIN_PRICE is not set"; BLS.test.ts: "should require standard payment for kind:23194 when spspMinPrice is not set" |
| AC4 | Accepted 0-amount SPSP requests logged at INFO level | `BusinessLogicServer.ts:188-190` — conditional INFO log | BLS.test.ts: "should log INFO when 0-amount SPSP request is accepted" (console.log spy) |
| AC5 | Unit tests for pricing bypass on SPSP events | 20 new tests across 3 test files | 5 config tests + 8 BLS tests + 3 relay tests + 4 implicit assertions |

### Improvements Checklist

- [x] All 10 files in File List verified as modified
- [x] Both BLS packages (`bls` and `relay`) have identical SPSP min price logic
- [x] Config validation covers: valid 0, valid positive, undefined (not set), negative (error), non-integer (error)
- [x] `SPSP_MIN_PRICE` cleanup in `beforeEach` prevents test state leakage
- [x] `server.ts` (`CreateBlsServerConfig`) correctly passes `spspMinPrice` through to `BlsConfig`
- [x] `entrypoint.ts` destructures `spspMinPrice`, passes to BLS, and conditionally logs at startup
- [ ] Consider adding a test for `spspMinPrice` equal to the standard calculated price (boundary case where `spspMinPrice === price` means the override is NOT applied since `spspMinPrice < price` is false — current behavior is correct but worth a boundary test)
- [ ] Consider adding a negative test that `spspMinPrice: 0n` does NOT trigger the INFO log when amount > 0n (e.g., overpayment for SPSP)

### Security Review

No security concerns. The SPSP min price override is:
- Opt-in only (requires explicit env var)
- Scoped to a single event kind (23194 only)
- Does not bypass signature verification
- Does not bypass the owner pubkey check ordering
- Only lowers the price floor, never raises it (the `spspMinPrice < price` guard ensures the lower of the two is used)

### Performance Considerations

No performance concerns. The SPSP min price check adds one boolean evaluation and one bigint comparison — negligible overhead in the payment processing path.

### Files Modified During Review

None. No refactoring was necessary.

### Gate Status

Gate: PASS → docs/qa/gates/7.4-configurable-0-amount-spsp-acceptance-for-bootstrap.yml

### Recommended Status

✓ Ready for Done

The implementation is clean, well-tested (939 tests all passing, 20 new), and fully satisfies all 5 acceptance criteria. Both BLS packages are correctly mirrored. ESLint shows only 3 pre-existing errors (none introduced). Story owner decides final status.

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug entries needed — implementation was clean, no blocking issues encountered.

### Completion Notes
- 939 tests passing (20 new tests added: 5 in config.test.ts, 8 in bls/BusinessLogicServer.test.ts, 3 in relay/BusinessLogicServer.test.ts, plus 4 implicit subtask assertions), 0 failures
- ESLint: 3 pre-existing errors (none introduced by this story)
- `SPSP_REQUEST_KIND` constant defined locally in both `packages/bls` and `packages/relay` types.ts files (not imported from core)
- Used destructuring (`const { spspMinPrice } = this.config`) to avoid non-null assertion lint error
- Added eslint-disable comment for empty arrow function in console.log mock test
- SPSP min price logic uses `spspMinPrice < price` comparison (bigint-safe, no Math.min)
- INFO log only fires when all 3 conditions met: amount===0n, kind===23194, and spspMinPriceApplied===true
