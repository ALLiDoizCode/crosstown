# Story 6.4: Social Graph Peer Discovery

## Status

Done

## Story

**As a** node operator,
**I want** my node to discover new peers from NIP-02 follow list changes and automatically negotiate peering via SPSP,
**so that** my routing table grows organically through social trust signals.

## Acceptance Criteria

1. Create `packages/core/src/discovery/SocialPeerDiscovery.ts`
2. Subscribe to NIP-02 follow list events (kind:3) for the node's pubkey
3. When a new follow is detected (pubkey not already peered):
   a. Query their relay for kind:10032 (ILP Peer Info)
   b. Perform SPSP handshake via `NostrSpspClient` (kind:23194 → 23195) to negotiate peering
   c. Register peer via connector admin API (`POST /admin/peers`)
   d. Log successful peering
4. When an unfollow is detected (pubkey removed from follow list):
   a. Optionally remove peer via `DELETE /admin/peers/:peerId`
   b. Log peer removal
5. Expose `start(): Subscription` that returns unsubscribe handle
6. Handle errors gracefully per-peer (one failed peer doesn't block others)
7. Respect a configurable cooldown between discovery attempts (prevent flooding)
8. Unit tests verify follow detection, SPSP handshake trigger, and admin API calls

## Tasks / Subtasks

- [x] Task 1: Define `SocialPeerDiscoveryConfig` interface and extend `ConnectorAdminClient` (AC: 1, 4, 7)
  - [x] Create `packages/core/src/discovery/SocialPeerDiscovery.ts`
  - [x] Define `SocialPeerDiscoveryConfig` interface:
    - `relayUrls: string[]` — relays to subscribe to for kind:3 events
    - `cooldownMs?: number` — minimum delay between peer processing attempts (default: 5000)
    - `spspTimeout?: number` — timeout for SPSP handshake in ms (default: 10000)
    - `removePeersOnUnfollow?: boolean` — whether to remove peers on unfollow (default: false)
  - [x] Extend `ConnectorAdminClient` in `bootstrap.ts` with optional `removePeer(peerId: string): Promise<void>` method for `DELETE /admin/peers/:peerId` (AC: 4)

- [x] Task 2: Implement `SocialPeerDiscovery` class constructor (AC: 1)
  - [x] Constructor accepts: `config: SocialPeerDiscoveryConfig`, `secretKey: Uint8Array`, `ownIlpInfo: IlpPeerInfo`, `pool?: SimplePool`
  - [x] Derive pubkey from secretKey via `getPublicKey(secretKey)`
  - [x] Create internal `NostrSpspClient` using `config.relayUrls`, optional `pool`, and `secretKey` for SPSP handshakes: `new NostrSpspClient(config.relayUrls, pool, secretKey)`
  - [x] Store `connectorAdmin?: ConnectorAdminClient` (set via `setConnectorAdmin()`)
  - [x] Initialize `peeredPubkeys: Set<string>` to track already-peered pubkeys
  - [x] Store config with defaults applied

- [x] Task 3: Implement follow list diffing logic (AC: 2, 3, 4)
  - [x] Add `private previousFollows: Set<string>` to track the last known follow list
  - [x] Add private method `processFollowListUpdate(followedPubkeys: string[]): Promise<void>`:
    - Compute `newFollows` = pubkeys in current list but not in `previousFollows` and not in `peeredPubkeys`
    - Compute `unfollows` = pubkeys in `previousFollows` but not in current list
    - For each new follow: call `handleNewFollow(pubkey)` with cooldown between calls
    - For each unfollow: call `handleUnfollow(pubkey)` if `removePeersOnUnfollow` is enabled
    - Update `previousFollows` to current list

- [x] Task 4: Implement `handleNewFollow(pubkey)` — the core peering flow (AC: 3)
  - [x] Query kind:10032 for the new follow's pubkey from configured relays using `pool.querySync`
  - [x] If no kind:10032 event found, log warning and skip (peer doesn't have ILP info)
  - [x] Parse `IlpPeerInfo` from the kind:10032 event using `parseIlpPeerInfo`
  - [x] Perform SPSP handshake via `this.spspClient.requestSpspInfo(pubkey, { timeout: config.spspTimeout })` — this serves as a reachability/liveness check to verify the peer is online and willing to negotiate before registering (the returned `SpspInfo` is not stored; peering uses kind:10032 data)
  - [x] Register peer via `connectorAdmin.addPeer({ id: "nostr-{pubkey16}", url: peerInfo.btpEndpoint, authToken: "", routes: [{ prefix: peerInfo.ilpAddress }] })`
  - [x] Add pubkey to `peeredPubkeys` set
  - [x] Log successful peering: `console.log("[SocialDiscovery] Peered with {pubkey16}...")`
  - [x] Wrap entire method in try/catch — log warning and continue on failure (AC: 6)

- [x] Task 5: Implement `handleUnfollow(pubkey)` (AC: 4)
  - [x] Compute peerId: `"nostr-{pubkey.slice(0, 16)}"`
  - [x] If `connectorAdmin?.removePeer` exists, call `connectorAdmin.removePeer(peerId)`
  - [x] Remove pubkey from `peeredPubkeys` set
  - [x] Log peer removal: `console.log("[SocialDiscovery] Removed peer {pubkey16}...")`
  - [x] Wrap in try/catch — log warning on failure, don't throw

- [x] Task 6: Implement `start()` method with kind:3 subscription (AC: 2, 5)
  - [x] Subscribe to kind:3 events for the node's pubkey using `pool.subscribeMany`:
    - Filter: `{ kinds: [3], authors: [this.pubkey] }`
  - [x] On each kind:3 event received:
    - Extract followed pubkeys from `p` tags (same logic as `NostrPeerDiscovery.getFollows`)
    - Call `processFollowListUpdate(followedPubkeys)`
  - [x] Return `Subscription` object with `unsubscribe()` that closes the pool subscription
  - [x] Ensure `start()` can only be called once (guard against double-start)

- [x] Task 7: Implement cooldown mechanism (AC: 7)
  - [x] Use a simple `await sleep(cooldownMs)` between peer processing attempts in `processFollowListUpdate`
  - [x] Add private `sleep(ms: number): Promise<void>` helper (or inline `new Promise(resolve => setTimeout(resolve, ms))`)
  - [x] Cooldown applies between sequential `handleNewFollow` calls, not to the subscription itself

- [x] Task 8: Update exports (AC: 1)
  - [x] Export `SocialPeerDiscovery` and `SocialPeerDiscoveryConfig` from `packages/core/src/discovery/index.ts`
  - [x] Re-export from `packages/core/src/index.ts`
  - [x] Ensure updated `ConnectorAdminClient` (with optional `removePeer`) is exported correctly

- [x] Task 9: Write unit tests for SocialPeerDiscovery (AC: 8)
  - [x] Create `packages/core/src/discovery/SocialPeerDiscovery.test.ts`
  - [x] Test: `start()` subscribes to kind:3 events for the node's pubkey
  - [x] Test: New follow triggers kind:10032 query, SPSP handshake, and admin API registration
  - [x] Test: New follow with no kind:10032 event is skipped with warning
  - [x] Test: New follow with SPSP handshake failure is skipped with warning (non-fatal)
  - [x] Test: New follow with admin API failure is skipped with warning (non-fatal)
  - [x] Test: Already-peered pubkey is not re-processed on subsequent follow list updates
  - [x] Test: Unfollow triggers `removePeer()` when `removePeersOnUnfollow: true`
  - [x] Test: Unfollow does NOT trigger `removePeer()` when `removePeersOnUnfollow: false`
  - [x] Test: `start()` returns Subscription with working `unsubscribe()`
  - [x] Test: Cooldown is respected between peer processing attempts
  - [x] Test: Errors in one peer don't block processing of other peers
  - [x] Test: `start()` called twice throws or returns same subscription (guard against double-start)
  - [x] Mock `SimplePool` (subscribeMany, querySync), `NostrSpspClient`, and `ConnectorAdminClient`
  - [x] Use `vi.useFakeTimers()` for cooldown tests

## Dev Notes

### Previous Story Insights
[Source: docs/stories/6.3.story.md#dev-agent-record]

From Story 6.3 implementation:
- 826 tests passing (16 in bootstrap.test.ts), 0 failures
- `ConnectorAdminClient` interface was updated to match agent-runtime API: `addPeer(config: { id: string, url: string, authToken: string, routes?: { prefix: string, priority?: number }[] }): Promise<void>`
- `BootstrapResult` no longer includes `spspInfo` — field replaced by `registeredPeerId`
- SPSP handshake (`directSpspHandshake()`) was removed from bootstrap but `NostrSpspClient`/`NostrSpspServer` remain in `packages/core/src/spsp/` — this story reuses `NostrSpspClient` for dynamic peering
- Peer ID format is `"nostr-{pubkey.slice(0, 16)}"` (16-char hex prefix)
- Non-fatal error pattern: wrap in try/catch, `console.warn`, continue to next peer
- ESLint has 2 pre-existing lint issues in `bootstrap.ts` (lines 294, 514) — non-blocking
- ArDrive peers without `defaultRelayUrl` are silently skipped (minor observability gap)

### Data Models
[Source: packages/core/src/types.ts, packages/core/src/bootstrap.ts]

**`IlpPeerInfo`** (from `types.ts`):
```typescript
export interface IlpPeerInfo {
  ilpAddress: string;
  btpEndpoint: string;
  settlementEngine?: string;
  assetCode: string;
  assetScale: number;
}
```

**`SpspInfo`** (from `types.ts`):
```typescript
export interface SpspInfo {
  destinationAccount: string;
  sharedSecret: string;
}
```

**`Subscription`** (from `types.ts`):
```typescript
export interface Subscription {
  unsubscribe(): void;
}
```

**`ConnectorAdminClient`** (from `bootstrap.ts` — needs extension):
```typescript
export interface ConnectorAdminClient {
  addPeer(config: {
    id: string;
    url: string;
    authToken: string;
    routes?: { prefix: string; priority?: number }[];
  }): Promise<void>;
  // Story 6.4 adds:
  removePeer?(peerId: string): Promise<void>;
}
```
Note: `removePeer` is optional — not all callers will implement peer removal. This maps to `DELETE /admin/peers/:id` in the agent-runtime admin API.

### API Specifications
[Source: docs/architecture/6-external-apis.md#62-agent-runtime-admin-api, docs/epics/epic-6-decentralized-peer-discovery.md#story-64]

**Connector Admin API (agent-runtime project):**
- `POST /admin/peers` — Body: `{ id: string, url: string, authToken: string, routes?: [{ prefix: string, priority?: number }] }` — used for adding newly discovered peers
- `DELETE /admin/peers/:id` — Remove a peer by ID — used on unfollow when `removePeersOnUnfollow: true`

**SPSP Handshake (kind:23194 → 23195):**
[Source: docs/architecture/7-core-workflows.md#72-dynamic-spsp-handshake]
- `NostrSpspClient.requestSpspInfo(recipientPubkey, { timeout })` sends encrypted kind:23194 request and waits for kind:23195 response
- Returns `SpspInfo` with `destinationAccount` and `sharedSecret`
- Throws `SpspTimeoutError` if no response within timeout
- Requires `secretKey` in constructor for NIP-44 encryption

**NIP-02 Follow List (kind:3):**
[Source: docs/architecture/7-core-workflows.md#71-peer-discovery-flow]
- Kind:3 is a replaceable event — each pubkey has at most one current follow list
- Followed pubkeys are in `p` tags: `["p", "<hex-pubkey>"]`
- Use `pool.subscribeMany(relayUrls, [{ kinds: [3], authors: [pubkey] }], { onevent })` for real-time updates

### Component Architecture
[Source: docs/architecture/5-components.md#51-agent-societycore]

`SocialPeerDiscovery` fits within the discovery module alongside `NostrPeerDiscovery`:
- `NostrPeerDiscovery` — one-shot and subscription-based peer discovery from follow lists (queries kind:10032 only)
- `SocialPeerDiscovery` (new) — real-time follow list subscription with **active peering**: kind:10032 query + SPSP handshake + admin API registration

The key difference: `NostrPeerDiscovery` is passive (returns info, caller decides what to do), while `SocialPeerDiscovery` is active (automatically negotiates peering and registers with connector).

### Existing Code to Reuse
[Source: packages/core/src/discovery/NostrPeerDiscovery.ts, packages/core/src/spsp/NostrSpspClient.ts, packages/core/src/bootstrap.ts]

**`NostrSpspClient`** (from `packages/core/src/spsp/NostrSpspClient.ts`):
```typescript
constructor(relayUrls: string[], pool?: SimplePool, secretKey?: Uint8Array)
async requestSpspInfo(recipientPubkey: string, options?: { timeout?: number }): Promise<SpspInfo>
```
- Requires `secretKey` for sending encrypted requests
- Accepts optional `pool` (reuse the same pool instance)
- Timeout defaults to 10000ms

**`NostrPeerDiscovery`** (from `packages/core/src/discovery/NostrPeerDiscovery.ts`):
- `getFollows(pubkey)` — returns `string[]` of followed pubkeys (can reference for follow list parsing logic)
- `subscribeToPeerUpdates(pubkey, callback)` — returns `Subscription` (pattern to follow for `start()` method)
- The `onevent` handler pattern with `subscribeMany` and `SubCloser.close()` in unsubscribe is the established pattern

**Event parsers** (from `packages/core/src/events/index.ts`):
- `parseIlpPeerInfo(event)` — parses kind:10032 into `IlpPeerInfo`

**Constants** (from `packages/core/src/constants.ts`):
- `ILP_PEER_INFO_KIND = 10032`

**Imports needed in SocialPeerDiscovery.ts:**
```typescript
import { SimplePool } from 'nostr-tools/pool';
import { getPublicKey } from 'nostr-tools/pure';
import { PeerDiscoveryError } from '../errors.js';
import { parseIlpPeerInfo } from '../events/index.js';
import { ILP_PEER_INFO_KIND } from '../constants.js';
import { NostrSpspClient } from '../spsp/index.js';
import type { IlpPeerInfo, Subscription } from '../types.js';
import type { ConnectorAdminClient } from '../bootstrap.js';
```

### Error Handling Pattern
[Source: docs/architecture/11-error-handling-strategy.md, packages/core/src/bootstrap.ts]

- **Per-peer failures:** Non-fatal. Log `console.warn` and continue to next peer (AC: 6). This is the established pattern from `BootstrapService.bootstrap()`.
- **SPSP timeout:** `SpspTimeoutError` thrown by `NostrSpspClient.requestSpspInfo()` — catch and log, skip peer.
- **Admin API failures:** Non-fatal. Catch, log warning, continue.
- **Kind:10032 not found:** Non-fatal. Log info/warning, skip peer (they may not be ILP-enabled).
- **Subscription errors:** If `subscribeMany` fails, throw `PeerDiscoveryError` (fatal for the subscription itself).
- Use `console.log` for successful peering actions, `console.warn` for non-fatal failures.

### File Locations
[Source: docs/architecture/9-source-tree.md, docs/epics/epic-6-decentralized-peer-discovery.md]

Files to create:
- `packages/core/src/discovery/SocialPeerDiscovery.ts` — Main implementation
- `packages/core/src/discovery/SocialPeerDiscovery.test.ts` — Co-located tests

Files to modify:
- `packages/core/src/discovery/index.ts` — Add export for `SocialPeerDiscovery`
- `packages/core/src/index.ts` — Re-export `SocialPeerDiscovery` and `SocialPeerDiscoveryConfig`
- `packages/core/src/bootstrap.ts` — Add optional `removePeer` to `ConnectorAdminClient` interface

### Scope Boundaries

**In Scope (this story):**
- Create `SocialPeerDiscovery` class with kind:3 subscription, follow list diffing, SPSP handshake, admin API registration
- Add optional `removePeer` to `ConnectorAdminClient` for unfollow handling
- Cooldown mechanism between peer processing attempts
- Unit tests with mocked dependencies

**Out of Scope:**
- Docker entrypoint integration (Story 6.5)
- Credit limit adjustment from trust scores (Epic 3, out of scope per epic)
- Peer health monitoring
- Multi-hop routing discovery
- Actual HTTP implementation of `ConnectorAdminClient` (caller provides)

### Testing

**Test Framework:** Vitest 1.x
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Standards:**
- Co-located test file: `packages/core/src/discovery/SocialPeerDiscovery.test.ts`
- Follow AAA pattern (Arrange, Act, Assert)
- Mock `SimplePool` as a plain object with `vi.fn()` for `querySync` and `subscribeMany`
- Mock `NostrSpspClient` — either mock the module or pass a mock instance
- Mock `ConnectorAdminClient` as a plain object with `vi.fn()` methods for `addPeer` and `removePeer`
- Use `vi.useFakeTimers()` for testing cooldown behavior (advance timers with `vi.advanceTimersByTime`)
- Use `vi.spyOn(console, 'log')` and `vi.spyOn(console, 'warn')` to verify logging
- No live relay dependencies
- Use factory functions for test fixtures (valid Nostr events, `IlpPeerInfo` objects)
- Follow the established test patterns from `NostrPeerDiscovery.test.ts` — especially the `subscribeMany` mock pattern with captured `onevent` callback

**Mocking pattern for `subscribeMany` (from existing tests):**
```typescript
let capturedOnevent: ((event: VerifiedEvent) => void) | undefined;
vi.mocked(mockPool.subscribeMany).mockImplementation(
  (_relays, _filters, params) => {
    capturedOnevent = params?.onevent as (event: VerifiedEvent) => void;
    return mockSubCloser;
  }
);
```

**Coverage Goals:** >80% line coverage for public methods

**Existing test suite:** 826 tests should continue to pass with no regressions.

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/discovery/SocialPeerDiscovery.ts` | Created | Main SocialPeerDiscovery class implementation |
| `packages/core/src/discovery/SocialPeerDiscovery.test.ts` | Created | 14 unit tests for SocialPeerDiscovery |
| `packages/core/src/bootstrap.ts` | Modified | Added optional `removePeer` to ConnectorAdminClient interface |
| `packages/core/src/discovery/index.ts` | Modified | Added SocialPeerDiscovery and SocialPeerDiscoveryConfig exports |
| `packages/core/src/index.ts` | Modified | Added SocialPeerDiscovery and SocialPeerDiscoveryConfig re-exports |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes
- 840 tests passing (14 new in SocialPeerDiscovery.test.ts), 0 failures
- Constructor accepts optional `spspClient` parameter (5th param) for testability via dependency injection; falls back to creating NostrSpspClient internally when not provided
- ESLint: 0 lint errors in new/modified files; 2 pre-existing lint issues in bootstrap.ts (lines 302, 522) remain as noted in Story 6.3
- All acceptance criteria verified via unit tests

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is clean, well-structured, and follows established patterns from `NostrPeerDiscovery` and `BootstrapService`. The code demonstrates good separation of concerns, proper error isolation, and consistent use of project conventions (peer ID format, logging prefixes, non-fatal error handling). The constructor accepts an optional `spspClient` parameter for dependency injection, which is a sound testability decision. All 14 tests pass, and the full 840-test suite shows 0 regressions.

### Refactoring Performed

None required. The implementation is clean and consistent with existing codebase patterns.

### Compliance Check

- Coding Standards: ✓ No new lint errors; 2 pre-existing issues in bootstrap.ts (lines 302, 522) from prior stories
- Project Structure: ✓ Co-located tests, correct module exports, follows source tree conventions
- Testing Strategy: ✓ AAA pattern, mocked dependencies, fake timers for cooldown, console spy for logging verification
- All ACs Met: ✓ All 8 acceptance criteria verified (see trace below)

### AC Traceability

| AC | Description | Test Coverage |
|----|-------------|---------------|
| 1 | Create `SocialPeerDiscovery.ts` | File exists, exports verified in `discovery/index.ts` and `index.ts` |
| 2 | Subscribe to kind:3 events | `start() subscribes to kind:3 events for the node pubkey` |
| 3a | Query kind:10032 | `triggers kind:10032 query, SPSP handshake, and admin API registration` |
| 3b | SPSP handshake | Same test + `skips peer on SPSP handshake failure` |
| 3c | Register via admin API | Same test + `skips peer on admin API failure` |
| 3d | Log successful peering | Same test asserts `[SocialDiscovery] Peered with` log |
| 4a | Unfollow removes peer | `triggers removePeer() when removePeersOnUnfollow is true` |
| 4b | Log peer removal | Same test asserts `[SocialDiscovery] Removed peer` log |
| 5 | `start()` returns Subscription | `returns Subscription with working unsubscribe()` |
| 6 | Per-peer error isolation | `errors in one peer do not block processing of other peers` + `handles multiple peers where some fail and some succeed` |
| 7 | Configurable cooldown | `waits cooldownMs between peer processing attempts` |
| 8 | Unit tests | 14 tests covering all scenarios |

### Improvements Checklist

- [x] All acceptance criteria implemented and tested
- [x] Error handling follows non-fatal pattern per AC 6
- [x] Cooldown mechanism properly tested with fake timers
- [x] Double-start guard with restart-after-unsubscribe test
- [ ] Consider adding pubkey format validation in `handleNewFollow` (defensive, low priority)
- [ ] Consider adding a test for `processFollowListUpdate` error propagation from the `start()` `.catch()` handler
- [ ] The `_ownIlpInfo` constructor param is unused (reserved for future) — consider documenting this in JSDoc more explicitly or deferring the parameter to a future story

### Security Review

No security concerns. SPSP handshake uses NIP-44 encryption via `NostrSpspClient`. No user input is directly used in queries without the established parsing pipeline. The `authToken: ''` in `addPeer` is consistent with the bootstrap service pattern and expected by the admin API.

### Performance Considerations

No concerns. The cooldown mechanism prevents relay flooding. Per-peer sequential processing with configurable delay is appropriate for this use case. The `sleep()` helper is minimal and correct.

### Files Modified During Review

None.

### Gate Status

Gate: PASS -> docs/qa/gates/6.4-social-graph-peer-discovery.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria are met with comprehensive test coverage. The implementation follows established patterns, has proper error isolation, and introduces no regressions. The unchecked items above are minor suggestions for future improvement, not blockers.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-07 | 0.2 | Validation fixes: clarify SPSP as liveness check, explicit NostrSpspClient constructor args, remove unused Filter import | QA (Claude Opus 4.6) |
| 2026-02-07 | 1.0 | Implementation complete — all 9 tasks done, 14 tests passing, 0 regressions | Dev (Claude Opus 4.6) |
