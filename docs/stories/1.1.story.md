# Story 1.1: Project Setup and Build Infrastructure

## Status

Done

## Story

**As a** developer,
**I want** a properly configured TypeScript monorepo with build, test, and lint tooling,
**so that** I can develop, test, and publish the library packages.

## Acceptance Criteria

1. Monorepo structure created with `packages/core`, `packages/relay`, `packages/examples` directories
2. TypeScript configured with strict mode in root `tsconfig.json` with package-level extensions
3. Vitest configured for unit testing with coverage reporting
4. ESLint and Prettier configured for code quality
5. Package.json files configured for ESM output with proper exports
6. `pnpm run build` successfully compiles all packages
7. `pnpm run test` successfully runs (empty test suites pass)
8. `pnpm run lint` successfully validates code style

## Tasks / Subtasks

- [x] Task 1: Initialize monorepo structure (AC: 1)
  - [x] Create root `package.json` with pnpm workspaces configuration
  - [x] Create `pnpm-workspace.yaml` with packages glob
  - [x] Create `.gitignore` with `node_modules/`, `dist/`, `coverage/`, `.turbo/`
  - [x] Create `packages/core/` directory with `package.json` for `@crosstown/core`
  - [x] Create `packages/relay/` directory with `package.json` for `@crosstown/relay`
  - [x] Create `packages/examples/` directory with `package.json` for `@crosstown/examples`
  - [x] Add basic `src/index.ts` to each package as entry point

- [x] Task 2: Configure TypeScript (AC: 2)
  - [x] Create root `tsconfig.json` with strict mode, ESM target, and base settings
  - [x] Create `packages/core/tsconfig.json` extending root config
  - [x] Create `packages/relay/tsconfig.json` extending root config
  - [x] Create `packages/examples/tsconfig.json` extending root config
  - [x] Ensure `moduleResolution: "bundler"` and `module: "ESNext"` settings

- [x] Task 3: Configure Vitest for testing (AC: 3)
  - [x] Install vitest as dev dependency in root
  - [x] Create root `vitest.config.ts` with workspace configuration
  - [x] Configure coverage reporting (v8 or istanbul provider)
  - [x] Add `test` script to root `package.json`
  - [x] Create placeholder test file in `packages/core/src/` to verify test runner works

- [x] Task 4: Configure ESLint and Prettier (AC: 4)
  - [x] Install eslint (9.x), @typescript-eslint/parser, @typescript-eslint/eslint-plugin
  - [x] Install prettier and eslint-config-prettier
  - [x] Create `eslint.config.js` (flat config format, native in ESLint 9.x)
  - [x] Create `prettier.config.js` with project formatting rules
  - [x] Add `lint` and `format` scripts to root `package.json`

- [x] Task 5: Configure package builds with tsup (AC: 5, 6)
  - [x] Install tsup as dev dependency
  - [x] Create `packages/core/tsup.config.ts` for ESM output
  - [x] Create `packages/relay/tsup.config.ts` for ESM output
  - [x] Configure `package.json` exports field for each package
  - [x] Add `build` script to root and each package
  - [x] Ensure builds produce `.d.ts` type declarations

- [x] Task 6: Verify all tooling works (AC: 6, 7, 8)
  - [x] Run `pnpm install` to install all dependencies
  - [x] Run `pnpm build` to verify compilation succeeds
  - [x] Run `pnpm test` to verify test runner works
  - [x] Run `pnpm lint` to verify linting works

## Dev Notes

### Project Structure
[Source: architecture/9-source-tree.md]

```
crosstown/
├── packages/
│   ├── core/                           # @crosstown/core
│   │   ├── src/
│   │   │   └── index.ts               # Package exports
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   ├── relay/                          # @crosstown/relay
│   │   ├── src/
│   │   │   └── index.ts
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   └── examples/                       # @crosstown/examples
│       ├── src/
│       ├── package.json
│       └── tsconfig.json
│
├── package.json                        # Root package.json (workspaces)
├── pnpm-workspace.yaml                # pnpm workspace config
├── tsconfig.json                      # Root TypeScript config
├── vitest.config.ts                   # Vitest configuration
├── eslint.config.js                   # ESLint configuration
├── prettier.config.js                 # Prettier configuration
└── README.md                          # Project README
```

### Technology Stack Requirements
[Source: architecture/3-tech-stack.md#32-technology-stack-table]

| Category | Technology | Version | Purpose |
|----------|------------|---------|---------|
| Language | TypeScript | 5.3.x | Primary development language |
| Runtime | Node.js | 20.x LTS | Primary runtime |
| Build Tool | tsup | 8.x | Library bundling (ESM/CJS dual output) |
| Package Manager | pnpm | 8.x | Monorepo management |
| Test Framework | Vitest | 1.x | Unit testing |
| Linting | ESLint | 9.x | Code quality (flat config native) |
| Formatting | Prettier | 3.x | Code formatting |

### Coding Standards
[Source: architecture/12-coding-standards.md]

- **TypeScript Strict Mode:** Required (`strict: true` in tsconfig)
- **File Naming:** kebab-case (e.g., `peer-discovery.ts`)
- **Classes:** PascalCase (e.g., `NostrPeerDiscovery`)
- **Functions:** camelCase (e.g., `discoverPeers`)
- **Constants:** UPPER_SNAKE_CASE (e.g., `ILP_PEER_INFO_KIND`)
- **Critical Rule:** Never use `any` - use `unknown` and type guards
- **Exports:** All public APIs exported from package `index.ts`

### Package.json Configuration Notes
[Source: architecture/3-tech-stack.md, PRD Section 3.1]

Each package must be configured for ESM output:
- `"type": "module"` in package.json
- `"exports"` field pointing to built output
- `"main"` and `"module"` fields for compatibility
- `"types"` field pointing to `.d.ts` declarations

Root package.json needs:
- `"private": true` (not published)
- `"workspaces"` or pnpm workspace configuration
- `"engines": { "node": ">=20", "pnpm": ">=8" }` for version enforcement
- Scripts: `build`, `test`, `lint`, `format`

### Greenfield Setup
[Source: architecture/1-introduction.md#11-starter-template-or-existing-project]

This is a greenfield project with no starter template. Manual setup provides complete control over tooling.

### Testing

[Source: architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x

**File Convention:** `*.test.ts` co-located with source files (same directory)

**Coverage Requirement:** >80% for public APIs (not applicable for this story, but configure reporter)

**Test Organization:**
- Unit tests in same directory as source: `packages/*/src/*.test.ts`
- Integration tests (not in CI): `packages/*/src/__integration__/`

**CI Integration:** GitHub Actions runs `pnpm test` on all PRs

For this story: Create at least one placeholder test to verify the test runner is properly configured and `pnpm test` exits successfully.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story draft | SM |
| 2026-02-05 | 0.2 | Validation fixes: pnpm terminology, ESLint 9.x, .gitignore task, engines field | SM |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no issues encountered during implementation.

### Completion Notes List

- Converted existing single-package structure to pnpm monorepo
- Removed old `src/` directory (contained prototype code to be replaced in future stories)
- Removed `package-lock.json` (npm) in favor of `pnpm-lock.yaml`
- Used ESLint 9.x flat config with typescript-eslint
- Configured v8 coverage provider for Vitest
- All packages use workspace protocol (`workspace:*`) for internal dependencies

### File List

**Created:**
- `pnpm-workspace.yaml` - pnpm workspace configuration
- `packages/core/package.json` - @crosstown/core package
- `packages/core/src/index.ts` - core entry point
- `packages/core/src/index.test.ts` - placeholder test
- `packages/core/tsconfig.json` - TypeScript config
- `packages/core/tsup.config.ts` - build config
- `packages/relay/package.json` - @crosstown/relay package
- `packages/relay/src/index.ts` - relay entry point
- `packages/relay/tsconfig.json` - TypeScript config
- `packages/relay/tsup.config.ts` - build config
- `packages/examples/package.json` - @crosstown/examples package
- `packages/examples/src/index.ts` - examples entry point
- `packages/examples/tsconfig.json` - TypeScript config
- `packages/examples/tsup.config.ts` - build config
- `vitest.config.ts` - Vitest configuration
- `eslint.config.js` - ESLint flat config
- `prettier.config.js` - Prettier configuration
- `pnpm-lock.yaml` - lockfile (auto-generated)

**Modified:**
- `package.json` - converted to monorepo root
- `tsconfig.json` - updated for monorepo with bundler resolution
- `.gitignore` - added `.turbo/` and `pnpm-debug.log*`

**Deleted:**
- `src/` directory (old single-package structure)
- `dist/` directory (old build output)
- `package-lock.json` (npm lockfile)
- `node_modules/` (regenerated with pnpm)

---

## QA Results

### Review Date: 2026-02-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of the monorepo infrastructure. The setup follows all architecture guidelines and coding standards. The implementation is clean, minimal, and focused on the specific requirements without over-engineering.

**Highlights:**
- TypeScript configuration is exemplary with strict mode and additional safety flags (`noUncheckedIndexedAccess`, `noImplicitOverride`, `noPropertyAccessFromIndexSignature`)
- ESLint flat config correctly uses `typescript-eslint` with strict and stylistic presets
- Vitest configuration properly excludes integration tests from CI runs
- All packages use workspace protocol for internal dependencies
- Clean separation between root and package-level configurations

### Refactoring Performed

No refactoring needed - implementation is already well-structured.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, ESLint configured, file naming follows kebab-case
- Project Structure: ✓ Matches architecture/9-source-tree.md (packages/core, packages/relay, packages/examples)
- Testing Strategy: ✓ Vitest configured per architecture/13-test-strategy-and-standards.md, placeholder test present
- All ACs Met: ✓ All 8 acceptance criteria verified

### Improvements Checklist

All items handled - no outstanding issues:

- [x] Monorepo structure created correctly
- [x] TypeScript strict mode enabled with additional safety checks
- [x] Vitest with v8 coverage configured
- [x] ESLint 9.x flat config with typescript-eslint
- [x] Prettier configured with consistent formatting rules
- [x] All packages have ESM exports and type declarations
- [x] Build, test, and lint scripts verified working

### Security Review

No security concerns - this is infrastructure setup with no runtime code. The `engines` field properly enforces Node.js >=20 and pnpm >=8.

### Performance Considerations

No performance concerns - build times are fast (sub-second for each package).

### Files Modified During Review

None - no modifications needed.

### Gate Status

Gate: PASS → docs/qa/gates/1.1-project-setup-and-build-infrastructure.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria are met, tooling is verified working, and the implementation follows all project standards.
