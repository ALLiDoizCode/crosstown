# Story 8.8: Fix Peer Registration Circular Dependency

## Status

Done

## Story

**As a** peer node opening payment channels during bootstrap,
**I want** the `POST /admin/channels` endpoint to accept `peerAddress` directly in the request body,
**so that** channel opening doesn't fail due to a circular dependency where settlement info is needed before it's available.

## Acceptance Criteria

1. `OpenChannelParams` passed from BLS include `peerAddress` from the SPSP request's `settlementAddresses[negotiatedChain]`
2. Agent-runtime's `POST /admin/channels` endpoint updated to accept and use `peerAddress` from request body (agent-runtime change — document requirements)
3. `POST /admin/peers` registration made idempotent: second call updates existing peer instead of returning 409 Conflict (agent-runtime change — document requirements)
4. Agent-society side of bootstrap flow correctly passes `peerAddress` through the full chain: SPSP request → `negotiateAndOpenChannel()` → `channelClient.openChannel({ peerAddress })` — verified by test
5. Agent-society side passes `peerAddress` through `ConnectorChannelClient.openChannel()` — already in the interface (Story 7.3)
6. Integration notes document the required agent-runtime changes with specific endpoint and parameter details

## Tasks / Subtasks

- [x] Task 1: Verify `OpenChannelParams` includes `peerAddress` (AC: 1, 5)
  - [x] In `packages/core/src/types.ts`:
    - Confirm `OpenChannelParams` already has `peerAddress: string` field (added in Story 7.3)
    - Confirm `ConnectorChannelClient.openChannel(params)` passes `peerAddress` through
  - [x] In `NostrSpspServer.negotiateSettlement()`:
    - Confirm `peerAddress` is extracted from `request.settlementAddresses[negotiatedChain]`
    - Confirm it's passed to `channelClient.openChannel({ ..., peerAddress })`

- [x] Task 2: Verify `createChannelClient` HTTP implementation includes `peerAddress` in POST body (AC: 1)
  - [x] In `docker/src/entrypoint.ts` (from Story 7.5):
    - Confirm `openChannel()` sends `peerAddress` in the JSON body to `POST /admin/channels`
    - If Story 7.5 is not yet implemented, document that it must include `peerAddress`

- [x] Task 3: Document agent-runtime changes required (AC: 2, 3, 6)
  - [x] Create integration requirements document section in Dev Notes:

    **Agent-runtime `POST /admin/channels` changes:**
    - Add `peerAddress?: string` to `OpenChannelRequest` interface
    - When `body.peerAddress` is provided, use it directly instead of looking up from `settlementPeers` map
    - Keep `settlementPeers` lookup as fallback for backward compatibility
    - File: `packages/agent-runtime/src/http/admin-api.ts` (lines 751-865)

    **Agent-runtime `POST /admin/peers` idempotency:**
    - Change from 409 Conflict on duplicate to upsert behavior
    - If peer with same `id` already exists, update its config instead of rejecting
    - Or add `PUT /admin/peers/:peerId` endpoint for updates
    - File: `packages/agent-runtime/src/http/admin-api.ts` (lines 334-340)

- [x] Task 4: Add test verifying peerAddress flows through the full chain (AC: 4)
  - [x] In `packages/core/src/spsp/NostrSpspServer.test.ts` (or `negotiateAndOpenChannel.test.ts` if Story 7.6 is done):
    - Test: when SPSP request has `settlementAddresses: { "evm:base:8453": "0xPEER_ADDR" }` and negotiated chain is `evm:base:8453`, `channelClient.openChannel()` is called with `peerAddress: "0xPEER_ADDR"`
    - This test may already exist from Story 7.3 — verify and add if missing

- [x] Task 5: Run full test suite
  - [x] Run `pnpm test` — verify no regressions
  - [x] Run `pnpm lint` — no new lint errors

## Dev Notes

### Integration Gaps Addressed
[Source: INTEGRATION-GAPS.md]

**Gap 5: Circular Dependency in Peer Registration (DESIGN ISSUE)**

The bootstrap flow has a circular dependency:
1. Phase 1: Query relay for peer's kind:10032 → get ILP address and BTP endpoint
2. Phase 2: Register peer via `POST /admin/peers` (no settlement info yet)
3. Phase 3: Send SPSP request to peer via ILP
4. Peer's BLS wants to open channel via `POST /admin/channels`
5. Connector's `POST /admin/channels` handler looks up `settlementPeers.get(peerId).xrpAddress` (or `evmAddress`)
6. **But `settlementPeers` doesn't have that info yet** — it gets populated AFTER SPSP completes

**Current Workaround (Broken):**
`NostrSpspServer.negotiateSettlement()` passes `peerAddress` in the `openChannel()` request, expecting the connector to accept it. But the connector endpoint doesn't have a `peerAddress` parameter — it only looks up from `settlementPeers`.

**Fix:** The connector's `POST /admin/channels` must accept `peerAddress` in the request body.

**Gap 11: `POST /admin/peers` Called Twice for Same Peer (INEFFICIENT)**

1. Phase 1: `addPeerToConnector()` calls `POST /admin/peers` with routing only
2. Phase 2: SPSP handshake completes
3. Phase 2: `addPeerToConnector()` called AGAIN with settlement config

`POST /admin/peers` returns 409 Conflict on second call. Fix: make it idempotent (upsert).

### Agent-Society Side Already Correct

The agent-society codebase already:
- Includes `peerAddress` in `OpenChannelParams` interface (Story 7.3)
- Extracts `peerAddress` from `request.settlementAddresses[negotiatedChain]` in `NostrSpspServer.negotiateSettlement()`
- Passes it through `channelClient.openChannel({ ..., peerAddress })`
- Gracefully degrades if `peerAddress` is missing (returns basic SPSP response)

The remaining fix is on the **agent-runtime side**: accepting `peerAddress` in `POST /admin/channels` and making `POST /admin/peers` idempotent.

### Agent-Runtime Changes Required

**File: `packages/agent-runtime/src/http/admin-api.ts`**

> **Note:** Line numbers below are approximate references from INTEGRATION-GAPS.md and may drift as the agent-runtime repo evolves. Use the endpoint handler names to locate the code.

**Change 1: `POST /admin/channels` — Accept `peerAddress` (~lines 751-865):**
```typescript
// Current: looks up peerAddress from settlementPeers map
const peer = settlementPeers.get(peerId);
const peerAddress = peer?.evmAddress || peer?.xrpAddress;

// After: accept peerAddress from request body, fall back to map
const peerAddress = body.peerAddress || settlementPeers.get(peerId)?.evmAddress;
```

**Change 2: `POST /admin/peers` — Idempotent upsert (~lines 334-340):**
```typescript
// Current: returns 409 on duplicate
if (existingPeer) return c.json({ error: 'Peer already exists' }, 409);

// After: upsert behavior
if (existingPeer) {
  // Update existing peer config
  Object.assign(existingPeer, newConfig);
  return c.json({ id: peerId, updated: true });
}
```

### Cross-Repo Coordination

The agent-runtime changes should be tracked as a corresponding story in the agent-runtime repo. Recommended workflow:
1. Complete this story (verification + documentation) in agent-society
2. Create a story in agent-runtime referencing this story's integration notes
3. Implement agent-runtime changes (accept `peerAddress`, idempotent peers)
4. Verify end-to-end with a multi-peer deployment

### File Locations

Files to verify (agent-society, this repo):
- `packages/core/src/types.ts` — `OpenChannelParams.peerAddress` exists
- `packages/core/src/spsp/NostrSpspServer.ts` — `peerAddress` extraction and passing

Files requiring changes (agent-runtime, external repo):
- `packages/agent-runtime/src/http/admin-api.ts` — `POST /admin/channels` and `POST /admin/peers`

Files NOT modified in this repo:
- This is primarily a verification and documentation story for agent-society
- The actual code changes are in agent-runtime

### Technical Constraints

**Cross-repo dependency:** This story identifies changes needed in agent-runtime. The agent-society side is already correctly implemented. The agent-runtime changes should be tracked as a separate story/task in that repo.

**Backward compatibility:** The `peerAddress` parameter in `POST /admin/channels` should be optional — existing callers that don't provide it continue to work via `settlementPeers` lookup.

### Testing

**Framework & Standards** [Source: docs/architecture/13-test-strategy-and-standards.md]
- **Framework:** Vitest 1.x
- **File convention:** `*.test.ts` co-located with source file
- **Mocking:** Vitest built-in mocking (`vi.fn()`) — SimplePool always mocked, never live relays
- **Pattern:** AAA (Arrange, Act, Assert)
- **Coverage:** >80% for public APIs

**Scope for this story:**

Minimal new tests needed on the agent-society side — the `peerAddress` flow is already tested in Story 7.3's `NostrSpspServer` tests. This story primarily verifies existing implementation and documents agent-runtime requirements.

Existing test coverage to verify:
- `packages/core/src/spsp/NostrSpspServer.test.ts` — `openChannel is called with correct params` (verifies `peerAddress: '0xPEER_ADDRESS'`)
- `packages/core/src/spsp/negotiateAndOpenChannel.test.ts` — `returns SettlementNegotiationResult when chains match` (verifies `peerAddress: '0xPEER_ADDR'`)
- `packages/core/src/spsp/NostrSpspServer.test.ts` — `missing peerAddress for negotiated chain: returns basic SPSP response`

**Expected new test count:** 0-2 (verification only — add if existing coverage has gaps)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
No source files modified — this is a verification and documentation story. All agent-society code was already correct.

Files verified (no changes):
- `packages/core/src/types.ts` — `OpenChannelParams.peerAddress` confirmed at line 149
- `packages/core/src/spsp/NostrSpspServer.ts` — delegates to `negotiateAndOpenChannel()` which handles peerAddress extraction
- `packages/core/src/spsp/negotiateAndOpenChannel.ts` — extracts `peerAddress` from `request.settlementAddresses[negotiatedChain]` (line 60), passes to `channelClient.openChannel()` (line 82)
- `docker/src/entrypoint.ts` — `createChannelClient().openChannel()` sends full params including `peerAddress` via `JSON.stringify(params)` (line 307)

Files modified:
- `docs/stories/8.8.story.md` — Task checkboxes, Dev Agent Record, status update

### Debug Log References
No issues encountered. All existing implementations were correct as documented.

### Completion Notes
- This story is a **verification and documentation** story. No source code changes were needed in agent-society.
- All `peerAddress` flow was already correctly implemented in prior stories (7.3, 7.5, 7.6).
- Existing test coverage fully covers the `peerAddress` flow:
  - `negotiateAndOpenChannel.test.ts` — verifies `openChannel()` called with `peerAddress: '0xPEER_ADDR'`
  - `NostrSpspServer.test.ts` — verifies `peerAddress: '0xPEER_ADDRESS'` in openChannel call
  - `NostrSpspServer.test.ts` — verifies graceful degradation when `peerAddress` missing
- **Agent-runtime changes still required** (documented in Dev Notes): `POST /admin/channels` must accept `peerAddress`, `POST /admin/peers` must be idempotent
- Pre-existing lint error in `packages/bls/src/storage/createEventStore.test.ts:67` (empty arrow function) — unrelated to this story
- All 1022 tests pass, no regressions

### DoD Checklist

1. **Requirements Met:**
   - [x] All functional requirements specified in the story are implemented.
   - [x] All acceptance criteria defined in the story are met.
     - AC1: `OpenChannelParams` includes `peerAddress` ✅
     - AC2: Agent-runtime changes documented ✅
     - AC3: Idempotent peers documented ✅
     - AC4: `peerAddress` flow verified by existing tests ✅
     - AC5: `ConnectorChannelClient.openChannel()` passes `peerAddress` ✅
     - AC6: Integration notes with endpoint/parameter details ✅

2. **Coding Standards & Project Structure:**
   - [N/A] No new/modified code — verification story only
   - [N/A] No new files created
   - [N/A] No tech changes
   - [N/A] No API or data model changes
   - [N/A] No new code to review for security
   - [x] No new linter errors introduced
   - [N/A] No new code to comment

3. **Testing:**
   - [x] Existing tests verified to cover peerAddress flow (3 tests across 2 files)
   - [N/A] No integration tests needed — verification story
   - [x] All 1022 tests pass
   - [x] Coverage verified for peerAddress flow

4. **Functionality & Verification:**
   - [x] Code paths verified by reading source and confirming test assertions
   - [x] Edge cases handled (missing peerAddress → graceful degradation)

5. **Story Administration:**
   - [x] All tasks marked complete
   - [x] Verification findings documented in Dev Agent Record
   - [x] Story wrap-up complete

6. **Dependencies, Build & Configuration:**
   - [x] All tests pass (pnpm test: 1022 pass)
   - [x] Linting passes (no new errors)
   - [N/A] No new dependencies
   - [N/A] No new env vars

7. **Documentation:**
   - [N/A] No new public APIs
   - [N/A] No user-facing changes
   - [x] Agent-runtime integration requirements documented in Dev Notes

- [x] I, the Developer Agent, confirm that all applicable items above have been addressed.

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

This is a verification and documentation story — no source code was modified in agent-society. The review confirms that the existing implementation correctly handles the `peerAddress` flow end-to-end. Code quality of the verified files is solid: clean separation of concerns between `negotiateAndOpenChannel()` (shared logic), `NostrSpspServer` (Nostr path), and `createChannelClient()` (HTTP transport). Graceful degradation patterns are well-implemented with clear null returns for missing chains/addresses.

### Refactoring Performed

None — no source code modifications needed. All verified code is well-structured.

### Compliance Check

- Coding Standards: ✓ All verified files follow TypeScript strict mode, naming conventions, and project patterns
- Project Structure: ✓ Co-located test files, proper module exports via index.ts
- Testing Strategy: ✓ Vitest with AAA pattern, mocked SimplePool, >80% coverage for peerAddress flow
- All ACs Met: ✓ All 6 acceptance criteria verified (see traceability below)

### Requirements Traceability

**AC1**: `OpenChannelParams` includes `peerAddress` from SPSP request's `settlementAddresses[negotiatedChain]`
- **Given** an SPSP request with `settlementAddresses: { "evm:base:8453": "0xPEER_ADDR" }` and negotiated chain `evm:base:8453`
- **When** `negotiateAndOpenChannel()` processes the request
- **Then** `channelClient.openChannel()` is called with `peerAddress: "0xPEER_ADDR"`
- **Tests**: `negotiateAndOpenChannel.test.ts:56-64`, `NostrSpspServer.test.ts:783-791`

**AC2**: Agent-runtime `POST /admin/channels` endpoint changes documented
- **Given** the circular dependency documented in Dev Notes
- **When** reviewing the story's "Agent-Runtime Changes Required" section
- **Then** specific code changes are documented with file paths, current behavior, and proposed fix
- **Verified**: Dev Notes lines 99-126

**AC3**: `POST /admin/peers` idempotent upsert documented
- **Given** the duplicate peer registration issue (Gap 11)
- **When** reviewing the documentation
- **Then** upsert behavior is documented with code examples
- **Verified**: Dev Notes lines 115-126

**AC4**: Agent-society side passes `peerAddress` through full chain — verified by test
- **Given** the SPSP request → negotiateAndOpenChannel → channelClient.openChannel chain
- **When** tracing the flow through source code
- **Then** `peerAddress` is extracted at `negotiateAndOpenChannel.ts:60` and passed at line 82
- **Tests**: `negotiateAndOpenChannel.test.ts:56-64` (direct), `NostrSpspServer.test.ts:757-791` (integration through server)

**AC5**: `ConnectorChannelClient.openChannel()` interface includes `peerAddress`
- **Given** the `OpenChannelParams` interface in `types.ts`
- **When** checking the interface definition
- **Then** `peerAddress: string` is present at `types.ts:149`
- **Verified**: Source code inspection

**AC6**: Integration notes with specific endpoint and parameter details
- **Given** the cross-repo coordination requirements
- **When** reviewing Dev Notes
- **Then** specific file paths, line numbers, and code change examples are provided for both `POST /admin/channels` and `POST /admin/peers`
- **Verified**: Dev Notes lines 99-135

### Improvements Checklist

- [x] All acceptance criteria verified with source code inspection
- [x] Existing test coverage confirmed adequate (3 specific tests cover peerAddress flow)
- [x] Cross-repo coordination workflow documented
- [ ] Consider adding a test for `createChannelClient().openChannel()` in `docker/src/entrypoint.test.ts` to verify `peerAddress` is included in the JSON body sent to `POST /admin/channels` (low priority — transport-level test)

### Security Review

No security concerns. This story documents changes to an admin API (`POST /admin/channels`, `POST /admin/peers`) that are internal-only endpoints. The `peerAddress` field flows through NIP-44 encrypted SPSP messages and is validated before use. No new attack surfaces introduced.

### Performance Considerations

No performance impact. This is a verification/documentation story with zero source code changes.

### Files Modified During Review

None — no refactoring was needed.

### Gate Status

Gate: PASS → docs/qa/gates/8.8-fix-peer-registration-circular-dependency.yml
Risk profile: N/A (low-risk verification story)
NFR assessment: N/A (no code changes)

### Recommended Status

✓ Ready for Done — All 6 ACs met, all 1022 tests pass, comprehensive documentation of cross-repo requirements.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft from INTEGRATION-GAPS.md (Gaps 5, 11) | PO (Claude Opus 4.6) |
| 2026-02-09 | 0.2 | Validation fixes: clarify AC4 scope, add testing standards, note approximate line refs, add cross-repo coordination | QA (Claude Opus 4.6) |
| 2026-02-09 | 1.0 | Story complete: all verifications pass, existing tests cover peerAddress flow, agent-runtime changes documented | Dev (Claude Opus 4.6) |
