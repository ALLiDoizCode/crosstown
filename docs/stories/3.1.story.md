# Story 3.1: Social Distance Calculation

## Status

Done

## Story

**As an** agent developer,
**I want** to calculate social distance between two pubkeys,
**so that** I can use proximity in the social graph as a trust signal.

## Acceptance Criteria

1. `SocialTrustManager` class created with constructor accepting relay URLs and optional SimplePool
2. `getSocialDistance(fromPubkey: string, toPubkey: string): Promise<number>` method implemented
3. Returns 1 for direct follows, 2 for follows-of-follows, etc.
4. Returns `Infinity` if no path found within configurable max depth (default 3)
5. Uses BFS algorithm for shortest path discovery
6. Unit tests verify distance calculation for various graph topologies

## Tasks / Subtasks

- [x] Task 1: Create SocialTrustManager class structure (AC: 1)
  - [x] Create `packages/core/src/trust/` directory
  - [x] Create `packages/core/src/trust/SocialTrustManager.ts` with class skeleton
  - [x] Add constructor accepting `relayUrls: string[]` and `pool?: SimplePool`
  - [x] Store `relayUrls` and `pool` as private readonly properties
  - [x] Create default `SimplePool` if not provided (same pattern as `NostrPeerDiscovery`)
  - [x] Create `packages/core/src/trust/index.ts` with exports

- [x] Task 2: Add TrustCalculationError to errors module (AC: 2, 4)
  - [x] Add `TrustCalculationError` class to `packages/core/src/errors.ts`
  - [x] Use error code `TRUST_CALCULATION_FAILED`
  - [x] Export from `packages/core/src/index.ts`

- [x] Task 3: Add pubkey validation helper (AC: 2)
  - [x] Reuse the pubkey validation pattern from `NostrPeerDiscovery`
  - [x] Validate pubkeys are 64-character lowercase hex strings
  - [x] Throw `TrustCalculationError` for invalid pubkeys

- [x] Task 4: Implement getFollowsForPubkey internal method (AC: 2, 5)
  - [x] Create private method `getFollowsForPubkey(pubkey: string): Promise<string[]>`
  - [x] Query kind:3 events from relays using same pattern as `NostrPeerDiscovery.getFollows()`
  - [x] Return array of followed pubkeys from the most recent event
  - [x] Handle relay failures gracefully (return empty array on failure)

- [x] Task 5: Implement BFS algorithm for getSocialDistance (AC: 2, 3, 4, 5)
  - [x] Method signature: `getSocialDistance(fromPubkey: string, toPubkey: string, maxDepth?: number): Promise<number>`
  - [x] Default `maxDepth` to 3
  - [x] Validate both pubkeys
  - [x] Return 0 if `fromPubkey === toPubkey` (same identity)
  - [x] Use BFS (Breadth-First Search) with queue of `{ pubkey, depth }` objects
  - [x] Track visited pubkeys in a `Set<string>` to avoid cycles
  - [x] At each level, call `getFollowsForPubkey()` and check if `toPubkey` is found
  - [x] If found, return current depth (1 = direct follow, 2 = follow-of-follow, etc.)
  - [x] If queue exhausted or maxDepth reached, return `Infinity`

- [x] Task 6: Implement optimizations for BFS (AC: 5)
  - [x] Batch follow queries at each BFS level where possible
  - [x] Early termination when target found
  - [x] Skip already-visited pubkeys before querying
  - [x] Consider using `Promise.allSettled()` for parallel follow queries within a level

- [x] Task 7: Export from package index (AC: 1)
  - [x] Add `export { SocialTrustManager } from './trust/index.js';` to `packages/core/src/index.ts`
  - [x] Export `TrustCalculationError` if not already done

- [x] Task 8: Write unit tests for constructor (AC: 1, 6)
  - [x] Create `packages/core/src/trust/SocialTrustManager.test.ts`
  - [x] Test constructor accepts relay URLs and stores them
  - [x] Test constructor creates SimplePool if not provided
  - [x] Test constructor uses provided SimplePool if passed

- [x] Task 9: Write unit tests for distance=0 (same pubkey) (AC: 6)
  - [x] Test `getSocialDistance(pubkey, pubkey)` returns 0
  - [x] No relay queries should be made

- [x] Task 10: Write unit tests for distance=1 (direct follow) (AC: 3, 6)
  - [x] Mock `pool.querySync` to return kind:3 event with target in 'p' tags
  - [x] Test returns 1 when fromPubkey directly follows toPubkey

- [x] Task 11: Write unit tests for distance=2 (follow-of-follow) (AC: 3, 6)
  - [x] Mock follow chain: A follows B, B follows C
  - [x] Test `getSocialDistance(A, C)` returns 2

- [x] Task 12: Write unit tests for distance=3 (AC: 3, 6)
  - [x] Mock follow chain: A follows B, B follows C, C follows D
  - [x] Test `getSocialDistance(A, D)` returns 3

- [x] Task 13: Write unit tests for Infinity (no path) (AC: 4, 6)
  - [x] Mock graph where no path exists within maxDepth
  - [x] Test returns `Infinity`

- [x] Task 14: Write unit tests for custom maxDepth (AC: 4, 6)
  - [x] Test `maxDepth: 1` only checks direct follows
  - [x] Test `maxDepth: 2` checks up to 2 hops
  - [x] Test returns `Infinity` when path exists but beyond maxDepth

- [x] Task 15: Write unit tests for cycle handling (AC: 5, 6)
  - [x] Mock circular follow graph (A follows B, B follows A)
  - [x] Verify no infinite loop
  - [x] Verify correct distance returned

- [x] Task 16: Write unit tests for invalid pubkey handling (AC: 6)
  - [x] Test throws `TrustCalculationError` for invalid fromPubkey
  - [x] Test throws `TrustCalculationError` for invalid toPubkey

- [x] Task 17: Write unit tests for empty follow lists (AC: 6)
  - [x] Test handles pubkey with no follows (returns Infinity)
  - [x] Test handles relay returning no events

## Dev Notes

### Previous Story Insights
[Source: docs/stories/2.4.story.md#dev-agent-record]

From Epic 2 stories:
- Package uses ESM (`"type": "module"`) - use `.js` extension in imports
- TypeScript strict mode is enabled
- 220 tests currently pass in core package
- Test helpers cast through `unknown` for `VerifiedEvent` type: `as unknown as VerifiedEvent`
- `pool.querySync()` is the synchronous query method for fetching events
- Subscription filter uses `'#p': [pubkey]` for tagged event filtering (not needed for this story)
- `pool.querySync(relayUrls, filter)` is called with URLs and filter directly

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create for this story:
```
packages/core/src/
├── trust/
│   ├── index.ts                        # Module exports (create)
│   ├── SocialTrustManager.ts           # Main class (create)
│   └── SocialTrustManager.test.ts      # Unit tests (create)
├── errors.ts                           # Add TrustCalculationError (modify)
└── index.ts                            # Add exports (modify)
```

### Data Models
[Source: docs/architecture/4-data-models.md#45-trustscore]

**TrustScore** (to be implemented in Story 3.3):
```typescript
interface TrustScore {
  score: number;           // 0-1 overall trust score
  socialDistance: number;  // Hops in follow graph (THIS STORY)
  mutualFollowerCount: number;
  breakdown: object;
}
```

For Story 3.1, we only implement `socialDistance` calculation. The full `TrustScore` type will be added in Story 3.3.

### NIP-02 Follow List Structure
[Source: docs/prd.md, nostr-tools documentation]

Kind:3 event structure for follow lists:
```typescript
{
  kind: 3,
  content: "",  // Usually empty or contains relay hints
  tags: [
    ["p", "pubkey1", "relay_url_hint", "petname"],  // Followed pubkey
    ["p", "pubkey2", "relay_url_hint", "petname"],
    // ...
  ],
  pubkey: "author_pubkey",
  created_at: timestamp,
}
```

The `p` tags contain followed pubkeys. Extract them using:
```typescript
const follows = event.tags
  .filter((tag): tag is [string, string, ...string[]] => tag[0] === 'p' && typeof tag[1] === 'string')
  .map((tag) => tag[1]);
```

### Existing Pattern: NostrPeerDiscovery.getFollows()
[Source: packages/core/src/discovery/NostrPeerDiscovery.ts:43-86]

The existing `getFollows()` method provides the exact pattern needed:
```typescript
async getFollows(pubkey: string): Promise<string[]> {
  // 1. Validate pubkey format (64-char lowercase hex)
  if (!PUBKEY_REGEX.test(pubkey)) {
    throw new PeerDiscoveryError(`Invalid pubkey format...`);
  }

  // 2. Query kind:3 events
  const filter: Filter = {
    kinds: [3],
    authors: [pubkey],
    limit: 1,
  };

  const events = await this.pool.querySync(this.relayUrls, filter);

  // 3. Get most recent event, extract 'p' tags
  const sortedEvents = events.sort((a, b) => b.created_at - a.created_at);
  const mostRecent = sortedEvents[0];
  if (!mostRecent) return [];

  // 4. Extract and deduplicate pubkeys
  const pubkeys = mostRecent.tags
    .filter((tag): tag is [string, string, ...string[]] => tag[0] === 'p' && typeof tag[1] === 'string')
    .map((tag) => tag[1]);

  return [...new Set(pubkeys)];
}
```

### BFS Algorithm Design
[Source: Algorithmic requirement from AC: 5]

BFS (Breadth-First Search) for shortest path in social graph:

```typescript
async getSocialDistance(fromPubkey: string, toPubkey: string, maxDepth = 3): Promise<number> {
  // Edge case: same pubkey
  if (fromPubkey === toPubkey) return 0;

  // BFS setup
  const visited = new Set<string>([fromPubkey]);
  let currentLevel: string[] = [fromPubkey];
  let depth = 0;

  while (currentLevel.length > 0 && depth < maxDepth) {
    depth++;
    const nextLevel: string[] = [];

    // Process all nodes at current depth
    for (const pubkey of currentLevel) {
      const follows = await this.getFollowsForPubkey(pubkey);

      for (const followed of follows) {
        // Found target!
        if (followed === toPubkey) {
          return depth;
        }

        // Queue unvisited nodes for next level
        if (!visited.has(followed)) {
          visited.add(followed);
          nextLevel.push(followed);
        }
      }
    }

    currentLevel = nextLevel;
  }

  // No path found within maxDepth
  return Infinity;
}
```

**Optimization consideration:** For large follow lists, consider batching queries:
```typescript
// Parallel query optimization (within a BFS level)
const followPromises = currentLevel.map(pubkey => this.getFollowsForPubkey(pubkey));
const followResults = await Promise.allSettled(followPromises);
```

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

Error class pattern:
```typescript
export class TrustCalculationError extends AgentSocietyError {
  constructor(message: string, cause?: Error) {
    super(message, 'TRUST_CALCULATION_FAILED', cause);
    this.name = 'TrustCalculationError';
  }
}
```

**Error scenarios:**
- Invalid pubkey format → throw `TrustCalculationError`
- Relay query failures → handle gracefully, return empty follows (don't fail entire calculation)
- Timeout (not implemented in MVP) → would return `Infinity` (path not found)

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case for utilities, PascalCase for class files | `SocialTrustManager.ts` |
| Classes | PascalCase | `SocialTrustManager` |
| Methods | camelCase | `getSocialDistance` |
| Constants | UPPER_SNAKE_CASE | `PUBKEY_REGEX` |
| Test files | Same name with `.test.ts` suffix | `SocialTrustManager.test.ts` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards
- Always mock SimplePool in tests - no live relay dependencies
- Export from index.ts - all public APIs exported from package index
- Use nostr-tools types - don't redefine event types
- >80% coverage for new functionality

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**Mocking pool.querySync():**
```typescript
import { vi, describe, it, expect, beforeEach } from 'vitest';
import { SimplePool } from 'nostr-tools/pool';
import type { VerifiedEvent } from 'nostr-tools/pure';

// Mock SimplePool
vi.mock('nostr-tools/pool', () => ({
  SimplePool: vi.fn().mockImplementation(() => ({
    querySync: vi.fn(),
    close: vi.fn(),
  })),
}));

// In tests:
const mockPool = new SimplePool() as unknown as {
  querySync: ReturnType<typeof vi.fn>;
  close: ReturnType<typeof vi.fn>;
};

// Mock follow list for pubkey A -> [B, C]
mockPool.querySync.mockResolvedValueOnce([
  {
    kind: 3,
    pubkey: pubkeyA,
    tags: [['p', pubkeyB], ['p', pubkeyC]],
    created_at: Date.now(),
    content: '',
    id: 'event-id',
    sig: 'signature',
  } as unknown as VerifiedEvent,
]);
```

**Test Requirements:**
- Follow AAA pattern (Arrange, Act, Assert)
- Mock all SimplePool calls
- Test success and error paths
- >80% coverage for new functionality
- Test various graph topologies (linear, cyclic, disconnected)

### Security Considerations
[Source: docs/architecture/14-security.md]

- Validate all pubkeys as 64-character hex before use
- Don't expose internal errors to consumers (wrap in library errors)
- No secrets involved in this story (only public follow lists)

### Performance Considerations

**BFS Complexity:**
- Time: O(V + E) where V = visited pubkeys, E = follow relationships
- Space: O(V) for visited set and queue

**Relay Query Optimization:**
- Each BFS level makes multiple relay queries (one per pubkey)
- Consider batching with `authors: [pubkey1, pubkey2, ...]` if possible
- However, kind:3 has limit:1 semantic per author, so batching may not help
- Accept that maxDepth=3 could result in many queries for large graphs

**Practical Limits:**
- maxDepth=3 with 100 follows per user = up to ~1,000,000 pubkeys to check
- Realistically, most social graphs are sparse enough that this completes quickly
- Production implementations may want to add timeouts or caching (out of scope for MVP)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/trust/SocialTrustManager.ts` | Created | Main class with getSocialDistance BFS implementation |
| `packages/core/src/trust/SocialTrustManager.test.ts` | Created | 28 unit tests covering all acceptance criteria |
| `packages/core/src/trust/index.ts` | Created | Module exports |
| `packages/core/src/errors.ts` | Modified | Added TrustCalculationError class |
| `packages/core/src/index.ts` | Modified | Added exports for SocialTrustManager and TrustCalculationError |

### Completion Notes

- Implemented BFS algorithm with Promise.allSettled() for parallel queries within each level
- Relay failures are handled gracefully (return empty array, don't fail entire calculation)
- All 28 new tests pass, total test count now 248
- Follows existing patterns from NostrPeerDiscovery for consistency

### Debug Log References
None

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM |
| 2026-02-06 | 1.0 | Implementation complete - all tasks done, 28 tests passing | Dev Agent |

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent.** The implementation demonstrates strong code quality with proper adherence to established patterns in the codebase. The `SocialTrustManager` class follows the same structural pattern as `NostrPeerDiscovery`, maintaining consistency. The BFS algorithm is correctly implemented with proper cycle detection, parallel query optimization via `Promise.allSettled()`, and graceful relay failure handling.

Key strengths:
- Clean separation of concerns with private `validatePubkey()` and `getFollowsForPubkey()` methods
- Consistent error handling using `TrustCalculationError` extending the base `AgentSocietyError`
- Efficient BFS with visited set preventing infinite loops
- Proper use of nostr-tools types (no redefinition)
- No use of `any` - strict TypeScript throughout

### Refactoring Performed

None required. The code is well-structured and follows project conventions.

### Compliance Check

- Coding Standards: ✓ Follows 12-coding-standards.md (PascalCase classes, camelCase methods, UPPER_SNAKE_CASE constants)
- Project Structure: ✓ Files created in correct locations (`packages/core/src/trust/`)
- Testing Strategy: ✓ Co-located test files, AAA pattern, mocked SimplePool, >80% coverage
- All ACs Met: ✓ All 6 acceptance criteria verified (see traceability below)

### Acceptance Criteria Traceability

| AC | Requirement | Implementation | Test Coverage |
|----|-------------|----------------|---------------|
| AC1 | SocialTrustManager class with constructor | `SocialTrustManager.ts:26-29` | 3 tests (constructor suite) |
| AC2 | getSocialDistance method signature | `SocialTrustManager.ts:97` | All distance tests verify signature |
| AC3 | Returns 1 for direct, 2 for follow-of-follow, etc. | `SocialTrustManager.ts:129-130` | 6 tests (distance=1,2,3 suites) |
| AC4 | Returns Infinity with configurable maxDepth | `SocialTrustManager.ts:145`, param default at :97 | 6 tests (Infinity + maxDepth suites) |
| AC5 | BFS algorithm for shortest path | `SocialTrustManager.ts:107-142` | 5 tests (cycle handling + BFS behavior) |
| AC6 | Unit tests for various topologies | `SocialTrustManager.test.ts` | 28 tests total covering all scenarios |

### Improvements Checklist

- [x] Implementation follows existing patterns from `NostrPeerDiscovery`
- [x] Proper error class added to `errors.ts`
- [x] Module exported from package index
- [x] Test coverage comprehensive (28 tests)
- [x] All graph topologies tested (linear, cyclic, disconnected, multi-path)
- [ ] Consider adding JSDoc @example tags for public API (nice-to-have)
- [ ] Consider adding a `close()` method for pool cleanup consistency (nice-to-have, mirrors future patterns)

### Security Review

No security concerns. The implementation:
- Validates all pubkey inputs before use (64-char lowercase hex)
- Only queries public follow lists (kind:3 events) - no secrets involved
- Does not expose internal relay errors to consumers
- Uses `TrustCalculationError` wrapper for all error paths

### Performance Considerations

The BFS implementation is efficient with O(V + E) time complexity:
- Uses `Set<string>` for O(1) visited lookup
- Batches queries per BFS level with `Promise.allSettled()` for parallelism
- Early termination when target is found
- Default `maxDepth=3` limits worst-case expansion

Note: Production deployments with large graphs may benefit from caching or timeouts (documented in Dev Notes, out of scope for MVP).

### Files Modified During Review

None - no refactoring performed.

### Gate Status

**Gate: PASS** → `docs/qa/gates/3.1-social-distance-calculation.yml`

### Recommended Status

✓ **Ready for Done**

All acceptance criteria met, 28 tests passing, code follows established patterns, no blocking issues identified.
