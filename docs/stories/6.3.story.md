# Story 6.3: Bootstrap Service Redesign

## Status

Done

## Story

**As a** node operator,
**I want** the bootstrap process to load peers from genesis config and ArDrive, then register them via the connector admin API,
**so that** initial peering is simple, reliable, and requires no SPSP handshake.

## Acceptance Criteria

1. Refactor `packages/core/src/bootstrap.ts`:
   - Remove `directSpspHandshake()` from bootstrap flow
   - Add method to load and merge peers from genesis config + ArDrive + env var
   - For each known peer: query kind:10032 from their relay for ILP info
   - Register peer via connector admin API: `POST /admin/peers { id, url, authToken, routes }`
   - Publish own kind:10032 to their relay
2. `ConnectorAdminClient` interface updated to match actual agent-runtime API shape:
   - `addPeer(config: { id: string, url: string, authToken: string, routes?: { prefix: string, priority?: number }[] }): Promise<void>`
3. Bootstrap returns list of successfully registered peers
4. Failed peer registrations are logged and skipped (non-fatal)
5. `BootstrapResult` no longer includes `spspInfo` field
6. Unit tests verify the simplified flow with mocked admin API

## Tasks / Subtasks

- [x] Task 1: Update `ConnectorAdminClient` interface to match agent-runtime API shape (AC: 2)
  - [x] Replace existing `addPeer(peerId, btpUrl, ilpAddress)` signature with `addPeer(config: { id: string, url: string, authToken: string, routes?: { prefix: string, priority?: number }[] }): Promise<void>`
  - [x] Remove the `addRoute(prefix, nextHop)` method (routes are now passed inline via `addPeer`)
  - [x] Update the `ConnectorAdminClient` JSDoc to reference the agent-runtime admin API

- [x] Task 2: Update `BootstrapResult` to remove `spspInfo` (AC: 5)
  - [x] Remove `spspInfo: SpspInfo` from the `BootstrapResult` interface
  - [x] Add `registeredPeerId: string` field to `BootstrapResult` (the ID used when registering with the connector)
  - [x] Remove `SpspInfo` import from bootstrap.ts if no longer needed

- [x] Task 3: Add peer loading method that merges genesis + ArDrive + env var sources (AC: 1)
  - [x] Add `loadPeers(additionalPeersJson?: string): Promise<GenesisPeer[]>` method to `BootstrapService`:
    - Call `GenesisPeerLoader.loadAllPeers(additionalPeersJson)` to get genesis + env var peers
    - Call `ArDrivePeerRegistry.fetchPeers()` to get ArDrive peers
    - Convert ArDrive `Map<string, IlpPeerInfo>` entries into `GenesisPeer` format (note: ArDrive records have `IlpPeerInfo` with `ilpAddress`, `btpEndpoint`, `assetCode`, `assetScale` but no `relayUrl` — these need a relay URL; use a configurable default relay URL or skip if no relay is available)
    - Merge all sources, deduplicating by pubkey (ArDrive overrides genesis for matching pubkeys)
    - Return combined peer list
  - [x] Add `ardriveEnabled` option to `BootstrapConfig` (default: `true`), so ArDrive lookup can be disabled
  - [x] Add `defaultRelayUrl` option to `BootstrapConfig` for ArDrive-sourced peers that lack relay URLs

- [x] Task 4: Refactor `bootstrapWithPeer` to remove SPSP handshake and use new admin API (AC: 1, 2, 3, 4)
  - [x] Remove the `directSpspHandshake()` call from `bootstrapWithPeer()`
  - [x] Remove the `directSpspHandshake()` private method entirely
  - [x] Remove the `NostrSpspClient` import (no longer needed in bootstrap)
  - [x] Remove `spspTimeout` from `BootstrapConfig` (no longer needed)
  - [x] Update `addPeerToConnector()` to use the new `ConnectorAdminClient.addPeer()` signature:
    - Build peer config: `{ id: "nostr-{pubkey16}", url: peerInfo.btpEndpoint, authToken: "", routes: [{ prefix: peerInfo.ilpAddress }] }`
    - `authToken` set to empty string for now (future stories may implement auth)
  - [x] Update `bootstrapWithPeer()` to return `BootstrapResult` without `spspInfo`, including `registeredPeerId`
  - [x] Wrap `addPeerToConnector` failure in `console.warn` and skip (non-fatal per AC: 4), rather than throwing
  - [x] Wrap `publishOurInfo` failure in `console.warn` and skip (non-fatal), rather than throwing

- [x] Task 5: Update `bootstrap()` method to use `loadPeers()` (AC: 1, 3)
  - [x] Modify `bootstrap()` to accept optional `additionalPeersJson?: string` parameter
  - [x] Call `loadPeers()` at the start of bootstrap to get the merged peer list
  - [x] Iterate over the loaded peers, converting `GenesisPeer` to `KnownPeer` for `bootstrapWithPeer()`
  - [x] Return `BootstrapResult[]` as before

- [x] Task 6: Update exports in index files (AC: 1)
  - [x] Ensure updated `ConnectorAdminClient`, `BootstrapResult`, and `BootstrapConfig` types are re-exported from `packages/core/src/index.ts`
  - [x] Verify no broken exports (removed `SpspInfo` from `BootstrapResult` should not affect `SpspInfo` export itself which is still used elsewhere)

- [x] Task 7: Write unit tests for the redesigned bootstrap (AC: 6)
  - [x] Update `packages/core/src/bootstrap.test.ts` with new tests:
    - [x] Test: `bootstrap()` with genesis peers calls `queryPeerInfo` and `addPeerToConnector` for each peer (no SPSP handshake)
    - [x] Test: `ConnectorAdminClient.addPeer()` called with correct config shape `{ id, url, authToken, routes }`
    - [x] Test: `BootstrapResult` does not include `spspInfo` field
    - [x] Test: `BootstrapResult` includes `registeredPeerId` field
    - [x] Test: Failed peer registration is logged and skipped (non-fatal)
    - [x] Test: Failed kind:10032 publish is logged and skipped (non-fatal)
    - [x] Test: `loadPeers()` merges genesis + ArDrive peers, deduplicating by pubkey
    - [x] Test: `loadPeers()` with `ardriveEnabled: false` skips ArDrive fetch
    - [x] Test: `loadPeers()` handles ArDrive fetch failure gracefully (returns only genesis peers)
    - [x] Test: `bootstrap()` with no known peers returns empty array
    - [x] Test: Invalid pubkey still throws `BootstrapError`
  - [x] Mock `GenesisPeerLoader.loadAllPeers` and `ArDrivePeerRegistry.fetchPeers` in tests
  - [x] Mock `ConnectorAdminClient` for admin API calls
  - [x] Mock WebSocket for `queryPeerInfo` tests (existing pattern from current tests)
  - [x] Verify `console.warn` is called for non-fatal failures via `vi.spyOn`

## Dev Notes

### Previous Story Insights
[Source: docs/stories/6.2.story.md#dev-agent-record]

From Story 6.2 implementation:
- 817 tests passing (14 added in 6.2), 0 failures
- `ArDrivePeerRegistry` follows GenesisPeerLoader const-object pattern with `fetchPeers()` and `publishPeerInfo()` methods
- `fetchPeers()` returns `Map<string, IlpPeerInfo>` keyed by pubkey — the bootstrap service will consume this map
- `ArDrivePeerRegistry` uses `globalThis.fetch` for HTTP calls — mock `fetch` in tests
- `isValidPubkey`, `isValidIlpAddress`, `isValidBtpEndpoint` validators are exported from `GenesisPeerLoader.ts`
- ESLint passes clean; TypeScript has a pre-existing strict null check issue in test files (non-blocking)

### Data Models
[Source: packages/core/src/types.ts, packages/core/src/discovery/GenesisPeerLoader.ts, packages/core/src/bootstrap.ts]

**Types involved in the refactoring:**

`GenesisPeer` (from `GenesisPeerLoader.ts`):
```typescript
export interface GenesisPeer {
  pubkey: string;
  relayUrl: string;
  ilpAddress: string;
  btpEndpoint: string;
}
```

`KnownPeer` (from `bootstrap.ts` — existing):
```typescript
export interface KnownPeer {
  pubkey: string;
  relayUrl: string;
  btpEndpoint: string;
}
```

`GenesisPeer` is a superset of `KnownPeer` (adds `ilpAddress`). When converting from `GenesisPeer` to `KnownPeer`, the `ilpAddress` can be dropped since `queryPeerInfo()` fetches the full `IlpPeerInfo` (which includes `ilpAddress`) from the peer's relay anyway.

`IlpPeerInfo` (from `types.ts`):
```typescript
export interface IlpPeerInfo {
  ilpAddress: string;
  btpEndpoint: string;
  settlementEngine?: string;
  assetCode: string;
  assetScale: number;
}
```

ArDrive peers arrive as `Map<string, IlpPeerInfo>` — they have `ilpAddress` and `btpEndpoint` but lack `relayUrl`. To convert to `GenesisPeer` or `KnownPeer`, a `defaultRelayUrl` config option is needed.

**Updated `BootstrapResult` (target shape):**
```typescript
export interface BootstrapResult {
  knownPeer: KnownPeer;
  peerInfo: IlpPeerInfo;
  registeredPeerId: string;  // e.g., "nostr-aabb11cc22dd33ee"
}
```

**Updated `ConnectorAdminClient` (target shape per AC 2):**
```typescript
export interface ConnectorAdminClient {
  addPeer(config: {
    id: string;
    url: string;
    authToken: string;
    routes?: { prefix: string; priority?: number }[];
  }): Promise<void>;
}
```
Note: the `addRoute()` method is removed — routes are now part of the `addPeer` config.

**Updated `BootstrapConfig` (target shape after Tasks 3 + 4):**
```typescript
export interface BootstrapConfig {
  /** List of known peers to bootstrap with */
  knownPeers: KnownPeer[];
  /** Timeout for relay queries in milliseconds (default: 5000) */
  queryTimeout?: number;
  /** Enable ArDrive peer lookup (default: true) */
  ardriveEnabled?: boolean;
  /** Default relay URL for ArDrive-sourced peers that lack relay URLs */
  defaultRelayUrl?: string;
  // NOTE: spspTimeout is REMOVED (was only needed for directSpspHandshake)
}
```

### API Specifications
[Source: docs/epics/epic-6-decentralized-peer-discovery.md#story-63, docs/epics/epic-6-decentralized-peer-discovery.md#existing-system-context]

**Connector Admin API (agent-runtime project):**
- `POST /admin/peers` — Body: `{ id: string, url: string, authToken: string, routes?: [{ prefix: string, priority?: number }] }`
- `POST /admin/routes` — Body: `{ prefix: string, nextHop: string, priority?: number }` (no longer used directly; routes passed via `addPeer`)

The `BootstrapService` does not call HTTP directly — it uses the `ConnectorAdminClient` interface. The caller (e.g., Docker entrypoint in Story 6.5) provides an implementation that calls the actual HTTP endpoints.

### File Locations
[Source: docs/architecture/9-source-tree.md, docs/epics/epic-6-decentralized-peer-discovery.md]

Files to modify:
- `packages/core/src/bootstrap.ts` — Main refactoring target: remove SPSP handshake, add peer loading, update admin API interface
- `packages/core/src/bootstrap.test.ts` — Update tests for new flow
- `packages/core/src/index.ts` — Verify exports still correct after interface changes

No new files need to be created for this story.

### Existing Code to Reuse
[Source: packages/core/src/discovery/GenesisPeerLoader.ts, packages/core/src/discovery/ArDrivePeerRegistry.ts]

- `GenesisPeerLoader.loadAllPeers(additionalPeersJson?)` — loads and merges genesis + env var peers, returns `GenesisPeer[]`
- `ArDrivePeerRegistry.fetchPeers(gatewayUrl?)` — fetches peers from Arweave, returns `Map<string, IlpPeerInfo>`
- Both are const objects exported from `packages/core/src/discovery/index.ts`
- Import paths:
  ```typescript
  import { GenesisPeerLoader, ArDrivePeerRegistry } from './discovery/index.js';
  import type { GenesisPeer } from './discovery/index.js';
  ```

[Source: packages/core/src/events/index.ts]

- `parseIlpPeerInfo(event)` — parses a kind:10032 Nostr event into `IlpPeerInfo`
- `buildIlpPeerInfoEvent(ilpInfo, secretKey)` — builds and signs a kind:10032 event

These are already used in the current bootstrap.ts and continue to be used.

### Error Handling Pattern
[Source: docs/architecture/11-error-handling-strategy.md, packages/core/src/errors.ts]

- **Per-peer failures:** Non-fatal. Log `console.warn` and continue to next peer (AC: 4). This is the existing pattern in `bootstrap()` which catches errors per peer and continues.
- **Admin API failures:** Non-fatal. The `addPeerToConnector` failure should be caught, logged, and the peer skipped — unlike the current code which throws `BootstrapError`.
- **Publish failures:** Non-fatal. The `publishOurInfo` failure should be caught and logged — unlike the current code which throws `BootstrapError`.
- **`BootstrapError`** class is retained for truly fatal errors (e.g., invalid pubkey format).

### Scope Boundaries

**In Scope (this story):**
- Refactor `BootstrapService` to remove SPSP handshake from bootstrap flow
- Update `ConnectorAdminClient` interface to match agent-runtime API
- Add `loadPeers()` method that merges genesis + ArDrive + env var peers
- Update `BootstrapResult` to remove `spspInfo`, add `registeredPeerId`
- Make admin API failures and publish failures non-fatal (log and skip)
- Update unit tests for new flow

**Unchanged (do NOT modify):**
- `discoverPeersViaRelay()` method on `BootstrapService` — retained as-is for future use
- `publishToRelay()` method on `BootstrapService` — retained as-is
- `getPubkey()` method on `BootstrapService` — retained as-is

**Out of Scope:**
- Social graph peer discovery (Story 6.4)
- Docker entrypoint integration (Story 6.5)
- SPSP handshake is NOT deleted from the codebase — `NostrSpspClient` and `NostrSpspServer` are retained in `packages/core/src/spsp/` for use by Story 6.4 (dynamic peering via social graph)
- Actual HTTP implementation of `ConnectorAdminClient` (caller provides implementation)
- Auth token generation/management (placeholder empty string for now)

### Package Dependencies
[Source: packages/core/package.json]

No new dependencies needed for this story. The `GenesisPeerLoader` and `ArDrivePeerRegistry` are already available in `packages/core`. The `NostrSpspClient` import is being removed from bootstrap.ts (it remains in the spsp package).

### Testing

**Test Framework:** Vitest 1.x
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Standards:**
- Co-located test file: `packages/core/src/bootstrap.test.ts` (already exists, update in place)
- Follow AAA pattern (Arrange, Act, Assert)
- Mock `GenesisPeerLoader.loadAllPeers` using `vi.mock('./discovery/index.js', ...)`
- Mock `ArDrivePeerRegistry.fetchPeers` using the same mock
- Mock `ConnectorAdminClient` as a plain object with `vi.fn()` methods
- Mock WebSocket (`ws` module) for `queryPeerInfo` relay interactions
- Mock `console.warn` using `vi.spyOn(console, 'warn')` to verify non-fatal logging
- No live relay or admin API dependencies
- Use factory functions for test fixtures (valid `GenesisPeer` objects, `IlpPeerInfo` objects, mock Nostr events)

**Coverage Goals:** >80% line coverage for public methods

**Import note:** The existing `bootstrap.test.ts` imports `KnownPeer` from `'./types.js'` but `KnownPeer` is actually defined in `bootstrap.ts` (and re-exported from `index.ts`). Update the test import to `import { ..., type KnownPeer } from './bootstrap.js'` or use the barrel export.

**Existing test suite:** 817 tests should continue to pass with no regressions. The existing bootstrap tests will be updated (not added alongside — since the interface changes).

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/bootstrap.ts` | Modified | Removed SPSP handshake, updated ConnectorAdminClient/BootstrapResult/BootstrapConfig interfaces, added loadPeers() method, made admin/publish failures non-fatal |
| `packages/core/src/bootstrap.test.ts` | Modified | Rewrote tests for new bootstrap flow with 16 tests covering all ACs |
| `packages/core/src/index.ts` | Unchanged | Exports already correct, no changes needed |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes
- 826 tests passing (16 in bootstrap.test.ts, up from 7), 0 failures
- ESLint clean on modified files; 2 pre-existing lint issues remain in unchanged code (`queryPeerInfo` uses `any[]`, `publishToRelay` has inferrable type annotation)
- TypeScript strict check has pre-existing issues in test files (consistent with 6.2 notes) — non-blocking
- `directSpspHandshake()` method and `NostrSpspClient` import removed from bootstrap.ts
- `NostrSpspClient`/`NostrSpspServer` remain in `packages/core/src/spsp/` as expected (out of scope)
- `discoverPeersViaRelay()`, `publishToRelay()`, and `getPubkey()` methods left unchanged per story scope
- ArDrive peers that lack a `defaultRelayUrl` config are skipped (no relay URL = can't connect)
- `bootstrap()` now merges config knownPeers + loaded peers (genesis + ArDrive), deduplicating by pubkey

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

- **Deep review triggered:** Diff ~1029 lines (exceeds 500-line threshold)
- **Security relevance:** Peer registration touches network topology (medium risk)
- **Prior gate:** None (first review)
- **AC count:** 6 (standard)

### Code Quality Assessment

The implementation is well-structured and follows the existing codebase patterns. The refactoring cleanly removes the SPSP handshake from the bootstrap flow while preserving the `NostrSpspClient`/`NostrSpspServer` in their own package for future use. The `loadPeers()` method correctly merges multiple peer sources with ArDrive-overrides-genesis semantics and proper deduplication. Error handling follows the non-fatal pattern specified in the story — admin API failures and publish failures are caught, logged, and skipped.

**Strengths:**
- Clean interface redesign: `ConnectorAdminClient.addPeer()` now matches agent-runtime API shape
- `BootstrapResult` correctly drops `spspInfo` and adds `registeredPeerId`
- Peer merge logic (genesis → ArDrive → config) with proper deduplication
- Non-fatal error handling with `console.warn` for admin/publish failures
- WebSocket-based `queryPeerInfo` with timeout handling is robust

**Findings:**

1. **ESLint violations (pre-existing, non-blocking):** Two lint issues remain in `bootstrap.ts`:
   - Line 294: `any[]` in `queryPeerInfo` — should use `unknown[]` per coding standard "Never use `any`"
   - Line 514: Inferrable type annotation on `publishToRelay` default parameter
   - These are noted as pre-existing in the Dev Agent Record and are outside the modified code paths for this story.

2. **Merge priority in `bootstrap()`:** The `bootstrap()` method (line 196-207) gives priority to `config.knownPeers` over loaded peers (genesis/ArDrive), since it checks `!knownPeersMap.has(peer.pubkey)` before adding loaded peers. Meanwhile `loadPeers()` gives ArDrive priority over genesis. This creates an intentional three-tier priority: config > ArDrive > genesis. This is reasonable but not explicitly documented in the story — the story only specifies "ArDrive overrides genesis for matching pubkeys." The config peers taking highest priority is a sensible default since they're explicitly provided by the caller.

3. **ArDrive peers without `defaultRelayUrl` are silently skipped:** In `loadPeers()` line 149, ArDrive peers are skipped when `defaultRelayUrl` is empty/unset (`if (!this.config.defaultRelayUrl) continue`). No warning is logged for these skipped peers. This is a minor observability gap — operators won't know that ArDrive peers are being discovered but not used.

### Refactoring Performed

None. The implementation is clean and does not require refactoring at this time.

### Compliance Check

- Coding Standards: **CONCERNS** — Two pre-existing `any` and inferrable-type lint violations in unchanged code (lines 294, 514). Not introduced by this story. The `any[]` at line 294 violates the "Never use `any`" rule but is pre-existing.
- Project Structure: ✓ — Files correctly located, co-located tests, proper barrel exports
- Testing Strategy: ✓ — 16 tests covering all ACs, AAA pattern, proper mocking (WebSocket, SimplePool, discovery modules), factory functions for fixtures
- All ACs Met: ✓ — See traceability below

### AC Traceability

| AC | Requirement | Test Coverage | Status |
|----|------------|---------------|--------|
| AC 1 | Refactor bootstrap: remove SPSP, add loadPeers, query kind:10032, register via admin, publish kind:10032 | Tests: "should call queryPeerInfo and addPeerToConnector for each genesis peer (no SPSP handshake)", loadPeers merge test, publish test | ✓ |
| AC 2 | ConnectorAdminClient interface updated to match agent-runtime API | Test: "should be called with correct config shape { id, url, authToken, routes }" | ✓ |
| AC 3 | Bootstrap returns list of successfully registered peers | Verified via bootstrap() return value tests | ✓ |
| AC 4 | Failed peer registrations logged and skipped | Test: "should log and skip failed peer registration" with console.warn spy | ✓ |
| AC 5 | BootstrapResult no longer includes spspInfo | Test: "should not include spspInfo field" with Object.keys check | ✓ |
| AC 6 | Unit tests verify simplified flow with mocked admin API | 16 tests with mocked admin, WebSocket, SimplePool, discovery modules | ✓ |

### Improvements Checklist

- [ ] Fix `any[]` at line 294 of `bootstrap.ts` to `unknown[]` (pre-existing, low priority)
- [ ] Remove inferrable type annotation at line 514 of `bootstrap.ts` (pre-existing, low priority)
- [ ] Consider logging a warning when ArDrive peers are skipped due to missing `defaultRelayUrl`

### Security Review

No security concerns identified. The implementation:
- Validates pubkey format before processing (BootstrapError for invalid pubkeys)
- Uses empty `authToken` as a placeholder (documented for future implementation)
- Does not expose secrets — SPSP handshake with shared secrets has been removed from bootstrap
- WebSocket connections use the relay URLs provided in config (no user-input URL injection path)

### Performance Considerations

No performance concerns. The bootstrap process is inherently sequential (peer-by-peer) and runs at startup only. The ArDrive fetch adds one HTTP call but is gated behind `ardriveEnabled` and has proper timeout via the underlying `fetch` implementation.

### Files Modified During Review

None — no refactoring performed.

### Gate Status

Gate: PASS → docs/qa/gates/6.3-bootstrap-service-redesign.yml

### Recommended Status

✓ Ready for Done

All 6 acceptance criteria are met. All 826 tests pass with 0 regressions. The two ESLint findings are pre-existing and outside the scope of this story. The implementation cleanly achieves the bootstrap redesign goals.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-07 | 0.2 | Added target BootstrapConfig shape, KnownPeer import note, unchanged methods list | Validation fixes |
| 2026-02-07 | 1.0 | Implementation complete: all 7 tasks done, 826 tests passing, 0 regressions | Dev (Claude Opus 4.6) |
