# Story 8.4: Reverse Registration and Cross-Peer Discovery

## Status

Done

## Story

**As a** bootstrap node,
**I want** to discover newly announced peers on my relay and initiate SPSP handshakes with them,
**so that** the bootstrap node has bidirectional payment channels with all peers in the network.

## Acceptance Criteria

1. Bootstrap node monitors own relay for new kind:10032 events
2. New peers automatically registered and SPSP-handshaked
3. Payment channel opened for each new peer (bidirectional with bootstrap)
4. Cross-peer SPSP handshakes route through ILP network
5. Each peer-pair has independent settlement relationship
6. Duplicate kind:10032 events from same peer are idempotent (no double registration)
7. Peer removal: if kind:10032 event has newer timestamp with empty content, deregister
8. Unit tests for relay subscription, event filtering, idempotent registration

## Dev Notes

### Previous Story Insights
[Source: docs/stories/8.3.story.md#dev-agent-record]

From Story 8.3 (Publish Peer Announcements as Paid ILP Packets):
- 991 tests passing (7 new), 0 failures
- ESLint: 1 pre-existing error in packages/bls (not introduced by Story 8.3)
- Build: pre-existing DTS error in `SocialPeerDiscovery.ts` importing from old `../bootstrap.js` path (not introduced by this story, exists since 8.1 bootstrap module refactor)
- `basePricePerByte` added to `BootstrapServiceConfig` as optional bigint (default `10n`)
- `announceViaIlp()` now uses configurable pricing, emits `bootstrap:announced` on FULFILL and `bootstrap:announce-failed` on REJECT
- Catch block in `bootstrap()` Phase 3 loop emits `bootstrap:announce-failed` for network errors before logging
- Docker entrypoint passes `basePricePerByte` from config and handles new event types in event listener
- QA noted: `PUBKEY_REGEX` duplication in `NostrSpspClient.ts` still present (low severity, future cleanup)
- QA noted: Entrypoint test `envKeysToClean` still missing `SUPPORTED_CHAINS` and `SETTLEMENT_ADDRESS_*` vars (low severity)

### Existing Discovery Infrastructure (Reference)
[Source: packages/core/src/bootstrap/BootstrapService.ts:711-753]

The `BootstrapService` already has a `discoverPeersViaRelay()` method that queries a relay for kind:10032 events from other peers:

```typescript
async discoverPeersViaRelay(
  relayUrl: string,
  excludePubkeys: string[] = []
): Promise<Map<string, IlpPeerInfo>> {
  const excludeSet = new Set([this.pubkey, ...excludePubkeys]);
  const filter: Filter = { kinds: [ILP_PEER_INFO_KIND] };
  const events = await this.pool.querySync([relayUrl], filter);
  // Groups by pubkey, keeps most recent, parses...
  return result;
}
```

This is a **one-shot query** method. Story 8.4 needs a **subscription-based** approach that continuously monitors for new kind:10032 events and reacts to them. The one-shot method can serve as reference for the parsing logic but the subscription pattern should follow `NostrPeerDiscovery.subscribeToPeerUpdates()`.

### Existing Subscription Pattern (Reference)
[Source: packages/core/src/discovery/NostrPeerDiscovery.ts:156-221]

`NostrPeerDiscovery.subscribeToPeerUpdates()` is the canonical subscription pattern in the codebase:
- Uses `this.pool.subscribeMany(relayUrls, filter, { onevent: ... })` for real-time subscriptions
- Tracks per-pubkey timestamps for replaceable event semantics (skip stale events)
- Returns a `Subscription` object with `unsubscribe()` method
- Silently skips malformed events via try/catch around `parseIlpPeerInfo()`
- Checks `isUnsubscribed` flag to prevent processing after close

**Key difference for 8.4:** The existing subscription only invokes a callback. Story 8.4 needs to additionally:
1. Register the peer via `ConnectorAdminClient.addPeer()`
2. Send a paid SPSP handshake via `IlpSpspClient.requestSpspInfo()`
3. Update registration with settlement/channel info from the handshake
4. Handle deregistration on empty-content events (AC 7)
5. Track registered peers for idempotency (AC 6)

### Bootstrap Flow Integration
[Source: docs/epics/epic-8-nostr-network-bootstrap.md, Phase 3 step 8]

After the bootstrap node completes its own bootstrap (Phase 1-3):
1. Peer2 publishes kind:10032 as paid ILP PREPARE (Story 8.3) -> stored on peer1's relay
2. **Peer1 discovers peer2's kind:10032** on its own relay (this story)
3. Peer1 sends paid SPSP (kind:23194) to peer2 via `POST /ilp/send`
4. Peer2 negotiates chain, opens channel -> FULFILL
5. Peer1 registers peer2 via `POST /admin/peers`

For cross-peer (non-bootstrap) nodes:
1. Peer3 reads kind:10032 events on bootstrap relay (free WebSocket read)
2. Peer3 sends paid SPSP to peer2 via ILP (multi-hop through bootstrap)
3. Each peer-pair negotiates own settlement chain independently

### Data Models
[Source: packages/core/src/types.ts, packages/core/src/bootstrap/types.ts]

**IlpPeerInfo (kind:10032 content):**
```typescript
interface IlpPeerInfo {
  ilpAddress: string;
  btpEndpoint: string;
  settlementEngine?: string; // deprecated
  assetCode: string;
  assetScale: number;
  supportedChains?: string[];
  settlementAddresses?: Record<string, string>;
  preferredTokens?: Record<string, string>;
  tokenNetworks?: Record<string, string>;
}
```

**BootstrapEvent types (existing):**
[Source: packages/core/src/bootstrap/types.ts:89-96]
```typescript
type BootstrapEvent =
  | { type: 'bootstrap:phase'; phase: BootstrapPhase; previousPhase?: BootstrapPhase }
  | { type: 'bootstrap:peer-registered'; peerId: string; peerPubkey: string; ilpAddress: string }
  | { type: 'bootstrap:channel-opened'; peerId: string; channelId: string; negotiatedChain: string }
  | { type: 'bootstrap:handshake-failed'; peerId: string; reason: string }
  | { type: 'bootstrap:announced'; peerId: string; eventId: string; amount: string }
  | { type: 'bootstrap:announce-failed'; peerId: string; reason: string }
  | { type: 'bootstrap:ready'; peerCount: number; channelCount: number };
```

**New event types needed:**
- `bootstrap:peer-discovered` — when a new kind:10032 is seen on the relay (before registration)
- `bootstrap:peer-deregistered` — when a peer is removed due to empty-content event (AC 7)

**ConnectorAdminClient (existing):**
[Source: packages/core/src/bootstrap/types.ts:46-73]
```typescript
interface ConnectorAdminClient {
  addPeer(config: {
    id: string; url: string; authToken: string;
    routes?: { prefix: string; priority?: number }[];
    settlement?: { preference: string; evmAddress?: string; ... };
  }): Promise<void>;
  removePeer?(peerId: string): Promise<void>; // Optional
}
```

**IlpSpspClient (existing from Story 8.2):**
[Source: packages/core/src/spsp/IlpSpspClient.ts:47-207]
```typescript
class IlpSpspClient {
  constructor(agentRuntimeClient, secretKey, config: IlpSpspClientConfig);
  async requestSpspInfo(
    recipientPubkey: string,
    peerIlpAddress: string,
    options?: IlpSpspRequestOptions
  ): Promise<SpspInfo & { settlement?: SettlementNegotiationResult }>;
}
```

The `IlpSpspClient` handles TOON encoding, retry logic (1 retry on timeout), and response decoding. It can be used directly for the paid SPSP handshakes in this story.

**Subscription type (existing):**
[Source: packages/core/src/types.ts:89-92]
```typescript
interface Subscription {
  unsubscribe(): void;
}
```

### API Specifications

**Agent-Runtime `POST /ilp/send` (used for paid SPSP handshakes):**
[Source: packages/core/src/bootstrap/agent-runtime-client.ts, packages/core/src/bootstrap/types.ts:117-124]

```
POST /ilp/send
Content-Type: application/json
{
  "destination": "g.peer2",        // ILP address of the new peer
  "amount": "1500",               // Paid handshake (calculated from TOON size * basePricePerByte)
  "data": "<base64-encoded-TOON>", // TOON-encoded kind:23194 SPSP request
  "timeout": 30000
}
```

The `IlpSpspClient` wraps this API — no direct HTTP calls needed.

**Connector Admin `POST /admin/peers` (register new peer):**
[Source: docker/src/entrypoint.ts:208-238]
```
POST /admin/peers
{
  "id": "nostr-aabb11cc22dd33ee",
  "url": "ws://peer2:3000",
  "authToken": "",
  "routes": [{ "prefix": "g.peer2" }],
  "settlement": { ... }  // Added after SPSP handshake
}
```

**Connector Admin `DELETE /admin/peers/:peerId` (deregister peer, AC 7):**
[Source: docker/src/entrypoint.ts:228-237]
```
DELETE /admin/peers/nostr-aabb11cc22dd33ee
```

The `ConnectorAdminClient.removePeer?()` method is already optional in the interface. For deregistration to work, the caller must check if `removePeer` is defined before calling it. The Docker entrypoint's `DockerConnectorAdminClient` always implements `removePeer`.

### Pricing for Paid SPSP Handshakes
[Source: docker/src/entrypoint.ts:436-442, packages/relay/src/pricing/PricingService.ts]

When the bootstrap node sends a paid SPSP handshake to a newly discovered peer, the amount must match what the receiving peer's BLS expects. The receiving peer's `PricingService` applies a half-price override for kind:23194 (SPSP request), so the `RelayMonitor` must pre-calculate the amount using the same formula:

- **Formula:** `BigInt(toonBytes.length) * (basePricePerByte / 2n)`
- The `IlpSpspClient` takes an `amount` option — the `RelayMonitor` must TOON-encode the SPSP request first to get `toonBytes.length`, then pass the calculated amount
- Uses BigInt floor division (e.g., `11n / 2n = 5n`), which is acceptable

### File Locations
[Source: docs/architecture/9-source-tree.md, packages/core/src/bootstrap/]

**Files to create:**
- `packages/core/src/bootstrap/RelayMonitor.ts` — New class for relay subscription, event processing, and reverse registration/handshake orchestration
- `packages/core/src/bootstrap/RelayMonitor.test.ts` — Co-located tests

**Files to modify:**
- `packages/core/src/bootstrap/types.ts` — Add `bootstrap:peer-discovered` and `bootstrap:peer-deregistered` event types; add `RelayMonitorConfig` interface
- `packages/core/src/bootstrap/index.ts` — Export `RelayMonitor` class and config type
- `packages/core/src/index.ts` — Re-export `RelayMonitor` and config type from bootstrap module
- `docker/src/entrypoint.ts` — Start `RelayMonitor` after bootstrap completes; handle new event types in event listener

**Files NOT modified:**
- `packages/core/src/bootstrap/BootstrapService.ts` — BootstrapService unchanged (relay monitor is a separate concern)
- `packages/core/src/spsp/IlpSpspClient.ts` — IlpSpspClient used as-is for paid handshakes
- `packages/core/src/discovery/NostrPeerDiscovery.ts` — Existing discovery unchanged
- `packages/relay/` — Relay package unchanged

### Technical Constraints

**SimplePool subscription pattern:**
[Source: packages/core/src/discovery/NostrPeerDiscovery.ts:190-211]
Use `this.pool.subscribeMany(relayUrls, [filter], { onevent: handler })` which returns a `SubCloser` with `.close()`. Wrap in a `Subscription` object.

**Replaceable event semantics:**
[Source: packages/core/src/discovery/NostrPeerDiscovery.ts:196-201]
Track per-pubkey timestamps. Only process events with `created_at > lastSeen`. This handles both fresh events and updates.

**Idempotent registration (AC 6):**
Maintain an internal `Set<string>` of registered pubkeys. Before registering, check if pubkey is already in the set. If so, skip registration and handshake (but still update the stored peer info for timestamp freshness). This prevents double registration from relay replays or multiple event deliveries.

**Peer deregistration on empty content (AC 7):**
If a kind:10032 event has an empty `content` field (or content parsing fails with an empty/null ILP address), this represents a peer leaving the network. The monitor should:
1. Guard with `if (this.connectorAdmin?.removePeer)` before calling `removePeer(peerId)` — the method is optional on `ConnectorAdminClient`
2. Remove pubkey from the registered set
3. Emit `bootstrap:peer-deregistered` event

**BigInt handling:**
[Source: docs/stories/8.1.story.md#dev-agent-record]
Use `BigInt()` constructor or `0n` literal. No `Math.min`/`Math.max`.

**DI pattern for TOON encoder/decoder:**
[Source: packages/core/src/bootstrap/BootstrapService.ts:67-68]
Follow the same DI injection pattern: pass `toonEncoder` and `toonDecoder` callbacks in the config to avoid circular dependencies with the relay package.

**Cross-peer SPSP routing (AC 4, 5):**
Cross-peer handshakes (e.g., peer3 -> peer2) route through the ILP network as multi-hop paid packets. This is handled transparently by `IlpSpspClient` — the caller just sets the destination to the peer's ILP address. The ILP routing table (populated during bootstrap) determines the actual path. No special handling needed in the relay monitor for cross-peer routing.

**Non-blocking handshake processing:**
The relay monitor should process discovered peers sequentially (not in parallel) to avoid overwhelming the connector admin API. Each peer discovery triggers: register -> SPSP handshake -> update registration. Failures are non-fatal (log and continue monitoring).

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

- Use `BootstrapError` for relay monitor failures (consistent with bootstrap module)
- Registration failures are non-fatal: catch, log WARNING, emit `bootstrap:handshake-failed` event, continue
- SPSP handshake failures are non-fatal: peer is registered but without channel info
- Deregistration failures are non-fatal: log WARNING, continue monitoring
- Subscription errors (relay disconnect) should be logged but not crash the process

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x
**File:** `packages/core/src/bootstrap/RelayMonitor.test.ts` (new file, co-located)

**Test patterns to follow:**
[Source: packages/core/src/bootstrap/BootstrapService.test.ts, packages/core/src/discovery/NostrPeerDiscovery.test.ts]
```typescript
import { describe, it, expect, vi, beforeEach, type Mock } from 'vitest';
import { generateSecretKey, getPublicKey } from 'nostr-tools/pure';
```
- Mock `SimplePool` with `vi.mock('nostr-tools/pool', ...)`
- Mock `AgentRuntimeClient.sendIlpPacket` with `vi.fn()`
- Mock `ConnectorAdminClient.addPeer` and `removePeer` with `vi.fn()`
- Mock `IlpSpspClient.requestSpspInfo` with `vi.fn()`
- Use `vi.fn()` for `toonEncoder`/`toonDecoder`
- Capture events via `monitor.on((event) => events.push(event))`
- Simulate relay events by invoking the `onevent` handler captured from `pool.subscribeMany`

**New tests needed (AC 8):**
- Test: subscribes to relay for kind:10032 events (verifies `pool.subscribeMany` called with correct filter)
- Test: registers discovered peer via `connectorAdmin.addPeer()` with correct peerId and routes
- Test: sends paid SPSP handshake via `IlpSpspClient` for newly discovered peer
- Test: updates peer registration with channel/settlement info from SPSP FULFILL
- Test: emits `bootstrap:peer-discovered` event when new kind:10032 seen
- Test: emits `bootstrap:peer-registered` event after successful registration
- Test: emits `bootstrap:channel-opened` event after successful handshake with channel
- Test: duplicate kind:10032 from same pubkey does NOT re-register (idempotent)
- Test: kind:10032 with empty content triggers `removePeer` and `bootstrap:peer-deregistered` event
- Test: stale kind:10032 events (older timestamp) are ignored
- Test: SPSP handshake failure is non-fatal (peer remains registered, monitoring continues)
- Test: unsubscribe stops processing events
- Test: excludes own pubkey from discovery

**Expected new test count:** ~13 new tests
**Total expected:** 991 (baseline from 8.3) + ~13 = ~1004

### Scope Boundaries

**In Scope:**
- New `RelayMonitor` class that subscribes to a relay for kind:10032 events
- Automatic peer registration for newly discovered peers
- Paid SPSP handshake initiation for registered peers using `IlpSpspClient`
- Peer registration update with channel/settlement info from handshake
- Idempotent registration (skip already-registered peers)
- Peer deregistration on empty-content kind:10032 events
- New event types: `bootstrap:peer-discovered`, `bootstrap:peer-deregistered`
- Docker entrypoint integration: start monitor after bootstrap, handle new events
- Unit tests for all new functionality

**Out of Scope:**
- Modifying `BootstrapService` itself (relay monitor is a separate service)
- Modifying `IlpSpspClient` (used as-is)
- Modifying relay package or pricing service
- Multi-relay monitoring (monitor subscribes to a single relay URL)
- Automatic reconnection on relay disconnect (future enhancement)
- Cross-peer discovery initiated by non-bootstrap nodes (those nodes start their own relay monitor via their own entrypoint)
- Docker Compose or deployment script changes (Story 8.5 scope)

## Tasks / Subtasks

- [x] Task 1: Add new event types and `RelayMonitorConfig` interface to types (AC: 1, 6, 7)
  - [x] In `packages/core/src/bootstrap/types.ts`:
    - Add `bootstrap:peer-discovered` event type: `{ type: 'bootstrap:peer-discovered'; peerPubkey: string; ilpAddress: string }`
    - Add `bootstrap:peer-deregistered` event type: `{ type: 'bootstrap:peer-deregistered'; peerId: string; peerPubkey: string; reason: string }`
    - Add `RelayMonitorConfig` interface with fields:
      - `relayUrl: string` — relay URL to monitor
      - `secretKey: Uint8Array` — Nostr secret key for SPSP requests
      - `toonEncoder: (event: NostrEvent) => Uint8Array` — DI callback
      - `toonDecoder: (bytes: Uint8Array) => NostrEvent` — DI callback
      - `basePricePerByte?: bigint` — price per byte (default `10n`)
      - `settlementInfo?: SpspRequestSettlementInfo` — own settlement prefs
      - `defaultTimeout?: number` — SPSP timeout (default `30000`)

- [x] Task 2: Implement `RelayMonitor` class (AC: 1, 2, 3, 4, 5, 6, 7)
  - [x] Create `packages/core/src/bootstrap/RelayMonitor.ts`
  - [x] Constructor takes `RelayMonitorConfig` and optional `SimplePool`. Does NOT create `IlpSpspClient` yet (requires `AgentRuntimeClient` which is injected later via setter).
  - [x] `setConnectorAdmin(admin: ConnectorAdminClient)` — setter for DI
  - [x] `setAgentRuntimeClient(client: AgentRuntimeClient)` — setter for DI
  - [x] Event emitter: `on(listener)`, `off(listener)`, private `emit(event)` — same pattern as `BootstrapService`
  - [x] `start(excludePubkeys?: string[]): Subscription` — begins subscription:
    - **Precondition:** Validate that both `connectorAdmin` and `agentRuntimeClient` have been set; throw `BootstrapError` if not. Create `IlpSpspClient` lazily here (it requires `agentRuntimeClient` at construction).
    - Subscribe to relay for `{ kinds: [ILP_PEER_INFO_KIND] }` events
    - Maintain `registeredPeers: Set<string>` for idempotency (AC 6)
    - Maintain `peerTimestamps: Map<string, number>` for replaceable event semantics
    - Exclude own pubkey and `excludePubkeys` from processing
    - For each new event:
      1. Check timestamp freshness (skip stale)
      2. Parse `IlpPeerInfo` via `parseIlpPeerInfo(event)`
      3. If empty content or missing `ilpAddress`: handle deregistration (AC 7)
      4. If already in `registeredPeers`: skip (AC 6)
      5. Emit `bootstrap:peer-discovered`
      6. Register peer via `connectorAdmin.addPeer()`
      7. Emit `bootstrap:peer-registered`
      8. Send paid SPSP handshake via `IlpSpspClient.requestSpspInfo()` (AC 3, 4, 5)
      9. On handshake FULFILL with channel: update registration with settlement, emit `bootstrap:channel-opened`
      10. On handshake failure: emit `bootstrap:handshake-failed`, continue
    - Return `Subscription` with `unsubscribe()` that closes the pool subscription
  - [x] Private `calculateSpspAmount(event: NostrEvent): string` — calculates paid handshake amount: `BigInt(toonBytes.length) * (basePricePerByte / 2n)` for kind:23194 SPSP half-price

- [x] Task 3: Export `RelayMonitor` from module indexes (AC: 1)
  - [x] In `packages/core/src/bootstrap/index.ts`: export `RelayMonitor` class and `RelayMonitorConfig` type
  - [x] In `packages/core/src/index.ts`: re-export `RelayMonitor` and `type RelayMonitorConfig` from bootstrap module

- [x] Task 4: Wire `RelayMonitor` in Docker entrypoint (AC: 1, 2)
  - [x] In `docker/src/entrypoint.ts`, after bootstrap completes:
    - Create `RelayMonitor` with config: `relayUrl: ws://localhost:${config.wsPort}`, `secretKey`, `toonEncoder`, `toonDecoder`, `basePricePerByte`, `settlementInfo`
    - Set connector admin client and agent-runtime client (same instances used by bootstrap)
    - Register event listener for new event types (`bootstrap:peer-discovered`, `bootstrap:peer-deregistered`)
    - Call `monitor.start(bootstrapPeerPubkeys)` where `bootstrapPeerPubkeys` are pubkeys already registered during bootstrap (to avoid duplicate registration): `const bootstrapPeerPubkeys = results.map(r => r.knownPeer.pubkey);`
    - Store subscription for graceful shutdown (call `unsubscribe()` on SIGINT/SIGTERM)

- [x] Task 5: Write unit tests for RelayMonitor (AC: 8)
  - [x] Create `packages/core/src/bootstrap/RelayMonitor.test.ts`
  - [x] Test: subscribes to relay for kind:10032 events with correct filter
  - [x] Test: registers discovered peer via `addPeer()` with correct peerId, URL, routes
  - [x] Test: sends paid SPSP handshake for newly discovered peer
  - [x] Test: updates registration with channel/settlement info from handshake
  - [x] Test: emits `bootstrap:peer-discovered` event on new event
  - [x] Test: emits `bootstrap:peer-registered` event after registration
  - [x] Test: emits `bootstrap:channel-opened` event after handshake with channel
  - [x] Test: duplicate kind:10032 from same pubkey does NOT re-register (idempotent, AC 6)
  - [x] Test: kind:10032 with empty content triggers deregistration (AC 7)
  - [x] Test: stale events (older timestamp) are ignored
  - [x] Test: SPSP handshake failure is non-fatal
  - [x] Test: unsubscribe stops event processing
  - [x] Test: excludes own pubkey from discovery

- [x] Task 6: Run full test suite and lint (AC: 8)
  - [x] Run `pnpm test` — target ~1004 tests passing (~13 new), 0 failures
  - [x] Run `pnpm lint` — no new lint errors
  - [x] Verify no regressions in any package

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/bootstrap/types.ts` | Modified | Add `bootstrap:peer-discovered`, `bootstrap:peer-deregistered` event types; add `RelayMonitorConfig` |
| `packages/core/src/bootstrap/RelayMonitor.ts` | Created | New class for relay subscription and reverse registration |
| `packages/core/src/bootstrap/RelayMonitor.test.ts` | Created | ~13 unit tests for relay monitoring |
| `packages/core/src/bootstrap/index.ts` | Modified | Export RelayMonitor and config type |
| `packages/core/src/index.ts` | Modified | Re-export RelayMonitor and config type |
| `docker/src/entrypoint.ts` | Modified | Start RelayMonitor after bootstrap, handle new events, shutdown |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug entries needed — all tasks completed without blocking issues.

### Completion Notes
- 1006 tests passing (15 new), 0 failures
- ESLint: 1 pre-existing error in `packages/bls/src/storage/createEventStore.test.ts` (not introduced by Story 8.4)
- `RelayMonitor` class created with subscription-based relay monitoring, automatic peer registration, paid SPSP handshakes via `IlpSpspClient`, idempotent registration, and peer deregistration on empty-content events
- New event types `bootstrap:peer-discovered` and `bootstrap:peer-deregistered` added to `BootstrapEvent` union type
- `RelayMonitorConfig` interface added to bootstrap types with DI callbacks for TOON encoding/decoding
- Docker entrypoint wires `RelayMonitor` after bootstrap completes, excludes already-bootstrapped peer pubkeys, includes graceful shutdown
- `calculateSpspAmount` uses half-price formula for kind:23194 SPSP requests: `BigInt(toonBytes.length) * (basePricePerByte / 2n)`
- Tests use `fireEvent()` helper to safely invoke captured `onevent` handler (avoids non-null assertions per ESLint rules)
- Timing-sensitive tests wait for `mockSpspRequestSpspInfo` (which runs after `registeredPeers.add`) to avoid race conditions

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Strong implementation. `RelayMonitor` is cleanly separated from `BootstrapService`, follows established codebase patterns (event emitter, DI injection, subscription lifecycle), and handles all acceptance criteria correctly. The lazy `IlpSpspClient` creation in `start()` is a good design choice that respects the DI lifecycle. Half-price SPSP calculation matches the relay's `PricingService` configuration. Error handling is comprehensive and non-fatal across all external operations. 15 new tests bring the total to 1006 with 0 failures.

### Refactoring Performed

None required. Code quality is high across all files.

### Compliance Check

- Coding Standards: ✓ TypeScript strict, no `any`, proper naming conventions, co-located tests
- Project Structure: ✓ New files in `packages/core/src/bootstrap/`, exported from index chain
- Testing Strategy: ✓ Unit tests with mocked SimplePool, 15 new tests, all passing
- All ACs Met: ✓ All 8 acceptance criteria verified with test coverage

### Improvements Checklist

- [x] All 8 ACs implemented and tested
- [x] Idempotent registration with `Set<string>` tracking
- [x] Replaceable event semantics with per-pubkey timestamps
- [x] Deregistration on empty-content events with `removePeer` guard
- [x] Graceful shutdown wired in entrypoint
- [x] Event emitter with all new event types (`peer-discovered`, `peer-deregistered`)
- [ ] Consider adding a test for `off()` listener removal (low severity)
- [ ] Consider adding a test for registration failure (`addPeer` throwing) — current code handles it correctly but lacks explicit test (low severity)

### Security Review

No security concerns found. Secret key handling follows established patterns (DI via config). No secrets exposed in events or logs. Pubkey-based peer identification is consistent.

### Performance Considerations

Sequential peer processing is deliberate and appropriate — prevents connector admin API overload. No performance concerns.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/8.4-reverse-registration-and-cross-peer-discovery.yml

### Recommended Status

✓ Ready for Done — All acceptance criteria met, code quality is high, 1006 tests passing, no new lint errors, no security concerns.
(Story owner decides final status)

---

### Review Date: 2026-02-09 (Independent Verification)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Independent verification confirms the initial review findings. `RelayMonitor` implementation is well-structured with clean separation of concerns from `BootstrapService`. All code paths were traced manually against acceptance criteria:

- **AC 1** (relay monitoring): `start()` calls `pool.subscribeMany` with `[ILP_PEER_INFO_KIND]` filter on configured relay URL — verified at `RelayMonitor.ts:120-124`
- **AC 2** (auto-registration): `processEvent()` calls `connectorAdmin.addPeer()` with correct peerId format (`nostr-{pubkey16}`) and routes — verified at `RelayMonitor.ts:220-225`
- **AC 3** (payment channel): SPSP handshake via `IlpSpspClient.requestSpspInfo()` with settlement info update on channel open — verified at `RelayMonitor.ts:247-290`
- **AC 4** (cross-peer routing): `IlpSpspClient` handles multi-hop transparently via ILP routing — architecture verified, no special handling needed
- **AC 5** (independent settlement): Each peer-pair negotiates via separate SPSP handshake — confirmed by `requestSpspInfo` per-peer invocation
- **AC 6** (idempotency): `registeredPeers.has(event.pubkey)` check at `RelayMonitor.ts:207` — verified, also timestamp check prevents stale re-processing
- **AC 7** (deregistration): Empty content detection with `removePeer` guard at `RelayMonitor.ts:181-203` — verified, includes `registeredPeers.delete`
- **AC 8** (tests): 15 tests covering all above scenarios — independently run, all passing

### Refactoring Performed

None required.

### Compliance Check

- Coding Standards: ✓ TypeScript strict, no `any`, PascalCase classes, camelCase methods, co-located tests
- Project Structure: ✓ Files in `packages/core/src/bootstrap/`, exported from `bootstrap/index.ts` → `core/index.ts`
- Testing Strategy: ✓ Vitest, SimplePool mocked, AAA pattern, `fireEvent()` helper avoids non-null assertions
- All ACs Met: ✓ All 8 acceptance criteria verified with code path tracing and test coverage

### Improvements Checklist

- [x] All 8 ACs implemented with code path verification
- [x] Idempotent registration prevents relay replay attacks
- [x] Replaceable event semantics prevent stale event processing
- [x] Deregistration with optional `removePeer` guard
- [x] Graceful shutdown: `relayMonitorSubscription.unsubscribe()` on SIGINT/SIGTERM
- [x] PUBKEY_REGEX import issue from 8.3 QA is now resolved in IlpSpspClient.ts (imports from bootstrap/types)
- [ ] Consider adding test for `off()` listener removal (low severity, method is trivial)
- [ ] Consider adding test for `addPeer()` registration failure path (low severity, code handles correctly at line 235-243)
- [ ] Entrypoint test `envKeysToClean` still missing `SUPPORTED_CHAINS` and `SETTLEMENT_ADDRESS_*` vars (carried from 8.2/8.3, low severity)

### Security Review

No security concerns. Secret key is DI-injected via config, not stored in logs or events. Pubkey validation is consistent via `excludeSet`. No user input passes through without parsing.

### Performance Considerations

Sequential peer processing via `async processEvent()` is deliberate and documented — prevents connector admin API overload. No unbounded resource growth; `registeredPeers` Set grows linearly with discovered peers (bounded by relay content).

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/8.4-reverse-registration-and-cross-peer-discovery.yml

### Recommended Status

✓ Ready for Done — Independent verification confirms all acceptance criteria met, code quality high, 1006 tests passing (15 new), no new lint errors, no security or performance concerns.
(Story owner decides final status)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-09 | 0.2 | Validation fixes: clarify lazy IlpSpspClient creation in start(), simplify pricing section, add removePeer guard note, add bootstrapPeerPubkeys extraction hint | QA (Claude Opus 4.6) |
| 2026-02-09 | 1.0 | Implementation complete — all 6 tasks done, 1006 tests passing, 0 new lint errors | Dev (Claude Opus 4.6) |
