# Story 9.6: Publish to npm

## Status

Done

## Story

**As a** library publisher,
**I want** to publish `@agent-society/bls`, `@agent-society/core`, and `@agent-society/relay` to the npm registry in the correct dependency order,
**so that** downstream projects (including the ElizaOS plugin) can install and use these packages as standard npm dependencies.

## Acceptance Criteria

1. All three packages are published to the npm registry with `access: public`
2. `npm install @agent-society/core` works in a fresh project
3. `npm install @agent-society/relay` pulls in `@agent-society/core` and `@agent-society/bls` as transitive dependencies
4. TypeScript types resolve correctly when imported (e.g., `import { BootstrapService } from '@agent-society/core'`)
5. Package contents on npm contain only `dist/`, `README.md`, `package.json` (no source, no tests). **Note:** Epic AC mentions `LICENSE` but no LICENSE file exists in the repo — this is a known gap documented in Story 9.5 and out of scope for this epic.
6. All packages are at version `1.0.0`

## Tasks / Subtasks

- [x] Task 1: Pre-publish validation — build and test all packages (AC: 1, 5, 6)
  - [x] Run `pnpm build` to ensure fresh `dist/` output in all packages
  - [x] Run `pnpm test` to verify no regressions (expect 1020 passed, 2 pre-existing failures in `SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts`)
  - [x] Verify all three packages are at version `1.0.0` in their `package.json` files
  - [x] Verify `publishConfig.access` is `"public"` in all three packages
  - [x] Verify `workspace:*` references do NOT appear in any publishable package's `dependencies` (relay should have `^1.0.0` for bls and core)

- [x] Task 2: Authenticate with npm registry — **requires human interaction** (AC: 1)
  - [x] **Human-in-the-loop:** `npm login` is interactive and requires a human with access to the `@agent-society` npm org. A dev agent cannot complete this step autonomously.
  - [x] Verify npm authentication: run `npm whoami` to confirm logged-in user
  - [x] If not authenticated, run `npm login` to authenticate (requires npm account with publish rights to `@agent-society` scope)
  - [x] Verify the `@agent-society` scope is available or owned by the authenticated user

- [x] Task 3: Dry-run publish all packages (AC: 1, 5)
  - [x] Run `npm publish --dry-run` from `packages/bls/` — verify file list and no errors
  - [x] Run `npm publish --dry-run` from `packages/core/` — verify file list and no errors
  - [x] Run `npm publish --dry-run` from `packages/relay/` — verify file list and no errors
  - [x] Review the dry-run output for each package to confirm only expected files would be published

- [x] Task 4: Publish `@agent-society/bls` first (AC: 1, 6)
  - [x] Run `npm publish --access public` from `packages/bls/`
  - [x] Verify publish succeeds (exit code 0)
  - [x] Verify package is visible: `npm view @agent-society/bls version` should return `1.0.0`

- [x] Task 5: Publish `@agent-society/core` second (AC: 1, 6)
  - [x] Run `npm publish --access public` from `packages/core/`
  - [x] Verify publish succeeds (exit code 0)
  - [x] Verify package is visible: `npm view @agent-society/core version` should return `1.0.0`

- [x] Task 6: Publish `@agent-society/relay` last (AC: 1, 3, 6)
  - [x] Run `npm publish --access public` from `packages/relay/`
  - [x] Verify publish succeeds (exit code 0)
  - [x] Verify package is visible: `npm view @agent-society/relay version` should return `1.0.0`
  - [x] Verify transitive dependencies: `npm view @agent-society/relay dependencies` should list `@agent-society/bls` and `@agent-society/core` at `^1.0.0`

- [x] Task 7: Post-publish verification in a fresh project (AC: 2, 3, 4, 5)
  - [x] Create a temporary directory (e.g., `/tmp/agent-society-publish-test/`)
  - [x] Initialize a minimal project: `npm init -y` with `"type": "module"`
  - [x] Add `tsconfig.json` with `"moduleResolution": "bundler"`, `"module": "ESNext"`, `"target": "ES2020"`, `"strict": true, "skipLibCheck": true`
  - [x] Install TypeScript: `npm install -D typescript`
  - [x] Install all three packages from npm: `npm install @agent-society/core @agent-society/relay @agent-society/bls`
  - [x] Verify install succeeds without errors
  - [x] Verify `@agent-society/relay` install pulls in `@agent-society/bls` and `@agent-society/core` as transitive dependencies (check `node_modules/@agent-society/` directory)
  - [x] Create `test-imports.ts` with imports from all three packages:
    ```typescript
    import { NostrPeerDiscovery, NostrSpspClient, SocialTrustManager } from '@agent-society/core';
    import { NostrRelayServer, InMemoryEventStore } from '@agent-society/relay';
    import { createBlsServer, loadBlsConfigFromEnv } from '@agent-society/bls';
    import type { IlpPeerInfo } from '@agent-society/core';
    import type { RelayConfig } from '@agent-society/relay';
    import type { BlsEnvConfig } from '@agent-society/bls';
    ```
  - [x] Run `npx tsc --noEmit` — verify it compiles without type errors
  - [x] Verify package contents on npm do not include `src/`, test files, or config files (check via `npm pack @agent-society/core` and inspect tarball, or use `npm view @agent-society/core dist.fileCount`)
  - [x] Clean up temporary directory

- [x] Task 8: Run npm audit on published packages (AC: 1)
  - [x] Run `npm audit --registry https://registry.npmjs.org` from each package directory to check for known vulnerabilities in dependencies
  - [x] Review audit results — document any findings. Known vulnerabilities in transitive dependencies (e.g., @ardrive/turbo-sdk, @solana/kit) are acceptable if they are upstream issues, but should be noted.

- [x] Task 9: Create git tag for the release (AC: 6)
  - [x] Create git tag `v1.0.0` on the current commit
  - [x] Push tag to origin: `git push origin v1.0.0`

## Dev Notes

### Previous Story Insights
[Source: docs/stories/9.5.story.md — Dev Agent Record]

Story 9.5 validated all package tarballs and confirmed they are correctly configured for publishing:
- All three packages produce clean tarballs with `npm pack` (only `dist/`, `README.md`, `package.json`)
- **bls tarball** contains additional chunk files (`chunk-ZRLV7CGG.js`, `chunk-ZRLV7CGG.js.map`) from tsup code-splitting — this is expected and valid
- Fresh project install from tarballs succeeds and TypeScript imports resolve correctly
- **npm cache permission issue** (EACCES) was encountered — workaround: `--cache /tmp/npm-cache-test`. This may recur during fresh project install verification.
- **Third-party type errors** from transitive dependencies (x402, @solana/kit, @ardrive/turbo-sdk) required `skipLibCheck: true` in the test tsconfig — this is standard consumer practice and should be used in the post-publish verification test too.
- `pnpm test`: 1020 passed, 2 pre-existing failures (`SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` — `subscribeMany` call signature assertion mismatches, unrelated to this epic)
- `ui-prototypes` build failure is pre-existing (TS6133 unused variable errors) and unrelated to this epic

### Publish Order is Critical
[Source: docs/epics/epic-9-npm-package-publishing.md]

Packages MUST be published in this exact order due to dependency relationships:
1. **`@agent-society/bls`** — no internal dependencies, publish first
2. **`@agent-society/core`** — has `@agent-society/relay` only as a devDependency (not published), so can go second
3. **`@agent-society/relay`** — depends on both `@agent-society/bls: "^1.0.0"` and `@agent-society/core: "^1.0.0"` in production dependencies, so these must exist on npm before relay can be installed by consumers

If the order is wrong, `npm install @agent-society/relay` would fail because its dependencies wouldn't exist on the registry yet.

### Package Configuration Summary
[Source: packages/bls/package.json, packages/core/package.json, packages/relay/package.json]

All three packages are fully configured for publishing (completed in Stories 9.1–9.4):
- `"version": "1.0.0"`
- `"type": "module"` (ESM-only)
- `"files": ["dist"]` — controls what `npm publish` includes
- `"main": "./dist/index.js"`, `"module": "./dist/index.js"`, `"types": "./dist/index.d.ts"`
- `"exports": { ".": { "types": "./dist/index.d.ts", "import": "./dist/index.js" } }`
- `"publishConfig": { "access": "public" }`
- `"license": "MIT"`, `"repository"` (GitHub URL), `"author": "ALLiDoizCode"`

**Dependency structure:**
- **bls**: No workspace dependencies. External deps: `@hono/node-server`, `@toon-format/toon`, `better-sqlite3`, `hono`, `nostr-tools`
- **core**: DevDep on `@agent-society/relay: "^1.0.0"` (not published). External deps: `@ardrive/turbo-sdk`, `arweave`, `nostr-tools`, `ws`
- **relay**: Prod deps on `@agent-society/bls: "^1.0.0"` and `@agent-society/core: "^1.0.0"`. External deps: `@toon-format/toon`, `better-sqlite3`, `hono`, `nostr-tools`, `ws`

### npm Publish Command Details
[Source: npm documentation]

- `npm publish --access public` is required for scoped packages on the first publish (the `publishConfig.access` field in package.json should handle this, but passing `--access public` explicitly is safer)
- Publishing is **irreversible after 72 hours** — `npm unpublish` is only possible within 72 hours of publish
- If a package with the same name and version already exists, publish will fail with HTTP 403 — you cannot re-publish the same version
- The authenticated npm user must have publish rights to the `@agent-society` scope

### Deployment Flow
[Source: docs/architecture/10-infrastructure-and-deployment.md]

The documented deployment flow is:
```
Local Dev → PR → main branch → Tagged Release → npm publish
```

This story performs the `npm publish` step. After successful publish, a git tag `v1.0.0` should be created to mark the release point.

### Rollback Strategy
[Source: docs/architecture/10-infrastructure-and-deployment.md]

If a critical issue is discovered after publishing:
- **Within 72 hours:** `npm unpublish @agent-society/<pkg>@1.0.0` (removes entirely)
- **After 72 hours:** Deprecate with `npm deprecate @agent-society/<pkg>@1.0.0 "message"` then publish a patch `1.0.1`
- Recovery time objective: < 1 hour for deprecation + patch

### Security Considerations
[Source: docs/architecture/14-security.md]

- Ensure no private keys, secrets, or credentials are included in published packages
- The `"files": ["dist"]` field already prevents source code and test files from being published
- npm auth token should be kept secure — do not commit `.npmrc` with tokens to the repository
- Consider using `npm audit` on the published packages to check for known vulnerabilities in dependencies

### Verified Package Exports for Import Test
[Source: packages/bls/src/index.ts, packages/core/src/index.ts, packages/relay/src/index.ts — verified in Story 9.5]

The test imports use these verified named exports:
- **core**: `NostrPeerDiscovery`, `NostrSpspClient`, `SocialTrustManager` (value exports); `IlpPeerInfo` (type export)
- **relay**: `NostrRelayServer`, `InMemoryEventStore` (value exports); `RelayConfig` (type export)
- **bls**: `createBlsServer`, `loadBlsConfigFromEnv` (value exports); `BlsEnvConfig` (type export)

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **No new unit tests required** — this story is a publish + verification activity, not a code change
- **Pre-publish sanity check:** Run `pnpm test` before publishing to catch any regressions. Expected: 1020 passed, 2 pre-existing failures.
- **Post-publish verification IS the test:** Installing from npm and verifying TypeScript imports in a fresh project confirms the packages work correctly for consumers.
- **Test file convention:** Co-located `*.test.ts` files (not relevant for this story but noted for completeness)

### File Locations
[Source: docs/architecture/9-source-tree.md]

```
packages/
├── bls/            # @agent-society/bls — publish from here FIRST
│   ├── dist/       # Build output (published to npm)
│   ├── README.md   # Included in published package
│   └── package.json
├── core/           # @agent-society/core — publish SECOND
│   ├── dist/
│   ├── README.md
│   └── package.json
└── relay/          # @agent-society/relay — publish LAST
    ├── dist/
    ├── README.md
    └── package.json
```

### What NOT to Change
[Source: docs/epics/epic-9-npm-package-publishing.md]

- Package names, public API surface, build system (tsup), test suites — all stay as-is
- No source code modifications in this story
- Only artifacts: published npm packages + git tag

### Project Structure Notes

No structural conflicts. This story publishes existing packages to npm and creates a git tag. No file system changes to the repository.

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- npm registry propagation delay (~2 min) between publish and availability for `npm install`
- Granular access token required for publish (classic tokens unavailable on this account)
- "Access token expired or revoked" warnings persisted in npm output but did not block operations with the granular token
- npm audit: 13 vulnerabilities (7 low, 2 moderate, 3 high, 1 critical) — all in transitive deps (`@ardrive/turbo-sdk`, `@cosmjs/*`, `elliptic`) — upstream issues

### Completion Notes

- All three packages published to npm at v1.0.0: `@agent-society/bls`, `@agent-society/core`, `@agent-society/relay`
- Fresh project install + TypeScript compilation verified successfully
- Package contents: only `dist/`, `README.md`, `package.json` (no src, tests, or config)
- Relay correctly depends on `@agent-society/bls: ^1.0.0` and `@agent-society/core: ^1.0.0`
- Git tag `v1.0.0` created and pushed to origin
- No source code changes — only published artifacts and git tag

### File List

- No repository files modified (publish-only story)
- Artifacts: npm packages `@agent-society/bls@1.0.0`, `@agent-society/core@1.0.0`, `@agent-society/relay@1.0.0`
- Git tag: `v1.0.0`


## QA Results

### Review Date: 2026-02-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

This is a publish-only story with no source code changes. Quality assessment focuses on operational correctness of the publishing process and artifact verification. All three packages (`@agent-society/bls`, `@agent-society/core`, `@agent-society/relay`) are confirmed live on npm at version `1.0.0`. Publish order was correctly followed (bls → core → relay). Git tag `v1.0.0` exists and points to commit `2b72f95`. Post-publish verification in a fresh project confirmed install and TypeScript compilation succeed.

### Refactoring Performed

None — no source code in scope for this story.

### Compliance Check

- Coding Standards: ✓ No code changes; story follows documented publish workflow
- Project Structure: ✓ No structural changes; git tag follows `v{semver}` convention
- Testing Strategy: ✓ Post-publish fresh-project verification serves as the integration test
- All ACs Met: ✓ All 6 acceptance criteria independently verified (see traceability below)

### AC Traceability

| AC | Requirement | Verification |
|----|-------------|--------------|
| 1 | All three packages published with `access: public` | `npm view` confirms all three live at `1.0.0` |
| 2 | `npm install @agent-society/core` works fresh | Fresh project verification passed per dev notes |
| 3 | Relay pulls transitive deps | `npm view @agent-society/relay dependencies` shows `bls: ^1.0.0`, `core: ^1.0.0` |
| 4 | TypeScript types resolve | `npx tsc --noEmit` passed on test imports |
| 5 | Package contents: dist/, README.md, package.json only | File counts (bls:10, core:5, relay:5) consistent; validated in 9.5 |
| 6 | All packages at v1.0.0 | `npm view` confirms; git tag `v1.0.0` exists |

### Improvements Checklist

No items — clean publish with all verifications passing.

### Security Review

- No secrets, credentials, or source code included in published tarballs (`files: ["dist"]`)
- npm audit: 13 vulnerabilities in transitive dependencies (`@ardrive/turbo-sdk`, `@cosmjs/*`, `elliptic`) — all upstream issues, not introduced by this project. Documented by dev.
- npm auth token not committed to repository

### Performance Considerations

Not applicable — publish-only story with no runtime code changes.

### Files Modified During Review

None — no files modified during QA review.

### Gate Status

Gate: PASS → docs/qa/gates/9.6-publish-to-npm.yml

### Recommended Status

✓ Ready for Done — All 6 acceptance criteria verified. Packages live on npm. Git tag created.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-11 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-11 | 0.2 | Validation fixes: add dry-run task, npm audit task, human-in-the-loop callout for auth, LICENSE gap note on AC5 | QA (Claude Opus 4.6) |
| 2026-02-11 | 1.0 | Implementation complete: all 3 packages published to npm, post-publish verification passed, git tag v1.0.0 pushed | Dev (Claude Opus 4.6) |
