# Story 6.5: Docker Entrypoint Integration

## Status

Done

## Story

**As a** node operator running the full crosstown container,
**I want** the Docker entrypoint to use the new layered discovery system,
**so that** the container bootstraps from genesis/ArDrive and expands via social graph.

## Acceptance Criteria

1. Update `docker/src/entrypoint.ts`:
   - Load genesis peers + query ArDrive registry on startup
   - Run bootstrap with combined static peer list (no SPSP during bootstrap)
   - Start `NostrSpspServer` for handling incoming peering requests from other nodes
   - Start `SocialPeerDiscovery` subscription for dynamic peer expansion
   - Wire connector admin URL from `CONNECTOR_ADMIN_URL` env var
2. New environment variables:
   - `ARDRIVE_ENABLED` (optional, default: `true`): Enable/disable ArDrive peer lookup
   - `ADDITIONAL_PEERS` (optional): JSON array of extra peers beyond genesis list
3. Startup logs show: genesis peers loaded, ArDrive peers found, bootstrap results, social discovery started
4. Graceful shutdown stops social discovery subscription
5. Unit tests for refactored utility functions (`parseConfig`, `createConnectorAdminClient`); full container integration test deferred to future story

## Tasks / Subtasks

- [x] Task 1: Update Config interface and `parseConfig()` for new env vars (AC: 1, 2)
  - [x] Add `ardriveEnabled: boolean` to `Config` interface (parsed from `ARDRIVE_ENABLED` env var, default `true`)
  - [x] Add `additionalPeersJson: string | undefined` to `Config` interface (parsed from `ADDITIONAL_PEERS` env var)
  - [x] Add `relayUrls: string[]` to `Config` interface — initialized to `['ws://localhost:${wsPort}']` (local relay only at config time; bootstrap results' relay URLs are not yet available). `SocialPeerDiscovery` will subscribe to these relays for kind:3 events
  - [x] Remove the `knownPeers: KnownPeer[]` field from `Config` — bootstrap now loads peers from genesis + ArDrive + env var internally via `BootstrapService.loadPeers()` and `BootstrapService.bootstrap(additionalPeersJson)`
  - [x] Update `parseConfig()` to parse the new fields

- [x] Task 2: Update `createConnectorAdminClient()` to match `ConnectorAdminClient` interface (AC: 1)
  - [x] Refactor `createConnectorAdminClient()` to return an object matching the `ConnectorAdminClient` interface from `@crosstown/core`:
    - `addPeer(config: { id: string; url: string; authToken: string; routes?: { prefix: string; priority?: number }[] }): Promise<void>` — `POST /peers` with the config body
    - `removePeer(peerId: string): Promise<void>` — `DELETE /peers/:peerId`
  - [x] Remove the old `addPeer(peerId, btpUrl, ilpAddress)` signature and `addRoute()` method (no longer used)
  - [x] Import `ConnectorAdminClient` type from `@crosstown/core` for type safety

- [x] Task 3: Rewire `main()` bootstrap flow to use `BootstrapService` with layered discovery (AC: 1, 3)
  - [x] Update imports from `@crosstown/core`: keep `BootstrapService`, `NostrSpspServer`, `buildSpspResponseEvent`, `buildIlpPeerInfoEvent`, `parseSpspRequest`, `type IlpPeerInfo`, `type SpspInfo`, `SPSP_REQUEST_KIND`; add `SocialPeerDiscovery`, `type ConnectorAdminClient`; remove `type KnownPeer` if no longer used in Config
  - [x] Remove the old `if (config.knownPeers.length > 0)` / `else` bootstrap logic
  - [x] Create `BootstrapService` with config: `{ knownPeers: [], ardriveEnabled: config.ardriveEnabled, defaultRelayUrl: 'ws://localhost:' + config.wsPort }`, `secretKey`, and `ownIlpInfo`
  - [x] Call `bootstrapService.setConnectorAdmin(adminClient)` with the updated admin client
  - [x] Call `const results = await bootstrapService.bootstrap(config.additionalPeersJson)` — this internally loads genesis peers + ArDrive peers + env var peers, queries kind:10032, and registers via admin API
  - [x] Log genesis peers loaded count, ArDrive peers found count, and total bootstrap results
  - [x] Remove the `discoverPeersViaRelay()` loop (bootstrap now handles all peer sources)
  - [x] Keep the bootstrap node fallback (no peers case): still publish own ILP info to local relay

- [x] Task 4: Start `SocialPeerDiscovery` subscription after bootstrap (AC: 1, 3, 4)
  - [x] After bootstrap completes, create `SocialPeerDiscovery` instance with:
    - `config: { relayUrls: config.relayUrls }` (includes local relay + any peer relay URLs)
    - `secretKey: config.secretKey`
    - `ownIlpInfo` (same as bootstrap)
  - [x] Call `socialDiscovery.setConnectorAdmin(adminClient)`
  - [x] Call `const socialSubscription = socialDiscovery.start()`
  - [x] Log `[Setup] Social graph discovery started`
  - [x] Store `socialSubscription` for graceful shutdown

- [x] Task 5: Update graceful shutdown to stop social discovery (AC: 4)
  - [x] Add `socialSubscription.unsubscribe()` to the `shutdown()` function
  - [x] Ensure shutdown order: social discovery -> SPSP server -> WebSocket relay -> BLS HTTP server
  - [x] Log `[Shutdown] Social discovery stopped`

- [x] Task 6: Verify startup log sequence (AC: 3)
  - [x] Ensure startup logs include in order:
    1. Config summary (node ID, pubkey, ILP address, BTP endpoint)
    2. Service initialization (event store, pricing, BLS, relay, SPSP server)
    3. Bootstrap: genesis peers loaded count, ArDrive peers found count (if enabled), total peers bootstrapped
    4. Social discovery started
    5. "Crosstown Container Ready" banner

- [x] Task 7: Set up test infrastructure for docker package and write unit tests (AC: 5)
  - [x] Add `vitest` to `docker/package.json` devDependencies
  - [x] Add `"test": "vitest run"` script to `docker/package.json`
  - [x] Create `docker/src/entrypoint.test.ts` — co-located test file
  - [x] Test: `parseConfig()` returns correct defaults when only required env vars are set
  - [x] Test: `parseConfig()` parses `ARDRIVE_ENABLED=false` correctly
  - [x] Test: `parseConfig()` parses `ADDITIONAL_PEERS` JSON correctly
  - [x] Test: `createConnectorAdminClient()` returns object matching `ConnectorAdminClient` interface
  - [x] Test: `createConnectorAdminClient().addPeer()` calls `POST /peers` with correct body
  - [x] Test: `createConnectorAdminClient().removePeer()` calls `DELETE /peers/:id`
  - [x] Mock `fetch` for admin API calls using `vi.fn()`
  - [x] Note: Full container boot integration test deferred — requires Docker environment; unit tests cover the refactored functions

## Dev Notes

### Previous Story Insights
[Source: docs/stories/6.4.story.md#dev-agent-record]

From Story 6.4 implementation:
- 840 tests passing (14 in SocialPeerDiscovery.test.ts), 0 failures
- `SocialPeerDiscovery` constructor accepts: `config: SocialPeerDiscoveryConfig`, `secretKey: Uint8Array`, `ownIlpInfo: IlpPeerInfo`, `pool?: SimplePool`, `spspClient?: NostrSpspClient`
- `SocialPeerDiscovery.start()` returns `Subscription` with `unsubscribe()` — calling `unsubscribe()` resets `started` flag, allowing restart
- `SocialPeerDiscovery.setConnectorAdmin(admin: ConnectorAdminClient)` must be called before `start()` to enable peer registration
- `ConnectorAdminClient` interface now includes optional `removePeer?(peerId: string): Promise<void>` — added in Story 6.4
- ESLint has 2 pre-existing lint issues in `bootstrap.ts` (lines 302, 522) — non-blocking
- Peer ID format throughout is `"nostr-{pubkey.slice(0, 16)}"` (16-char hex prefix)
- From Story 6.3: `BootstrapService.bootstrap()` accepts optional `additionalPeersJson` string, loads genesis + ArDrive + env var peers internally, returns `BootstrapResult[]`
- From Story 6.3: `BootstrapService` constructor takes `config: BootstrapConfig` with `{ knownPeers, queryTimeout?, ardriveEnabled?, defaultRelayUrl? }`

### Data Models
[Source: packages/core/src/types.ts, packages/core/src/bootstrap.ts]

**`IlpPeerInfo`** (from `types.ts`):
```typescript
export interface IlpPeerInfo {
  ilpAddress: string;
  btpEndpoint: string;
  settlementEngine?: string;
  assetCode: string;
  assetScale: number;
}
```

**`SpspInfo`** (from `types.ts`):
```typescript
export interface SpspInfo {
  destinationAccount: string;
  sharedSecret: string;
}
```

**`BootstrapConfig`** (from `bootstrap.ts`):
```typescript
export interface BootstrapConfig {
  knownPeers: KnownPeer[];
  queryTimeout?: number;       // default: 5000
  ardriveEnabled?: boolean;    // default: true
  defaultRelayUrl?: string;
}
```

**`BootstrapResult`** (from `bootstrap.ts`):
```typescript
export interface BootstrapResult {
  knownPeer: KnownPeer;
  peerInfo: IlpPeerInfo;
  registeredPeerId: string;  // "nostr-{pubkey16}"
}
```

**`ConnectorAdminClient`** (from `bootstrap.ts`):
```typescript
export interface ConnectorAdminClient {
  addPeer(config: {
    id: string;
    url: string;
    authToken: string;
    routes?: { prefix: string; priority?: number }[];
  }): Promise<void>;
  removePeer?(peerId: string): Promise<void>;
}
```

**`SocialPeerDiscoveryConfig`** (from `discovery/SocialPeerDiscovery.ts`):
```typescript
export interface SocialPeerDiscoveryConfig {
  relayUrls: string[];
  cooldownMs?: number;            // default: 5000
  spspTimeout?: number;           // default: 10000
  removePeersOnUnfollow?: boolean; // default: false
}
```

### API Specifications
[Source: docs/architecture/6-external-apis.md#62-agent-runtime-admin-api]

**Connector Admin API (agent-runtime project):**
- `POST /peers` — Body: `{ id: string, url: string, authToken: string, routes?: [{ prefix: string, priority?: number }] }`
- `DELETE /peers/:id` — Remove a peer by ID
- `GET /peers` — List configured peers
- Base URL: Configured via `CONNECTOR_ADMIN_URL` env var (default: `http://{nodeId}:8081`)

**Note on URL path:** The architecture doc uses `/peers` not `/admin/peers`. The existing entrypoint already uses `${adminUrl}/peers` for POSTs. Maintain this pattern.

### Current Docker Entrypoint Structure
[Source: docker/src/entrypoint.ts]

The current entrypoint at `docker/src/entrypoint.ts` has the following structure that needs updating:
1. **`Config` interface** — Currently includes `knownPeers: KnownPeer[]` parsed from `KNOWN_PEERS` env var. This should be replaced with `ardriveEnabled` and `additionalPeersJson` since `BootstrapService` now handles peer loading internally.
2. **`createConnectorAdminClient()`** — Currently returns `{ addPeer(peerId, btpUrl, ilpAddress), addRoute(prefix, nextHop) }` with old-style signatures. Must be updated to match the `ConnectorAdminClient` interface from core.
3. **`main()` bootstrap section** — Currently has `if (config.knownPeers.length > 0)` branch with manual bootstrap + `discoverPeersViaRelay()` loop, and `else` branch for bootstrap node. Replace with `BootstrapService.bootstrap(additionalPeersJson)`.
4. **`main()` SPSP server** — Already starts `NostrSpspServer` correctly. Keep as-is.
5. **`main()` shutdown** — Currently stops SPSP subscription, relay, and BLS. Add social discovery subscription.

### File Locations
[Source: docs/architecture/9-source-tree.md, docker/]

Files to modify:
- `docker/src/entrypoint.ts` — Main entrypoint refactoring
- `docker/package.json` — Add `vitest` devDependency and `test` script

Files to create:
- `docker/src/entrypoint.test.ts` — Unit tests for refactored functions

Files unchanged:
- `docker/Dockerfile` — No changes needed (already builds correctly)
- `packages/core/src/**` — No changes to core package

### Environment Variables (Complete List)
[Source: docker/src/entrypoint.ts]

**Required:**
- `NODE_ID` — Unique identifier for this node
- `NOSTR_SECRET_KEY` — 64-char hex secret key
- `ILP_ADDRESS` — This node's ILP address (e.g., `g.peer1`)

**Optional with defaults:**
- `BTP_ENDPOINT` — BTP WebSocket endpoint (default: `ws://{NODE_ID}:3000`)
- `BLS_PORT` — HTTP port for BLS (default: `3100`)
- `WS_PORT` — WebSocket port for relay (default: `7100`)
- `CONNECTOR_ADMIN_URL` — Admin API URL (default: `http://{NODE_ID}:8081`)
- `ASSET_CODE` — Asset code (default: `USD`)
- `ASSET_SCALE` — Asset scale (default: `6`)
- `BASE_PRICE_PER_BYTE` — Base price per byte (default: `10`)

**New in Story 6.5 (AC: 2):**
- `ARDRIVE_ENABLED` — Enable/disable ArDrive peer lookup (default: `true`). Parse as `env !== 'false'`.
- `ADDITIONAL_PEERS` — JSON array of extra peers beyond genesis list. Uses `GenesisPeer` format (not `KnownPeer`): `[{ "pubkey": "hex64", "relayUrl": "wss://...", "ilpAddress": "g.xxx", "btpEndpoint": "ws://..." }]`. The `ilpAddress` field is part of `GenesisPeer` but not `KnownPeer` — `BootstrapService.loadPeers()` handles this via `GenesisPeerLoader.loadAllPeers(additionalPeersJson)` which parses the `GenesisPeer` format internally.

**Removed in Story 6.5:**
- `KNOWN_PEERS` — Replaced by genesis peers + ArDrive + `ADDITIONAL_PEERS`. The `BootstrapService.bootstrap()` now handles all peer sources internally.

### Error Handling Pattern
[Source: docs/architecture/11-error-handling-strategy.md, docker/src/entrypoint.ts]

- **Bootstrap failures:** Non-fatal. `BootstrapService.bootstrap()` catches per-peer failures internally and returns only successful results. The entrypoint logs the count.
- **ArDrive failures:** Non-fatal. `BootstrapService` catches ArDrive errors internally (logs warning, continues with genesis peers only).
- **Social discovery errors:** Non-fatal for individual peers. `SocialPeerDiscovery` handles errors per-peer internally. Fatal subscription errors throw `PeerDiscoveryError`.
- **SPSP server errors:** Non-fatal. Already handled by `NostrSpspServer`.
- **Overall startup:** Fatal errors in `main()` are caught by the `.catch()` handler and exit with code 1.

### Scope Boundaries

**In Scope (this story):**
- Refactor Docker entrypoint to use `BootstrapService` with genesis + ArDrive + env var peers
- Start `SocialPeerDiscovery` subscription after bootstrap
- Add `ARDRIVE_ENABLED` and `ADDITIONAL_PEERS` env vars
- Update `createConnectorAdminClient()` to match `ConnectorAdminClient` interface
- Graceful shutdown of social discovery
- Unit tests for refactored functions

**Out of Scope:**
- Changes to `packages/core/` (all components are complete from Stories 6.1-6.4)
- Dockerfile changes (already correct)
- Docker Compose or Kubernetes configurations
- Live ArDrive gateway testing
- Credit limit adjustment from trust scores
- Peer health monitoring

### Testing

**Test Framework:** Vitest 1.x
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Standards:**
- Co-located test file: `docker/src/entrypoint.test.ts`
- Follow AAA pattern (Arrange, Act, Assert)
- Mock `fetch` for admin API calls using `vi.fn()`
- The `docker/` package currently has no test infrastructure — Task 7 adds `vitest` as a devDependency and a `"test": "vitest run"` script to `docker/package.json`. The root workspace vitest config should cover the docker package; if not, create a minimal `docker/vitest.config.ts`.
- **Coverage Goals:** >80% for `parseConfig()` and `createConnectorAdminClient()` utility functions
- **Existing test suite:** 840 tests in core package should continue passing with no regressions.

## File List

| File | Action | Description |
|------|--------|-------------|
| `docker/src/entrypoint.ts` | Modified | Refactored to use BootstrapService with layered discovery + SocialPeerDiscovery |
| `docker/package.json` | Modified | Add vitest devDependency and test script |
| `docker/src/entrypoint.test.ts` | Created | Unit tests for parseConfig and createConnectorAdminClient (15 tests) |
| `docker/vitest.config.ts` | Created | Vitest config for docker package (root config only covers packages/*) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes
- All 7 tasks and all subtasks completed
- 15 new tests in `docker/src/entrypoint.test.ts` — all passing (14 original + 1 QA fix)
- 840 tests in full regression suite — all passing (0 failures)
- ESLint clean on all modified/created files
- `parseConfig()` and `createConnectorAdminClient()` exported for testability; `main()` guarded with `VITEST` env check to prevent auto-execution during tests
- Root vitest config only includes `packages/*/src/**/*.test.ts`, so a local `docker/vitest.config.ts` was created for the docker package
- No changes to `packages/core/` — all core components used as-is from Stories 6.1-6.4
- QA fix: Added `DockerConnectorAdminClient` interface extending `ConnectorAdminClient` with non-optional `removePeer`, eliminating type casts in tests
- QA fix: Added missing `parseConfig()` test for `ILP_ADDRESS` required env var validation

## QA Results

### Review Date: 2026-02-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Strong implementation. The Docker entrypoint has been cleanly refactored to use the layered discovery system (BootstrapService with genesis + ArDrive + env var) and SocialPeerDiscovery for dynamic expansion. Code is well-structured, follows AAA test patterns, and properly matches the interfaces defined in `@crosstown/core`. The separation of exported utility functions (`parseConfig`, `createConnectorAdminClient`) from the non-exported `main()` is a good pattern for testability.

The diff is ~330 lines — moderate but well within the refactoring scope of this story. No security/auth/payment files are directly modified (the docker entrypoint orchestrates them but doesn't alter their logic).

### Refactoring Performed

No refactoring performed — the implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ — Co-located test file, Vitest 1.x, AAA pattern, proper mocking
- Project Structure: ✓ — `docker/src/entrypoint.test.ts` co-located, `docker/vitest.config.ts` correctly created since root config only covers `packages/*/src/**/*.test.ts`
- Testing Strategy: ✓ — 14 unit tests covering `parseConfig()` and `createConnectorAdminClient()`, full container integration deferred per AC 5, >80% coverage for utility functions
- All ACs Met: ✓ — See trace below

### AC Traceability

- **AC 1** (Entrypoint refactoring): ✓ Genesis/ArDrive loaded via `BootstrapService.bootstrap()`, `NostrSpspServer` started, `SocialPeerDiscovery` started, `CONNECTOR_ADMIN_URL` wired via `createConnectorAdminClient()`
- **AC 2** (New env vars): ✓ `ARDRIVE_ENABLED` parsed as `env !== 'false'` (default true), `ADDITIONAL_PEERS` passed through as JSON string to `BootstrapService.bootstrap()`
- **AC 3** (Startup logs): ✓ Log sequence: config summary → service init → bootstrap results → social discovery started → "Crosstown Container Ready" banner
- **AC 4** (Graceful shutdown): ✓ `socialSubscription.unsubscribe()` called first in shutdown handler, followed by SPSP → relay → BLS
- **AC 5** (Unit tests): ✓ 14 tests for `parseConfig()` (9 tests) and `createConnectorAdminClient()` (5 tests); integration test explicitly deferred

### Improvements Checklist

- [x] All 14 docker tests passing
- [x] Full regression suite (840 tests) green — 0 regressions
- [x] `VITEST` env guard prevents `main()` auto-execution during testing
- [ ] Consider adding `parseConfig()` test for missing `ILP_ADDRESS` env var (covers the third required var; NODE_ID and NOSTR_SECRET_KEY already tested)
- [ ] The `removePeer` cast in test line 203/220 (`as (id: string) => Promise<void>`) works around the optional `removePeer?` in `ConnectorAdminClient` — consider declaring `removePeer` as non-optional in docker's implementation type since it always implements it
- [ ] Pre-existing: TS7016 declaration file error when type-checking docker package standalone (needs core's `.d.ts` built first) — not introduced by this story

### Security Review

No security concerns. The entrypoint does not introduce new attack surfaces. Admin API calls use the existing `CONNECTOR_ADMIN_URL` pattern. No secrets are logged. The `NOSTR_SECRET_KEY` is validated for correct length before use. `ADDITIONAL_PEERS` is passed through to `BootstrapService` which handles parsing/validation internally.

### Performance Considerations

No performance concerns. Bootstrap and social discovery run sequentially (appropriate for startup). The 500ms relay warmup delay is a pre-existing pattern. `SocialPeerDiscovery` has configurable cooldown to prevent relay flooding.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/6.5-docker-entrypoint-integration.yml

### Recommended Status

✓ Ready for Done — All acceptance criteria met, all tests passing, no regressions. The unchecked items above are minor improvements, not blockers.

(Story owner decides final status)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-07 | 0.2 | QA validation fixes: AC5 wording, test infrastructure task, imports folded into Tasks 3/4, relayUrls and ADDITIONAL_PEERS format clarified | SM (Claude Opus 4.6) |
| 2026-02-08 | 1.0 | Implementation complete: all 7 tasks done, 14 tests passing, full regression green (840/840) | Dev (Claude Opus 4.6) |
| 2026-02-08 | 1.1 | QA fixes applied: added ILP_ADDRESS validation test, introduced DockerConnectorAdminClient interface to remove removePeer type casts (15 tests passing) | Dev (Claude Opus 4.6) |
