# Story 7.2: Extend SPSP Request/Response with Settlement Negotiation

## Status

Done

## Story

**As a** peer initiating an SPSP handshake,
**I want** to include my settlement preferences in the SPSP request (kind:23194) and receive the negotiated chain in the response (kind:23195),
**so that** both peers agree on a settlement chain during the handshake.

## Acceptance Criteria

1. `SpspRequest` and `SpspResponse` in `types.ts` extended with settlement fields
2. `buildSpspRequestEvent()` includes settlement preferences in encrypted payload
3. `buildSpspResponseEvent()` includes negotiated chain and channel info
4. NIP-44 encryption preserved for both request and response
5. Backward compatible: responses without settlement fields parse as basic SPSP
6. Unit tests for builders, parsers, encryption round-trip with new fields

## Tasks / Subtasks

- [x] Task 1: Extend `SpspRequest` interface in `types.ts` (AC: 1)
  - [x] Add `ilpAddress?: string` optional field — the requester's ILP address for the responder to know who is requesting
  - [x] Add `supportedChains?: string[]` optional field — array of chain identifiers the requester supports (same format as `IlpPeerInfo.supportedChains`: `{blockchain}:{network}:{chainId}`)
  - [x] Add `settlementAddresses?: Record<string, string>` optional field — maps chain identifier to the requester's settlement address on that chain
  - [x] Add `preferredTokens?: Record<string, string>` optional field — maps chain identifier to the requester's preferred token contract address
  - [x] All new fields optional to maintain backward compat with existing SPSP requests that have no settlement info

- [x] Task 2: Extend `SpspResponse` interface in `types.ts` (AC: 1)
  - [x] Add `negotiatedChain?: string` optional field — the agreed-upon chain identifier (e.g., `"evm:base:8453"`)
  - [x] Add `settlementAddress?: string` optional field — the responder's settlement address on the negotiated chain
  - [x] Add `tokenAddress?: string` optional field — token contract address on the negotiated chain (EVM)
  - [x] Add `tokenNetworkAddress?: string` optional field — TokenNetwork contract address on the negotiated chain (EVM)
  - [x] Add `channelId?: string` optional field — payment channel ID if opened during handshake
  - [x] Add `settlementTimeout?: number` optional field — challenge period in seconds
  - [x] All new fields optional to maintain backward compat with existing SPSP responses

- [x] Task 3: Update `buildSpspRequestEvent()` in `builders.ts` (AC: 2, 4)
  - [x] Add optional `settlementInfo` parameter to `buildSpspRequestEvent()` — an object with `{ ilpAddress?: string, supportedChains?: string[], settlementAddresses?: Record<string, string>, preferredTokens?: Record<string, string> }`
  - [x] When `settlementInfo` is provided, spread its fields into the `SpspRequest` payload before encryption
  - [x] When `settlementInfo` is not provided, behavior is identical to current (backward compat)
  - [x] NIP-44 encryption still applied to the full payload including settlement fields
  - [x] Update `SpspRequestEventResult` interface if needed (no changes expected — it returns `{ event, requestId }`)

- [x] Task 4: Update `buildSpspResponseEvent()` in `builders.ts` (AC: 3, 4)
  - [x] No signature change needed — the function already accepts `response: SpspResponse`, and since the interface is extended with optional fields, callers can pass the new fields when constructing the `SpspResponse` object
  - [x] Verify that `JSON.stringify(response)` serializes all new optional fields when present
  - [x] NIP-44 encryption still applied to the full payload including settlement fields

- [x] Task 5: Update `parseSpspRequest()` in `parsers.ts` (AC: 5)
  - [x] After existing `requestId` and `timestamp` validation, parse new settlement fields from decrypted payload
  - [x] Parse `ilpAddress`: if present, validate it is a non-empty string. If not present, leave as `undefined`
  - [x] Parse `supportedChains`: if present, validate it is an array of strings where each entry passes `validateChainId()`. If not present, leave as `undefined`. If not an array, throw `InvalidEventError('supportedChains must be an array')`
  - [x] Parse `settlementAddresses`: if present, validate it is a `Record<string, string>` using `isObject()`. Keys must pass `validateChainId()`. Values must be non-empty strings. If not present, leave as `undefined`. If not an object, throw `InvalidEventError('settlementAddresses must be an object')`. If any value is not a non-empty string, throw `InvalidEventError('settlementAddresses values must be non-empty strings')`
  - [x] Parse `preferredTokens`: if present, validate it is a `Record<string, string>` using `isObject()`. If not present, leave as `undefined`. If not an object, throw `InvalidEventError('preferredTokens must be an object')`
  - [x] If `supportedChains` contains invalid chain IDs, throw `InvalidEventError('Invalid chain identifier in SPSP request: {chainId}')`
  - [x] Return all new fields in the parsed `SpspRequest` (only fields that were present in the payload)
  - [x] Backward compat: existing requests without new fields parse successfully (all new fields `undefined`)

- [x] Task 6: Update `parseSpspResponse()` in `parsers.ts` (AC: 5)
  - [x] After existing `requestId`, `destinationAccount`, `sharedSecret` validation, parse new settlement fields
  - [x] Parse `negotiatedChain`: if present, validate it is a non-empty string that passes `validateChainId()`. If not present, leave as `undefined`
  - [x] Parse `settlementAddress`: if present, validate it is a non-empty string. If not present, leave as `undefined`
  - [x] Parse `tokenAddress`: if present, validate it is a string. If not present, leave as `undefined`
  - [x] Parse `tokenNetworkAddress`: if present, validate it is a string. If not present, leave as `undefined`
  - [x] Parse `channelId`: if present, validate it is a non-empty string. If not present, leave as `undefined`
  - [x] Parse `settlementTimeout`: if present, validate it is a positive integer (`Number.isInteger(x) && x > 0`). If not present, leave as `undefined`. If not a positive integer, throw `InvalidEventError('settlementTimeout must be a positive integer')`
  - [x] If `negotiatedChain` is present but fails `validateChainId()`, throw `InvalidEventError('Invalid negotiatedChain: {value}')`
  - [x] Return all new fields in the parsed `SpspResponse` (only fields that were present in the payload)
  - [x] Backward compat: existing responses without new fields parse successfully (all new fields `undefined`)

- [x] Task 7: Write unit tests for `buildSpspRequestEvent` with settlement fields (AC: 2, 4, 6)
  - [x] Add tests in `packages/core/src/events/builders.test.ts`
  - [x] Test: `buildSpspRequestEvent` with settlement info includes all settlement fields in encrypted payload
  - [x] Test: `buildSpspRequestEvent` with only `supportedChains` and `settlementAddresses` (no `preferredTokens`) serializes correctly
  - [x] Test: `buildSpspRequestEvent` without settlement info produces identical output to current behavior
  - [x] Test: settlement fields are NIP-44 encrypted (not visible in event.content as plaintext)
  - [x] Test: signature verification passes with settlement fields present

- [x] Task 8: Write unit tests for `buildSpspResponseEvent` with settlement fields (AC: 3, 4, 6)
  - [x] Add tests in `packages/core/src/events/builders.test.ts`
  - [x] Test: `buildSpspResponseEvent` with all settlement fields serializes correctly
  - [x] Test: `buildSpspResponseEvent` with only `negotiatedChain` and `settlementAddress` (no optional EVM fields) serializes correctly
  - [x] Test: `buildSpspResponseEvent` without settlement fields produces identical output to current behavior
  - [x] Test: settlement fields are NIP-44 encrypted
  - [x] Test: signature verification passes with settlement fields present

- [x] Task 9: Write unit tests for `parseSpspRequest` with settlement fields (AC: 5, 6)
  - [x] Add tests in `packages/core/src/events/parsers.test.ts`
  - [x] Test: parses request with all settlement fields
  - [x] Test: parses request with only `supportedChains` and `settlementAddresses`
  - [x] Test: backward compat — parses request without any settlement fields (all new fields `undefined`)
  - [x] Test: throws `InvalidEventError` for invalid chain ID in `supportedChains`
  - [x] Test: throws `InvalidEventError` for non-array `supportedChains`
  - [x] Test: throws `InvalidEventError` for non-object `settlementAddresses`
  - [x] Test: throws `InvalidEventError` for `settlementAddresses` with non-string values
  - [x] Test: round-trip (build with settlement → parse) preserves all settlement fields

- [x] Task 10: Write unit tests for `parseSpspResponse` with settlement fields (AC: 5, 6)
  - [x] Add tests in `packages/core/src/events/parsers.test.ts`
  - [x] Test: parses response with all settlement fields
  - [x] Test: parses response with only `negotiatedChain` and `settlementAddress`
  - [x] Test: backward compat — parses response without any settlement fields (all new fields `undefined`)
  - [x] Test: throws `InvalidEventError` for invalid `negotiatedChain` format
  - [x] Test: throws `InvalidEventError` for non-integer `settlementTimeout`
  - [x] Test: round-trip (build with settlement → parse) preserves all settlement fields

- [x] Task 11: Write round-trip encryption tests (AC: 4, 6)
  - [x] Add tests in `packages/core/src/events/builders.test.ts`
  - [x] Import `parseSpspRequest` from `./parsers.js` in `builders.test.ts` (currently only `parseIlpPeerInfo` and `parseSpspResponse` are imported — `parseSpspRequest` is needed for request round-trip tests)
  - [x] Test: SPSP request build → parse round-trip preserves settlement fields through NIP-44 encryption
  - [x] Test: SPSP response build → parse round-trip preserves settlement fields through NIP-44 encryption
  - [x] Test: SPSP request build → parse round-trip without settlement fields still works

- [x] Task 12: Verify no regressions in existing SPSP client/server tests (AC: 5)
  - [x] Run `pnpm test` — all existing tests must pass (863+ tests) plus new tests
  - [x] Run `pnpm lint` — no new lint errors
  - [x] Verify existing `NostrSpspClient.test.ts` passes unchanged (client constructs basic requests without settlement)
  - [x] Verify existing `NostrSpspServer.test.ts` passes unchanged (server processes basic requests/responses)
  - [x] Verify existing `parseSpspRequest` and `parseSpspResponse` tests pass unchanged (backward compat)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/7.1.story.md#dev-agent-record]

From Story 7.1 (Extend IlpPeerInfo with Settlement Capabilities):
- 863 tests passing, 0 failures
- ESLint: 3 pre-existing errors (none introduced by this story)
- `validateChainId` is now exported from `parsers.ts`, `events/index.ts`, and the package root `index.ts` — reuse it in this story for chain ID validation in SPSP request/response parsing
- `buildIlpPeerInfoEvent` uses `JSON.stringify(info)` so new fields are automatically serialized — the same pattern applies to `buildSpspResponseEvent` which uses `JSON.stringify(response)`
- `buildSpspRequestEvent` constructs the `SpspRequest` payload internally (not passed as a parameter), so it needs a new parameter to accept settlement info
- Both builders and parsers use NIP-44 encryption via `nip44.getConversationKey()` / `nip44.encrypt()` / `nip44.decrypt()` from `nostr-tools`

### Data Models
[Source: packages/core/src/types.ts]

**Current `SpspRequest` interface (to be extended):**
```typescript
export interface SpspRequest {
  requestId: string;
  timestamp: number;
}
```

**Target `SpspRequest` interface (after this story):**
```typescript
export interface SpspRequest {
  requestId: string;
  timestamp: number;
  // New settlement fields (all optional for backward compat)
  ilpAddress?: string;
  supportedChains?: string[];
  settlementAddresses?: Record<string, string>;
  preferredTokens?: Record<string, string>;
}
```

**Current `SpspResponse` interface (to be extended):**
```typescript
export interface SpspResponse {
  requestId: string;
  destinationAccount: string;
  sharedSecret: string;
}
```

**Target `SpspResponse` interface (after this story):**
```typescript
export interface SpspResponse {
  requestId: string;
  destinationAccount: string;
  sharedSecret: string;
  // New settlement fields (all optional for backward compat)
  negotiatedChain?: string;
  settlementAddress?: string;
  tokenAddress?: string;
  tokenNetworkAddress?: string;
  channelId?: string;
  settlementTimeout?: number;
}
```

**Note:** All new fields are optional on both interfaces so that:
1. Existing code constructing `SpspRequest`/`SpspResponse` objects (`NostrSpspClient`, `NostrSpspServer`) continues to compile without changes
2. Existing events in the wild without settlement fields parse correctly
3. Story 7.3 (Settlement Negotiation in SPSP Server) will populate these fields when settlement negotiation is performed
[Source: docs/epics/epic-7-spsp-settlement-negotiation.md#story-72]

**Chain Identifier Format (from Story 7.1):**
- Pattern: `{blockchain}:{network}` or `{blockchain}:{network}:{chainId}`
- EVM: `evm:base:8453`, XRP: `xrp:mainnet`, Aptos: `aptos:mainnet:1`
- Validated by `validateChainId()` from `parsers.ts`
[Source: packages/core/src/events/parsers.ts#validateChainId]

### API Specifications

No external API changes in this story. This story only modifies the SPSP event payload structures (kind:23194 and kind:23195). The connector Admin API is not affected.
[Source: docs/architecture/6-external-apis.md#62-agent-runtime-admin-api]

### Component Specifications

**`NostrSpspClient` (`packages/core/src/spsp/NostrSpspClient.ts`):**
- Currently calls `buildSpspRequestEvent(recipientPubkey, secretKey)` — after this story, the builder accepts an optional third parameter for settlement info
- The client does NOT need modification in this story — it will be updated in a future story when it needs to pass settlement preferences
- Existing tests must continue passing unchanged

**`NostrSpspServer` (`packages/core/src/spsp/NostrSpspServer.ts`):**
- Currently constructs `SpspResponse` with only `requestId`, `destinationAccount`, `sharedSecret`
- After this story, it can optionally include settlement fields — but the server does NOT need modification in this story
- Story 7.3 will update the server to populate settlement response fields
- Existing tests must continue passing unchanged
[Source: docs/architecture/5-components.md, packages/core/src/spsp/]

### File Locations
[Source: docs/architecture/9-source-tree.md, packages/core/src/]

Files to modify:
- `packages/core/src/types.ts` — Extend `SpspRequest` and `SpspResponse` interfaces with settlement fields
- `packages/core/src/events/builders.ts` — Update `buildSpspRequestEvent()` to accept optional settlement info parameter
- `packages/core/src/events/parsers.ts` — Update `parseSpspRequest()` and `parseSpspResponse()` to parse/validate new settlement fields
- `packages/core/src/events/builders.test.ts` — Add builder tests for SPSP with settlement fields, round-trip encryption tests
- `packages/core/src/events/parsers.test.ts` — Add parser tests for SPSP with settlement fields, backward compat, validation errors

Files NOT modified:
- `packages/core/src/events/index.ts` — No new exports needed (existing builder/parser exports cover the changes)
- `packages/core/src/index.ts` — No new exports needed (`SpspRequest` and `SpspResponse` types already exported)
- `packages/core/src/constants.ts` — No new event kinds (same kind:23194, kind:23195)
- `packages/core/src/errors.ts` — `InvalidEventError` already exists and is sufficient
- `packages/core/src/spsp/NostrSpspClient.ts` — Not modified (will be updated in Story 7.3 or later)
- `packages/core/src/spsp/NostrSpspServer.ts` — Not modified (will be updated in Story 7.3)
- `packages/core/src/spsp/NostrSpspClient.test.ts` — Not modified (must pass unchanged for backward compat)
- `packages/core/src/spsp/NostrSpspServer.test.ts` — Not modified (must pass unchanged for backward compat)

### Technical Constraints
[Source: docs/architecture/payment-channel-reference.md]

**Settlement address formats (for reference — not validated in this story, stored as opaque strings):**
- EVM: `0x`-prefixed 40-char hex (42 chars total)
- XRP: `r`-prefixed base58 address
- Aptos: `0x`-prefixed 64-char hex (66 chars total)

**Builder pattern:**
- `buildSpspRequestEvent` constructs the payload internally (`const payload: SpspRequest = { requestId, timestamp }`) — it needs a new parameter to merge in settlement fields
- `buildSpspResponseEvent` accepts the full `SpspResponse` object from the caller, so new optional fields on the interface are automatically serialized via `JSON.stringify(response)` — no code change to the builder logic itself, only verify behavior

**NIP-44 encryption constraint:** All SPSP payloads (including new settlement fields) are encrypted before being placed in the Nostr event content. The settlement data must never appear as plaintext in the event.
[Source: packages/core/src/events/builders.ts]

### Scope Boundaries

**In Scope:**
- Extending `SpspRequest` and `SpspResponse` type interfaces with settlement fields
- Updating `buildSpspRequestEvent` to accept optional settlement info
- Updating parsers to validate and return new settlement fields
- Backward compat: requests/responses without new fields parse correctly
- Unit tests for all new behavior

**Out of Scope:**
- Updating `NostrSpspClient` to pass settlement preferences (Story 7.3+)
- Updating `NostrSpspServer` to perform settlement negotiation (Story 7.3)
- Opening payment channels during SPSP (Story 7.3)
- Modifying any service/class that uses SPSP (client, server)
- Chain matching / negotiation logic (Story 7.3)
- Blockchain address format validation (addresses stored as opaque strings)

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md, packages/core/src/errors.ts]

- Use existing `InvalidEventError` class for validation failures in parsers
- Error pattern: `throw new InvalidEventError('descriptive message')` — same as existing SPSP parsers
- No new error classes needed

### Testing

**Test Framework:** Vitest 1.x
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Standards:**
- Co-located test files: `builders.test.ts` and `parsers.test.ts` (already exist)
- Follow AAA pattern (Arrange, Act, Assert) — same as existing tests
- Use `generateSecretKey()` and `getPublicKey()` from `nostr-tools/pure` for test key generation
- Use `nip44.getConversationKey()`, `nip44.encrypt()`, `nip44.decrypt()` from `nostr-tools` for encryption round-trip tests
- Use `createMockEvent()` helper (already in `parsers.test.ts`) for error case tests
- Use `createEncryptedSpspRequestEvent()` helper (already in `parsers.test.ts`) for request parser tests
- Use `createEncryptedSpspResponseEvent()` helper (already in `parsers.test.ts`) for response parser tests
- Mock `SimplePool` where needed (not applicable for this story — no relay interactions in builders/parsers)
- Coverage: >80% for new parsing/validation code

**Existing test fixtures (do NOT modify — existing tests depend on them):**
- `createEncryptedSpspRequestEvent()` in `parsers.test.ts` — creates basic request without settlement fields
- `createEncryptedSpspResponseEvent()` in `parsers.test.ts` — creates basic response without settlement fields
- `createEncryptedResponseEvent()` in `builders.test.ts` — creates response for round-trip tests
- `testResponse` constant in `builders.test.ts` — basic `SpspResponse` without settlement fields

**New test fixtures to add (alongside existing ones):**
- `createTestSpspRequestWithSettlement()` — returns `SpspRequest` with all new settlement fields
- `createTestSpspResponseWithSettlement()` — returns `SpspResponse` with all new settlement fields

**Test count expectation:** ~20-25 new tests across builders.test.ts and parsers.test.ts

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/types.ts` | Modified | Extend SpspRequest with ilpAddress, supportedChains, settlementAddresses, preferredTokens; extend SpspResponse with negotiatedChain, settlementAddress, tokenAddress, tokenNetworkAddress, channelId, settlementTimeout |
| `packages/core/src/events/builders.ts` | Modified | Add SpspRequestSettlementInfo interface; update buildSpspRequestEvent to accept optional settlement info parameter |
| `packages/core/src/events/parsers.ts` | Modified | Update parseSpspRequest and parseSpspResponse to parse/validate new settlement fields |
| `packages/core/src/events/index.ts` | Modified | Export new SpspRequestSettlementInfo type |
| `packages/core/src/index.ts` | Modified | Export new SpspRequestSettlementInfo type from package root |
| `packages/core/src/events/builders.test.ts` | Modified | Add builder tests and round-trip encryption tests for SPSP with settlement fields (16 new tests) |
| `packages/core/src/events/parsers.test.ts` | Modified | Add parser tests, backward compat tests, validation error tests for SPSP with settlement fields (13 new tests) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered during implementation.

### Completion Notes
- 890 tests passing (27 new tests added), 0 failures
- ESLint: 3 pre-existing errors (none introduced by this story) — same as Story 7.1
- DTS build has a pre-existing error in `SocialPeerDiscovery.ts` (not related to this story)
- `SpspRequestSettlementInfo` interface was added to `builders.ts` and exported from `events/index.ts` and package root `index.ts` for consumer use
- `buildSpspResponseEvent` required no code changes — `JSON.stringify(response)` automatically serializes the new optional fields on `SpspResponse`
- `buildSpspRequestEvent` now accepts an optional third parameter `settlementInfo?: SpspRequestSettlementInfo` which gets spread into the payload
- All validation in parsers uses `InvalidEventError` with descriptive messages matching story specifications exactly
- Backward compatibility verified: all pre-existing tests pass unchanged, requests/responses without settlement fields parse correctly
- No new dependencies added

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-08 | 0.2 | QA validation fixes: explicit error messages for Task 5 settlementAddresses/supportedChains/preferredTokens validation; added parseSpspRequest import note to Task 11 | QA (Claude Opus 4.6) |
| 2026-02-08 | 0.3 | Task 6: added explicit error message and validation logic for settlementTimeout | QA (Claude Opus 4.6) |
| 2026-02-08 | 1.0 | Implementation complete: all 12 tasks done, 890 tests passing (27 new), 0 failures | Dev (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. The code follows existing patterns precisely, maintaining consistency with the Story 7.1 settlement field extensions on `IlpPeerInfo`. All 6 acceptance criteria are fully met with comprehensive test coverage (27 new tests across builders and parsers). The implementation is clean, minimal, and well-documented.

Key strengths:
- **Backward compatibility** rigorously maintained — all pre-existing tests pass unchanged
- **Validation consistency** — `parseSpspRequest` reuses the same `validateChainId()` function and `isObject()` guard established in Story 7.1's `parseIlpPeerInfo`
- **Encryption correctness** — NIP-44 encryption verified through round-trip tests for both request and response paths
- **Minimal surface area** — `buildSpspResponseEvent` required zero code changes since `JSON.stringify(response)` naturally serializes optional fields; only `buildSpspRequestEvent` needed the new parameter
- **Clean type design** — `SpspRequestSettlementInfo` interface mirrors the settlement fields on `SpspRequest` without duplication, providing a focused builder parameter type

### Refactoring Performed

No refactoring required. The implementation is clean and follows established patterns. The code is well-structured with appropriate separation of concerns.

### Compliance Check

- Coding Standards: ✓ TypeScript strict, camelCase functions, PascalCase interfaces, no `any` usage, nostr-tools types used throughout
- Project Structure: ✓ Co-located test files, exports from `events/index.ts` and package root `index.ts`
- Testing Strategy: ✓ Vitest, AAA pattern, co-located tests, >80% coverage of new code, proper fixtures
- All ACs Met: ✓ All 6 acceptance criteria verified (see traceability below)

**AC Traceability:**
1. **AC1** (types extended): `SpspRequest` has 4 new optional fields, `SpspResponse` has 6 new optional fields in `types.ts:45-83`
2. **AC2** (builder includes settlement prefs): `buildSpspRequestEvent` accepts `settlementInfo?: SpspRequestSettlementInfo` and spreads into payload (`builders.ts:65-94`)
3. **AC3** (response includes negotiated chain): `buildSpspResponseEvent` accepts `SpspResponse` with optional settlement fields — verified via decrypt-and-inspect tests
4. **AC4** (NIP-44 preserved): Encryption round-trip tests confirm settlement fields survive NIP-44 encrypt/decrypt cycle; plaintext never appears in `event.content`
5. **AC5** (backward compatible): Dedicated backward-compat tests in both `parsers.test.ts` and `builders.test.ts` confirm requests/responses without settlement fields parse correctly with all new fields `undefined`
6. **AC6** (unit tests): 27 new tests across builders (16) and parsers (13) covering happy paths, partial fields, backward compat, validation errors, and round-trips

### Improvements Checklist

- [x] All settlement fields properly validated in parsers
- [x] Chain ID validation reuses existing `validateChainId()` from Story 7.1
- [x] `SpspRequestSettlementInfo` type exported from `events/index.ts` and package root
- [x] Round-trip encryption tests cover both request and response paths
- [x] Backward compatibility verified for both parsers
- [ ] Consider adding validation for `settlementAddresses` keys matching `supportedChains` entries (future story — cross-field validation is out of scope for this story per Scope Boundaries)
- [ ] Consider adding `preferredTokens` key validation against `supportedChains` (same — future story)

### Security Review

No security concerns. All settlement data (addresses, chain IDs, tokens) is NIP-44 encrypted before being placed in Nostr event content. The encryption round-trip tests explicitly verify that settlement field values do not appear as plaintext in `event.content`. No new attack surface introduced — the parser validates all new fields defensively using existing `InvalidEventError` patterns.

### Performance Considerations

No performance concerns. The new validation code adds O(n) iteration over `supportedChains` and `settlementAddresses` entries, where n is the number of chains (typically 1-5). Chain ID validation via `validateChainId()` is O(1) per entry. No additional network calls, allocations, or blocking operations introduced.

### Files Modified During Review

No files modified during review. Implementation is clean as-is.

### Gate Status

Gate: PASS → docs/qa/gates/7.2-extend-spsp-request-response-settlement-negotiation.yml

### Recommended Status

✓ Ready for Done
