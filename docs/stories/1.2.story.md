# Story 1.2: Event Kind Constants and Type Definitions

## Status

Done

## Story

**As a** library consumer,
**I want** TypeScript types and constants for all ILP-related Nostr event kinds,
**so that** I can work with strongly-typed event data.

## Acceptance Criteria

1. Constants exported for event kinds: `ILP_PEER_INFO = 10032`, `SPSP_INFO = 10047`, `SPSP_REQUEST = 23194`, `SPSP_RESPONSE = 23195`
2. TypeScript interface `IlpPeerInfo` defined with fields: `ilpAddress`, `btpEndpoint`, `settlementEngine`, `assetCode`, `assetScale`
3. TypeScript interface `SpspInfo` defined with fields: `destinationAccount`, `sharedSecret`
4. TypeScript interface `SpspRequest` defined for dynamic SPSP requests
5. TypeScript interface `SpspResponse` defined for dynamic SPSP responses
6. All interfaces exported from `@crosstown/core`
7. Unit tests verify type exports are accessible

## Tasks / Subtasks

- [x] Task 1: Create event kind constants file (AC: 1)
  - [x] Create `packages/core/src/constants.ts`
  - [x] Define `ILP_PEER_INFO_KIND = 10032` constant
  - [x] Define `SPSP_INFO_KIND = 10047` constant
  - [x] Define `SPSP_REQUEST_KIND = 23194` constant
  - [x] Define `SPSP_RESPONSE_KIND = 23195` constant
  - [x] Export all constants

- [x] Task 2: Create IlpPeerInfo interface (AC: 2)
  - [x] Create `packages/core/src/types.ts`
  - [x] Define `IlpPeerInfo` interface with:
    - `ilpAddress: string` - ILP address of the peer's connector
    - `btpEndpoint: string` - BTP WebSocket endpoint URL
    - `settlementEngine?: string` - Optional settlement engine identifier
    - `assetCode: string` - Asset code (e.g., "USD", "XRP")
    - `assetScale: number` - Asset scale (decimal places)

- [x] Task 3: Create SpspInfo interface (AC: 3)
  - [x] Define `SpspInfo` interface with:
    - `destinationAccount: string` - ILP address to send payment to
    - `sharedSecret: string` - Base64-encoded shared secret for STREAM

- [x] Task 4: Create SpspRequest interface (AC: 4)
  - [x] Define `SpspRequest` interface with:
    - `requestId: string` - Unique request identifier
    - `timestamp: number` - Request timestamp

- [x] Task 5: Create SpspResponse interface (AC: 5)
  - [x] Define `SpspResponse` interface with:
    - `requestId: string` - Matching request identifier
    - `destinationAccount: string` - ILP address
    - `sharedSecret: string` - Base64-encoded shared secret

- [x] Task 6: Update package exports (AC: 6)
  - [x] Update `packages/core/src/index.ts` to export all constants from `constants.ts`
  - [x] Update `packages/core/src/index.ts` to export all interfaces from `types.ts`

- [x] Task 7: Write unit tests (AC: 7)
  - [x] Create `packages/core/src/constants.test.ts`
  - [x] Test that all event kind constants have expected values
  - [x] Create `packages/core/src/types.test.ts`
  - [x] Test that all interfaces are exported and can be used for type checking
  - [x] Verify exports are accessible via `@crosstown/core` package entry point

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.1.story.md#dev-agent-record]

- Monorepo structure is now in place with `packages/core`, `packages/relay`, `packages/examples`
- Uses pnpm workspaces with `workspace:*` protocol for internal dependencies
- All packages use ESM (`"type": "module"`)
- TypeScript strict mode is enabled with additional safety flags (`noUncheckedIndexedAccess`, `noImplicitOverride`)
- Placeholder `packages/core/src/index.ts` exists and should be updated

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create for this story:
```
packages/core/src/
├── constants.ts           # Event kind constants (new)
├── types.ts               # TypeScript interfaces (new)
├── constants.test.ts      # Tests for constants (new)
├── types.test.ts          # Tests for types (new)
└── index.ts               # Package exports (update existing)
```

### Data Models
[Source: docs/architecture/4-data-models.md]

**IlpPeerInfo:**
- `ilpAddress`: string - ILP address of the peer's connector
- `btpEndpoint`: string - BTP WebSocket endpoint URL
- `settlementEngine`: string | undefined - Settlement engine identifier
- `assetCode`: string - Asset code (e.g., "USD", "XRP")
- `assetScale`: number - Asset scale (decimal places)

**SpspInfo:**
- `destinationAccount`: string - ILP address to send payment to
- `sharedSecret`: string - Base64-encoded shared secret for STREAM

**SpspRequest:**
- `requestId`: string - Unique request identifier
- `timestamp`: number - Request timestamp

**SpspResponse:**
- `requestId`: string - Matching request identifier
- `destinationAccount`: string - ILP address
- `sharedSecret`: string - Base64-encoded shared secret

### Event Kinds
[Source: CLAUDE.md#event-kinds-proposed-nips]

| Kind | Name | Purpose |
|------|------|---------|
| `10032` | ILP Peer Info | Replaceable event with connector's ILP address, BTP endpoint, settlement info |
| `10047` | SPSP Info | Replaceable event with SPSP destination_account and shared_secret |
| `23194` | SPSP Request | Ephemeral request for fresh SPSP parameters (NIP-47 style) |
| `23195` | SPSP Response | Ephemeral response with SPSP parameters |

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case | `constants.ts`, `types.ts` |
| Interfaces | PascalCase | `IlpPeerInfo`, `SpspInfo` |
| Constants | UPPER_SNAKE_CASE | `ILP_PEER_INFO_KIND` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards instead
- Export from index.ts - all public APIs exported from package index
- Use nostr-tools types - don't redefine Nostr event types

### Testing

[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**File Convention:** `*.test.ts` co-located with source files (same directory)

**Location:** Same directory as source file being tested:
- `packages/core/src/constants.test.ts`
- `packages/core/src/types.test.ts`

**Test Requirements:**
- Follow AAA pattern (Arrange, Act, Assert)
- All public exports have tests
- Edge cases and error conditions covered

**Coverage:** >80% for public APIs

**Note for this story:** Testing types in TypeScript primarily involves compile-time verification. The tests should:
1. Verify constants have correct numeric values
2. Import and use interfaces to ensure they're properly exported
3. Create test objects conforming to each interface

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story draft | SM |
| 2026-02-05 | 0.2 | Implementation complete - all tasks done | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no issues encountered during implementation.

### Completion Notes List

- All 4 event kind constants defined with correct values (10032, 10047, 23194, 23195)
- All 4 TypeScript interfaces implemented with full JSDoc documentation
- Package exports updated to re-export all constants and types from index.ts
- 20 unit tests written covering constants, types, and package entry point exports
- All tests passing, lint clean

### File List

| File | Action |
|------|--------|
| `packages/core/src/constants.ts` | Created |
| `packages/core/src/types.ts` | Created |
| `packages/core/src/constants.test.ts` | Created |
| `packages/core/src/types.test.ts` | Created |
| `packages/core/src/index.ts` | Modified |
| `packages/core/src/index.test.ts` | Modified |

---

## QA Results

### Review Date: 2026-02-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The code is clean, well-documented with JSDoc comments, and follows all project conventions. The implementation correctly defines:
- 4 event kind constants with proper NIP-compliant ranges (replaceable: 10000-19999, ephemeral: 20000-29999)
- 4 TypeScript interfaces with comprehensive field documentation
- Proper re-exports from the package entry point

The code demonstrates good understanding of both Nostr conventions and ILP/SPSP protocols.

### Refactoring Performed

None required. The implementation is clean and follows all established patterns.

### Compliance Check

- Coding Standards: ✓ All naming conventions followed (UPPER_SNAKE_CASE for constants, PascalCase for interfaces, kebab-case for files)
- Project Structure: ✓ Files co-located as specified in source-tree.md
- Testing Strategy: ✓ 20 tests with AAA pattern, co-located test files, >80% coverage
- All ACs Met: ✓ All 7 acceptance criteria fully satisfied

### Improvements Checklist

All items completed satisfactorily:

- [x] Constants have correct numeric values and proper JSDoc documentation
- [x] Interfaces match architecture data models exactly
- [x] All types properly exported from package index using `export type`
- [x] Tests cover both direct imports and package entry point exports
- [x] Tests validate NIP-compliant event kind ranges (nice additional coverage)

### Security Review

No security concerns. This story only defines type constants and interfaces with no runtime behavior. No `any` types used.

### Performance Considerations

No performance concerns. Pure type definitions have zero runtime overhead (interfaces are erased at compile time).

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: PASS → docs/qa/gates/1.2-event-kind-constants-and-type-definitions.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria met. Implementation is clean, well-tested (20 passing tests), and follows all project standards. No changes required.
