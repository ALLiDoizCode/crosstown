# Story 7.6: Add Settlement Negotiation to BLS /handle-payment Handler

## Status

Done

## Story

**As a** peer receiving an SPSP request via ILP,
**I want** the BLS `/handle-payment` handler to negotiate settlement and open payment channels,
**so that** SPSP handshakes routed through the ILP network (bootstrap flow) establish payment channels, not just direct Nostr SPSP.

## Acceptance Criteria

1. BLS `/handle-payment` handler for kind:23194 extracts `supportedChains`, `settlementAddresses`, `preferredTokens` from decrypted SPSP request payload
2. Settlement negotiation logic extracted from `NostrSpspServer.negotiateSettlement()` into a shared function callable by both code paths (Option A from Gap 4)
3. When settlement fields are present in the SPSP request: call shared negotiation function, then `ConnectorChannelClient.openChannel()`, then poll `getChannelState()` until `status === "open"`
4. kind:23195 SPSP response includes `channelId`, `negotiatedChain`, `settlementAddress`, `tokenAddress`, `tokenNetworkAddress` when channel opened successfully
5. When no chain intersection: return basic SPSP response without settlement fields (graceful degradation)
6. When channel opening fails or times out: return ILP REJECT with `internal_error` code
7. Existing SPSP requests without settlement fields continue to work unchanged (backward compatible)
8. Unit tests with mocked `ConnectorChannelClient` for settlement negotiation in the ILP-routed path
9. Both SPSP code paths (direct Nostr and ILP-routed) produce equivalent settlement results for the same inputs

## Tasks / Subtasks

- [x] Task 1: Extract settlement negotiation into shared module (AC: 2, 9)
  - [x] Create `packages/core/src/spsp/negotiateAndOpenChannel.ts` — shared function that:
    - Accepts: `{ request: SpspRequest, config: SettlementNegotiationConfig, channelClient: ConnectorChannelClient, senderPubkey: string }`
    - Calls `negotiateSettlementChain()` (from `settlement.ts`) to find matching chain
    - Calls `resolveTokenForChain()` to determine token
    - Calls `channelClient.openChannel()` with negotiated params
    - Polls `channelClient.getChannelState()` until `status === "open"` or timeout
    - Returns `SettlementNegotiationResult | null` (null = no settlement / graceful degradation)
  - [x] Update `NostrSpspServer.negotiateSettlement()` to call the shared function instead of duplicating logic
  - [x] Export shared function from `packages/core/src/spsp/index.ts` and `packages/core/src/index.ts`

- [x] Task 2: Wire settlement dependencies into `createBlsServer()` and update handler (AC: 1, 3, 4, 5, 6, 7)
  - [x] Move `settlementConfig`/`channelClient` creation (lines 599-614) BEFORE `createBlsServer()` call (line 583) in `main()`
  - [x] Move `adminClient` creation (line 638) BEFORE `createBlsServer()` call as well
  - [x] Update `createBlsServer()` signature to accept new optional dependencies:
    ```typescript
    function createBlsServer(
      config: Config,
      eventStore: EventStore,
      pricingService: PricingService,
      getBootstrapPhase?: () => string,
      settlementConfig?: SettlementNegotiationConfig,
      channelClient?: ConnectorChannelClient,
      adminClient?: ConnectorAdminClient
    ): Hono
    ```
  - [x] Update `createBlsServer()` call site to pass the new arguments
  - [x] In the `/handle-payment` kind:23194 handler, after parsing the SPSP request (NIP-44 decrypt):
    - Extract settlement fields from parsed request: `supportedChains`, `settlementAddresses`, `preferredTokens`
    - If settlement fields present AND `settlementConfig` and `channelClient` are configured:
      - Call shared `negotiateAndOpenChannel()` with request fields and own config
      - On success: include settlement fields in kind:23195 response (`negotiatedChain`, `settlementAddress`, `tokenAddress`, `tokenNetworkAddress`, `channelId`, `settlementTimeout`)
      - On failure (no chain match): return basic SPSP response without settlement (graceful degradation)
      - On error (channel open failure): return `{ accept: false, data: "..." }` with error details (ILP REJECT)
    - If no settlement fields in request: proceed with basic SPSP response (backward compat)

- [x] Task 3: Register peer with settlement config after channel opens (AC: 3, 4)
  - [x] After successful channel opening in `/handle-payment`:
    - Call `adminClient.addPeer()` (which sends `POST ${connectorAdminUrl}/peers`) to update peer registration with settlement info — NOTE: this uses the existing `createConnectorAdminClient()` instance passed to `createBlsServer()` in Task 2, NOT a direct fetch to `/admin/peers`
    - Use `peerAddress` from the SPSP request's `settlementAddresses[negotiatedChain]`
    - Non-fatal: if registration update fails, log warning but still return SPSP response with channel info

- [x] Task 4: Write unit tests for shared negotiation function (AC: 8, 9)
  - [x] Create `packages/core/src/spsp/negotiateAndOpenChannel.test.ts`:
    - Test: returns `SettlementNegotiationResult` when chains match and channel opens
    - Test: returns `null` when no chain intersection
    - Test: returns `null` when peer has no address for negotiated chain
    - Test: throws when `channelClient.openChannel()` fails
    - Test: returns `null` when channel open times out
    - Test: polls `getChannelState()` until status is "open"

- [x] Task 5: Write unit tests for BLS `/handle-payment` settlement integration (AC: 8)
  - [x] Export `createBlsServer` from `docker/src/entrypoint.ts` (change `function` to `export function`) so tests can create a Hono app instance directly with controlled dependencies
  - [x] In `docker/src/entrypoint.test.ts`, add a `describe('createBlsServer /handle-payment settlement')` block:
    - Create the Hono app via `createBlsServer(config, eventStore, pricingService, undefined, settlementConfig, mockChannelClient, mockAdminClient)` with mocked dependencies
    - Use `app.request('/handle-payment', { method: 'POST', body: ... })` to test the handler directly (Hono's built-in test helper, no HTTP server needed)
    - Test: SPSP request with settlement fields triggers negotiation
    - Test: SPSP response includes settlement fields when channel opened
    - Test: SPSP request without settlement fields returns basic response (backward compat)
    - Test: channel open failure returns REJECT response
    - Test: no settlement config → basic response regardless of request fields

- [x] Task 6: Write equivalence test for both SPSP paths (AC: 9)
  - [x] Test that given the same `SpspRequest` with settlement fields, both:
    - `NostrSpspServer.processRequest()` path
    - BLS `/handle-payment` path
    - Produce equivalent `SpspResponse` settlement fields

- [x] Task 7: Run full test suite and lint
  - [x] Run `pnpm test` — all existing tests pass plus new tests
  - [x] Run `pnpm lint` — no new lint errors

## Dev Notes

### Integration Gaps Addressed
[Source: INTEGRATION-GAPS.md]

**Gap 1: BLS `/handle-payment` Missing Settlement Negotiation (CRITICAL)**
- The BLS `/handle-payment` endpoint handles kind:23194 SPSP requests but only:
  1. Parses the request (NIP-44 decrypt)
  2. Generates `destinationAccount` + `sharedSecret`
  3. Builds kind:23195 response with only those two fields
- Missing: settlement chain negotiation, channel opening, and settlement fields in response
- Without this, Phase 3 of bootstrap completes but no payment channels are opened

**Gap 4: Two SPSP Code Paths Never Converge (ARCHITECTURAL)**
- **Path 1: Direct Nostr SPSP** (`NostrSpspServer`) — has full settlement negotiation (Story 7.3)
- **Path 2: ILP-Routed SPSP** (BLS `/handle-payment`) — has NO settlement negotiation
- The ILP bootstrap flow (Phase 3) uses Path 2, which lacks settlement
- Fix: Extract shared function (Option A from INTEGRATION-GAPS.md)

### Why This Story Depends on Story 7.5

Story 7.5 creates the `ConnectorChannelClient` HTTP implementation and wires `settlementConfig`. This story uses both to add settlement negotiation to the ILP-routed SPSP path. The shared function also needs the channel client interface.

### Current BLS /handle-payment Flow (kind:23194)
[Source: docker/src/entrypoint.ts:394-454]

```
1. Receive ILP PREPARE with TOON-encoded kind:23194
2. Base64 decode → TOON decode → Nostr event
3. Check kind === SPSP_REQUEST_KIND (line 395)
4. Verify payment meets price (line 397)
5. parseSpspRequest(event, config.secretKey, event.pubkey) — NIP-44 decrypt (line 412)
6. generateSpspInfo(config.ilpAddress) → { destinationAccount, sharedSecret } (line 415)
7. buildSpspResponseEvent({ requestId, destinationAccount, sharedSecret }, ...) (line 418)
8. encodeEventToToon(responseEvent) → base64 (lines 430-431)
9. Return { accept: true, fulfillment, data: "<base64>", metadata } (lines 433-446)
```

**After this story:**
```
1-3. Same as above
4. Generate fresh SPSP info
5. NEW: If request has supportedChains AND settlement config available:
   a. Call negotiateAndOpenChannel() with request settlement fields
   b. On success: merge settlement result into SpspResponse
   c. On failure: return basic SpspResponse (graceful degradation)
   d. On error: return { accept: false } (ILP REJECT)
6. Build kind:23195 with SpspResponse (now includes settlement fields)
7. Same as above
```

### Data Models
[Source: packages/core/src/types.ts, packages/core/src/spsp/settlement.ts]

**SpspRequest (with settlement fields from Story 7.2):**
```typescript
interface SpspRequest {
  requestId: string;
  timestamp: number;
  ilpAddress?: string;
  supportedChains?: string[];
  settlementAddresses?: Record<string, string>;
  preferredTokens?: Record<string, string>;
}
```

**SpspResponse (with settlement fields from Story 7.2):**
```typescript
interface SpspResponse {
  requestId: string;
  destinationAccount: string;
  sharedSecret: string;
  negotiatedChain?: string;
  settlementAddress?: string;
  tokenAddress?: string;
  tokenNetworkAddress?: string;
  channelId?: string;
  settlementTimeout?: number;
}
```

**SettlementNegotiationResult (from Story 7.3):**
```typescript
interface SettlementNegotiationResult {
  negotiatedChain: string;
  settlementAddress: string;
  tokenAddress?: string;
  tokenNetworkAddress?: string;
  channelId?: string;
  settlementTimeout?: number;
}
```

### Existing Settlement Logic in NostrSpspServer
[Source: packages/core/src/spsp/NostrSpspServer.ts]

The `negotiateSettlement()` private method (added in Story 7.3) contains:
1. Guard check: `if (!config || !channelClient || !supportedChains) return;`
2. `negotiateSettlementChain()` call for chain intersection
3. `resolveTokenForChain()` for token resolution
4. `channelClient.openChannel()` with assembled params
5. Polling loop: `getChannelState()` until `status === "open"` or timeout
6. On success: mutates `SpspResponse` with settlement fields

This logic should be extracted into `negotiateAndOpenChannel()` so both `NostrSpspServer` and BLS `/handle-payment` can share it.

### File Locations
[Source: docs/architecture/9-source-tree.md]

Files to create:
- `packages/core/src/spsp/negotiateAndOpenChannel.ts` — Shared settlement negotiation function
- `packages/core/src/spsp/negotiateAndOpenChannel.test.ts` — Tests for shared function

Files to modify:
- `packages/core/src/spsp/NostrSpspServer.ts` — Refactor `negotiateSettlement()` to use shared function
- `docker/src/entrypoint.ts` — Add settlement negotiation to `/handle-payment` kind:23194 handler
- `docker/src/entrypoint.test.ts` — Add tests for settlement in `/handle-payment`
- `packages/core/src/spsp/index.ts` — Export shared function
- `packages/core/src/index.ts` — Re-export shared function

Files NOT modified:
- `packages/core/src/spsp/settlement.ts` — Pure functions unchanged
- `packages/core/src/types.ts` — Interfaces unchanged
- `packages/core/src/events/builders.ts` — Event builders unchanged
- `packages/core/src/events/parsers.ts` — Event parsers unchanged

### Technical Constraints

**NIP-44 decryption in BLS handler:**
The BLS `/handle-payment` handler already decrypts the kind:23194 event content using NIP-44 via `parseSpspRequest(event, config.secretKey, event.pubkey)` (docker/src/entrypoint.ts line 412). The decrypted content is parsed as `SpspRequest`. After Story 7.2, `SpspRequest` includes optional settlement fields — the parser already handles them.

**TOON encoding of response:**
The kind:23195 response is TOON-encoded and returned in the HTTP response `data` field (lines 430-431). The settlement fields are included in the `SpspResponse` object BEFORE encryption via `buildSpspResponseEvent()`, so no changes to the encoding pipeline are needed.

**Shared function must be pure (no side effects beyond channel client calls):**
The `negotiateAndOpenChannel()` function should only depend on its arguments (SpspRequest fields, config, channelClient). It should not access global state or environment variables.

**`createBlsServer()` must be updated with new parameters and `main()` reordered:**
The current `createBlsServer(config, eventStore, pricingService, getBootstrapPhase)` function (line 329) does NOT receive `settlementConfig`, `channelClient`, or `adminClient`. The fix requires two changes:

1. **Reorder `main()`:** Move `settlementConfig`/`channelClient` creation (lines 599-614) and `adminClient` creation (line 638) BEFORE the `createBlsServer()` call (line 583). This is required because the current code builds these dependencies AFTER creating the BLS server.

2. **Add parameters to `createBlsServer()`:** Update the function signature to:
```typescript
function createBlsServer(
  config: Config,
  eventStore: EventStore,
  pricingService: PricingService,
  getBootstrapPhase?: () => string,
  settlementConfig?: SettlementNegotiationConfig,
  channelClient?: ConnectorChannelClient,
  adminClient?: ConnectorAdminClient
): Hono
```

3. **Export `createBlsServer`:** Change from `function` to `export function` so Task 5 tests can create Hono app instances with controlled dependencies.

4. **Update call site:** Pass the new arguments at the `createBlsServer()` call site in `main()`.

All three new parameters are optional — when `config.settlementInfo` is undefined, they remain undefined and the handler falls back to basic SPSP responses (backward compat).

**Admin API URL pattern (Task 3):**
The existing `createConnectorAdminClient(config.connectorAdminUrl)` calls `${adminUrl}/peers` (e.g., `http://test-node:8081/peers`). This is different from `createChannelClient()` which calls `${connectorAdminUrl}/admin/channels`. Task 3 must use the existing `adminClient.addPeer()` method (passed to `createBlsServer()`), NOT a direct fetch to `/admin/peers`.

**Default timeout values:**
The `SettlementNegotiationConfig` built in `main()` (lines 602-611) uses these defaults:
- `channelOpenTimeout: 30000` (30 seconds — max time to wait for channel to reach `status: "open"`)
- `pollInterval: 1000` (1 second between `getChannelState()` polls)
- `settlementTimeout: 86400` (24 hours — on-chain challenge period)
- `initialDeposit: '0'` (no initial deposit)

**Previous story insights from Story 7.5:**
- `createChannelClient()` is exported from entrypoint.ts (line 296) — returns `ConnectorChannelClient` that calls `POST /admin/channels` and `GET /admin/channels/:channelId`
- `settlementConfig` is built from `config.settlementInfo` (lines 602-611) with defaults: `initialDeposit: '0'`, `settlementTimeout: 86400`, `channelOpenTimeout: 30000`, `pollInterval: 1000`
- Both are passed to `NostrSpspServer` constructor (lines 618-624)
- When `config.settlementInfo` is undefined, both remain undefined (backward compat)

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

The shared `negotiateAndOpenChannel()` should handle errors as follows:
- No chain intersection: return `null` (not an error — graceful degradation)
- Peer missing address for negotiated chain: return `null` (graceful degradation)
- `channelClient.openChannel()` throws: propagate error (let caller decide)
- Channel open timeout (polling exceeds `channelOpenTimeout`): throw with descriptive message
- `channelClient.getChannelState()` throws during polling: propagate error

The BLS `/handle-payment` caller handles these:
- `null` result: return basic SPSP response (no settlement fields)
- Thrown error: return `{ accept: false, code: ILP_ERROR_CODES.INTERNAL_ERROR, message: error.message }` (ILP REJECT)
- Peer registration update failure (Task 3): non-fatal, log warning and continue

The `NostrSpspServer` caller handles these:
- `null` result: leave response unchanged (existing graceful degradation behavior)
- Thrown error: catch and return (existing graceful degradation behavior — no settlement fields added)

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x

**New test files:**
- `packages/core/src/spsp/negotiateAndOpenChannel.test.ts` — ~6 tests for shared function
- Updates to `docker/src/entrypoint.test.ts` — ~5 tests for BLS integration

**Expected new test count:** ~12-15 new tests

### Existing Exports and Imports
[Source: packages/core/src/spsp/index.ts, packages/core/src/index.ts]

**spsp/index.ts** currently exports:
- `NostrSpspClient`, `NostrSpspServer`, `IlpSpspClient`
- `negotiateSettlementChain`, `resolveTokenForChain` (from settlement.ts)

After this story, add:
- `negotiateAndOpenChannel` (from negotiateAndOpenChannel.ts)

**core/src/index.ts** currently re-exports from `./spsp/index.js`:
- `NostrSpspClient`, `NostrSpspServer`, `IlpSpspClient`, `negotiateSettlementChain`, `resolveTokenForChain`

After this story, add:
- `negotiateAndOpenChannel`

**entrypoint.ts** already imports from `@crosstown/core`:
- `ConnectorChannelClient`, `SettlementNegotiationConfig`, `OpenChannelParams`, `OpenChannelResult`, `ChannelState`
- `parseSpspRequest`, `buildSpspResponseEvent`, `SPSP_REQUEST_KIND`
- All needed types are already imported; add `negotiateAndOpenChannel` and `SettlementNegotiationResult`

### Existing Test Patterns
[Source: docker/src/entrypoint.test.ts]

The existing test file (38 tests after Story 7.5) uses:
- `vi.stubGlobal('fetch', vi.fn())` for mocking HTTP calls
- `savedEnv` / `envKeysToClean` pattern for env var management
- `beforeEach` saves and sets env vars, `afterEach` restores originals
- Direct function import testing (e.g., `import { parseConfig, createChannelClient } from './entrypoint.js'`)

For Task 5 (BLS integration tests), `createBlsServer` will be exported (see Task 5 subtasks). Tests create a Hono app instance directly via `createBlsServer(config, eventStore, pricingService, undefined, mockSettlementConfig, mockChannelClient, mockAdminClient)` and use Hono's built-in `app.request()` test helper to invoke `/handle-payment` without spinning up an HTTP server. This follows the same pattern as the existing tests (direct function imports with mocked dependencies).

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft from INTEGRATION-GAPS.md (Gaps 1, 4) | PO (Claude Opus 4.6) |
| 2026-02-09 | 0.2 | Architecture review: corrected line references, added `createBlsServer` parameter constraint, ordering issue, existing import/export context, test patterns, refined error handling contract | SM (Claude Opus 4.6) |
| 2026-02-09 | 0.3 | QA validation fixes: Task 2 explicit `main()` reorder + `createBlsServer()` signature update subtasks; Task 3 clarified to use `adminClient.addPeer()` not direct `/admin/peers` fetch; Task 5 concrete testability approach (export `createBlsServer`, Hono `app.request()` pattern); added default timeout values; resolved open design questions in Dev Notes | QA (Claude Opus 4.6) |
| 2026-02-09 | 1.0 | Implementation complete: all 7 tasks done, 13 new tests passing, 0 lint errors | Dev (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Strong implementation.** The settlement negotiation extraction into a shared function (`negotiateAndOpenChannel`) is well-architected. Clean separation of concerns, proper error propagation semantics (null for graceful degradation, throw for errors), and correct integration into both SPSP code paths. The `createBlsServer()` parameter extension with optional deps preserves backward compatibility cleanly.

**Specific Strengths:**
- Shared function is pure (no side effects beyond channel client calls), testable, and well-documented
- Error handling contract is clearly defined: null vs throw semantics
- `NostrSpspServer` wraps shared function in try/catch for graceful degradation — correct behavior
- BLS handler differentiates between null result (graceful degradation) and thrown error (ILP REJECT)
- Peer registration is correctly non-fatal with logged warning
- `main()` reordering correctly builds settlement deps before BLS server creation
- 13 new tests covering all critical paths

**Issues Found:**

1. **(LOW) Inline type annotation in entrypoint.ts:422-432** — The BLS handler defines `spspResponse` with an inline type literal that duplicates the `SpspResponse` interface from `types.ts`. This works but is slightly less maintainable than importing and using the type directly. Not blocking since the fields match.

2. **(LOW) Missing TOKEN_NETWORK_* env var parsing** — `parseConfig()` builds `settlementInfo` with `supportedChains`, `settlementAddresses`, and `preferredTokens` from env vars, but does not parse `TOKEN_NETWORK_*` env vars. The `SettlementNegotiationConfig.ownTokenNetworks` is hard-coded to `undefined` in `main()` (line 631). This means the `tokenNetworkAddress` field will always be `undefined` in settlement results from the BLS path. This is consistent with the `NostrSpspServer` path (which receives the same `settlementConfig`), so both paths are equivalent — but token network addresses are never populated. This appears to be a pre-existing design choice/gap, not introduced by this story.

3. **(LOW) Polling loop does one extra setTimeout after the status check that detects open** — In `negotiateAndOpenChannel.ts:93-108`, if `getChannelState()` returns `status: 'open'`, the function returns immediately. But if the timeout check fails on the `while` condition, the last `setTimeout` at line 107 was already awaited unnecessarily. This is a minor inefficiency — the polling loop is correct but could be slightly tighter. Not worth changing.

### Refactoring Performed

None. The implementation is clean and well-structured. No refactoring needed.

### Compliance Check

- Coding Standards: ✓ — TypeScript strict, proper error handling, consistent patterns
- Project Structure: ✓ — Files created/modified in expected locations per source tree
- Testing Strategy: ✓ — Unit tests with mocked dependencies, proper test isolation, Given-When-Then patterns
- All ACs Met: ✓ — All 9 acceptance criteria verified (see traceability below)

### AC Traceability

| AC | Status | Validation |
|----|--------|-----------|
| 1 | ✓ | `entrypoint.ts:439` — handler checks `spspRequest.supportedChains` and reads settlement fields |
| 2 | ✓ | `negotiateAndOpenChannel.ts` — shared function extracted; `NostrSpspServer.ts:164` delegates to it |
| 3 | ✓ | `entrypoint.ts:441-471` — calls shared function, opens channel, polls state, registers peer |
| 4 | ✓ | `entrypoint.ts:449-455` — merges all settlement fields into SPSP response before building event |
| 5 | ✓ | `entrypoint.ts:472` — null result from negotiation = basic SPSP response (graceful degradation) |
| 6 | ✓ | `entrypoint.ts:473-481` — catch block returns ILP REJECT with INTERNAL_ERROR code |
| 7 | ✓ | `entrypoint.ts:439` — condition requires `supportedChains AND settlementConfig AND channelClient`; test at line 791 verifies backward compat |
| 8 | ✓ | 7 tests in `negotiateAndOpenChannel.test.ts`, 5 tests in `entrypoint.test.ts` describe block, all with mocked `ConnectorChannelClient` |
| 9 | ✓ | Equivalence test at `entrypoint.test.ts:899`; both paths call same `negotiateAndOpenChannel()` with identical parameter structure |

### Improvements Checklist

- [x] All acceptance criteria implemented and tested
- [x] Shared function properly exported from spsp/index.ts and core/index.ts
- [x] Error handling follows documented contract (null vs throw)
- [x] Backward compatibility preserved (basic SPSP requests work unchanged)
- [x] Both SPSP paths converge on shared function
- [ ] Consider importing `SpspResponse` type in BLS handler instead of inline type literal (minor cleanup)
- [ ] Consider parsing TOKEN_NETWORK_* env vars in `parseConfig()` to populate `ownTokenNetworks` (future story)

### Security Review

No security concerns. Settlement negotiation uses the same NIP-44 encrypted channel as existing SPSP handling. Channel client calls go to the local connector admin API (not exposed externally). Peer registration is non-fatal and uses the existing admin client interface.

### Performance Considerations

The polling loop in `negotiateAndOpenChannel()` uses configurable timeout (30s default) and interval (1s default). The test suite uses short intervals (10ms) to avoid slow tests. The timeout mechanism correctly prevents indefinite blocking. No performance concerns.

### Files Modified During Review

None. No files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/7.6-add-settlement-negotiation-to-bls-handle-payment-handler.yml

### Recommended Status

✓ Ready for Done — All ACs met, 13 new tests passing, clean lint, no blocking issues.

(Story owner decides final status)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes
- Created `negotiateAndOpenChannel()` shared function extracted from `NostrSpspServer.negotiateSettlement()`
- Refactored `NostrSpspServer` to delegate to shared function (catches errors for graceful degradation)
- Updated `createBlsServer()` signature with 3 new optional params: `settlementConfig`, `channelClient`, `adminClient`
- Reordered `main()` to build settlement deps before BLS server creation
- BLS `/handle-payment` now: negotiates settlement on success, returns ILP REJECT on error, degrades gracefully on no match
- Peer registration after channel open is non-fatal (logs warning on failure)
- 7 new tests for shared function, 5 new tests for BLS integration, 1 equivalence test = 13 new tests
- Pre-existing DTS build error in `settlement.ts:56` unrelated to this story (ESM build succeeds)

### File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/spsp/negotiateAndOpenChannel.ts` | Created | Shared settlement negotiation function |
| `packages/core/src/spsp/negotiateAndOpenChannel.test.ts` | Created | 7 unit tests for shared function |
| `packages/core/src/spsp/NostrSpspServer.ts` | Modified | Refactored `negotiateSettlement()` to use shared function |
| `packages/core/src/spsp/index.ts` | Modified | Added export of `negotiateAndOpenChannel` |
| `packages/core/src/index.ts` | Modified | Added re-export of `negotiateAndOpenChannel` |
| `docker/src/entrypoint.ts` | Modified | Updated `createBlsServer` signature/export, added settlement to handler, reordered `main()` |
| `docker/src/entrypoint.test.ts` | Modified | Added 6 new tests (5 BLS settlement + 1 equivalence) |
