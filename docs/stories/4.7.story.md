# Story 4.7: Integration Example

## Status

Done

## Story

**As a** developer,
**I want** a complete example of an agent using the ILP-gated relay,
**so that** I can understand the end-to-end flow.

## Acceptance Criteria

1. Example in `packages/examples/ilp-gated-relay-demo`
2. Example includes: agent setup, relay startup, payment flow, event verification
3. README with step-by-step instructions
4. Example uses mocked ILP connector for local testing without real payments
5. Code is well-commented explaining each step

## Tasks / Subtasks

- [x] Task 1: Create demo directory structure and add dependencies (AC: 1, 4)
  - [x] Create `packages/examples/src/ilp-gated-relay-demo/` directory
  - [x] Create `README.md` in demo directory
  - [x] Create `agent.ts` file for agent-side demo code
  - [x] Create `relay.ts` file for relay server code
  - [x] Create `mock-connector.ts` file for mocked ILP connector
  - [x] Add `@hono/node-server` to `packages/examples/package.json` dependencies
  - [x] Add `nostr-tools` to `packages/examples/package.json` dependencies

- [x] Task 2: Implement mock ILP connector (AC: 4)
  - [x] Create `MockIlpConnector` class that simulates ILP STREAM payments
  - [x] Mock should forward TOON-encoded events to BLS `/handle-payment` endpoint
  - [x] Mock should handle accept/reject responses from BLS
  - [x] Mock should support configurable payment amounts for testing
  - [x] Include helper function `sendPaymentWithEvent(event, amount)` for demo

- [x] Task 3: Implement relay.ts relay server setup (AC: 2)
  - [x] Initialize `SqliteEventStore` with in-memory or file-based storage
  - [x] Initialize `PricingService` with configurable pricing
  - [x] Initialize `BusinessLogicServer` with event store and pricing
  - [x] Initialize `NostrRelayServer` for WebSocket connections
  - [x] Use `@hono/node-server` `serve()` to bind BLS HTTP server
  - [x] Start both BLS HTTP server and WebSocket server
  - [x] Add console logging showing server startup with ports
  - [x] Export relay startup function for programmatic usage
  - [x] Add graceful shutdown handlers for SIGINT/SIGTERM

- [x] Task 4: Implement agent.ts agent client demo (AC: 2)
  - [x] Generate or load Nostr keypair for agent identity
  - [x] Create a signed Nostr event (kind:1 text note)
  - [x] TOON-encode the event
  - [x] Use mock connector to send payment with encoded event
  - [x] Handle accept/reject response from BLS
  - [x] Connect to relay WebSocket using `ws` package
  - [x] Send NIP-01 REQ message to query for stored event by id
  - [x] Parse EOSE response and verify event was stored correctly
  - [x] Close WebSocket connection cleanly

- [x] Task 5: Demonstrate self-write bypass (AC: 2)
  - [x] Create separate demo function `demonstrateSelfWriteBypass()`
  - [x] Configure BLS with `ownerPubkey` matching demo agent's pubkey
  - [x] Show owner events accepted with amount=0 (zero payment)
  - [x] Show non-owner events require payment (demonstrate rejection, then success)
  - [x] Log clear output distinguishing "BYPASS: Owner event accepted" vs "PAID: Event accepted"

- [x] Task 6: Write comprehensive README (AC: 3, 5)
  - [x] Add overview section explaining ILP-gated relay concept
  - [x] Document prerequisites (Node.js 20.x, pnpm)
  - [x] Provide step-by-step instructions to run the demo
  - [x] Include expected output examples
  - [x] Explain each component (relay, agent, mock connector)
  - [x] Document how to modify pricing configuration
  - [x] Document how to test self-write bypass
  - [x] Add troubleshooting section for common issues
  - [x] Document default ports: BLS on 3100, WebSocket relay on 7100

- [x] Task 7: Add inline code comments (AC: 5)
  - [x] Comment each major step in agent.ts
  - [x] Comment each major step in relay.ts
  - [x] Comment mock connector functions explaining ILP simulation
  - [x] Explain TOON encoding purpose
  - [x] Explain BLS accept/reject flow

- [x] Task 8: Create npm script for running demo (AC: 3)
  - [x] Add `demo:ilp-gated-relay` script to `packages/examples/package.json`
  - [x] Script should run relay then agent in sequence using tsx
  - [x] Use Node.js child_process or concurrently package for process management
  - [x] Add signal handlers for proper cleanup (close servers, exit cleanly)
  - [x] Ensure proper process cleanup on exit (SIGINT handler)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/4.6.story.md#dev-agent-record]

From Story 4.6 implementation:
- All 561 tests pass across the project
- BusinessLogicServer supports `ownerPubkey` for self-write bypass
- Owner events bypass payment but still require valid signature
- Pattern: Check `event.pubkey === this.config.ownerPubkey` before price calculation
- `isValidPubkey()` function exported from `@crosstown/relay` for pubkey validation

### Architecture: Package Exports
[Source: packages/relay/src/index.ts]

The `@crosstown/relay` package exports everything needed for the demo:

```typescript
// Types
export type { RelayConfig } from './types.js';
export { DEFAULT_RELAY_CONFIG } from './types.js';

// Storage
export type { EventStore } from './storage/index.js';
export { InMemoryEventStore, SqliteEventStore, RelayError } from './storage/index.js';

// WebSocket
export type { Subscription } from './websocket/index.js';
export { ConnectionHandler, NostrRelayServer } from './websocket/index.js';

// TOON encoding/decoding
export { encodeEventToToon, decodeEventFromToon, ToonEncodeError, ToonError } from './toon/index.js';

// Business Logic Server
export type { BlsConfig, HandlePaymentRequest, HandlePaymentAcceptResponse, HandlePaymentRejectResponse, HandlePaymentResponse } from './bls/index.js';
export { BlsError, ILP_ERROR_CODES, BusinessLogicServer, generateFulfillment, isValidPubkey } from './bls/index.js';

// Pricing
export type { PricingConfig } from './pricing/index.js';
export { PricingError, PricingService, loadPricingConfigFromEnv, loadPricingConfigFromFile } from './pricing/index.js';
```

### Architecture: Core Package Exports
[Source: packages/core/src/index.ts]

The `@crosstown/core` package provides Nostr event utilities:

```typescript
// Event kind constants
export { ILP_PEER_INFO_KIND, SPSP_INFO_KIND, SPSP_REQUEST_KIND, SPSP_RESPONSE_KIND } from './constants.js';

// Event parsers and builders
export { parseIlpPeerInfo, parseSpspInfo, buildIlpPeerInfoEvent, buildSpspInfoEvent } from './events/index.js';
```

### BLS Payment Flow
[Source: packages/relay/src/bls/BusinessLogicServer.ts]

The BusinessLogicServer handles payment requests via HTTP:

1. **Endpoint**: `POST /handle-payment`
2. **Request format**:
   ```typescript
   interface HandlePaymentRequest {
     amount: string;        // Payment amount as string
     destination: string;   // ILP destination address
     data: string;          // Base64-encoded TOON data containing Nostr event
   }
   ```
3. **Response format (accept)**:
   ```typescript
   interface HandlePaymentAcceptResponse {
     accept: true;
     fulfillment: string;   // SHA256(eventId) as base64
     metadata: { eventId: string; storedAt: number };
   }
   ```
4. **Response format (reject)**:
   ```typescript
   interface HandlePaymentRejectResponse {
     accept: false;
     code: string;          // ILP error code (e.g., 'F06')
     message: string;
     metadata?: { required: string; received: string };
   }
   ```

### NostrRelayServer Usage
[Source: packages/relay/src/websocket/NostrRelayServer.ts]

```typescript
import { NostrRelayServer, SqliteEventStore, DEFAULT_RELAY_CONFIG } from '@crosstown/relay';

// DEFAULT_RELAY_CONFIG.port = 7000
const eventStore = new SqliteEventStore(':memory:');
const relay = new NostrRelayServer({ port: 7000 }, eventStore);
await relay.start();
// Server now listening on ws://localhost:7000

// Shutdown
await relay.stop();
```

### TOON Encoding
[Source: packages/relay/src/toon/]

TOON (Typed Object Oriented Notation) encodes Nostr events for ILP packet embedding:

```typescript
import { encodeEventToToon, decodeEventFromToon } from '@crosstown/relay';

// Encode event to bytes
const toonBytes = encodeEventToToon(event);

// Convert to base64 for BLS request
const base64Data = Buffer.from(toonBytes).toString('base64');

// Decode back to event
const decodedEvent = decodeEventFromToon(toonBytes);
```

### Creating Nostr Events
[Source: nostr-tools documentation]

```typescript
import { generateSecretKey, getPublicKey, finalizeEvent } from 'nostr-tools/pure';

const secretKey = generateSecretKey();
const pubkey = getPublicKey(secretKey);

const event = finalizeEvent({
  kind: 1,
  content: 'Hello from ILP-gated relay demo!',
  tags: [],
  created_at: Math.floor(Date.now() / 1000),
}, secretKey);
// event.id and event.sig are now populated
```

### WebSocket Client for Event Verification
[Source: NIP-01, ws package documentation]

To verify events were stored, connect to the relay and send a REQ:

```typescript
import WebSocket from 'ws';

async function verifyEventStored(wsUrl: string, eventId: string): Promise<boolean> {
  return new Promise((resolve, reject) => {
    const ws = new WebSocket(wsUrl);
    const subId = 'verify-' + Date.now();
    let found = false;

    ws.on('open', () => {
      // Send REQ with filter for specific event ID
      ws.send(JSON.stringify(['REQ', subId, { ids: [eventId] }]));
    });

    ws.on('message', (data) => {
      const msg = JSON.parse(data.toString());
      if (msg[0] === 'EVENT' && msg[1] === subId && msg[2].id === eventId) {
        found = true;
      }
      if (msg[0] === 'EOSE' && msg[1] === subId) {
        ws.close();
        resolve(found);
      }
    });

    ws.on('error', reject);
    setTimeout(() => { ws.close(); reject(new Error('Timeout')); }, 5000);
  });
}
```

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create for this story:
```
packages/examples/src/
└── ilp-gated-relay-demo/
    ├── README.md              # Step-by-step instructions
    ├── agent.ts               # Agent-side demo code
    ├── relay.ts               # Relay server setup
    └── mock-connector.ts      # Mocked ILP connector
```

### Mock Connector Pattern
[Source: This story requirement]

The mock connector simulates what a real ILP connector does:

1. Receives a Nostr event from the agent
2. TOON-encodes the event
3. Makes HTTP POST to BLS `/handle-payment` with amount and data
4. Returns accept/reject result to agent

```typescript
// Mock connector implementation pattern
import { encodeEventToToon } from '@crosstown/relay';
import type { NostrEvent } from 'nostr-tools/pure';

interface BlsResponse {
  accept: boolean;
  fulfillment?: string;
  code?: string;
  message?: string;
  metadata?: Record<string, unknown>;
}

class MockIlpConnector {
  constructor(private blsUrl: string) {}

  async sendPayment(event: NostrEvent, amount: bigint): Promise<BlsResponse> {
    const toonBytes = encodeEventToToon(event);
    const base64Data = Buffer.from(toonBytes).toString('base64');

    const response = await fetch(`${this.blsUrl}/handle-payment`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        amount: amount.toString(),
        destination: 'g.crosstown.demo',
        data: base64Data,
      }),
    });

    return response.json();
  }
}
```

### Hono Server Binding for Node.js
[Source: hono documentation, packages/relay/src/bls/BusinessLogicServer.ts]

The BusinessLogicServer uses Hono which requires `@hono/node-server` for Node.js HTTP binding:

```typescript
import { serve } from '@hono/node-server';
import { BusinessLogicServer, SqliteEventStore, PricingService } from '@crosstown/relay';

const eventStore = new SqliteEventStore(':memory:');
const pricingService = new PricingService({ basePricePerByte: 10n });
const bls = new BusinessLogicServer(
  { basePricePerByte: 10n, pricingService },
  eventStore
);

const server = serve({ fetch: bls.getApp().fetch, port: 3000 });
console.log('BLS listening on http://localhost:3000');

// Graceful shutdown
process.on('SIGINT', () => {
  server.close();
  process.exit(0);
});
```

### Dependencies
[Source: packages/examples/package.json]

Dependencies to add for this demo:
```json
{
  "dependencies": {
    "@crosstown/core": "workspace:*",
    "@crosstown/relay": "workspace:*",
    "@hono/node-server": "^1.x",
    "nostr-tools": "^2.x",
    "ws": "^8.x"
  }
}
```

Note: `ws` is already a transitive dependency via `@crosstown/relay`, but adding it explicitly for type support.

### Tech Stack
[Source: docs/architecture/3-tech-stack.md]

| Technology | Version | Purpose |
|------------|---------|---------|
| TypeScript | 5.3.x | Language |
| Node.js | 20.x LTS | Runtime |
| nostr-tools | 2.x | Nostr event handling |
| Hono | 4.x | BLS HTTP framework |
| better-sqlite3 | 9.x | Event storage |
| ws | 8.x | WebSocket server/client |

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case | `mock-connector.ts` |
| Classes | PascalCase | `MockIlpConnector` |
| Functions | camelCase | `sendPayment` |
| Constants | UPPER_SNAKE_CASE | `DEFAULT_BLS_PORT` |

### Testing

This story is primarily an example/demo, not a library feature, so formal unit tests are not required. However:

[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test File Location:** Not applicable (demo code)

**Test Standards:** N/A for demos

**Testing Framework:** N/A

**Validation Requirements:**
- The demo code should be executable and produce expected output
- Code should handle errors gracefully with informative messages
- Demo should work with both in-memory and file-based SQLite storage
- Validate demo runs without errors via `pnpm demo:ilp-gated-relay`

**Expected Console Output:**
```
[Relay] Starting BLS on http://localhost:3000
[Relay] Starting WebSocket relay on ws://localhost:7000
[Agent] Generated keypair: <pubkey>
[Agent] Created event: <eventId>
[Agent] Sending payment of 1000 units...
[Agent] Payment accepted! Fulfillment: <base64>
[Agent] Verifying event stored...
[Agent] Event verified in relay!
[Demo] Self-write bypass demonstration...
[Demo] BYPASS: Owner event accepted with 0 payment
[Demo] Non-owner event rejected (insufficient): F06
[Demo] PAID: Non-owner event accepted with 1000 payment
[Demo] Complete!
```

### Scope Boundaries

**In Scope (this story):**
- Demo directory structure
- Mock ILP connector
- Relay server setup script
- Agent client demo script
- Self-write bypass demonstration
- Comprehensive README
- Well-commented code
- NPM script to run demo
- WebSocket client for event verification

**Out of Scope:**
- Real ILP connector integration
- Real payment processing
- Browser compatibility (Node.js only)
- Docker/containerization
- Formal unit tests for demo code

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

None

### Completion Notes

- All 8 tasks completed successfully
- Demo runs via `pnpm demo:ilp-gated-relay`
- Default ports changed from 3000/7000 to 3100/7100 due to macOS ControlCenter using port 7000
- All 561 existing tests continue to pass
- Linting passes with no errors
- Added `tsx` dev dependency for running TypeScript demos
- Added `index.ts` as main entry point combining basic demo and self-write bypass demo

### File List

| File | Status | Description |
|------|--------|-------------|
| packages/examples/src/ilp-gated-relay-demo/README.md | Created | Comprehensive demo documentation |
| packages/examples/src/ilp-gated-relay-demo/mock-connector.ts | Created | Mock ILP connector for testing |
| packages/examples/src/ilp-gated-relay-demo/relay.ts | Created | Relay server setup with BLS and WebSocket |
| packages/examples/src/ilp-gated-relay-demo/agent.ts | Created | Agent client demo code |
| packages/examples/src/ilp-gated-relay-demo/index.ts | Created | Main demo entry point |
| packages/examples/package.json | Modified | Added dependencies and demo script |
| package.json | Modified | Added tsx and demo:ilp-gated-relay script |
| pnpm-lock.yaml | Modified | Updated lock file |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM (Claude Opus 4.5) |
| 2026-02-06 | 0.2 | Validation fixes: added dependencies task, WebSocket verification, testing section, process cleanup | SM (Claude Opus 4.5) |
| 2026-02-06 | 1.0 | Implementation complete | Dev (Claude Opus 4.5) |

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality for a demo/example. Code is well-structured with clear separation of concerns across files. TypeScript types are properly defined. Consistent naming conventions followed (kebab-case files, PascalCase classes, camelCase functions). Clean async/await patterns with proper error handling and graceful shutdown via try/finally blocks.

### Refactoring Performed

None required. Code quality is good as-is for demo purposes.

### Compliance Check

- Coding Standards: ✓ Follows kebab-case files, PascalCase classes, camelCase functions
- Project Structure: ✓ Correct location in packages/examples/src/ilp-gated-relay-demo/
- Testing Strategy: ✓ N/A - Demo code per story scope (formal unit tests not required)
- All ACs Met: ✓ All 5 acceptance criteria verified

### Improvements Checklist

- [ ] Update comment in agent.ts:160 - says "ports 3000/7000" but actual ports are 3100/7100
- [ ] Update JSDoc in relay.ts:28-31 - says "default: 3000/7000" but defaults are 3100/7100
- [ ] Update docs/architecture/9-source-tree.md to include index.ts in ilp-gated-relay-demo directory

### Security Review

No security concerns. This is demo code using a mock ILP connector - no real payments, no secrets stored, no external network calls to production systems.

### Performance Considerations

No performance concerns. Demo uses in-memory SQLite storage and includes proper cleanup with graceful shutdown handlers.

### Files Modified During Review

None - no refactoring was necessary.

### Gate Status

Gate: PASS → docs/qa/gates/4.7-integration-example.yml

### Recommended Status

✓ Ready for Done

Minor documentation inconsistencies noted (port numbers in comments) but these are cosmetic and do not affect functionality. The demo runs successfully end-to-end, all 561 existing tests pass, and linting passes.
