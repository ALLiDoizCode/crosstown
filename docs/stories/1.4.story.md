# Story 1.4: NIP-02 Follow List Discovery

## Status

Done

## Story

**As an** agent developer,
**I want** to retrieve the list of pubkeys an agent follows,
**so that** I can identify potential ILP peers.

## Acceptance Criteria

1. `NostrPeerDiscovery` class created with constructor accepting relay URLs and optional SimplePool
2. `getFollows(pubkey: string): Promise<string[]>` method queries kind:3 events and returns followed pubkeys
3. Method queries multiple relays and deduplicates results
4. Method handles relay failures gracefully (continues with available relays)
5. Unit tests with mocked SimplePool verify correct filter construction and response parsing
6. Unit tests verify graceful handling of missing/empty follow lists

## Tasks / Subtasks

- [x] Task 1: Create discovery directory structure (AC: 1)
  - [x] Create `packages/core/src/discovery/` directory
  - [x] Create `packages/core/src/discovery/index.ts` for module exports

- [x] Task 2: Create PeerDiscoveryError class (AC: 4)
  - [x] Add `PeerDiscoveryError` class to `packages/core/src/errors.ts`
  - [x] Error should extend `CrosstownError` with code `PEER_DISCOVERY_FAILED`
  - [x] Export from `packages/core/src/index.ts`

- [x] Task 3: Create NostrPeerDiscovery class (AC: 1, 2)
  - [x] Create `packages/core/src/discovery/NostrPeerDiscovery.ts`
  - [x] Implement constructor accepting `relayUrls: string[]` and optional `pool?: SimplePool`
  - [x] If no pool provided, create new SimplePool internally
  - [x] Store relay URLs and pool as private properties

- [x] Task 4: Implement getFollows method (AC: 2, 3, 4)
  - [x] Add `getFollows(pubkey: string): Promise<string[]>` method
  - [x] Validate pubkey is a 64-character hex string (throw `PeerDiscoveryError` if invalid)
  - [x] Query kind:3 events using `pool.querySync(relayUrls, filter)` with `limit: 1`
  - [x] Each relay returns its most recent kind:3 event; sort results by `created_at` descending
  - [x] Use the event with highest `created_at` (most recent across all relays)
  - [x] Parse the `tags` array for `p` tags: `event.tags.filter(t => t[0] === 'p').map(t => t[1])`
  - [x] Deduplicate pubkeys before returning
  - [x] Return empty array if no kind:3 event found (AC: 6)
  - [x] Catch relay errors and continue with remaining relays (AC: 4)

- [x] Task 5: Export from discovery module and package index (AC: 1)
  - [x] Export `NostrPeerDiscovery` from `packages/core/src/discovery/index.ts`
  - [x] Update `packages/core/src/index.ts` to re-export from discovery module

- [x] Task 6: Write unit tests for constructor (AC: 1, 5)
  - [x] Create `packages/core/src/discovery/NostrPeerDiscovery.test.ts`
  - [x] Test constructor with relay URLs creates instance
  - [x] Test constructor with custom SimplePool uses provided pool
  - [x] Test constructor creates internal SimplePool if none provided

- [x] Task 7: Write unit tests for getFollows (AC: 2, 3, 5, 6)
  - [x] Mock SimplePool using vitest mocking
  - [x] Test getFollows returns followed pubkeys from kind:3 event
  - [x] Test getFollows constructs correct filter `{ kinds: [3], authors: [pubkey] }`
  - [x] Test getFollows returns most recent event when multiple exist
  - [x] Test getFollows deduplicates pubkeys from tags
  - [x] Test getFollows returns empty array for nonexistent pubkey
  - [x] Test getFollows returns empty array for user with no follows

- [x] Task 8: Write unit tests for error handling (AC: 4, 5)
  - [x] Test getFollows throws PeerDiscoveryError for invalid pubkey format
  - [x] Test getFollows continues on individual relay failure
  - [x] Test getFollows returns results from successful relays even if some fail

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.3.story.md#dev-agent-record]

- Event parsers and builders are complete in `packages/core/src/events/`
- `CrosstownError` base class exists in `packages/core/src/errors.ts` with `code` and `cause` properties
- Uses ES2022 Error cause pattern for error chaining
- Package uses ESM (`"type": "module"`) - use `.js` extension in imports
- TypeScript strict mode is enabled
- 49 tests currently pass in core package

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create for this story:
```
packages/core/src/
├── errors.ts                        # Add PeerDiscoveryError (update existing)
├── discovery/
│   ├── index.ts                     # Module exports (new)
│   ├── NostrPeerDiscovery.ts        # Main class (new)
│   └── NostrPeerDiscovery.test.ts   # Unit tests (new)
└── index.ts                         # Package exports (update existing)
```

### Data Models
[Source: docs/architecture/4-data-models.md, NIP-02]

**NIP-02 Follow List Event (kind:3):**
- Standard Nostr event with `kind: 3`
- `tags` array contains `["p", "<pubkey>"]` entries for each followed pubkey
- Example: `{ kind: 3, tags: [["p", "abc123..."], ["p", "def456..."]], ... }`
- Replaceable event - only most recent per pubkey is canonical

**NostrEvent (from nostr-tools):**
- `id`: string - Event hash
- `pubkey`: string - Author public key (64-char hex)
- `kind`: number - Event kind (3 for follow list)
- `content`: string - Event content (usually empty for kind:3)
- `tags`: string[][] - Event tags (contains followed pubkeys)
- `created_at`: number - Unix timestamp
- `sig`: string - Schnorr signature

### Core Workflows
[Source: docs/architecture/7-core-workflows.md#peer-discovery-flow]

This story implements the first step of the peer discovery flow:
1. **This story:** Agent calls `getFollows(myPubkey)` → Discovery queries kind:3 → Returns followed pubkeys
2. (Story 1.5) For each followed pubkey → Query kind:10032 → Return IlpPeerInfo map

### nostr-tools Usage
[Source: docs/architecture/3-tech-stack.md, docs/architecture/6-external-apis.md]

**Key nostr-tools types and functions:**

1. **SimplePool for relay management:**
```typescript
import { SimplePool } from 'nostr-tools/pool';

const pool = new SimplePool();

// Query events from multiple relays - use this for getFollows
const events = await pool.querySync(relayUrls, filter);
```

2. **Filter type:**
```typescript
import type { Filter } from 'nostr-tools/filter';

const filter: Filter = {
  kinds: [3],
  authors: [pubkey],
  limit: 1  // Each relay returns its most recent
};
```

3. **Event type:**
```typescript
import type { NostrEvent } from 'nostr-tools/pure';
```

**Why `querySync` with `limit: 1` (not `get`):**
- `querySync` queries all relays and returns an array of events
- With `limit: 1`, each relay returns its most recent kind:3 event
- Different relays may have different versions (due to propagation delays)
- Client must sort by `created_at` descending and use the most recent
- `get` returns only the first event found, which may not be the most recent

**Selecting the most recent event:**
```typescript
// querySync returns one event per relay (with limit: 1)
const events = await pool.querySync(relayUrls, filter);
if (events.length === 0) return [];

// Sort by created_at descending and take the most recent
const mostRecent = events.sort((a, b) => b.created_at - a.created_at)[0];
```

**Critical Notes:**
- SimplePool manages WebSocket connections automatically
- Handle relay connection errors gracefully (querySync continues on failures)

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

**Error class pattern (add to errors.ts):**
```typescript
export class PeerDiscoveryError extends CrosstownError {
  constructor(message: string, cause?: Error) {
    super(message, 'PEER_DISCOVERY_FAILED', cause);
    this.name = 'PeerDiscoveryError';
  }
}
```

**Relay Error Strategy:**
- Query multiple relays simultaneously
- Continue on individual relay failures
- Only fail if ALL relays fail
- Log/report failures but don't throw

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case or PascalCase for classes | `NostrPeerDiscovery.ts` |
| Classes | PascalCase | `NostrPeerDiscovery` |
| Methods | camelCase | `getFollows` |
| Constants | UPPER_SNAKE_CASE | `FOLLOW_LIST_KIND = 3` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards instead
- Always mock SimplePool in tests - no live relay dependencies
- Export from index.ts - all public APIs exported from package index
- Use nostr-tools types - don't redefine Nostr event types

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**File Convention:** `*.test.ts` co-located with source files

**Location:** `packages/core/src/discovery/NostrPeerDiscovery.test.ts`

**Mocking SimplePool:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { NostrPeerDiscovery } from './NostrPeerDiscovery.js';
import type { SimplePool } from 'nostr-tools/pool';

describe('NostrPeerDiscovery', () => {
  const mockPool = {
    querySync: vi.fn(),
  } as unknown as SimplePool;

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('returns followed pubkeys from kind:3 event', async () => {
    // Arrange
    const discovery = new NostrPeerDiscovery(['wss://relay.example'], mockPool);
    vi.mocked(mockPool.querySync).mockResolvedValue([{
      kind: 3,
      tags: [['p', 'abc123'], ['p', 'def456']],
      created_at: 1234567890,
      // ... other required fields
    }]);

    // Act
    const follows = await discovery.getFollows('somepubkey');

    // Assert
    expect(follows).toEqual(['abc123', 'def456']);
    expect(mockPool.querySync).toHaveBeenCalledWith(
      ['wss://relay.example'],
      { kinds: [3], authors: ['somepubkey'], limit: 1 }
    );
  });

  it('uses most recent event when relays return different versions', async () => {
    // Arrange
    const discovery = new NostrPeerDiscovery(['wss://relay1', 'wss://relay2'], mockPool);
    vi.mocked(mockPool.querySync).mockResolvedValue([
      { kind: 3, tags: [['p', 'old']], created_at: 1000 },
      { kind: 3, tags: [['p', 'new']], created_at: 2000 },  // Most recent
    ]);

    // Act
    const follows = await discovery.getFollows('somepubkey');

    // Assert - should use the event with created_at: 2000
    expect(follows).toEqual(['new']);
  });
});
```

**Test Requirements:**
- Follow AAA pattern (Arrange, Act, Assert)
- All public methods have unit tests
- Edge cases: empty follow list, no event found, multiple events
- Error cases: invalid pubkey, relay failures
- SimplePool always mocked (never live relays)
- >80% coverage for public APIs

### Pubkey Validation

A valid Nostr pubkey is a 64-character lowercase hexadecimal string. Validation:
```typescript
function isValidPubkey(pubkey: string): boolean {
  return /^[0-9a-f]{64}$/.test(pubkey);
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story draft | SM |
| 2026-02-05 | 0.2 | Clarified querySync usage: use querySync (not get), sort by created_at to find most recent | SM |
| 2026-02-06 | 1.0 | Implementation complete | Dev |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List
| File | Action |
|------|--------|
| `packages/core/src/discovery/index.ts` | Created |
| `packages/core/src/discovery/NostrPeerDiscovery.ts` | Created |
| `packages/core/src/discovery/NostrPeerDiscovery.test.ts` | Created |
| `packages/core/src/errors.ts` | Modified (added PeerDiscoveryError) |
| `packages/core/src/index.ts` | Modified (added exports) |

### Debug Log References
None required.

### Completion Notes
- All 8 tasks completed with 15 new unit tests
- Total test count: 64 tests (up from 49)
- All tests pass, linting passes
- `NostrPeerDiscovery` class implements NIP-02 follow list discovery
- `PeerDiscoveryError` added for invalid pubkey and relay failures
- SimplePool properly mocked in all tests (no live relay dependencies)
- Uses `querySync` with `limit: 1` and sorts by `created_at` to get most recent event

---

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is clean, well-documented, and follows established project patterns. Key observations:

1. **Proper nostr-tools usage:** Uses `SimplePool`, `Filter`, and `VerifiedEvent` types correctly without redefinition
2. **Type safety:** Excellent type guard for tag filtering (`tag is [string, string, ...string[]]`) prevents runtime errors
3. **Correct algorithm:** Implementation correctly uses `querySync` with `limit: 1`, sorts by `created_at` descending, and uses most recent event as specified in story
4. **Error handling:** Follows ES2022 cause pattern with proper error code (`PEER_DISCOVERY_FAILED`)
5. **Defensive programming:** Line 65-67 includes defensive check for undefined despite prior length check - good practice

### Refactoring Performed

No refactoring required - implementation is clean and follows project patterns.

### Compliance Check

- Coding Standards: ✓ No `any`, proper naming conventions, exports from index.ts
- Project Structure: ✓ Files in `packages/core/src/discovery/` as documented
- Testing Strategy: ✓ Co-located tests, mocked SimplePool, AAA pattern, 15 tests
- All ACs Met: ✓ All 6 acceptance criteria verified

### Improvements Checklist

- [x] All acceptance criteria implemented with test coverage
- [x] Error handling follows architecture documentation patterns
- [x] Public API exported from package index
- [x] JSDoc documentation complete
- [x] No live relay dependencies in tests

No outstanding items requiring developer attention.

### Security Review

- Pubkey validation (`/^[0-9a-f]{64}$/`) prevents malformed input
- Error messages are informative without leaking internal details
- No sensitive data handling in this module

### Performance Considerations

- `querySync` is appropriate for this use case
- Sorting and deduplication are O(n log n) and O(n) respectively, appropriate for expected data size (small number of relay responses)

### Files Modified During Review

None - no refactoring performed.

### Gate Status

Gate: PASS → docs/qa/gates/1.4-nip-02-follow-list-discovery.yml

### Recommended Status

✓ Ready for Done

Implementation is complete, well-tested, and follows all project standards.
