# Story 10.2: Create createDirectRuntimeClient()

## Status

Done

## Story

**As a** library consumer embedding agent-runtime in-process,
**I want** a `createDirectRuntimeClient()` factory that wraps `ConnectorNode.sendPacket()` as an `AgentRuntimeClient`,
**so that** ILP packets can be sent via direct function calls instead of HTTP, enabling zero-latency embedded mode while preserving the existing `AgentRuntimeClient` interface for all consumers.

## Acceptance Criteria

1. A `ConnectorNodeLike` structural interface is defined with `sendPacket()` method signature, so `@agent-runtime/connector` remains an optional peer dependency
2. `createDirectRuntimeClient(connector, config?)` returns an `AgentRuntimeClient` that sends ILP packets by calling `connector.sendPacket()` directly (no HTTP)
3. The client correctly converts `sendIlpPacket()` string params (amount, data) to `ConnectorNode` native types (`BigInt` amount, `Uint8Array` data)
4. The client computes the ILP execution condition as `SHA256(SHA256(event.id))` from the TOON-encoded Nostr event data when config provides a `toonDecoder`
5. The client maps fulfill responses (`type: 'fulfill'`) to `{ accepted: true, fulfillment }` and reject responses (`type: 'reject'`) to `{ accepted: false, code, message }`
6. When `connector.sendPacket()` throws, the error is wrapped in a `BootstrapError`
7. All new code has unit tests with >80% coverage following AAA pattern
8. The new module exports are added to `packages/core/src/bootstrap/index.ts` barrel

## Tasks / Subtasks

- [x] Task 1: Define `ConnectorNodeLike` structural interface (AC: 1)
  - [x] Create `packages/core/src/bootstrap/direct-runtime-client.ts`
  - [x] Define `SendPacketParams` interface: `{ destination: string; amount: bigint; data: Uint8Array; executionCondition?: Uint8Array; expiresAt?: Date }`. Note: `expiresAt` is included for structural compatibility with `ConnectorNode` but is not set by the direct client — callers or the connector provide it if needed.
  - [x] Define `SendPacketResult` type: `{ type: 'fulfill'; fulfillment: Uint8Array; data?: Uint8Array } | { type: 'reject'; code: string; message: string; data?: Uint8Array }`
  - [x] Define `ConnectorNodeLike` interface: `{ sendPacket(params: SendPacketParams): Promise<SendPacketResult> }`
  - [x] Add JSDoc documenting this is a structural interface — consumers pass an `@agent-runtime/connector` ConnectorNode without importing it

- [x] Task 2: Define `DirectRuntimeClientConfig` options interface (AC: 4)
  - [x] Define `DirectRuntimeClientConfig` interface with optional `toonDecoder?: (bytes: Uint8Array) => { id: string }` callback for extracting event ID from TOON data. Note: this is intentionally a narrower type than `BootstrapServiceConfig.toonDecoder` (which returns full `NostrEvent`). Only the `id` field is needed for condition computation, so the interface is minimal.
  - [x] Document that when `toonDecoder` is provided, the client computes `executionCondition = SHA256(SHA256(event.id))` and passes it to `sendPacket()`
  - [x] Document that when `toonDecoder` is omitted, no `executionCondition` is set (connector uses its default)

- [x] Task 3: Implement `createDirectRuntimeClient()` factory function (AC: 2, 3, 4, 5, 6)
  - [x] Accept `connector: ConnectorNodeLike` and optional `config?: DirectRuntimeClientConfig`
  - [x] Return an object implementing `AgentRuntimeClient` with `sendIlpPacket()` method
  - [x] In `sendIlpPacket()`:
    - [x] Convert `params.amount` from string to `BigInt` (note: `BigInt()` throws `SyntaxError` on invalid input — this is caught by the outer error wrapper)
    - [x] Convert `params.data` from base64 string to `Uint8Array` via `Buffer.from(params.data, 'base64')`
    - [x] If `config.toonDecoder` is provided: decode the data bytes, extract `event.id`, compute `SHA256(SHA256(event.id))` as `executionCondition` using Node.js `crypto.createHash('sha256')`
    - [x] Call `connector.sendPacket({ destination, amount, data, executionCondition, expiresAt })`
    - [x] Map fulfill result: `{ accepted: true, fulfillment: Buffer.from(result.fulfillment).toString('base64'), data: result.data ? Buffer.from(result.data).toString('base64') : undefined }`
    - [x] Map reject result: `{ accepted: false, code: result.code, message: result.message, data: result.data ? Buffer.from(result.data).toString('base64') : undefined }`
  - [x] Wrap any thrown errors in `BootstrapError` with descriptive message

- [x] Task 4: Export from barrel files (AC: 8)
  - [x] Add to `packages/core/src/bootstrap/index.ts`: export `createDirectRuntimeClient` function and `ConnectorNodeLike`, `SendPacketParams`, `SendPacketResult`, `DirectRuntimeClientConfig` types
  - [x] Note: Do NOT update `packages/core/src/index.ts` yet — that is Story 10.5's scope

- [x] Task 5: Write unit tests (AC: 7)
  - [x] Create `packages/core/src/bootstrap/direct-runtime-client.test.ts`
  - [x] Test: creates client from mock ConnectorNodeLike — `sendIlpPacket` is a function
  - [x] Test: converts string amount to BigInt correctly (e.g., `"50000"` → `50000n`)
  - [x] Test: converts base64 data to Uint8Array correctly
  - [x] Test: passes destination through unchanged
  - [x] Test: maps fulfill response (`type: 'fulfill'`) → `{ accepted: true, fulfillment: "<base64>" }`
  - [x] Test: maps reject response (`type: 'reject'`) → `{ accepted: false, code, message }`
  - [x] Test: includes base64-encoded response data when present in both fulfill and reject
  - [x] Test: omits response data field when not present in result
  - [x] Test: wraps sendPacket errors in BootstrapError
  - [x] Test: computes `executionCondition = SHA256(SHA256(eventId))` when toonDecoder is provided
  - [x] Test: does not set executionCondition when toonDecoder is omitted
  - [x] Test: handles toonDecoder throwing gracefully (wraps in BootstrapError)
  - [x] Test: wraps invalid amount string (e.g., `"abc"`) BigInt parse error in BootstrapError

- [x] Task 6: Build and test validation (AC: 7)
  - [x] Run `pnpm build` — verify all packages compile
  - [x] Run `pnpm test` — verify all tests pass (baseline: ~1020 passed, 2 pre-existing failures)
  - [x] Run `npx tsc --noEmit` from `packages/core/` to verify type-checking passes

## Dev Notes

### Previous Story Insights
[Source: docs/stories/10.1.story.md — Dev Agent Record]

Story 10.1 completed a mechanical rename of `handlePayment` → `handlePacket` across 22 files. Build and test baseline: 1020 passed, 2 failed (pre-existing: `SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` — `subscribeMany` call signature mismatches, unrelated to this work). `tsc --noEmit` passes clean for all packages on source files. The codebase is stable post-rename.

### AgentRuntimeClient Interface (The Interface We Implement)
[Source: packages/core/src/bootstrap/types.ts lines 118-128]

```typescript
export interface AgentRuntimeClient {
  sendIlpPacket(params: {
    destination: string;
    amount: string;
    data: string; // base64-encoded TOON
    timeout?: number;
  }): Promise<IlpSendResult>;
}

export interface IlpSendResult {
  accepted: boolean;
  fulfillment?: string;
  data?: string; // base64-encoded response TOON
  code?: string;
  message?: string;
}
```

The new `createDirectRuntimeClient()` must return an object matching this interface exactly. The existing `createAgentRuntimeClient()` (HTTP version) in `agent-runtime-client.ts` is the reference implementation — follow the same return shape.

### ConnectorNode.sendPacket() Expected Shape
[Source: docs/epics/epic-10-embedded-connector-integration.md#Part-B, ELIZAOS-INTEGRATION-HANDOFF.md lines 128-144]

The `@agent-runtime/connector` package's `ConnectorNode` has a `sendPacket()` method with this approximate shape:

```typescript
connector.sendPacket({
  destination: string,       // ILP address
  amount: BigInt,            // amount as BigInt (not string)
  data: Uint8Array,          // binary data (not base64 string)
  executionCondition?: Uint8Array,  // 32 bytes SHA-256 hash
  expiresAt?: Date,
}) → Promise<{
  type: 'fulfill' | 'reject',
  fulfillment?: Uint8Array,  // 32 bytes (only on fulfill)
  data?: Uint8Array,         // response data
  code?: string,             // ILP error code (only on reject)
  message?: string,          // error message (only on reject)
}>
```

**Key conversion responsibilities of the direct client:**
1. `params.amount` (string) → `BigInt(params.amount)`
2. `params.data` (base64 string) → `Buffer.from(params.data, 'base64')` (Uint8Array)
3. `result.fulfillment` (Uint8Array) → `Buffer.from(result.fulfillment).toString('base64')` (string)
4. `result.data` (Uint8Array) → `Buffer.from(result.data).toString('base64')` (string)

### Structural Typing Approach (ConnectorNodeLike)
[Source: docs/epics/epic-10-embedded-connector-integration.md line 41]

The `ConnectorNodeLike` interface is a **structural type** — it describes just the `sendPacket()` method signature. This means consumers can pass an `@agent-runtime/connector` `ConnectorNode` instance without agent-society needing to import `@agent-runtime/connector` as a dependency. TypeScript's structural type system handles compatibility automatically.

### Execution Condition Computation (SHA256(SHA256(event.id)))
[Source: packages/bls/src/bls/BusinessLogicServer.ts lines 14-24, docs/stories/4.4.story.md lines 124, 216]

The ILP protocol uses condition/fulfillment pairs:
- **Fulfillment** = `SHA256(event.id)` — generated by the BLS when it accepts a packet
- **Condition** = `SHA256(fulfillment)` = `SHA256(SHA256(event.id))` — sender must include this in the ILP PREPARE packet

The `generateFulfillment()` function in BLS:
```typescript
function generateFulfillment(eventId: string): string {
  const hash = createHash('sha256').update(eventId).digest();
  return hash.toString('base64');
}
```

For the direct client, when `toonDecoder` is provided:
1. Decode TOON bytes → extract `event.id`
2. `fulfillment = SHA256(event.id)` (32 bytes)
3. `executionCondition = SHA256(fulfillment)` (32 bytes)
4. Pass `executionCondition` to `connector.sendPacket()`

When `toonDecoder` is NOT provided, omit `executionCondition` — the connector will use its own default.

### BootstrapError (Error Class to Use)
[Source: packages/core/src/bootstrap/BootstrapService.ts]

`BootstrapError` is already exported from the bootstrap module. Import it from `./BootstrapService.js`. It extends `AgentSocietyError` (which extends `Error`) and accepts `(message: string, cause?: Error)`. Internally it calls `super(message, 'BOOTSTRAP_FAILED', cause)`.

### File Locations
[Source: docs/architecture/9-source-tree.md, docs/epics/epic-10-embedded-connector-integration.md#Story-10.2]

```
packages/core/src/bootstrap/
├── direct-runtime-client.ts       # NEW — createDirectRuntimeClient()
├── direct-runtime-client.test.ts  # NEW — unit tests
├── index.ts                       # MODIFY — add new exports
├── agent-runtime-client.ts        # EXISTING (HTTP version) — reference implementation
├── types.ts                       # EXISTING — AgentRuntimeClient, IlpSendResult interfaces
├── BootstrapService.ts            # EXISTING — BootstrapError class
└── RelayMonitor.ts                # EXISTING — no changes
```

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

- Files: kebab-case → `direct-runtime-client.ts` ✓
- Functions: camelCase → `createDirectRuntimeClient` ✓
- Interfaces: PascalCase → `ConnectorNodeLike`, `SendPacketParams`, `SendPacketResult`, `DirectRuntimeClientConfig` ✓
- Never use `any` — use `unknown` and type guards
- All public APIs exported from index.ts
- Use `.js` extension in imports (ESM)

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **Framework:** Vitest 1.x
- **File Convention:** `*.test.ts` co-located with source → `direct-runtime-client.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Vitest built-in mocking (`vi.fn()`)
- **Coverage:** >80% for public APIs
- **Reference test file:** `packages/core/src/bootstrap/agent-runtime-client.test.ts` — follow the same structure (imports, describe blocks, error handling patterns)
- **Mock pattern:** Create a mock `ConnectorNodeLike` object with `sendPacket: vi.fn()` — no live connector needed
- **Validation command:** `pnpm test` from workspace root. Expected baseline: ~1020 passed + new tests, 2 pre-existing failures.
- **Build validation:** `pnpm build` from workspace root.

### What NOT to Change

- `AgentRuntimeClient` interface in `types.ts` — unchanged
- `IlpSendResult` interface in `types.ts` — unchanged
- `agent-runtime-client.ts` (HTTP version) — unchanged (rename happens in Story 10.5)
- `packages/core/src/index.ts` (package-level exports) — unchanged (updated in Story 10.5)
- `BootstrapService.ts` — unchanged
- `RelayMonitor.ts` — unchanged
- Any files outside `packages/core/src/bootstrap/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-16 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-16 | 0.2 | Post-validation fixes: precise BootstrapError inheritance, toonDecoder type rationale, expiresAt passthrough note, BigInt parse error handling, added invalid amount test case | QA (Claude Opus 4.6) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/bootstrap/direct-runtime-client.ts` | NEW | `createDirectRuntimeClient()` factory, `ConnectorNodeLike`, `SendPacketParams`, `SendPacketResult`, `DirectRuntimeClientConfig` interfaces |
| `packages/core/src/bootstrap/direct-runtime-client.test.ts` | NEW | 15 unit tests covering all acceptance criteria |
| `packages/core/src/bootstrap/index.ts` | MODIFIED | Added exports for `createDirectRuntimeClient` and associated types |

### Debug Log References
No issues encountered during implementation.

### Completion Notes
- All 6 tasks completed with all subtasks checked
- 15 new unit tests all passing (1035 total passed, 2 pre-existing failures unchanged)
- `tsc --noEmit` clean for new source file (0 errors in `direct-runtime-client.ts`)
- `packages/core` build success (ESM + DTS)
- `pnpm build` has pre-existing failure in `packages/ui-prototypes` (unused import TS6133 errors) — unrelated to this story
- No changes made outside `packages/core/src/bootstrap/`

## QA Results

### Review Date: 2026-02-16

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

- 8 acceptance criteria (>5 threshold) triggered deep review
- Diff ~470 lines (new files) + small barrel change — within bounds
- No auth/payment/security files touched directly
- No previous gate for this story
- Risk level: **Low**

### Code Quality Assessment

Excellent implementation quality. The code is clean, concise, and follows established patterns from the existing `agent-runtime-client.ts` HTTP reference implementation. Key strengths:

- **Structural typing** via `ConnectorNodeLike` avoids hard dependency on `@agent-runtime/connector` — idiomatic TypeScript approach
- **Error wrapping** properly re-throws `BootstrapError` instances without double-wrapping (line 139-140)
- **JSDoc** is comprehensive and explains design decisions (e.g., toonDecoder's narrower type vs. `BootstrapServiceConfig.toonDecoder`)
- **Minimal interface surface** — `DirectRuntimeClientConfig.toonDecoder` only requires `{ id: string }`, not full `NostrEvent`
- **SHA256 computation** uses Node.js `crypto.createHash` (not custom), matching BLS `generateFulfillment()` pattern
- `Uint8Array.from(Buffer.from(..., 'base64'))` correctly produces a clean `Uint8Array` matching `SendPacketParams.data` type

### Requirements Traceability

| AC | Description | Validating Test(s) | Status |
|----|-------------|---------------------|--------|
| 1 | ConnectorNodeLike structural interface defined | "creates client from mock ConnectorNodeLike" — Given a mock object with sendPacket, When passed to factory, Then client is defined | Covered |
| 2 | createDirectRuntimeClient returns AgentRuntimeClient | "creates client with sendIlpPacket function" — Given mock connector, When factory called, Then returned object has sendIlpPacket as Function | Covered |
| 3 | Converts string params to native types | "converts string amount to BigInt" + "converts base64 data to Uint8Array" — Given string "50000", When sendIlpPacket called, Then sendPacket receives 50000n; Given base64 data, When decoded, Then matches original bytes | Covered |
| 4 | Computes SHA256(SHA256(event.id)) with toonDecoder | "computes executionCondition" — Given toonDecoder returning {id: eventId}, When sendIlpPacket called, Then executionCondition equals SHA256(SHA256(eventId)) | Covered |
| 5 | Maps fulfill/reject responses | "maps fulfill response" + "maps reject response" + data presence/absence tests — Given fulfill result, When mapped, Then {accepted: true, fulfillment: base64}; Given reject, Then {accepted: false, code, message} | Covered |
| 6 | Wraps errors in BootstrapError | "wraps sendPacket errors" + "wraps invalid amount" + "handles toonDecoder throwing" — Given error thrown, When caught, Then BootstrapError with descriptive message and original cause | Covered |
| 7 | Unit tests >80% coverage, AAA pattern | 15 tests all passing, co-located file, AAA pattern, vi.fn() mocking | Covered |
| 8 | Barrel exports added | index.ts exports createDirectRuntimeClient + 4 types — verified by reading barrel file | Covered |

### Refactoring Performed

No refactoring was necessary. The implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ kebab-case files, camelCase functions, PascalCase interfaces, no `any`, ESM `.js` imports
- Project Structure: ✓ New files in `packages/core/src/bootstrap/`, co-located tests
- Testing Strategy: ✓ Vitest, AAA pattern, vi.fn() mocking, >80% coverage, co-located test file
- All ACs Met: ✓ All 8 acceptance criteria fully implemented and tested

### Improvements Checklist

All items are satisfactory — no required changes.

- [x] All 8 acceptance criteria implemented and tested
- [x] 15 unit tests covering happy paths, error paths, and edge cases
- [x] No `any` types used
- [x] ESM import extensions (.js) correct
- [x] Barrel exports complete (function + 4 types)
- [x] Error handling follows BootstrapError pattern with cause chaining
- [x] tsc --noEmit clean for new source files
- [x] No changes outside `packages/core/src/bootstrap/`

### Security Review

No security concerns. The SHA256 computation uses Node.js `crypto.createHash` (not a custom implementation). No external network calls (this is the direct/in-process client). No user input beyond what's passed through the typed API. No injection vectors.

### Performance Considerations

No performance concerns. The double SHA256 hash is lightweight (~microseconds per packet). The `Uint8Array.from(Buffer.from(...))` creates one extra copy but is negligible for typical ILP packet sizes.

### Files Modified During Review

None — no refactoring was needed.

### Gate Status

Gate: PASS → docs/qa/gates/10.2-create-directruntimeclient.yml
Risk profile: Low (standard library code, no security surface, well-tested)

### Recommended Status

✓ Ready for Done
