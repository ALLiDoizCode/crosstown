# Story 10.1: Rename handlePayment to handlePacket across codebase

## Status

Done

## Story

**As a** protocol maintainer,
**I want** all `handlePayment` references (methods, types, HTTP routes, exports) renamed to `handlePacket` across bls, relay, docker, and examples packages,
**so that** the naming conventions align with agent-runtime's `setPacketHandler` / `PaymentHandler` API, reducing cognitive friction for integrators.

## Acceptance Criteria

1. All `handlePayment` method references renamed to `handlePacket` across bls, relay, docker, examples packages
2. HTTP route `/handle-payment` renamed to `/handle-packet` everywhere
3. All type interfaces renamed: `HandlePaymentRequest` → `HandlePacketRequest`, `HandlePaymentAcceptResponse` → `HandlePacketAcceptResponse`, `HandlePaymentRejectResponse` → `HandlePacketRejectResponse`, `HandlePaymentResponse` → `HandlePacketResponse`
4. All existing tests pass with renamed routes/methods — `pnpm build` and `pnpm test` pass across all packages
5. All exports from `index.ts` barrel files updated with new names
6. Integration docs (`AGENT-RUNTIME-INTEGRATION.md`, `INTEGRATION-GAPS.md`, `ELIZAOS-INTEGRATION-HANDOFF.md`) updated with new names

## Tasks / Subtasks

- [x] Task 1: Rename types in `packages/bls/src/bls/types.ts` (AC: 3, 5)
  - [x] Rename `HandlePaymentRequest` → `HandlePacketRequest`
  - [x] Rename `HandlePaymentAcceptResponse` → `HandlePacketAcceptResponse`
  - [x] Rename `HandlePaymentRejectResponse` → `HandlePacketRejectResponse`
  - [x] Rename `HandlePaymentResponse` → `HandlePacketResponse`
  - [x] Update JSDoc comments ("payment request" → "packet request", etc.)

- [x] Task 2: Rename method and route in `packages/bls/src/bls/BusinessLogicServer.ts` (AC: 1, 2)
  - [x] Rename private method `handlePayment()` → `handlePacket()`
  - [x] Update HTTP route from `/handle-payment` to `/handle-packet`
  - [x] Update all type references within the file (`HandlePaymentRequest` → `HandlePacketRequest`, etc.)
  - [x] Update import statements from `./types.js`

- [x] Task 3: Update bls barrel exports (AC: 5)
  - [x] Update `packages/bls/src/bls/index.ts` — rename all `HandlePayment*` type exports to `HandlePacket*`
  - [x] Update `packages/bls/src/index.ts` — rename all `HandlePayment*` type exports to `HandlePacket*`

- [x] Task 4: Update bls test files (AC: 4)
  - [x] Update `packages/bls/src/bls/BusinessLogicServer.test.ts` — all `/handle-payment` route strings → `/handle-packet`, all `HandlePayment*` type refs → `HandlePacket*`
  - [x] Update `packages/bls/src/entrypoint.test.ts` — route string `/handle-payment` → `/handle-packet`, test description text

- [x] Task 5: Rename types in `packages/relay/src/bls/types.ts` (AC: 3, 5)
  - [x] Same renames as Task 1 (relay has its own copy of these types)

- [x] Task 6: Rename method and route in `packages/relay/src/bls/BusinessLogicServer.ts` (AC: 1, 2)
  - [x] Same renames as Task 2 (relay has its own copy of BLS)

- [x] Task 7: Update relay barrel exports (AC: 5)
  - [x] Update `packages/relay/src/bls/index.ts` — rename all `HandlePayment*` type exports to `HandlePacket*`
  - [x] Update `packages/relay/src/index.ts` — rename all `HandlePayment*` type exports to `HandlePacket*`

- [x] Task 8: Update relay test file (AC: 4)
  - [x] Update `packages/relay/src/bls/BusinessLogicServer.test.ts` — all `/handle-payment` route strings → `/handle-packet`, all `HandlePayment*` type refs → `HandlePacket*`

- [x] Task 9: Update docker entrypoint (AC: 1, 2, 3)
  - [x] Update `docker/src/entrypoint.ts` — rename all type imports (`HandlePaymentRequest` → `HandlePacketRequest`, etc.), route `/handle-payment` → `/handle-packet`, all variable/type usages
  - [x] Update `docker/src/entrypoint.test.ts` — all `/handle-payment` route strings → `/handle-packet`, test description text

- [x] Task 10: Update examples package (AC: 1, 2)
  - [x] Update `packages/examples/src/ilp-gated-relay-demo/mock-connector.ts` — URL string `/handle-payment` → `/handle-packet`, update JSDoc comments

- [x] Task 11: Update integration documentation and remaining comments (AC: 6)
  - [x] Update `docs/AGENT-RUNTIME-INTEGRATION.md` — all `/handle-payment` references → `/handle-packet`, all `handlePayment` → `handlePacket` references (~10 occurrences)
  - [x] Update `INTEGRATION-GAPS.md` — all `/handle-payment` references → `/handle-packet` (~9 occurrences)
  - [x] Update `ELIZAOS-INTEGRATION-HANDOFF.md` — all `handlePayment` / `HandlePayment*` / `/handle-payment` references → `handlePacket` / `HandlePacket*` / `/handle-packet` (~7 occurrences: lines 152, 154, 160, 166, 202, 476, 537)
  - [x] Update `packages/bls/README.md` — endpoint documentation
  - [x] Update `packages/examples/src/ilp-gated-relay-demo/README.md` — endpoint documentation
  - [x] Update `packages/core/src/spsp/negotiateAndOpenChannel.ts` — comment referencing "BLS /handle-payment" → "BLS /handle-packet"
  - [x] Update `packages/bls/examples/docker-compose.yml` — comments with `/handle-payment` → `/handle-packet`
  - [x] Update `packages/bls/examples/k8s/service.yaml` — comments with `/handle-payment` → `/handle-packet`

- [x] Task 12: Build and test validation (AC: 4)
  - [x] Run `pnpm build` — verify all packages compile
  - [x] Run `pnpm test` — verify all tests pass (expect same baseline: ~1020 passed, 2 pre-existing failures in `SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts`)
  - [x] Run `npx tsc --noEmit` from `packages/bls/`, `packages/relay/`, `packages/core/`, and `docker/` to verify type-checking passes

## Dev Notes

### Previous Story Insights
[Source: docs/stories/9.6.story.md — Dev Agent Record]

Story 9.6 published all three packages to npm. No code changes were made — only publish artifacts. The codebase is stable at v1.0.0. Pre-existing test baseline: 1020 passed, 2 failures in `SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` (subscribeMany call signature mismatches — unrelated to this work).

### Rename Mapping Table
[Source: docs/epics/epic-10-embedded-connector-integration.md#Part-A]

This is a mechanical find-and-replace across the codebase. The complete mapping:

| Old | New |
|-----|-----|
| `handlePayment()` | `handlePacket()` |
| `HandlePaymentRequest` | `HandlePacketRequest` |
| `HandlePaymentAcceptResponse` | `HandlePacketAcceptResponse` |
| `HandlePaymentRejectResponse` | `HandlePacketRejectResponse` |
| `HandlePaymentResponse` | `HandlePacketResponse` |
| `/handle-payment` (HTTP route) | `/handle-packet` |

### Source Files to Modify (with exact current state)
[Source: docs/epics/epic-10-embedded-connector-integration.md#Story-10.1]

**packages/bls/ (4 source files + 2 test files):**

1. **`packages/bls/src/bls/types.ts`** — Defines all 4 type interfaces (`HandlePaymentRequest`, `HandlePaymentAcceptResponse`, `HandlePaymentRejectResponse`, `HandlePaymentResponse`). Lines 41, 55, 68, 83. Also update JSDoc comments on each interface.

2. **`packages/bls/src/bls/BusinessLogicServer.ts`** — Has `private handlePayment()` method (line 82), route `'/handle-payment'` (line 55), and imports `HandlePaymentRequest`, `HandlePaymentAcceptResponse`, `HandlePaymentRejectResponse` from `./types.js` (lines 8-10).

3. **`packages/bls/src/bls/index.ts`** — Re-exports all 4 `HandlePayment*` types from `./types.js` (lines 2-6).

4. **`packages/bls/src/index.ts`** — Re-exports all 4 `HandlePayment*` types from `./bls/index.js` (lines 19-24).

5. **`packages/bls/src/bls/BusinessLogicServer.test.ts`** — Contains 43 references to `/handle-payment` route strings and `HandlePayment*` type references. The `describe` block is `'POST /handle-payment'` (line 100).

6. **`packages/bls/src/entrypoint.test.ts`** — Contains route string `/handle-payment` at line 70 and test description at line 63.

**packages/relay/ (4 source files + 1 test file):**

7. **`packages/relay/src/bls/types.ts`** — Identical type structure to bls types. Same 4 interfaces at same-ish lines. Note: relay's `HandlePaymentAcceptResponse` has `fulfillment?: string` (optional with `@deprecated` tag), while bls has `fulfillment: string` (required). Preserve this difference.

8. **`packages/relay/src/bls/BusinessLogicServer.ts`** — Same structure as bls version. `private handlePayment()` (line 84), route `'/handle-payment'` (line 57), same imports.

9. **`packages/relay/src/bls/index.ts`** — Same re-exports as bls version.

10. **`packages/relay/src/index.ts`** — Re-exports all 4 `HandlePayment*` types from `./bls/index.js` (lines 33-38).

11. **`packages/relay/src/bls/BusinessLogicServer.test.ts`** — 38 references to `/handle-payment` route strings.

**docker/ (2 files):**

12. **`docker/src/entrypoint.ts`** — Imports `HandlePaymentRequest`, `HandlePaymentAcceptResponse`, `HandlePaymentRejectResponse` from `@crosstown/bls` (lines 65-67). Route `'/handle-payment'` at line 360. Multiple type usages throughout the `/handle-payment` handler (lines 360-555).

13. **`docker/src/entrypoint.test.ts`** — `describe` block `'createBlsServer /handle-payment settlement'` (line 608). Multiple test requests to `/handle-payment` (lines 722, 766, 800, 832, 859, 883, 913, 1030).

**packages/examples/ (1 file):**

14. **`packages/examples/src/ilp-gated-relay-demo/mock-connector.ts`** — URL string `${this.blsUrl}/handle-payment` at line 66. JSDoc comments referencing `/handle-payment` at lines 6 and 37.

**Documentation (3 files + 2 READMEs):**

15. **`docs/AGENT-RUNTIME-INTEGRATION.md`** — ~10 references to `/handle-payment` and `handlePayment`.
16. **`INTEGRATION-GAPS.md`** — ~9 references to `/handle-payment`.
17. **`ELIZAOS-INTEGRATION-HANDOFF.md`** — ~7 references to `handlePayment` / `HandlePayment*` / `/handle-payment` (lines 152, 154, 160, 166, 202, 476, 537).
18. **`packages/bls/README.md`** — Endpoint documentation section `### POST /handle-payment`.
19. **`packages/examples/src/ilp-gated-relay-demo/README.md`** — References to `/handle-payment`.

### Critical Notes for Implementation

1. **BLS and relay have SEPARATE copies of types and BLS implementation.** Both must be updated independently. They are NOT shared files.

2. **The relay `HandlePaymentAcceptResponse.fulfillment` is `optional` (`fulfillment?: string`) with a `@deprecated` tag, while the bls `HandlePaymentAcceptResponse.fulfillment` is `required` (`fulfillment: string`).** When renaming, preserve this difference in the `HandlePacketAcceptResponse` types.

3. **Do NOT modify past story files** (e.g., `docs/stories/4.4.story.md`, `docs/stories/7.6.story.md`, and 12 others). These are historical records and should not be updated.

4. **Do NOT modify epic files** (`docs/epics/epic-{5,6,7,8,10,13}*.md`). These are historical/planning records. Epic 10 already documents the rename plan.

5. **Do NOT modify QA gate files** (`docs/qa/gates/*.yml`). These are historical QA records.

6. **Do NOT modify research docs** (`docs/research/elizaos-integration-deep-research-prompt.md`, `docs/research/babylon-integration-deep-research-report.md`, `docs/research/babylon-integration-deep-research-prompt.md`). These are point-in-time research artifacts.

7. **`dist/` directories** (`packages/bls/dist/`, `packages/relay/dist/`, `packages/core/dist/`) contain `.d.ts` files with `HandlePayment*` references. These are build artifacts and will be regenerated automatically by `pnpm build` in Task 12 — do NOT edit them manually.

8. **The `packages/core/` package has NO `handlePayment` references** in source code. It has one comment in `packages/core/src/spsp/negotiateAndOpenChannel.ts` referencing "BLS /handle-payment" — this comment should be updated.

9. **Docker `packages/bls/examples/docker-compose.yml` and `packages/bls/examples/k8s/service.yaml`** contain comments with `/handle-payment` — update these too.

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **Framework:** Vitest 1.x
- **File Convention:** `*.test.ts` co-located with source files
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Vitest built-in mocking; SimplePool always mocked
- **No new tests required** — this is a rename operation. All existing tests must continue to pass with the renamed routes and types.
- **Validation command:** `pnpm test` from workspace root runs all tests. Expected baseline: ~1020 passed, 2 pre-existing failures.
- **Build validation:** `pnpm build` from workspace root builds all packages.

### File Locations
[Source: docs/architecture/9-source-tree.md]

```
packages/
├── bls/src/
│   ├── bls/
│   │   ├── types.ts                 # Type interfaces (Task 1)
│   │   ├── BusinessLogicServer.ts   # Method + route (Task 2)
│   │   ├── BusinessLogicServer.test.ts  # Test route strings (Task 4)
│   │   └── index.ts                 # Barrel exports (Task 3)
│   ├── index.ts                     # Package exports (Task 3)
│   └── entrypoint.test.ts           # Entrypoint test (Task 4)
├── relay/src/
│   ├── bls/
│   │   ├── types.ts                 # Type interfaces (Task 5)
│   │   ├── BusinessLogicServer.ts   # Method + route (Task 6)
│   │   ├── BusinessLogicServer.test.ts  # Test route strings (Task 8)
│   │   └── index.ts                 # Barrel exports (Task 7)
│   └── index.ts                     # Package exports (Task 7)
├── examples/src/
│   └── ilp-gated-relay-demo/
│       └── mock-connector.ts        # URL string (Task 10)
└── core/src/
    └── spsp/
        └── negotiateAndOpenChannel.ts  # Comment update (Task 11)
docker/src/
├── entrypoint.ts                    # Imports, route, type usages (Task 9)
└── entrypoint.test.ts               # Route strings in tests (Task 9)
```

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

- Files: kebab-case (no file renames needed — no file is named after handlePayment)
- Classes: PascalCase
- Functions/methods: camelCase → `handlePacket` is correct
- Type aliases: PascalCase → `HandlePacketRequest` is correct
- Constants: UPPER_SNAKE_CASE (no constant renames needed)
- All public APIs exported from index.ts

### Project Structure Notes

No structural conflicts. This is a pure rename operation — no new files, no file moves, no new dependencies. All changes are in-place edits to existing files.

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
None — no blocking issues encountered.

### Completion Notes
- All 12 tasks completed successfully. Pure mechanical rename operation.
- Build validation: `@crosstown/core`, `@crosstown/bls`, `@crosstown/relay` all build clean. Docker type-checks clean.
- Test validation: 1020 passed, 2 failed (pre-existing: `SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` — `subscribeMany` call signature mismatches, unrelated to this work).
- `tsc --noEmit` on source files passes clean for all packages. Test files have pre-existing strict-mode warnings (TS18046/TS2532) that don't affect runtime.
- `ui-prototypes` package has pre-existing TS errors (unused variables) — not in scope of this story.
- Relay's `HandlePacketAcceptResponse.fulfillment` remains `optional` (`fulfillment?: string`) with `@deprecated` tag, as required.
- Historical files (stories, epics, QA gates, research docs) intentionally NOT modified per story instructions.

### File List

**Modified source files:**
- `packages/bls/src/bls/types.ts`
- `packages/bls/src/bls/BusinessLogicServer.ts`
- `packages/bls/src/bls/index.ts`
- `packages/bls/src/index.ts`
- `packages/bls/src/bls/BusinessLogicServer.test.ts`
- `packages/bls/src/entrypoint.test.ts`
- `packages/relay/src/bls/types.ts`
- `packages/relay/src/bls/BusinessLogicServer.ts`
- `packages/relay/src/bls/index.ts`
- `packages/relay/src/index.ts`
- `packages/relay/src/bls/BusinessLogicServer.test.ts`
- `docker/src/entrypoint.ts`
- `docker/src/entrypoint.test.ts`
- `packages/examples/src/ilp-gated-relay-demo/mock-connector.ts`
- `packages/core/src/spsp/negotiateAndOpenChannel.ts`

**Modified documentation files:**
- `docs/AGENT-RUNTIME-INTEGRATION.md`
- `INTEGRATION-GAPS.md`
- `ELIZAOS-INTEGRATION-HANDOFF.md`
- `packages/bls/README.md`
- `packages/examples/src/ilp-gated-relay-demo/README.md`
- `packages/bls/examples/docker-compose.yml`
- `packages/bls/examples/k8s/service.yaml`

**Modified story file:**
- `docs/stories/10.1.story.md`

## QA Results

### Review Date: 2026-02-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** — This is a clean, mechanical rename operation (handlePayment → handlePacket) executed with precision across 22 files spanning 4 packages and 7 documentation files. All renames are complete and consistent. No source code files retain old naming. The implementation correctly preserves the intentional difference between BLS (required `fulfillment: string`) and relay (optional `fulfillment?: string` with @deprecated tag).

### Refactoring Performed

None — no refactoring needed. The rename was mechanically applied and the resulting code is clean.

### Compliance Check

- Coding Standards: ✓ Method names use camelCase (`handlePacket`), types use PascalCase (`HandlePacketRequest`), consistent with project conventions
- Project Structure: ✓ No new files created, no file moves — pure in-place edits
- Testing Strategy: ✓ All existing tests updated to reference new names. 1020 tests pass, 2 pre-existing failures (SocialPeerDiscovery.test.ts and RelayMonitor.test.ts — `subscribeMany` call signature mismatches, unrelated to this work)
- All ACs Met: ✓ All 6 acceptance criteria verified (see traceability below)

### Acceptance Criteria Traceability

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | All `handlePayment` method refs renamed to `handlePacket` | ✓ | Grep confirms zero `handlePayment` in source files |
| 2 | HTTP route `/handle-payment` renamed to `/handle-packet` | ✓ | Grep confirms zero `/handle-payment` in source files |
| 3 | All type interfaces renamed (`HandlePayment*` → `HandlePacket*`) | ✓ | Verified in bls/types.ts, relay/types.ts, all barrel exports, docker imports |
| 4 | All existing tests pass | ✓ | 1020 passed, 2 failed (pre-existing baseline) |
| 5 | All exports from index.ts barrel files updated | ✓ | Verified bls/src/bls/index.ts, bls/src/index.ts, relay/src/bls/index.ts, relay/src/index.ts |
| 6 | Integration docs updated | ✓ | AGENT-RUNTIME-INTEGRATION.md (~10 refs), INTEGRATION-GAPS.md (~9 refs), ELIZAOS-INTEGRATION-HANDOFF.md, bls/README.md, examples README, docker-compose.yml, k8s/service.yaml |

### Improvements Checklist

All items handled — no outstanding work required.

- [x] Verified all source code files have no remaining `handlePayment` / `HandlePayment` / `/handle-payment` references
- [x] Verified relay's `HandlePacketAcceptResponse.fulfillment` remains optional with @deprecated (preserving intentional BLS/relay difference)
- [x] Verified historical files (past stories, epics, QA gates, research docs) correctly NOT modified
- [x] Verified build passes across all packages (bls, relay, core, examples, docker)
- [x] Verified test suite: 1020 passed, 2 pre-existing failures (unchanged baseline)

### Security Review

No security concerns. This is a naming-only change — no logic, authentication, authorization, or data handling was modified.

### Performance Considerations

No performance impact. Route strings changed but HTTP routing performance is unaffected.

### Files Modified During Review

None — no files were modified during QA review.

### Gate Status

Gate: PASS → docs/qa/gates/10.1-rename-handlepayment-to-handlepacket.yml
Risk profile: N/A (mechanical rename, no risk escalation triggers)
NFR assessment: N/A (no functional changes)

### Recommended Status

✓ Ready for Done

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-16 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-16 | 0.2 | Post-validation fixes: added ELIZAOS-INTEGRATION-HANDOFF.md to AC6/Task 11, added exclusion notes for research docs/dist files/epics, corrected reference counts (bls test: 43, relay test: 38, AGENT-RUNTIME-INTEGRATION: ~10, INTEGRATION-GAPS: ~9) | QA (Claude Opus 4.6) |
