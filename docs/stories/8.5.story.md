# Story 8.5: Update Docker Entrypoint and Compose for Bootstrap Flow

## Status

Done

## Story

**As a** deployer,
**I want** the Docker entrypoint and Compose configuration to support the new ILP-first bootstrap flow,
**so that** a multi-peer network self-organizes when containers start.

## Acceptance Criteria

1. Docker entrypoint starts bootstrap service after agent-runtime health check
2. Settlement env vars configured and validated on startup
3. Peer1 configured as bootstrap node (`SPSP_MIN_PRICE=0`)
4. Peers 2-5 configured with peer1 as known bootstrap peer [agent-runtime repo]
5. Full 5-peer network self-organizes: relay reads → registration → SPSP → channels [agent-runtime repo]
6. Deploy script verifies: health checks, routing tables, payment channels [agent-runtime repo]
7. End-to-end test: send paid packet from peer1 to peer5 through full topology [agent-runtime repo]
8. All 16 containers (TigerBeetle + 5 connectors + 5 agent-runtimes + 5 agent-societies) healthy [agent-runtime repo]

## Dev Notes

### Previous Story Insights
[Source: docs/stories/8.4.story.md#dev-agent-record]

From Story 8.4 (Reverse Registration and Cross-Peer Discovery):
- 1006 tests passing (15 new from 8.4), 0 failures
- ESLint: 1 pre-existing error in `packages/bls/src/storage/createEventStore.test.ts` (not introduced by Story 8.4)
- `RelayMonitor` class created and wired into Docker entrypoint, starts after bootstrap completes
- Docker entrypoint already parses settlement env vars (`SUPPORTED_CHAINS`, `SETTLEMENT_ADDRESS_*`, `PREFERRED_TOKEN_*`, `TOKEN_NETWORK_*`, `SETTLEMENT_TIMEOUT`, `INITIAL_DEPOSIT`)
- Docker entrypoint already uses new `BootstrapService` from Story 8.1, `IlpSpspClient` from Story 8.2, and paid announcements from Story 8.3
- Entrypoint test `envKeysToClean` still missing `SUPPORTED_CHAINS` and `SETTLEMENT_ADDRESS_*` vars (carried from 8.2/8.3, low severity)
- QA noted: `PUBKEY_REGEX` duplication is now resolved

### What Has Already Been Implemented (Stories 8.1-8.4)
[Source: docker/src/entrypoint.ts]

The Docker entrypoint **already** includes most of the Epic 8.5 scope from earlier stories:
- **Settlement env vars:** `SUPPORTED_CHAINS`, `SETTLEMENT_ADDRESS_*`, `PREFERRED_TOKEN_*` are parsed in `parseConfig()` (line 134-157)
- **AGENT_RUNTIME_URL:** Parsed and validated in `parseConfig()` (line 124-132)
- **New BootstrapService:** Used with ILP-first flow configuration (line 447-466)
- **AgentRuntimeClient:** Wired for ILP-first flow (line 509-513)
- **RelayMonitor:** Started after bootstrap with exclude list (line 567-607)
- **Graceful shutdown:** Handles SIGINT/SIGTERM with relay monitor unsubscribe (line 627-644)
- **Health endpoint:** Reports bootstrap phase (line 254-263)

### What Remains for Story 8.5

The remaining work focuses on two areas:

#### Area 1: Agent-Runtime Health Check Before Bootstrap (AC 1)
[Source: docker/src/entrypoint.ts:544]

Currently the entrypoint calls `bootstrapService.bootstrap()` immediately without waiting for the agent-runtime to be healthy. When `AGENT_RUNTIME_URL` is set, the entrypoint should poll the agent-runtime health endpoint (`GET /health`) before starting bootstrap, since the ILP-first flow depends on agent-runtime being available for `POST /ilp/send`.

**Implementation:** Add a `waitForAgentRuntime(url: string, options?: { timeout?: number; interval?: number }): Promise<void>` function that:
- Polls `${agentRuntimeUrl}/health` with configurable interval (default: 2000ms) and timeout (default: 60000ms)
- Returns when health check responds with HTTP 200
- Throws `Error` on timeout
- Logs each retry attempt for observability
- Called in `main()` before `bootstrapService.bootstrap()` when `config.agentRuntimeUrl` is set

#### Area 2: Settlement Env Var Validation (AC 2)
[Source: docker/src/entrypoint.ts:134-157]

Currently settlement env vars are parsed but not validated. Add validation:
- When `SUPPORTED_CHAINS` is set, at least one chain must have a `SETTLEMENT_ADDRESS_*` env var
- Warn (but don't fail) if a chain is listed in `SUPPORTED_CHAINS` but has no corresponding `SETTLEMENT_ADDRESS_*`

#### Area 3: Entrypoint Test Cleanup (AC 2)
[Source: docker/src/entrypoint.test.ts:17-31]

Add missing env var keys to `envKeysToClean` array:
- `SUPPORTED_CHAINS`
- `SETTLEMENT_ADDRESS_EVM_BASE_8453` (representative example)
- `PREFERRED_TOKEN_EVM_BASE_8453`
- `TOKEN_NETWORK_EVM_BASE_8453`
- `SETTLEMENT_TIMEOUT` (documented in entrypoint header but not currently parsed by `parseConfig()` — add to cleanup defensively)
- `INITIAL_DEPOSIT` (documented in entrypoint header but not currently parsed by `parseConfig()` — add to cleanup defensively)
- `SPSP_MIN_PRICE`

Add new test cases for:
- Settlement info parsing with `SUPPORTED_CHAINS` and settlement address env vars
- Agent-runtime health check wait behavior
- Settlement validation warnings

#### Area 4: SPSP_MIN_PRICE Support (AC 3)
[Source: docker/src/entrypoint.ts:89-176]

Add `SPSP_MIN_PRICE` env var parsing to `parseConfig()`:
- Type: `bigint | undefined`
- When set to `"0"`, this is a bootstrap node that accepts 0-amount SPSP handshakes
- Pass to `PricingService` kind override for SPSP_REQUEST_KIND when `SPSP_MIN_PRICE=0`
- The current kind override for SPSP is `basePricePerByte / 2n` (half price); `SPSP_MIN_PRICE=0` should override this to `0n`

#### Area 5: Docker Compose and Deploy Script (AC 3-8) — EXTERNAL REPO
[Source: docs/epics/epic-8-nostr-network-bootstrap.md, "Update agent-runtime docker-compose-unified.yml" scope]

The Docker Compose and deploy script changes target the **agent-runtime repository** (not this repo). These items are out of scope for code changes in this story but should be documented as integration notes:

- `docker-compose-unified.yml` in agent-runtime needs settlement env vars for agent-society services
- `.env.peers` in agent-runtime needs EVM addresses
- `scripts/deploy-5-peer-multihop.sh` in agent-runtime needs bootstrap/channel/routing verification
- Peer1 should have `SPSP_MIN_PRICE=0` in its agent-society service config
- Peers 2-5 should have `KNOWN_PEERS` / `ADDITIONAL_PEERS` pointing to peer1

These external-repo changes are **integration requirements** that should be tracked separately (e.g., as an agent-runtime story or task).

### Data Models
[Source: docker/src/entrypoint.ts:67-84]

**Config interface (existing, in docker/src/entrypoint.ts):**
```typescript
interface Config {
  nodeId: string;
  secretKey: Uint8Array;
  pubkey: string;
  ilpAddress: string;
  btpEndpoint: string;
  blsPort: number;
  wsPort: number;
  connectorAdminUrl: string;
  ardriveEnabled: boolean;
  additionalPeersJson: string | undefined;
  relayUrls: string[];
  assetCode: string;
  assetScale: number;
  basePricePerByte: bigint;
  agentRuntimeUrl: string | undefined;
  settlementInfo: SpspRequestSettlementInfo | undefined;
}
```

**New field to add to Config:**
- `spspMinPrice: bigint | undefined` — when set, overrides SPSP pricing for this node (bootstrap node sets to `0n`)

### API Specifications

**Agent-runtime health endpoint:**
```
GET /health
Response: { "status": "healthy", ... }
Status: 200 when healthy
```

The `waitForAgentRuntime` function polls this endpoint. No authentication required (local network).

### File Locations
[Source: docs/architecture/9-source-tree.md, docker/src/]

**Files to modify:**
- `docker/src/entrypoint.ts` — Add `waitForAgentRuntime()`, add `SPSP_MIN_PRICE` parsing, add settlement validation
- `docker/src/entrypoint.test.ts` — Add missing env vars to cleanup, add new test cases

**Files NOT modified:**
- `packages/core/src/bootstrap/BootstrapService.ts` — No changes needed
- `packages/core/src/bootstrap/RelayMonitor.ts` — No changes needed
- `packages/core/src/bootstrap/types.ts` — No changes needed
- `packages/core/src/index.ts` — No changes needed

### Technical Constraints

**Health check polling pattern:**
Use a simple retry loop with `setTimeout` (not `setInterval`) to avoid overlapping requests. Each iteration: attempt fetch, on success return, on failure wait interval and retry. On timeout, throw with descriptive message including URL and timeout duration. Note: cancellation support is not needed — `waitForAgentRuntime` runs sequentially before bootstrap starts, so graceful shutdown is not a concern at this point in the startup sequence.

**`fetch` error handling:**
The health endpoint may not be reachable initially (connection refused). Wrap in try/catch and treat network errors the same as non-200 responses (retry). Only throw on timeout.

**BigInt for SPSP_MIN_PRICE:**
Parse with `BigInt(env['SPSP_MIN_PRICE'])`. Only create the bigint if the env var is set and non-empty.

**PricingService kind override:**
[Source: docker/src/entrypoint.ts:437-443]
The `kindOverrides` map currently sets SPSP request kind to `basePricePerByte / 2n`. When `SPSP_MIN_PRICE` is set, override to `BigInt(SPSP_MIN_PRICE)` instead.

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

- Agent-runtime health check timeout: throw `Error` with descriptive message, causes `main()` to exit with error code 1
- Settlement validation: log `console.warn` for missing addresses, do NOT throw (non-blocking)
- `SPSP_MIN_PRICE` parse failure: throw `Error` if value is not a valid integer string

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x
**File:** `docker/src/entrypoint.test.ts` (existing file, co-located)

**Test patterns to follow:**
[Source: docker/src/entrypoint.test.ts]
```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { parseConfig, createConnectorAdminClient } from './entrypoint.js';
```
- Mock `nostr-tools/pure` with `vi.mock()`
- Save/restore env vars in `beforeEach`/`afterEach`
- Use `vi.stubGlobal('fetch', vi.fn())` for HTTP mocks

**New tests needed:**

For `parseConfig`:
- Test: `SPSP_MIN_PRICE=0` parsed as `0n` bigint
- Test: `SPSP_MIN_PRICE=5` parsed as `5n` bigint (non-zero positive value)
- Test: `SPSP_MIN_PRICE` not set defaults to `undefined`
- Test: `SUPPORTED_CHAINS` with settlement address creates correct `settlementInfo`
- Test: `SUPPORTED_CHAINS` without any settlement address logs warning

For `waitForAgentRuntime`:
- Test: returns immediately when health endpoint responds 200
- Test: retries on network error until success
- Test: throws on timeout after max attempts
- Test: logs retry attempts

**Expected new test count:** ~8-9 new tests
**Total expected:** 1006 (baseline from 8.4) + ~8-9 = ~1014-1015

### Scope Boundaries

**In Scope:**
- Agent-runtime health check before bootstrap (`waitForAgentRuntime`)
- `SPSP_MIN_PRICE` env var parsing and PricingService integration
- Settlement env var validation (warn on missing addresses)
- Entrypoint test cleanup (add missing env vars to `envKeysToClean`)
- New unit tests for all new functionality
- Documentation of Docker Compose/deploy script requirements for agent-runtime repo

**Out of Scope:**
- Docker Compose changes (in agent-runtime repo)
- Deploy script changes (in agent-runtime repo)
- `.env.peers` changes (in agent-runtime repo)
- End-to-end multi-container testing (requires agent-runtime infrastructure)
- Modifying core library packages
- AC 4-8 verification (requires running multi-container setup in agent-runtime repo)

## Tasks / Subtasks

- [x] Task 1: Add `SPSP_MIN_PRICE` env var to `parseConfig()` (AC: 3)
  - [x] In `docker/src/entrypoint.ts`:
    - Add `spspMinPrice: bigint | undefined` field to `Config` interface
    - Parse `SPSP_MIN_PRICE` env var as `BigInt()` when set
    - Return `spspMinPrice` in config object
  - [x] Update PricingService initialization to use `spspMinPrice` when set:
    - If `config.spspMinPrice !== undefined`, use it as the SPSP kind override price
    - Otherwise keep existing `basePricePerByte / 2n` as default

- [x] Task 2: Add settlement env var validation (AC: 2)
  - [x] In `docker/src/entrypoint.ts` `parseConfig()`:
    - After parsing `SUPPORTED_CHAINS`, log `console.warn` for each chain that has no `SETTLEMENT_ADDRESS_*` env var
    - This is a non-fatal warning — deployment can proceed without addresses

- [x] Task 3: Add `waitForAgentRuntime()` function and wire into startup (AC: 1)
  - [x] Create `waitForAgentRuntime(url: string, options?: { timeout?: number; interval?: number }): Promise<void>` in `docker/src/entrypoint.ts`
    - Poll `${url}/health` with configurable interval (default: 2000ms) and timeout (default: 60000ms)
    - On HTTP 200: return (success)
    - On network error or non-200: log retry, wait interval, try again
    - On timeout: throw `Error('Agent-runtime health check timed out after ${timeout}ms: ${url}')`
  - [x] In `main()`, before `bootstrapService.bootstrap()`:
    - If `config.agentRuntimeUrl` is set, call `await waitForAgentRuntime(config.agentRuntimeUrl)`
    - Log `[Bootstrap] Waiting for agent-runtime at ${config.agentRuntimeUrl}...`
    - Log `[Bootstrap] Agent-runtime is healthy` on success

- [x] Task 4: Update entrypoint tests (AC: 1, 2, 3)
  - [x] Add missing env vars to `envKeysToClean` array:
    - `SUPPORTED_CHAINS`, `SETTLEMENT_ADDRESS_EVM_BASE_8453`, `PREFERRED_TOKEN_EVM_BASE_8453`, `TOKEN_NETWORK_EVM_BASE_8453`, `SETTLEMENT_TIMEOUT`, `INITIAL_DEPOSIT`, `SPSP_MIN_PRICE`
  - [x] Add test: `SPSP_MIN_PRICE=0` parsed as `0n`
  - [x] Add test: `SPSP_MIN_PRICE=5` parsed as `5n` (non-zero positive value)
  - [x] Add test: `SPSP_MIN_PRICE` defaults to `undefined` when not set
  - [x] Add test: `SUPPORTED_CHAINS` with `SETTLEMENT_ADDRESS_*` creates `settlementInfo`
  - [x] Add new `describe('waitForAgentRuntime')` block:
    - Test: resolves when health endpoint returns 200
    - Test: retries on fetch error until success
    - Test: rejects on timeout
  - [x] Export `waitForAgentRuntime` from entrypoint for testing

- [x] Task 5: Document Docker Compose integration requirements (AC: 3, 4, 5, 6, 7, 8)
  - [x] Add integration notes section to this story's Dev Notes documenting:
    - Required Docker Compose env vars for peer1 (bootstrap): `SPSP_MIN_PRICE=0`, `AGENT_RUNTIME_URL`, `SUPPORTED_CHAINS`, settlement addresses
    - Required Docker Compose env vars for peers 2-5: `AGENT_RUNTIME_URL`, `ADDITIONAL_PEERS` pointing to peer1, `SUPPORTED_CHAINS`, settlement addresses
    - Deploy script verification steps: health checks, routing tables, payment channels, e2e packet
  - [x] This task is documentation-only (no code changes in this repo)

- [x] Task 6: Run full test suite and lint (AC: 1, 2, 3)
  - [x] Run `pnpm test` — target ~1014 tests passing (~8 new), 0 failures
  - [x] Run `pnpm lint` — no new lint errors
  - [x] Verify no regressions in any package

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Integration Notes (Docker Compose / Deploy Script — agent-runtime repo)

**Peer 1 (bootstrap node) agent-society service env vars:**
- `SPSP_MIN_PRICE=0` — accept free SPSP handshakes
- `AGENT_RUNTIME_URL=http://agent-runtime-peer1:3000`
- `SUPPORTED_CHAINS=evm:base:8453`
- `SETTLEMENT_ADDRESS_EVM_BASE_8453=<peer1-evm-address>`

**Peers 2-5 agent-society service env vars:**
- `AGENT_RUNTIME_URL=http://agent-runtime-peerN:3000`
- `ADDITIONAL_PEERS=[{"pubkey":"<peer1-pubkey>","relayUrl":"ws://agent-society-peer1:7100","ilpAddress":"g.peer1","btpEndpoint":"ws://connector-peer1:3000"}]`
- `SUPPORTED_CHAINS=evm:base:8453`
- `SETTLEMENT_ADDRESS_EVM_BASE_8453=<peerN-evm-address>`

**Deploy script verification steps (agent-runtime repo):**
1. Health checks: `GET /health` on all 16 containers returns 200
2. Routing tables: each connector has routes to all other peers
3. Payment channels: SPSP handshakes complete between all connected peers
4. E2E packet: send paid ILP packet from peer1 to peer5 through full topology

### Debug Log References
_(none)_

### Completion Notes
- 9 new tests added (26 total in entrypoint.test.ts)
- `waitForAgentRuntime()` function added with retry/timeout pattern
- `SPSP_MIN_PRICE` env var parsed and wired into PricingService kind overrides
- Settlement validation warns on chains without addresses
- `envKeysToClean` updated with 7 missing env var keys

## File List

| File | Action | Description |
|------|--------|-------------|
| `docker/src/entrypoint.ts` | Modified | Add `waitForAgentRuntime()`, `SPSP_MIN_PRICE` parsing, settlement validation |
| `docker/src/entrypoint.test.ts` | Modified | Add env var cleanup, new tests for health check and config parsing |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-09 | 0.2 | QA validation fixes: correct Data Models source tag, annotate ACs 4-8 as agent-runtime repo, clarify SETTLEMENT_TIMEOUT/INITIAL_DEPOSIT not parsed, add SPSP_MIN_PRICE non-zero test, add waitForAgentRuntime cancellation note | QA (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Solid implementation. The story scope was well-defined and constrained — 3 new fields in `Config`, a health-check polling function, settlement validation warnings, and `SPSP_MIN_PRICE` integration. The code follows established patterns from prior stories (BigInt parsing, env var validation, retry loops) and aligns with the architecture's error handling strategy.

**Strengths:**
- `waitForAgentRuntime` uses `setTimeout`-based retry (no overlapping requests), as specified
- `SPSP_MIN_PRICE` parsing handles edge cases: empty string, invalid input, absent variable
- Settlement warning is non-fatal (`console.warn`), correctly following error handling strategy
- PricingService integration correctly prioritizes `spspMinPrice` over default `basePricePerByte / 2n`
- Test env cleanup (`envKeysToClean`) addresses carry-over issue from 8.4 gate (TEST-001)

**Minor observations (not blocking):**
- `waitForAgentRuntime` does not validate the URL before polling — however, the URL was already validated in `parseConfig()`, so this is safe
- Negative `SPSP_MIN_PRICE` values (e.g., `-1`) are accepted by `BigInt()` without error — semantically questionable but non-blocking since this is an internal deployment config, not user-facing input

### Refactoring Performed

None — code quality is clean and no refactoring was warranted.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, camelCase functions, PascalCase interfaces, UPPER_SNAKE_CASE constants
- Project Structure: ✓ Co-located test file, changes confined to `docker/src/`
- Testing Strategy: ✓ Vitest, AAA pattern, mocked fetch/console, no live relay dependencies
- All ACs Met: ✓ (for in-scope ACs 1-3; ACs 4-8 correctly documented as agent-runtime repo scope)

### Improvements Checklist

- [x] `envKeysToClean` updated with 7 missing env var keys (resolves 8.4 gate TEST-001)
- [x] `SPSP_MIN_PRICE` parsing with BigInt validation
- [x] Settlement validation with non-fatal warnings
- [x] `waitForAgentRuntime` with retry/timeout pattern
- [x] PricingService `spspMinPrice` override
- [ ] Consider adding negative `SPSP_MIN_PRICE` validation (reject values < 0) — low priority, deployment-only config

### Security Review

No security concerns. No secrets are exposed in logs. The `waitForAgentRuntime` function connects only to an internal health endpoint over local Docker network (no authentication needed per spec). Settlement addresses are stored in config only, not logged. `SPSP_MIN_PRICE` affects pricing logic but cannot be exploited externally (set via env var at deployment).

### Performance Considerations

No performance concerns. `waitForAgentRuntime` runs once at startup before bootstrap — the 60-second default timeout and 2-second interval are appropriate for container orchestration. The polling loop exits immediately on success.

### Files Modified During Review

None — no refactoring performed.

### Gate Status

Gate: PASS → docs/qa/gates/8.5-update-docker-entrypoint-and-compose-for-bootstrap-flow.yml

### Recommended Status

✓ Ready for Done

(Story owner decides final status)
