# Story 5.3: Environment Variable Configuration

## Status

Done

## Story

**As a** relay operator,
**I want** the BLS container configurable via environment variables,
**so that** I can customize behavior without rebuilding the image.

## Acceptance Criteria

1. Environment variables documented in README:
   - `NODE_ID` (required): Unique node identifier
   - `NOSTR_SECRET_KEY` (required): 64-char hex Nostr secret key
   - `ILP_ADDRESS` (required): Node's ILP address (e.g., `g.crosstown.node1`)
   - `BLS_PORT` (optional): HTTP port, default `3100`
   - `BLS_BASE_PRICE_PER_BYTE` (optional): Pricing rate, default `10` (also accepts unprefixed `BASE_PRICE_PER_BYTE` or `RELAY_BASE_PRICE_PER_BYTE` as fallbacks)
   - `OWNER_PUBKEY` (optional): Pubkey for self-write bypass
   - `DATA_DIR` (optional): Directory for SQLite database, default `/data`
   - `BLS_KIND_OVERRIDES` (optional): JSON object mapping event kinds to prices (also accepts unprefixed `KIND_OVERRIDES` or `RELAY_KIND_OVERRIDES` as fallbacks)
2. Container fails fast with descriptive error if required vars missing
3. Configuration logged on startup (secrets masked)
4. Unit tests verify config parsing and validation

## Tasks / Subtasks

- [x] Task 1: Extract config parsing into a dedicated `packages/bls/src/config.ts` module (AC: 2, 4)
  - [x] Create a `BlsEnvConfig` interface representing all parsed/validated configuration fields (nodeId, nostrSecretKey, ilpAddress, port, basePricePerByte, ownerPubkey, dataDir, kindOverrides, pubkey). **Note:** The name `BlsConfig` is already taken by the BLS server config type in `bls/types.ts` — use `BlsEnvConfig` to avoid collision.
  - [x] Create a `loadBlsConfigFromEnv()` function that reads and validates all environment variables
  - [x] Validate `NODE_ID`: non-empty string
  - [x] Validate `NOSTR_SECRET_KEY`: must be exactly 64 hex characters (`/^[0-9a-f]{64}$/` after `.toLowerCase()`). Normalize to lowercase before validation to match the existing `PUBKEY_REGEX` convention in `bls/types.ts`.
  - [x] Derive `pubkey` from secret key via `getPublicKey()` (nostr-tools) — include in config output
  - [x] Validate `ILP_ADDRESS`: non-empty string matching ILP address pattern (starts with `g.`, contains only alphanumeric and dots/hyphens)
  - [x] Validate `BLS_PORT`: parse as integer, must be 1–65535 (default: 3100)
  - [x] Delegate `BASE_PRICE_PER_BYTE` and `KIND_OVERRIDES` parsing to `loadPricingConfigFromEnv()` from `pricing/config.ts`. That function reads `BLS_BASE_PRICE_PER_BYTE` / `RELAY_BASE_PRICE_PER_BYTE` (with fallback) and `BLS_KIND_OVERRIDES` / `RELAY_KIND_OVERRIDES`. Also read the unprefixed `BASE_PRICE_PER_BYTE` env var as a final fallback: if set and the `BLS_`/`RELAY_` prefixed vars are not, write it into `process.env['BLS_BASE_PRICE_PER_BYTE']` before calling `loadPricingConfigFromEnv()` so that existing behavior is preserved. Same approach for `KIND_OVERRIDES` → `BLS_KIND_OVERRIDES`.
  - [x] Validate `OWNER_PUBKEY` if provided: must be 64-char lowercase hex (normalize with `.toLowerCase()`, validate with `/^[0-9a-f]{64}$/`)
  - [x] Parse `DATA_DIR` with default `/data`
  - [x] Throw a descriptive `ConfigError` (or use `console.error` + `process.exit(1)`) for any validation failure, naming the specific variable and what went wrong
  - [x] Export `BlsEnvConfig` type and `loadBlsConfigFromEnv` function from the module

- [x] Task 2: Create `ConfigError` class or use existing error pattern (AC: 2)
  - [x] If creating a new error class, extend `BlsBaseError` from `errors.ts`
  - [x] Include the environment variable name and the validation failure reason in the error message
  - [x] Ensure error messages are descriptive enough for operators to fix (e.g., "NOSTR_SECRET_KEY must be a 64-character hex string, got 32 characters")

- [x] Task 3: Refactor `entrypoint.ts` to use the new config module (AC: 2, 3)
  - [x] Replace inline `getRequiredEnv()` calls and manual parsing with a single call to `loadBlsConfigFromEnv()`
  - [x] Keep the `try/catch` around config loading that calls `process.exit(1)` on failure
  - [x] Use the parsed `BlsEnvConfig` to construct the event store, pricing service, and BLS server
  - [x] Ensure startup log output remains the same (nodeId, pubkey, ilpAddress, dataDir — NOT the secret key)

- [x] Task 4: Enhance startup logging with complete config summary (AC: 3)
  - [x] Log all configuration values on startup
  - [x] Mask `NOSTR_SECRET_KEY` entirely (show derived pubkey instead)
  - [x] Mask `OWNER_PUBKEY` partially if desired, or show in full (it's a public key, not a secret)
  - [x] Log `BLS_PORT`, `BASE_PRICE_PER_BYTE`, `DATA_DIR`
  - [x] Log `KIND_OVERRIDES` if set (just the kind numbers and prices)
  - [x] Existing log format is fine — just ensure all fields are present

- [x] Task 5: Write unit tests for `config.ts` (AC: 4)
  - [x] Test: `loadBlsConfigFromEnv()` returns valid config when all required vars are set
  - [x] Test: throws/exits when `NODE_ID` is missing
  - [x] Test: throws/exits when `NOSTR_SECRET_KEY` is missing
  - [x] Test: throws/exits when `NOSTR_SECRET_KEY` is not 64 hex chars (too short, too long, non-hex characters)
  - [x] Test: throws/exits when `ILP_ADDRESS` is missing
  - [x] Test: throws/exits when `ILP_ADDRESS` has invalid format
  - [x] Test: uses default port 3100 when `BLS_PORT` is not set
  - [x] Test: parses custom `BLS_PORT` correctly
  - [x] Test: throws/exits when `BLS_PORT` is not a valid port number (0, 65536, non-numeric)
  - [x] Test: uses default basePricePerByte of 10 when not set
  - [x] Test: parses `BASE_PRICE_PER_BYTE` correctly
  - [x] Test: validates `OWNER_PUBKEY` format when provided (64-char hex)
  - [x] Test: uses default `/data` for `DATA_DIR` when not set
  - [x] Test: parses `KIND_OVERRIDES` JSON correctly
  - [x] Test: throws/exits on invalid `KIND_OVERRIDES` JSON
  - [x] Test: derives correct pubkey from secret key
  - [x] Follow AAA pattern (Arrange, Act, Assert) and use `beforeEach`/`afterEach` to save/restore `process.env`

- [x] Task 6: Create `packages/bls/README.md` with environment variable documentation (AC: 1)
  - [x] Document all environment variables in a table format:
    | Variable | Required | Default | Description |
  - [x] Include examples for each variable
  - [x] Include a "Quick Start" section showing a minimal `docker run` command with required vars
  - [x] Include a "Configuration" section with detailed descriptions of each variable
  - [x] Document `KIND_OVERRIDES` JSON format with example
  - [x] Document `BLS_`-prefixed pricing variable aliases: note that `BLS_BASE_PRICE_PER_BYTE` and `BLS_KIND_OVERRIDES` are the canonical names, with `BASE_PRICE_PER_BYTE` / `KIND_OVERRIDES` (unprefixed) and `RELAY_BASE_PRICE_PER_BYTE` / `RELAY_KIND_OVERRIDES` supported as fallbacks for backwards compatibility
  - [x] Document the health endpoint response format
  - [x] Document the `/handle-payment` endpoint contract (reference Epic 5 BLS Contract Specification)
  - [x] Keep README focused — this is an operator reference, not a developer guide

- [x] Task 7: Update `packages/bls/src/index.ts` exports (AC: 4)
  - [x] Export `BlsEnvConfig` type and `loadBlsConfigFromEnv` from package index
  - [x] Export `ConfigError` if created as a class

- [x] Task 8: Verify all existing tests still pass
  - [x] Run `pnpm test` from root — all existing 734+ tests must pass
  - [x] Verify new config tests pass
  - [x] Note: there are no existing entrypoint tests (`entrypoint.test.ts` does not exist). Entrypoint testing is covered indirectly by the new `config.test.ts` which tests the extracted `loadBlsConfigFromEnv()` function.

## Dev Notes

### Previous Story Insights
[Source: docs/stories/5.2.story.md#dev-agent-record]

From Story 5.2 implementation:
- Used `pnpm deploy --prod` for clean production Docker deployment
- Image optimized to 147MB by stripping `better-sqlite3` build artifacts
- `libstdc++` required at runtime on Alpine for `better-sqlite3` native addon
- All 9 acceptance criteria verified via Docker CLI
- No issues encountered during implementation

From Story 5.1 implementation:
[Source: docs/stories/5.1.story.md#dev-agent-record]
- BLS package at `packages/bls/` is fully standalone
- Docker entrypoint reads env vars: `NODE_ID`, `NOSTR_SECRET_KEY`, `ILP_ADDRESS`, `BLS_PORT`, `BASE_PRICE_PER_BYTE`, `OWNER_PUBKEY`, `DATA_DIR`, `KIND_OVERRIDES`
- Entrypoint uses `@hono/node-server` `serve()` to bind the HTTP server
- Graceful shutdown handlers for SIGINT/SIGTERM are implemented
- Health endpoint returns `{ status, nodeId, pubkey, ilpAddress, timestamp }`
- `getPublicKey()` from `nostr-tools/pure` requires `Uint8Array`, not hex string — entrypoint converts hex to Uint8Array via `match(/.{2}/g)` + `map(parseInt)`
- QA fix pass added `BLS_` prefix env var aliases in pricing config with `RELAY_` fallback
- 734 tests passing after QA fixes

### Current Entrypoint Implementation
[Source: packages/bls/src/entrypoint.ts]

The current entrypoint has inline config parsing that needs to be extracted:

```typescript
// Current pattern (to be refactored):
function getRequiredEnv(name: string): string {
  const value = process.env[name];
  if (!value) {
    console.error(`ERROR: Required environment variable ${name} is not set`);
    process.exit(1);
  }
  return value;
}

// In main():
const nodeId = getRequiredEnv('NODE_ID');
const nostrSecretKey = getRequiredEnv('NOSTR_SECRET_KEY');
const ilpAddress = getRequiredEnv('ILP_ADDRESS');
const port = parseInt(process.env['BLS_PORT'] ?? '3100', 10);
const basePricePerByte = BigInt(process.env['BASE_PRICE_PER_BYTE'] ?? '10');
const ownerPubkey = process.env['OWNER_PUBKEY'];
const dataDir = process.env['DATA_DIR'] ?? '/data';
```

Key observations:
- `getRequiredEnv` only checks for presence, NOT format validation
- `NOSTR_SECRET_KEY` format validation happens later during `getPublicKey()` conversion, but error message is generic
- `BLS_PORT` is parsed but never validated for range (1-65535) or NaN
- `OWNER_PUBKEY` has no format validation
- `ILP_ADDRESS` has no format validation
- Config parsing is untestable because it's inside `main()` with `process.exit(1)` calls

The refactoring should extract all parsing into a pure function that **throws** errors (not calls `process.exit`), making it testable. The entrypoint's `main()` wraps the call and handles `process.exit(1)` on error.

### Existing Pricing Config Module
[Source: packages/bls/src/pricing/config.ts]

There is already a `loadPricingConfigFromEnv()` function in `packages/bls/src/pricing/config.ts` that:
- Reads `BLS_BASE_PRICE_PER_BYTE` / `RELAY_BASE_PRICE_PER_BYTE` with fallback
- Reads `BLS_KIND_OVERRIDES` / `RELAY_KIND_OVERRIDES` with fallback
- Validates values and throws `PricingError` on invalid input
- Has comprehensive tests in `packages/bls/src/pricing/config.test.ts`

The new `config.ts` module should either:
- Import and reuse `loadPricingConfigFromEnv()` for pricing-specific vars, OR
- Inline the parsing for `BASE_PRICE_PER_BYTE` and `KIND_OVERRIDES` to avoid circular dependencies

Recommended: **Reuse** `loadPricingConfigFromEnv()` — it's already tested and handles edge cases well. The new `loadBlsConfigFromEnv()` can call it internally for the pricing portion.

### Error Pattern
[Source: packages/bls/src/errors.ts]

The BLS package uses `BlsBaseError` as its base error class:
```typescript
export class BlsBaseError extends Error {
  constructor(message: string, public code: string) {
    super(message);
    this.name = 'BlsBaseError';
  }
}
```

The `ConfigError` should follow this pattern (same as `BlsError` in `bls/types.ts`):
```typescript
export class ConfigError extends BlsBaseError {
  constructor(public readonly variable: string, message: string) {
    super(`${variable}: ${message}`, 'CONFIG_ERROR');
  }
}
```

### Package Exports
[Source: packages/bls/src/index.ts]

All public APIs must be exported from `packages/bls/src/index.ts` (barrel exports pattern used throughout the project).

### BLS Contract Specification
[Source: docs/epics/epic-5-standalone-bls-docker.md#bls-contract-specification]

For the README, reference these endpoints:

**GET /health** - Returns `{ status, nodeId, pubkey, ilpAddress, timestamp }`

**POST /handle-payment** - Request: `{ amount, destination, data }` → Response: `{ accept, fulfillment, metadata }` or `{ accept: false, code, message, metadata }`

ILP Error Codes: `F00` (BAD_REQUEST), `F06` (INSUFFICIENT_AMOUNT), `T00` (INTERNAL_ERROR)

### Scope Boundaries

**In Scope (this story):**
- `packages/bls/src/config.ts` — new config parsing/validation module
- `packages/bls/src/config.test.ts` — unit tests for config module
- `packages/bls/src/entrypoint.ts` — refactor to use config module
- `packages/bls/README.md` — environment variable documentation
- `packages/bls/src/index.ts` — export new types
- `packages/bls/src/errors.ts` — add `ConfigError` class (if needed)

**Out of Scope:**
- Volume-based storage configuration details (Story 5.4)
- Docker Hub publishing and CI workflow (Story 5.5)
- Docker Compose examples (Story 5.6)
- Kubernetes manifests (Story 5.7)
- BLS contract documentation (Story 5.8)
- Changing the Dockerfile (already complete in Story 5.2)

### Testing

**Test File Location:** `packages/bls/src/config.test.ts` (co-located with source)
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x with built-in mocking
[Source: docs/architecture/3-tech-stack.md]

**Test Standards:**
- Follow AAA pattern (Arrange, Act, Assert)
- >80% coverage for public APIs
- Save/restore `process.env` in `beforeEach`/`afterEach` (same pattern as `pricing/config.test.ts`)
- Test both success and failure paths
- Test edge cases: empty strings, wrong formats, boundary values for port numbers
- Do NOT mock `getPublicKey` from nostr-tools — use a real test keypair (hex secret key → expected pubkey)

**Test Keypair for Tests:**
Use a deterministic test keypair. A valid 64-char hex secret key and its derived pubkey can be generated with nostr-tools. Example approach: use a known hex string like `'a'.repeat(64)` and derive the expected pubkey in the test setup.

**Existing Test Pattern Reference:**
[Source: packages/bls/src/pricing/config.test.ts]
```typescript
const originalEnv = process.env;
beforeEach(() => {
  vi.resetModules();
  process.env = { ...originalEnv };
});
afterEach(() => {
  process.env = originalEnv;
});
```

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `packages/bls/src/config.ts` | Created | New config parsing/validation module with `BlsEnvConfig` interface and `loadBlsConfigFromEnv()` |
| `packages/bls/src/config.test.ts` | Created | 27 unit tests for config parsing and validation |
| `packages/bls/src/errors.ts` | Modified | Added `ConfigError` class extending `BlsBaseError` |
| `packages/bls/src/entrypoint.ts` | Modified | Refactored to use `loadBlsConfigFromEnv()`, enhanced startup logging |
| `packages/bls/src/index.ts` | Modified | Added exports for `BlsEnvConfig`, `loadBlsConfigFromEnv`, `ConfigError` |
| `packages/bls/README.md` | Created | Environment variable documentation, endpoint reference |

### Debug Log References
No issues encountered during implementation.

### Completion Notes
- Created `ConfigError` extending `BlsBaseError` with `variable` field and `CONFIG_ERROR` code
- `loadBlsConfigFromEnv()` is a pure function that throws errors (not `process.exit`), making it fully testable
- Pricing delegation uses `propagateUnprefixedEnvVars()` to bridge unprefixed `BASE_PRICE_PER_BYTE`/`KIND_OVERRIDES` to `BLS_`-prefixed vars before calling `loadPricingConfigFromEnv()`
- `NOSTR_SECRET_KEY` and `OWNER_PUBKEY` are normalized to lowercase before validation
- Entrypoint catches both `ConfigError` and `PricingError` in try/catch, calls `process.exit(1)`
- Startup logging now includes all config fields: nodeId, pubkey, ilpAddress, dataDir, basePricePerByte, ownerPubkey (if set), kindOverrides (if set). Secret key is never logged.
- 761 tests passing (734 existing + 27 new config tests)

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Strong implementation. The config module cleanly extracts all environment variable parsing into a testable pure function (`loadBlsConfigFromEnv`) that throws typed `ConfigError` exceptions instead of calling `process.exit(1)`. The entrypoint wraps this with appropriate error handling. Code is well-structured with clear separation of concerns: `config.ts` handles parsing/validation, `entrypoint.ts` handles orchestration, and pricing delegation reuses the existing `loadPricingConfigFromEnv()` as recommended by the story.

Key strengths:
- Clean `BlsEnvConfig` interface with proper TypeScript types (including `bigint` for prices)
- Descriptive error messages naming the specific variable and what went wrong
- Proper case normalization for hex values before validation
- Smart delegation to existing `loadPricingConfigFromEnv()` via `propagateUnprefixedEnvVars()` bridge
- Comprehensive test coverage with 27 tests covering all success/failure paths
- README is focused and operator-friendly with complete endpoint documentation

### Refactoring Performed

No refactoring performed. Code quality is already high.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, camelCase functions, PascalCase types, co-located tests, no `any` usage, exports from index.ts
- Project Structure: ✓ New files placed correctly in `packages/bls/src/`, README at package root
- Testing Strategy: ✓ Vitest with AAA pattern, >80% coverage for public API, proper env save/restore in beforeEach/afterEach, real test keypair (not mocked)
- All ACs Met: ✓ See detailed AC validation below

### AC Validation

1. **Environment variables documented in README** ✓ — All 8 variables documented in table format with types, defaults, and detailed descriptions. Pricing variable aliases documented. Quick Start section with `docker run` example included.
2. **Container fails fast with descriptive error if required vars missing** ✓ — `loadBlsConfigFromEnv()` throws `ConfigError` with variable name and reason. `entrypoint.ts` catches and calls `process.exit(1)`. Error messages are specific (e.g., "NOSTR_SECRET_KEY: must be a 64-character hex string, got 32 characters").
3. **Configuration logged on startup (secrets masked)** ✓ — Startup logging shows all config fields: nodeId, pubkey, ilpAddress, dataDir, basePricePerByte, ownerPubkey (if set), kindOverrides (if set). `NOSTR_SECRET_KEY` is never logged; derived pubkey shown instead.
4. **Unit tests verify config parsing and validation** ✓ — 27 tests covering all required/optional variables, valid/invalid inputs, defaults, format validation, normalization, and error messages.

### Improvements Checklist

- [x] All acceptance criteria fully implemented
- [x] ConfigError extends BlsBaseError with correct pattern
- [x] Tests use deterministic keypair without mocking nostr-tools
- [x] Env save/restore follows existing pricing/config.test.ts pattern
- [ ] Minor: `ILP_ADDRESS_REGEX` (`/^g\.[a-zA-Z0-9.-]+$/`) allows trailing dots and consecutive dots — consider tightening to `/^g\.([a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?\.)*[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$/` in a future pass (non-blocking, current regex is adequate for MVP)
- [ ] Minor: `parsePort()` accepts floats like `"3100.5"` due to `parseInt` truncation — consider adding a check for `portStr.includes('.')` (non-blocking, edge case)
- [ ] Minor: `requireEnv` treats empty string `""` the same as unset (falsy check) — this is acceptable behavior but worth noting that `NODE_ID=""` would fail with "is required but not set" rather than "must be non-empty"

### Security Review

No security concerns. Secret key (`NOSTR_SECRET_KEY`) is:
- Never logged (pubkey is shown instead)
- Validated for correct format (64 hex chars)
- Normalized to lowercase before use
- Converted to `Uint8Array` for `getPublicKey()` derivation

`OWNER_PUBKEY` is a public key, not a secret, and is shown in full in logs (appropriate).

### Performance Considerations

No performance concerns. Config loading is a one-time startup operation. The `getPublicKey()` call is a single secp256k1 derivation, which is fast.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/5.3-environment-variable-configuration.yml

### Recommended Status

✓ Ready for Done — All acceptance criteria met, 761 tests passing, implementation is clean and well-tested.
(Story owner decides final status)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-07 | 0.2 | Validation fixes: rename BlsConfig→BlsEnvConfig (name collision), fix ConfigError constructor signature, clarify pricing env var delegation via loadPricingConfigFromEnv(), normalize hex to lowercase, document BLS_-prefixed vars, clarify no entrypoint tests exist | QA (Claude Opus 4.6) |
| 2026-02-07 | 1.0 | Implementation complete: config.ts module, ConfigError, entrypoint refactor, enhanced logging, 27 unit tests, README, index exports. 761 tests passing. | Dev (Claude Opus 4.6) |
