# Story 5.6: Docker Compose Integration Example

## Status

Done

## Story

**As a** developer integrating with agent-runtime,
**I want** example docker-compose configuration,
**so that** I can quickly add the BLS to my stack.

## Acceptance Criteria

1. Create `/packages/bls/examples/docker-compose.yml`
2. Example shows BLS service configuration with all env vars
3. Example includes volume mount for persistent storage
4. Example includes health check and restart policy
5. Example shows how to connect BLS to an ILP connector service
6. README explains how to integrate with agent-runtime's compose file
7. Example can be run standalone for testing: `docker compose up`

## Tasks / Subtasks

- [x] Task 1: Create example directory and docker-compose.yml (AC: 1, 2, 3, 4, 5, 7)
  - [x] Create `packages/bls/examples/` directory
  - [x] Create `packages/bls/examples/docker-compose.yml` with:
    - `bls` service using `di3twater/agent-society-bls:latest` image
    - All environment variables documented (required: `NODE_ID`, `NOSTR_SECRET_KEY`, `ILP_ADDRESS`; optional: `BLS_PORT`, `BLS_BASE_PRICE_PER_BYTE`, `OWNER_PUBKEY`, `DATA_DIR`, `BLS_KIND_OVERRIDES`)
    - Port mapping `3100:3100`
    - Named volume `bls-data` mounted at `/data`
    - Health check using `wget -q --spider http://localhost:3100/health` with `interval: 30s`, `timeout: 5s`, `start_period: 10s`, `retries: 3` (matching Dockerfile HEALTHCHECK)
    - `restart: unless-stopped` policy
    - Use `${NOSTR_SECRET_KEY}` env var substitution for secrets (not hardcoded)
  - [x] Add a placeholder `ilp-connector` service stub to demonstrate how BLS connects to an ILP connector (AC: 5)
    - Include comments explaining this is a placeholder for the user's actual connector
    - Show `depends_on` relationship with health check condition
    - Reference `bls` service hostname for connector-to-BLS communication

- [x] Task 2: Create `.env.example` file for docker-compose (AC: 2, 7)
  - [x] Create `packages/bls/examples/.env.example` with all required and optional env vars
  - [x] Include comments explaining each variable
  - [x] Use placeholder values for required fields (e.g., `NODE_ID=my-node`)
  - [x] Include instructions to copy to `.env` before running
  - [x] Verify `.env` is already covered by the root `.gitignore` (it has a `.env` pattern that matches all directories) — no additional `.gitignore` entry should be needed. Only add one if the root pattern is insufficient.

- [x] Task 3: Update BLS README with Docker Compose integration section (AC: 6)
  - [x] Add a "Docker Compose" section to `packages/bls/README.md` after the Docker Hub section
  - [x] Include quickstart instructions:
    1. Copy `.env.example` to `.env`
    2. Edit `.env` with real values
    3. Run `docker compose up`
  - [x] Explain how to integrate the BLS service into an existing agent-runtime `docker-compose.yml`:
    - Copy the `bls` service definition
    - Add the `bls-data` volume
    - Set environment variables
    - Connect to the same Docker network as the ILP connector
  - [x] Reference the example file location

- [x] Task 4: Validate docker-compose.yml syntax and standalone execution (AC: 7)
  - [x] Verify YAML is syntactically valid
  - [x] Confirm `docker compose config` parses the file without errors (when `.env` is populated)
  - [x] Document in comments that users need to create `.env` from `.env.example` before running
  - [x] Ensure the compose file works standalone: `cd packages/bls/examples && docker compose up`

- [x] Task 5: Verify all environment variables match BLS config.ts (AC: 2)
  - [x] Cross-reference docker-compose env vars with `loadBlsConfigFromEnv()` in `packages/bls/src/config.ts`
  - [x] Ensure variable names, defaults, and descriptions are consistent between compose file, `.env.example`, and README
  - [x] Verify pricing variable aliases (`BLS_BASE_PRICE_PER_BYTE` / `RELAY_BASE_PRICE_PER_BYTE` / `BASE_PRICE_PER_BYTE`) are documented

## Dev Notes

### Previous Story Insights
[Source: docs/stories/5.5.story.md#dev-agent-record]

From Story 5.5 implementation:
- 771 tests passing, 0 failures after Story 5.5
- GitHub Actions workflow created at `.github/workflows/publish-bls.yml`
- Image published to Docker Hub: `di3twater/agent-society-bls`
- Available tags: `latest` (main), `X.Y.Z` (semver from `bls-v*` tags), `sha-<short>` (Git SHA)
- Multi-arch: `linux/amd64`, `linux/arm64`
- No issues encountered during 5.5 implementation

From Story 5.4 implementation:
[Source: docs/stories/5.5.story.md#dev-notes]
- `createEventStore` helper with directory-check and in-memory fallback was added
- BLS package code is in `packages/bls/`

From Story 5.2 implementation:
[Source: docs/stories/5.5.story.md#dev-notes]
- Dockerfile is at `packages/bls/Dockerfile`
- Build command: `docker build -f packages/bls/Dockerfile -t agent-society-bls .`
- Image is 147MB
- Base image: `node:20-alpine`
- Runs as non-root `node` user
- Container health check: `wget -q --spider http://localhost:3100/health` (every 30s, 5s timeout, 10s start period, 3 retries)

### Docker Hub Configuration
[Source: docs/epics/epic-5-standalone-bls-docker.md#configuration]

| Setting | Value |
|---------|-------|
| Docker Hub Organization | `di3twater` |
| Image Name | `agent-society-bls` |
| Full Image Reference | `di3twater/agent-society-bls` |
| Default Port | `3100` |
| Data Volume | `/data` |

### Epic-Provided Compose Example
[Source: docs/epics/epic-5-standalone-bls-docker.md#story-56]

The epic provides a reference compose structure:
```yaml
services:
  bls:
    image: di3twater/agent-society-bls:latest
    ports:
      - "3100:3100"
    volumes:
      - bls-data:/data
    environment:
      NODE_ID: my-node
      NOSTR_SECRET_KEY: ${NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.agent-society.my-node
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    restart: unless-stopped

volumes:
  bls-data:
```

The implementation should expand on this with all env vars, an ILP connector stub, and `.env.example`.

### BLS Environment Variables
[Source: packages/bls/src/config.ts, packages/bls/README.md]

Complete list of environment variables parsed by `loadBlsConfigFromEnv()`:

**Required:**
| Variable | Validation | Description |
|----------|-----------|-------------|
| `NODE_ID` | Non-empty string | Unique node identifier |
| `NOSTR_SECRET_KEY` | 64-char lowercase hex (`/^[0-9a-f]{64}$/`) | Nostr secret key |
| `ILP_ADDRESS` | Must match `/^g\.[a-zA-Z0-9.-]+$/` | Node's ILP address |

**Optional:**
| Variable | Default | Validation | Description |
|----------|---------|-----------|-------------|
| `BLS_PORT` | `3100` | Integer 1–65535 | HTTP port |
| `BLS_BASE_PRICE_PER_BYTE` | `10` | Positive integer (bigint) | Base price per byte |
| `OWNER_PUBKEY` | — | 64-char lowercase hex | Owner pubkey for payment bypass |
| `DATA_DIR` | `/data` | String path | SQLite database directory |
| `BLS_KIND_OVERRIDES` | — | JSON object `{"kind":"price"}` | Kind-specific price overrides |

**Pricing Variable Aliases** (fallback chain):
- `BLS_BASE_PRICE_PER_BYTE` > `RELAY_BASE_PRICE_PER_BYTE` > `BASE_PRICE_PER_BYTE`
- `BLS_KIND_OVERRIDES` > `RELAY_KIND_OVERRIDES` > `KIND_OVERRIDES`

### Dockerfile Health Check Reference
[Source: packages/bls/Dockerfile]

The Dockerfile already defines:
```dockerfile
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD wget -q --spider http://localhost:3100/health || exit 1
```

The docker-compose health check should mirror this, including `start_period: 10s`. Note: when both Dockerfile HEALTHCHECK and compose `healthcheck:` are defined, the compose definition takes precedence. Using a compose-level healthcheck enables `depends_on` with `condition: service_healthy`.

**Syntax note:** Dockerfile uses `--start-period` (hyphen) while compose uses `start_period` (underscore). Both are correct for their respective formats.

### Compose File Format
[Source: Docker Compose specification]

The compose file uses the modern Compose Specification format (no top-level `version:` key). The `version` key is obsolete and should not be included. Add a comment at the top of the compose file noting this uses the Compose Specification format for developer clarity.

### BLS Endpoints
[Source: packages/bls/README.md#endpoints]

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/health` | GET | Health check — returns `{ status, nodeId, pubkey, ilpAddress, timestamp }` |
| `/handle-payment` | POST | Verify ILP payment and process event storage |

### Existing README Structure
[Source: packages/bls/README.md]

Current README sections:
1. Quick Start (docker pull + docker run)
2. Docker Hub (link + available tags table)
3. Environment Variables (table + aliases + details)
4. Endpoints (/health, /handle-payment, ILP error codes)

The Docker Compose section should be added after "Docker Hub" and before "Environment Variables" for logical flow (Quick Start > Docker Hub > Docker Compose > Environment Variables > Endpoints).

### File Locations
[Source: docs/architecture/9-source-tree.md]

New files to create:
- `packages/bls/examples/docker-compose.yml` — Main deliverable
- `packages/bls/examples/.env.example` — Template for environment variables

Existing file to modify:
- `packages/bls/README.md` — Add Docker Compose integration section

### Scope Boundaries

**In Scope (this story):**
- `packages/bls/examples/docker-compose.yml` — Docker Compose example
- `packages/bls/examples/.env.example` — Environment variable template
- `packages/bls/README.md` — Update with Docker Compose documentation

**Out of Scope:**
- Kubernetes manifests (Story 5.7)
- BLS contract documentation (Story 5.8)
- Modifying the Dockerfile or BLS source code
- Modifying the GitHub Actions workflow
- Creating actual ILP connector images (the connector service is a stub/placeholder)

### Testing

**Test Approach:** This story is primarily documentation/configuration. There is no runtime application code to unit test. Validation is done through:

1. **YAML syntax validation** — Ensure the compose file is valid YAML
2. **`docker compose config`** — Verify compose file parses correctly when `.env` is populated
3. **Manual smoke test** — `docker compose up` starts the BLS and it responds to `/health`
4. **README review** — Integration instructions are clear and accurate

**Test Standards:**
[Source: docs/architecture/13-test-strategy-and-standards.md]
- Framework: Vitest 1.x (not applicable for YAML/documentation files)
- No new unit tests needed for this story (no TypeScript changes)
- Existing test suite (771 tests) should continue to pass with no regressions

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### File List

| File | Action | Description |
|------|--------|-------------|
| `packages/bls/examples/docker-compose.yml` | Created | Docker Compose example with BLS service, ILP connector stub, health check, volumes |
| `packages/bls/examples/.env.example` | Created | Environment variable template with all required/optional vars and comments |
| `packages/bls/README.md` | Modified | Added Docker Compose section with quickstart and integration instructions |

### Debug Log References

No issues encountered.

### Completion Notes

- All 5 tasks completed successfully
- `docker compose config` validates cleanly with populated `.env`
- All env vars cross-referenced with `loadBlsConfigFromEnv()` in config.ts — consistent
- 771 tests passing, 0 failures (no regression)
- No new TypeScript code — story is documentation/configuration only

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-07 | 0.2 | Validation fixes: add healthcheck start_period, .gitignore for .env, compose format notes | SM (Claude Opus 4.6) |
| 2026-02-07 | 0.3 | Validation fix: clarify .gitignore subtask — root pattern already covers .env files | SM (Claude Opus 4.6) |
| 2026-02-07 | 1.0 | Implementation complete — all tasks done, regression passing | Dev (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent documentation-only implementation. All three deliverables — `docker-compose.yml`, `.env.example`, and the README Docker Compose section — are well-structured, consistent with each other, and accurately reflect the BLS source configuration in `packages/bls/src/config.ts`.

**Strengths:**
- Docker Compose file uses modern Compose Specification format (no deprecated `version` key) with explanatory header comment
- Health check mirrors the Dockerfile HEALTHCHECK exactly (`interval: 30s`, `timeout: 5s`, `start_period: 10s`, `retries: 3`)
- Secret handling is correct — `NOSTR_SECRET_KEY` uses env var substitution (`${NOSTR_SECRET_KEY}`) rather than hardcoded values
- `.env.example` leaves `NOSTR_SECRET_KEY` blank with generation instructions (`openssl rand -hex 32`)
- ILP connector stub is clearly documented as a placeholder with comments explaining how to replace it
- `depends_on` with `condition: service_healthy` properly leverages the compose-level health check
- README integration instructions are clear and actionable (4-step process)
- All 7 environment variables from `loadBlsConfigFromEnv()` are documented in both compose file and `.env.example`
- Pricing variable alias fallback chains are documented in `.env.example`
- `docker compose config` validates cleanly with populated env vars

### Refactoring Performed

None — no code changes needed. Documentation and configuration quality is high as-is.

### Compliance Check

- Coding Standards: ✓ N/A (no TypeScript changes)
- Project Structure: ✓ Files placed in correct locations (`packages/bls/examples/`)
- Testing Strategy: ✓ No new tests needed (documentation/configuration only); 771 existing tests passing with 0 failures across 32 test files
- All ACs Met: ✓ All 7 acceptance criteria verified (see trace below)

### Improvements Checklist

No mandatory items. All items below are non-blocking suggestions:

- [ ] Consider adding a `networks:` section to the compose example showing explicit named network for multi-service stacks (nice-to-have for AC 5 integration guidance)
- [ ] Consider adding `logging:` configuration with `max-size`/`max-file` to prevent unbounded log growth in production deployments

### Security Review

**No security concerns found.**

- `NOSTR_SECRET_KEY` is properly handled via env var substitution (`${NOSTR_SECRET_KEY}`) — never hardcoded in the compose file
- `.env.example` leaves the secret key blank, requiring the user to generate their own
- `.env` files are already covered by the root `.gitignore` pattern (line 21: `.env`), preventing accidental secret commits
- The ILP connector stub uses a benign `sleep infinity` command — no risk of exposing services

### Performance Considerations

No performance concerns. The compose file configures appropriate health check intervals (30s) and restart policies (`unless-stopped`) for production use.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/5.6-docker-compose-integration-example.yml

### Recommended Status

✓ Ready for Done
