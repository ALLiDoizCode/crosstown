# Story 10.5: HTTP client rename and export updates

## Status

Done

## Story

**As a** library consumer importing from `@crosstown/core`,
**I want** the HTTP-based runtime client renamed to `createHttpRuntimeClient` (with backward-compat alias), all new Epic 10 modules re-exported from the package barrel files, and `@agent-runtime/connector` declared as an optional peer dependency,
**so that** I can discover and use the embedded-mode APIs (`createDirectRuntimeClient`, `createDirectConnectorAdmin`, `createCrosstownNode`) through the public package entry point, and HTTP-only consumers continue to work without changes.

## Acceptance Criteria

1. `createHttpRuntimeClient(baseUrl)` is the primary export name for the HTTP-based runtime client (was `createAgentRuntimeClient`)
2. `createAgentRuntimeClient` remains as a backward-compatible alias that calls `createHttpRuntimeClient` — existing consumers (e.g., `docker/src/entrypoint.ts`) do not need changes
3. Tests cover both `createHttpRuntimeClient` (new name) and `createAgentRuntimeClient` (alias) — both produce identical results
4. `packages/core/src/bootstrap/index.ts` exports `createHttpRuntimeClient` and continues to export `createAgentRuntimeClient` as an alias
5. `packages/core/src/index.ts` re-exports all new Epic 10 modules: `createDirectRuntimeClient`, `createDirectConnectorAdmin`, `createHttpRuntimeClient`, `createCrosstownNode`, and their associated types
6. `packages/core/package.json` declares `@agent-runtime/connector` as an optional `peerDependencies` entry with `peerDependenciesMeta` marking it optional — HTTP-only mode works without it installed
7. `pnpm build` succeeds across all packages
8. `pnpm test` passes with no regressions

## Tasks / Subtasks

- [x] Task 1: Rename `createAgentRuntimeClient` → `createHttpRuntimeClient` with backward-compat alias (AC: 1, 2)
  - [x] In `packages/core/src/bootstrap/agent-runtime-client.ts`:
    - Rename the exported function from `createAgentRuntimeClient` to `createHttpRuntimeClient`
    - Update JSDoc to reflect the new name and explain it is the HTTP-based factory
    - Add a backward-compat alias: `export const createAgentRuntimeClient = createHttpRuntimeClient;`
    - Add a JSDoc `@deprecated` tag on the alias directing users to `createHttpRuntimeClient`

- [x] Task 2: Update tests for renamed function (AC: 3)
  - [x] In `packages/core/src/bootstrap/agent-runtime-client.test.ts`:
    - Import both `createHttpRuntimeClient` and `createAgentRuntimeClient`
    - Add a test verifying `createAgentRuntimeClient` is the same function reference as `createHttpRuntimeClient` (or produces identical output)
    - Update the top-level `describe` block name to `'createHttpRuntimeClient'`
    - Update a representative subset of tests to use `createHttpRuntimeClient` directly (at minimum, the URL validation test and one success test), while keeping existing tests using `createAgentRuntimeClient` as-is to verify backward compat

- [x] Task 3: Update `bootstrap/index.ts` exports (AC: 4)
  - [x] In `packages/core/src/bootstrap/index.ts`:
    - Add `createHttpRuntimeClient` to the exports from `'./agent-runtime-client.js'`
    - Keep the existing `createAgentRuntimeClient` export (it's the alias, re-exported from the same module)

- [x] Task 4: Update `core/index.ts` exports (AC: 5)
  - [x] In `packages/core/src/index.ts`:
    - Keep existing `createAgentRuntimeClient` in the bootstrap re-exports (it remains as the backward-compat alias)
    - Add `createHttpRuntimeClient` to the bootstrap re-exports
    - Add `createDirectRuntimeClient` to the bootstrap re-exports
    - Add type re-exports from bootstrap: `ConnectorNodeLike`, `SendPacketParams`, `SendPacketResult`, `DirectRuntimeClientConfig`
    - Add `createDirectConnectorAdmin` to the bootstrap re-exports
    - Add type re-exports from bootstrap: `ConnectorAdminLike`, `RegisterPeerParams`
    - Add a new section re-exporting from `'./compose.js'`:
      - `createCrosstownNode`
      - Types: `CrosstownNodeConfig`, `CrosstownNode`, `CrosstownNodeStartResult`, `EmbeddableConnectorLike`, `PacketHandler`, `HandlePacketRequest`, `HandlePacketAcceptResponse`, `HandlePacketRejectResponse`, `HandlePacketResponse`

- [x] Task 5: Add optional peerDependency for `@agent-runtime/connector` (AC: 6)
  - [x] In `packages/core/package.json`:
    - Add `"peerDependencies": { "@agent-runtime/connector": ">=0.1.0" }`
    - Add `"peerDependenciesMeta": { "@agent-runtime/connector": { "optional": true } }`

- [x] Task 6: Build and test validation (AC: 7, 8)
  - [x] Run `pnpm build` — verify all packages compile
  - [x] Run `pnpm test` — verify all tests pass (baseline: ~1060 passed, 2 pre-existing failures)
  - [x] Run `npx tsc --noEmit` from `packages/core/` to verify type-checking passes

## Dev Notes

### Relevant Source Tree
[Source: packages/core/src/]

```
packages/core/src/
├── index.ts                          # Package barrel — add new re-exports here
├── compose.ts                        # createCrosstownNode (Story 10.4, already complete)
├── compose.test.ts
├── types.ts
├── constants.ts
├── errors.ts
├── bootstrap/
│   ├── index.ts                      # Bootstrap barrel — add createHttpRuntimeClient export
│   ├── agent-runtime-client.ts       # Rename function here, add alias
│   ├── agent-runtime-client.test.ts  # Update tests for new name + alias verification
│   ├── direct-runtime-client.ts      # Story 10.2 (already complete)
│   ├── direct-runtime-client.test.ts
│   ├── direct-connector-admin.ts     # Story 10.3 (already complete)
│   ├── direct-connector-admin.test.ts
│   ├── BootstrapService.ts
│   ├── BootstrapService.test.ts
│   ├── RelayMonitor.ts
│   ├── RelayMonitor.test.ts
│   └── types.ts
├── discovery/
├── events/
├── spsp/
└── trust/
```

### Previous Story Insights
[Source: docs/stories/10.4.story.md — Dev Agent Record]

Story 10.4 created `createCrosstownNode()` in `packages/core/src/compose.ts` (330 lines) with 15 integration tests. It deliberately did NOT update `bootstrap/index.ts` or `core/index.ts` — those updates are this story's scope. Key note: `BootstrapError` import in compose.ts uses `./bootstrap/BootstrapService.js`, and `Subscription` imports from `./types.js` (not `./bootstrap/types.js`). All compose.ts exports use structural types to avoid cross-package dependencies.

Test baseline: 1060 passed, 2 pre-existing failures (`RelayMonitor.test.ts`, `SocialPeerDiscovery.test.ts` — `subscribeMany` call signature mismatches, unrelated).

### File Modifications

#### `packages/core/src/bootstrap/agent-runtime-client.ts`
[Source: packages/core/src/bootstrap/agent-runtime-client.ts]

Current state: exports a single function `createAgentRuntimeClient(baseUrl: string): AgentRuntimeClient`. This is the HTTP-based factory that calls `POST /ilp/send` on the agent-runtime.

Change: Rename the function to `createHttpRuntimeClient`, add backward-compat alias `createAgentRuntimeClient`.

```typescript
// Primary export — new name
export function createHttpRuntimeClient(baseUrl: string): AgentRuntimeClient { ... }

// Backward-compat alias
/** @deprecated Use createHttpRuntimeClient instead */
export const createAgentRuntimeClient = createHttpRuntimeClient;
```

#### `packages/core/src/bootstrap/agent-runtime-client.test.ts`
[Source: packages/core/src/bootstrap/agent-runtime-client.test.ts]

Current state: 12 tests all using `createAgentRuntimeClient`. The test file imports only from `./agent-runtime-client.js` and `./BootstrapService.js`.

Change: Import `createHttpRuntimeClient` alongside the existing import. Add backward-compat alias verification test. Update describe block name. Keep majority of existing tests using old name for backward compat coverage.

#### `packages/core/src/bootstrap/index.ts`
[Source: packages/core/src/bootstrap/index.ts]

Current state: Already exports `createAgentRuntimeClient`, `createDirectRuntimeClient`, `createDirectConnectorAdmin`, and their types.

Change: Add `createHttpRuntimeClient` to the agent-runtime-client.js export line.

```typescript
// Before:
export { createAgentRuntimeClient } from './agent-runtime-client.js';

// After:
export { createHttpRuntimeClient, createAgentRuntimeClient } from './agent-runtime-client.js';
```

#### `packages/core/src/index.ts`
[Source: packages/core/src/index.ts]

Current state: Re-exports bootstrap modules but only `createAgentRuntimeClient` — none of the Story 10.2/10.3/10.4 additions are re-exported.

Change: Add all new exports. The following need to be added to the bootstrap re-export block:

From `bootstrap/index.ts`:
- `createHttpRuntimeClient` (function)
- `createDirectRuntimeClient` (function)
- `ConnectorNodeLike` (type)
- `SendPacketParams` (type)
- `SendPacketResult` (type)
- `DirectRuntimeClientConfig` (type)
- `createDirectConnectorAdmin` (function)
- `ConnectorAdminLike` (type)
- `RegisterPeerParams` (type)

New section for compose exports from `'./compose.js'`:
- `createCrosstownNode` (function)
- `CrosstownNodeConfig` (type)
- `CrosstownNode` (type)
- `CrosstownNodeStartResult` (type)
- `EmbeddableConnectorLike` (type)
- `PacketHandler` (type)
- `HandlePacketRequest` (type)
- `HandlePacketAcceptResponse` (type)
- `HandlePacketRejectResponse` (type)
- `HandlePacketResponse` (type)

#### `packages/core/package.json`
[Source: packages/core/package.json]

Current state: Has `dependencies` and `devDependencies` but no `peerDependencies`.

Change: Add optional peer dependency:

```json
"peerDependencies": {
  "@agent-runtime/connector": ">=0.1.0"
},
"peerDependenciesMeta": {
  "@agent-runtime/connector": {
    "optional": true
  }
}
```

This ensures:
- `pnpm install` does NOT fail if `@agent-runtime/connector` is not available
- Consumers using embedded mode know they need to provide a connector
- HTTP-only consumers are not affected

### Consumers That Must NOT Break
[Source: grep for createAgentRuntimeClient across codebase]

- `docker/src/entrypoint.ts` (lines 38, 721, 800): Imports `createAgentRuntimeClient` from `@crosstown/core`. The backward-compat alias keeps this working without changes.
- `packages/core/src/bootstrap/direct-runtime-client.ts` (line 4): JSDoc reference only — no import.

### What NOT to Change

- `docker/src/entrypoint.ts` — continues to use `createAgentRuntimeClient` alias (no change needed)
- `packages/core/src/compose.ts` — already complete from Story 10.4
- `packages/core/src/bootstrap/direct-runtime-client.ts` — already complete from Story 10.2
- `packages/core/src/bootstrap/direct-connector-admin.ts` — already complete from Story 10.3
- BLS, relay, or examples packages — no changes needed
- `ELIZAOS-INTEGRATION-HANDOFF.md` — documentation reference, not code

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

- Files: kebab-case → `agent-runtime-client.ts` (no file rename needed)
- Functions: camelCase → `createHttpRuntimeClient`
- All public APIs exported from `index.ts`
- Use `.js` extension in imports (ESM)
- Never use `any`

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **Framework:** Vitest 1.x
- **File Convention:** `*.test.ts` co-located with source → `agent-runtime-client.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Vitest built-in mocking (`vi.fn()`)
- **Coverage:** >80% for public APIs
- **Validation:** `pnpm test` from workspace root. Expected: ~1060+ passed, 2 pre-existing failures
- **Baseline verification:** Run `pnpm test 2>&1 | tail -5` before making changes to capture the exact pass/fail counts, then compare after
- **Build:** `pnpm build` from workspace root
- **Type-check:** `npx tsc --noEmit` from `packages/core/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-16 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-16 | 0.2 | Validation fixes: corrected test count (13→12), added explicit subtask to keep createAgentRuntimeClient in core/index.ts re-exports, added source tree snippet, added baseline verification command | QA (Claude Opus 4.6) |
| 2026-02-16 | 1.0 | Implementation complete - all tasks and validations passed | Dev Agent (Claude Sonnet 4.5) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Status Updates
- Started: 2026-02-16 11:12 UTC
- Completed: 2026-02-16 11:13 UTC

### Debug Log References
None

### Completion Notes
All tasks completed successfully:
1. Renamed `createAgentRuntimeClient` → `createHttpRuntimeClient` in agent-runtime-client.ts with JSDoc update
2. Added backward-compatible alias `createAgentRuntimeClient = createHttpRuntimeClient` with @deprecated tag
3. Updated tests: added backward-compat alias verification test, updated describe block to 'createHttpRuntimeClient', updated URL validation and create client tests to use new name
4. Updated bootstrap/index.ts to export both createHttpRuntimeClient and createAgentRuntimeClient
5. Updated core/index.ts to re-export all Epic 10 modules: createHttpRuntimeClient, createDirectRuntimeClient, createDirectConnectorAdmin, createCrosstownNode, and all associated types
6. Added optional @agent-runtime/connector peer dependency in package.json
7. Build validation: packages/core builds successfully
8. Test validation: 1061 passed, 2 failed (matches baseline - pre-existing failures in RelayMonitor and SocialPeerDiscovery subscribeMany signature mismatches)

All acceptance criteria met. Backward compatibility preserved - existing consumers (docker/src/entrypoint.ts) continue to work without changes.

### File List
- packages/core/src/bootstrap/agent-runtime-client.ts
- packages/core/src/bootstrap/agent-runtime-client.test.ts
- packages/core/src/bootstrap/index.ts
- packages/core/src/index.ts
- packages/core/package.json

## QA Results

### Review Date: 2026-02-16

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

- Diff size: ~153 lines (low)
- No auth/payment/security files touched
- Tests added: yes (alias verification test)
- Previous gate: N/A (first review)
- Acceptance criteria count: 8 (standard)
- **Risk level: Standard review**

### Code Quality Assessment

Implementation is clean, minimal, and well-scoped. The rename follows existing naming conventions (camelCase functions, kebab-case files). The backward-compatible alias is correctly implemented as a `const` assignment rather than a wrapper function, ensuring reference equality (`===`) and zero overhead. JSDoc `@deprecated` tag on the alias provides IDE-level deprecation warnings. All Epic 10 modules are properly re-exported from both the bootstrap barrel and the package barrel, making the full API surface discoverable.

### Refactoring Performed

None required. The implementation is already minimal and follows established patterns.

### Compliance Check

- Coding Standards: ✓ — camelCase functions, kebab-case files, `.js` ESM extensions in imports, no use of `any`
- Project Structure: ✓ — co-located tests, barrel exports from `index.ts`, follows source tree conventions
- Testing Strategy: ✓ — Vitest, AAA pattern, alias verification test with reference equality check, backward-compat tests retained
- All ACs Met: ✓ — See AC validation below

### AC Validation

| AC | Status | Evidence |
|----|--------|----------|
| 1. `createHttpRuntimeClient` is primary export | ✓ | `agent-runtime-client.ts:15` — function named `createHttpRuntimeClient` |
| 2. `createAgentRuntimeClient` alias preserved | ✓ | `agent-runtime-client.ts:75` — `const createAgentRuntimeClient = createHttpRuntimeClient` |
| 3. Tests cover both names | ✓ | `agent-runtime-client.test.ts:20-23` — alias identity test; lines 25-33 use new name; lines 48+ retain old name |
| 4. `bootstrap/index.ts` exports both | ✓ | `bootstrap/index.ts:27` — both exported |
| 5. `core/index.ts` re-exports all Epic 10 modules | ✓ | `index.ts:94-129` — all functions and types re-exported |
| 6. Optional peer dependency declared | ✓ | `package.json:44-51` — `peerDependencies` + `peerDependenciesMeta` with `optional: true` |
| 7. `pnpm build` succeeds | ✓ | Build passes (verified) |
| 8. `pnpm test` passes with no regressions | ✓ | 1061 passed, 2 failed (pre-existing `subscribeMany` signature mismatches) |

### Improvements Checklist

- [x] All acceptance criteria verified
- [x] Backward compatibility confirmed (`docker/src/entrypoint.ts` uses `createAgentRuntimeClient` — unmodified and still working)
- [x] Test coverage adequate (13 tests for HTTP client + 1 alias identity test)
- [x] Type exports complete (all structural types from Stories 10.2–10.4 re-exported)

No items require developer action.

### Security Review

No security concerns. The changes are purely renaming/re-exporting — no new I/O, no new authentication flows, no changes to data handling. The `@agent-runtime/connector` peer dependency is optional and structural only.

### Performance Considerations

No performance concerns. The alias is a direct reference assignment (zero overhead). No new runtime code paths introduced.

### Files Modified During Review

None. No refactoring was necessary.

### Gate Status

Gate: PASS → docs/qa/gates/10.5-http-client-rename-and-export-updates.yml
Risk profile: N/A (standard review, no escalated risks)
NFR assessment: N/A (no NFR concerns identified)

### Recommended Status

✓ Ready for Done
