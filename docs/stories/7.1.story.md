# Story 7.1: Extend kind:10032 IlpPeerInfo with Settlement Capabilities

## Status

Done

## Story

**As a** peer node,
**I want** to advertise my supported settlement chains, addresses, and preferred tokens in my kind:10032 event,
**so that** other peers can discover my settlement capabilities before initiating an SPSP handshake.

## Acceptance Criteria

1. `IlpPeerInfo` in `types.ts` extended with `supportedChains`, `settlementAddresses`, `preferredTokens`, `tokenNetworks`
2. Old `settlementEngine` field deprecated (kept for backward compat, ignored)
3. `buildIlpPeerInfoEvent()` serializes new fields into kind:10032 content
4. Parser validates new fields (supportedChains is non-empty array, addresses match chain format)
5. Backward compatible: events without new fields parse successfully (empty arrays/objects)
6. Chain identifier format defined: `{blockchain}:{network}:{chainId}` (e.g., `evm:base:8453`, `xrp:mainnet`, `aptos:mainnet:1`)
7. Unit tests for serialization, parsing, backward compat, and validation

## Tasks / Subtasks

- [x] Task 1: Extend `IlpPeerInfo` interface in `types.ts` (AC: 1, 2)
  - [x] Add `supportedChains?: string[]` optional field — array of chain identifiers in `{blockchain}:{network}:{chainId}` format (e.g., `"evm:base:8453"`, `"xrp:mainnet"`, `"aptos:mainnet:1"`). Optional to maintain backward compatibility with existing construction sites.
  - [x] Add `settlementAddresses?: Record<string, string>` optional field — maps chain identifier to the peer's settlement address on that chain (e.g., `{ "evm:base:8453": "0x1234..." }`). Optional to maintain backward compatibility.
  - [x] Add `preferredTokens?: Record<string, string>` optional field — maps chain identifier to preferred token contract address (e.g., `{ "evm:base:8453": "0xAGENT_TOKEN" }`)
  - [x] Add `tokenNetworks?: Record<string, string>` optional field — maps chain identifier to TokenNetwork contract address (EVM-specific, e.g., `{ "evm:base:8453": "0xTOKEN_NETWORK" }`)
  - [x] Add JSDoc `@deprecated` annotation to existing `settlementEngine?: string` field with note: "Use supportedChains instead. Kept for backward compatibility."
  - [x] Export updated type from `packages/core/src/index.ts` (already exported — verify no changes needed)

- [x] Task 2: Add chain identifier validation utility (AC: 4, 6)
  - [x] Create `validateChainId(chainId: string): boolean` function in `packages/core/src/events/parsers.ts` (keep co-located with parsing logic)
  - [x] Export `validateChainId` from `packages/core/src/events/index.ts` so it is available to Story 7.2 and other consumers
  - [x] Chain ID format: `{blockchain}:{network}` or `{blockchain}:{network}:{chainId}` — minimum 2 segments, maximum 3 segments separated by `:`
  - [x] Valid examples: `"evm:base:8453"`, `"xrp:mainnet"`, `"aptos:mainnet:1"` — segments must be non-empty strings
  - [x] Invalid examples: `""`, `"evm"`, `"evm:"`, `":base:8453"`, `"evm:base:8453:extra:segments"`

- [x] Task 3: Update `parseIlpPeerInfo()` in `parsers.ts` (AC: 4, 5)
  - [x] After existing field validation, add parsing for new settlement fields
  - [x] Parse `supportedChains`: if present, validate it is an array of strings where each entry passes `validateChainId()`. If not present, default to `[]`
  - [x] Parse `settlementAddresses`: if present, validate it is a `Record<string, string>` (object with string keys and string values). Keys must pass `validateChainId()` (key format validation is in scope; cross-field validation that keys are a subset of `supportedChains` is deferred — see Scope Boundaries). Values must be non-empty strings. If not present, default to `{}`
  - [x] Parse `preferredTokens`: if present, validate it is a `Record<string, string>`. If not present, leave as `undefined`
  - [x] Parse `tokenNetworks`: if present, validate it is a `Record<string, string>`. If not present, leave as `undefined`
  - [x] If `supportedChains` is present but empty array, throw `InvalidEventError('supportedChains must be a non-empty array when provided')`
  - [x] If `supportedChains` contains invalid chain IDs, throw `InvalidEventError('Invalid chain identifier: {chainId}')`
  - [x] Continue to parse/ignore `settlementEngine` (backward compat — include in result if present)
  - [x] Backward compat: events without ANY of the new fields must parse successfully, returning `supportedChains: []`, `settlementAddresses: {}`

- [x] Task 4: Verify `buildIlpPeerInfoEvent()` in `builders.ts` needs no changes (AC: 3)
  - [x] Confirm that `buildIlpPeerInfoEvent` at `builders.ts:25` uses `JSON.stringify(info)` and does not destructure or filter fields — this means new fields on the interface are automatically serialized when provided
  - [x] No code changes needed to the builder

- [x] Task 5: Write unit tests for serialization (AC: 3, 7)
  - [x] Add tests in `packages/core/src/events/builders.test.ts`
  - [x] Test: `buildIlpPeerInfoEvent` with all new settlement fields serializes correctly
  - [x] Test: `buildIlpPeerInfoEvent` with only `supportedChains` and `settlementAddresses` (no other optional fields) serializes correctly
  - [x] Test: `buildIlpPeerInfoEvent` with optional `preferredTokens` and `tokenNetworks` includes them in content
  - [x] Test: signature verification passes with new fields present

- [x] Task 6: Write unit tests for parsing and validation (AC: 4, 5, 6, 7)
  - [x] Add tests in `packages/core/src/events/parsers.test.ts`
  - [x] Test: parses event with all new settlement fields
  - [x] Test: parses event with only `supportedChains` and `settlementAddresses` (no optional fields)
  - [x] Test: backward compat — parses event without any new fields (returns `supportedChains: []`, `settlementAddresses: {}`)
  - [x] Test: backward compat — parses event with old `settlementEngine` field (still included in result)
  - [x] Test: throws `InvalidEventError` for empty `supportedChains` array
  - [x] Test: throws `InvalidEventError` for invalid chain ID in `supportedChains` (e.g., `"evm"`)
  - [x] Test: throws `InvalidEventError` for non-array `supportedChains`
  - [x] Test: throws `InvalidEventError` for non-object `settlementAddresses`
  - [x] Test: throws `InvalidEventError` for `settlementAddresses` with non-string values
  - [x] Test: `validateChainId` accepts valid formats (`"evm:base:8453"`, `"xrp:mainnet"`, `"aptos:mainnet:1"`)
  - [x] Test: `validateChainId` rejects invalid formats (`""`, `"evm"`, `"evm:"`, `":base"`)

- [x] Task 7: Write round-trip tests (AC: 3, 4, 7)
  - [x] Add tests in `packages/core/src/events/builders.test.ts` (round-trip section)
  - [x] Test: build → parse round-trip preserves all settlement fields including optional ones
  - [x] Test: build → parse round-trip preserves data when optional fields (`preferredTokens`, `tokenNetworks`) are omitted — parsed result should have `supportedChains: []`, `settlementAddresses: {}`, and `preferredTokens`/`tokenNetworks` as `undefined` (not `{}`)
  - [x] Test: build → parse round-trip preserves deprecated `settlementEngine` alongside new fields

- [x] Task 8: Run full test suite and lint (AC: 7)
  - [x] Run `pnpm test` — all existing tests must pass (840+ tests) plus new tests
  - [x] Run `pnpm lint` — no new lint errors
  - [x] Verify no regressions in existing `parseIlpPeerInfo` tests (they test events without new fields)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/6.5.story.md#dev-agent-record]

From Story 6.5 (Epic 6 final story):
- 855 tests passing (840 core + 15 docker), 0 failures
- ESLint clean on all files
- `IlpPeerInfo` is used throughout the codebase: in `BootstrapService`, `SocialPeerDiscovery`, `NostrSpspClient`, `NostrSpspServer`, `NostrPeerDiscovery`, and the Docker entrypoint
- Extending `IlpPeerInfo` with optional fields maintains backward compatibility since all existing code only accesses the current fields
- `ConnectorAdminClient` interface uses `IlpPeerInfo` indirectly (peer info is queried from kind:10032 events)
- The `buildIlpPeerInfoEvent()` function uses `JSON.stringify(info)` so new fields on the interface are automatically serialized

### Data Models
[Source: packages/core/src/types.ts]

**Current `IlpPeerInfo` interface (to be extended):**
```typescript
export interface IlpPeerInfo {
  ilpAddress: string;
  btpEndpoint: string;
  settlementEngine?: string;  // DEPRECATED — keep for backward compat
  assetCode: string;
  assetScale: number;
}
```

**Target `IlpPeerInfo` interface (after this story):**
```typescript
export interface IlpPeerInfo {
  ilpAddress: string;
  btpEndpoint: string;
  /** @deprecated Use supportedChains instead. Kept for backward compatibility. */
  settlementEngine?: string;
  assetCode: string;
  assetScale: number;
  // New settlement fields (all optional to maintain backward compat with existing construction sites)
  supportedChains?: string[];              // e.g., ["evm:base:8453", "xrp:mainnet"]
  settlementAddresses?: Record<string, string>;  // chain → address
  preferredTokens?: Record<string, string>;      // chain → token contract
  tokenNetworks?: Record<string, string>;        // chain → TokenNetwork contract
}
```
**Note:** All new fields are optional on the interface so that existing code constructing `IlpPeerInfo` objects (BootstrapService, SocialPeerDiscovery, NostrSpspClient, etc.) continues to compile without changes. The parser defaults `supportedChains` to `[]` and `settlementAddresses` to `{}` when fields are absent from parsed events.
[Source: docs/epics/epic-7-spsp-settlement-negotiation.md#story-71]

**Chain Identifier Format:**
- Pattern: `{blockchain}:{network}` or `{blockchain}:{network}:{chainId}`
- EVM: `evm:base:8453` (blockchain:network:chainId)
- XRP: `xrp:mainnet` (blockchain:network)
- Aptos: `aptos:mainnet:1` (blockchain:network:chainId)
[Source: docs/epics/epic-7-spsp-settlement-negotiation.md#story-71, AC 6]

### API Specifications

No API changes in this story. This story only modifies the data model and event serialization/parsing. The `POST /peers` Admin API endpoint (agent-runtime) is unaffected — it uses its own `PeerConfig` type.
[Source: docs/architecture/6-external-apis.md#62-agent-runtime-admin-api]

### Component Specifications

No component/service changes. `NostrPeerDiscovery`, `NostrSpspClient`, `NostrSpspServer`, and `BootstrapService` all use `IlpPeerInfo` but will not need modification since:
- The parser returns new fields with defaults for old events
- The builder serializes whatever fields are on the object
- Consumers that don't use settlement fields will simply ignore them
[Source: docs/architecture/5-components.md]

### File Locations
[Source: docs/architecture/9-source-tree.md, packages/core/src/]

Files to modify:
- `packages/core/src/types.ts` — Extend `IlpPeerInfo` interface with new settlement fields
- `packages/core/src/events/parsers.ts` — Add `validateChainId` utility, add validation for new fields, backward compat defaults
- `packages/core/src/events/index.ts` — Export `validateChainId` for use by Story 7.2 and other consumers
- `packages/core/src/events/builders.test.ts` — Add serialization tests for new fields
- `packages/core/src/events/parsers.test.ts` — Add parsing/validation tests for new fields

Files NOT modified:
- `packages/core/src/events/builders.ts` — No changes needed (uses `JSON.stringify(info)`)
- `packages/core/src/constants.ts` — No new event kinds
- `packages/core/src/index.ts` — `IlpPeerInfo` already exported
- `packages/core/src/errors.ts` — `InvalidEventError` already exists

### Technical Constraints
[Source: docs/architecture/payment-channel-reference.md]

**Settlement address formats (for reference — not validated in this story, just stored as strings):**
- EVM: `0x`-prefixed 40-char hex (42 chars total)
- XRP: `r`-prefixed base58 address
- Aptos: `0x`-prefixed 64-char hex (66 chars total)

**Token/TokenNetwork addresses:**
- EVM only: `0x`-prefixed contract addresses
- XRP/Aptos: Not applicable (no token contract model)

**Backward compatibility constraint:** Existing kind:10032 events in the wild will NOT have the new fields. The parser MUST handle this gracefully by defaulting `supportedChains` to `[]` and `settlementAddresses` to `{}`.

### Scope Boundaries

**In Scope:**
- Extending `IlpPeerInfo` type with settlement fields
- Updating parser with validation and backward-compat defaults
- Chain identifier format definition and validation
- Unit tests for all new behavior

**Out of Scope:**
- Extending `SpspRequest`/`SpspResponse` (Story 7.2)
- Settlement negotiation logic (Story 7.3)
- Any connector/Admin API changes
- Blockchain address format validation (addresses stored as opaque strings)
- Changes to any service/class that consumes `IlpPeerInfo`
- Cross-field validation between `settlementAddresses` keys and `supportedChains` (deferred — the parser validates each field independently but does not enforce that address keys are a subset of supported chains)

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md, packages/core/src/errors.ts]

- Use existing `InvalidEventError` class for validation failures
- Error pattern: `throw new InvalidEventError('descriptive message')` — same as existing parser
- No new error classes needed

### Testing

**Test Framework:** Vitest 1.x
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Standards:**
- Co-located test files: `builders.test.ts` and `parsers.test.ts` (already exist)
- Follow AAA pattern (Arrange, Act, Assert) — same as existing tests
- Use `generateSecretKey()` and `getPublicKey()` from `nostr-tools/pure` for test key generation
- Use `createMockEvent()` helper (already in `parsers.test.ts`) for error case tests
- Mock `SimplePool` where needed (not applicable for this story — no relay interactions)
- Coverage: >80% for new parsing/validation code

**Existing test fixtures (do NOT modify — existing tests depend on them):**
- `createTestIlpPeerInfo()` in `builders.test.ts` and `parsers.test.ts` — returns `IlpPeerInfo` without settlement fields
- `createTestIlpPeerInfoWithSettlement()` in both files — returns `IlpPeerInfo` with old `settlementEngine` field

**New test fixtures to add (alongside existing ones):**
- `createTestIlpPeerInfoWithChains()` — returns `IlpPeerInfo` with new `supportedChains`, `settlementAddresses`, and optionally `preferredTokens`/`tokenNetworks`
- `createTestIlpPeerInfoWithAllFields()` — returns `IlpPeerInfo` with both old `settlementEngine` and all new settlement fields (for round-trip/coexistence tests)

**Test count expectation:** ~19 new tests across both test files

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/types.ts` | Modified | Extend IlpPeerInfo with supportedChains, settlementAddresses, preferredTokens, tokenNetworks |
| `packages/core/src/events/parsers.ts` | Modified | Add validateChainId utility, validation for new fields, backward compat defaults |
| `packages/core/src/events/index.ts` | Modified | Export validateChainId for use by Story 7.2 and other consumers |
| `packages/core/src/index.ts` | Modified | Export validateChainId from package root |
| `packages/core/src/events/builders.test.ts` | Modified | Add serialization tests and round-trip tests for new settlement fields |
| `packages/core/src/events/parsers.test.ts` | Modified | Add parsing/validation tests, backward compat tests, chain ID validation tests |
| `packages/core/src/bootstrap.test.ts` | Modified | Update toEqual assertion to include parser defaults (supportedChains, settlementAddresses) |
| `packages/core/src/discovery/NostrPeerDiscovery.test.ts` | Modified | Update toHaveBeenCalledWith assertion to include parser defaults |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes
- 863 tests passing (all 863 pass, 0 failures), up from 855 baseline
- 20 new tests added: 7 in builders.test.ts (4 serialization + 3 round-trip), 13 in parsers.test.ts (9 parsing/validation + 4 validateChainId)
- 2 existing tests updated for backward-compat (bootstrap.test.ts, NostrPeerDiscovery.test.ts) — `toEqual` assertions needed parser defaults
- ESLint: 3 pre-existing errors (none introduced by this story)
- `validateChainId` also exported from package root `index.ts` (not in original file list but needed for public API)
- Builder confirmed to need zero changes (`JSON.stringify(info)` at builders.ts:25)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-08 | 0.2 | Validation fixes: made supportedChains/settlementAddresses optional on interface for backward compat, added validateChainId export from events/index.ts, clarified test fixture strategy (new fixtures alongside existing), sharpened Task 4 verification step, documented deferred cross-field validation, added events/index.ts to file list | SM (Claude Opus 4.6) |
| 2026-02-08 | 0.3 | Post-validation fixes: Task 3 settlementAddresses subtask now clarifies that key format validation is in scope while cross-field validation is deferred; Task 7 round-trip subtask 2 now specifies expected default values when optional fields are omitted (supportedChains: [], settlementAddresses: {}, preferredTokens/tokenNetworks: undefined) | SM (Claude Opus 4.6) |
| 2026-02-08 | 1.0 | Implementation complete — all 8 tasks done, 863 tests passing, status set to Ready for Review | Dev (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. The code follows existing patterns precisely, with clean interface extension, defensive validation, proper backward compatibility defaults, and comprehensive test coverage. All 20 new tests pass, and all 863 total tests pass with no regressions. The builder correctly requires zero changes due to its `JSON.stringify(info)` approach. The `validateChainId` utility is well-designed with proper JSDoc and is exported at all required levels (parsers, events/index, package root).

### Refactoring Performed

None required. The implementation is clean and well-structured with no refactoring opportunities identified.

### Compliance Check

- Coding Standards: ✓ All naming conventions followed, no `any` usage, proper exports, uses nostr-tools types
- Project Structure: ✓ Co-located test files, exports from index.ts at all levels
- Testing Strategy: ✓ Vitest 1.x, AAA pattern, factory functions, >80% coverage for new code
- All ACs Met: ✓ All 7 acceptance criteria implemented and tested

### Improvements Checklist

- [x] All 7 acceptance criteria verified as implemented
- [x] 20 new tests added with comprehensive coverage
- [x] Backward compatibility verified (old events parse correctly)
- [x] No regressions in existing 843 tests
- [x] Chain ID validation exported for Story 7.2 consumers
- [x] 2 existing tests updated for parser defaults (bootstrap.test.ts, NostrPeerDiscovery.test.ts)

### Security Review

No security concerns. This story extends a data model and parser — no authentication, authorization, or encryption code is modified. Input validation is properly applied to all new fields via `InvalidEventError`.

### Performance Considerations

No performance concerns. `validateChainId` is O(1) per chain ID. Parser iteration over settlement fields is linear in the number of chains (expected to be small, typically 1-3).

### Files Modified During Review

None. No refactoring was performed.

### Gate Status

Gate: PASS → docs/qa/gates/7.1-extend-ilp-peer-info-settlement-capabilities.yml

### Recommended Status

✓ Ready for Done
(Story owner decides final status)
