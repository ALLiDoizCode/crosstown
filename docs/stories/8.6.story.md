# Story 8.6: Fix IlpSendResult Field Name Mismatch

## Status

Done

## Story

**As a** node bootstrapping into the network,
**I want** the `IlpSendResult` interface to match what agent-runtime actually returns,
**so that** SPSP handshakes and peer announcements correctly detect FULFILL vs REJECT responses.

## Acceptance Criteria

1. `IlpSendResult` field name aligned between crosstown and agent-runtime — both use the same field name for the success indicator
2. `BootstrapService` Phase 2 (`performSpspHandshake`) correctly detects FULFILL responses
3. `BootstrapService` Phase 3 (`announceViaIlp`) correctly detects FULFILL vs REJECT
4. `RelayMonitor` SPSP handshakes correctly detect FULFILL responses
5. `IlpSpspClient` response parsing correctly detects FULFILL vs REJECT
6. All existing tests continue to pass with the updated parsing logic
7. Backward compatibility: if agent-runtime returns either `accepted` or `fulfilled`, handle both gracefully
8. Unit tests verify both field names are handled

## Tasks / Subtasks

- [x] Task 1: Determine the canonical field name (AC: 1)
  - [x] Check what agent-runtime's `POST /ilp/send` handler actually returns in its HTTP response body
  - [x] Decision: Either update crosstown to use `fulfilled` (match runtime) OR coordinate with agent-runtime to return `accepted` (match society)
  - [x] Preferred approach: Update `IlpSendResult` to check both fields for maximum compatibility:
    ```typescript
    // In AgentRuntimeClient.sendIlpPacket():
    const data = await response.json();
    return {
      accepted: data.accepted ?? data.fulfilled ?? false,
      fulfillment: data.fulfillment,
      data: data.data,
      code: data.code,
      message: data.message,
    };
    ```

- [x] Task 2: Update `AgentRuntimeClient.sendIlpPacket()` response parsing (AC: 1, 7)
  - [x] In `packages/core/src/bootstrap/agent-runtime-client.ts`:
    - Update the response parsing to handle both `accepted` and `fulfilled` fields
    - The `IlpSendResult.accepted` field is populated from `data.accepted ?? data.fulfilled ?? false`
    - This ensures compatibility regardless of which field name the agent-runtime version uses

- [x] Task 3: Verify all consumers of `IlpSendResult.accepted` (AC: 2, 3, 4, 5)
  - [x] `BootstrapService.performSpspHandshake()` — line 410: `if (!ilpResult.accepted)` ✓
  - [x] `BootstrapService.announceViaIlp()` — line 505: `if (ilpResult.accepted)` ✓
  - [x] `IlpSpspClient.requestSpspInfo()` — verify it checks `ilpResult.accepted`
  - [x] `RelayMonitor` — uses `IlpSpspClient` which handles the check internally
  - [x] No changes needed to consumers if `AgentRuntimeClient` normalizes the field

- [x] Task 4: Write unit tests for field name compatibility (AC: 6, 8)
  - [x] In `packages/core/src/bootstrap/agent-runtime-client.test.ts` (file already exists with 5 tests):
    - Test: response with `{ accepted: true }` → `IlpSendResult.accepted === true`
    - Test: response with `{ fulfilled: true }` → `IlpSendResult.accepted === true`
    - Test: response with `{ fulfilled: false }` → `IlpSendResult.accepted === false`
    - Test: response with neither field → `IlpSendResult.accepted === false`
    - Test: response with both fields, `accepted` takes precedence

- [x] Task 5: Document the expected agent-runtime response format (AC: 1)
  - [x] Add JSDoc to `IlpSendResult` interface noting the field name discrepancy:
    ```typescript
    /**
     * Result of sending an ILP packet via agent-runtime POST /ilp/send.
     * Note: agent-runtime may return either `accepted` or `fulfilled` as the
     * success indicator. AgentRuntimeClient normalizes to `accepted`.
     */
    ```

- [x] Task 6: Run full test suite and lint
  - [x] Run `pnpm test` — all existing tests pass plus new tests (1018 tests, 40 files)
  - [x] Run `pnpm lint` — no new lint errors (1 pre-existing error in unrelated file)

## Dev Notes

### Integration Gap Addressed
[Source: INTEGRATION-GAPS.md]

**Gap 6: `IlpSendResult` Field Name Mismatch (CRITICAL)**

Agent-runtime sends:
```typescript
{ fulfilled: true, ... }   // FULFILL
{ fulfilled: false, ... }  // REJECT
```

Agent-society checks:
```typescript
if (!ilpResult.accepted) {  // ← "accepted" not "fulfilled"
  throw new BootstrapError(...);
}
```

**Impact:** `BootstrapService` Phase 2 (line 410) will always throw because `ilpResult.accepted` is `undefined` (falsy). The SPSP handshake always appears to fail even when the ILP FULFILL is received.

### Current IlpSendResult Interface
[Source: packages/core/src/bootstrap/types.ts:108-114]

```typescript
export interface IlpSendResult {
  accepted: boolean;
  fulfillment?: string;
  data?: string; // base64-encoded response TOON
  code?: string;
  message?: string;
}
```

### Current AgentRuntimeClient
[Source: packages/core/src/bootstrap/agent-runtime-client.ts]

The `sendIlpPacket()` method makes a `POST /ilp/send` request and returns the response JSON directly as `IlpSendResult`. If the runtime returns `{ fulfilled: true }`, the `accepted` field would be `undefined` because the field name doesn't match.

### Fix Strategy

**Normalize at the boundary:** Update `AgentRuntimeClient.sendIlpPacket()` to map the response fields, checking `data.accepted ?? data.fulfilled`. This is the simplest fix with the broadest compatibility:
- Works if agent-runtime returns `accepted` (current interface)
- Works if agent-runtime returns `fulfilled` (actual runtime behavior per Gap 6)
- Works if agent-runtime returns both
- Requires no changes to agent-runtime

### Affected Consumers

All consumers use `ilpResult.accepted`:
1. `BootstrapService.performSpspHandshake()` — Phase 2 SPSP handshake check
2. `BootstrapService.announceViaIlp()` — Phase 3 announce result check
3. `IlpSpspClient.requestSpspInfo()` — SPSP via ILP result check
4. `RelayMonitor` — uses `IlpSpspClient` (indirect)

No consumer changes needed if the normalization happens in `AgentRuntimeClient`.

### File Locations

Files to modify:
- `packages/core/src/bootstrap/agent-runtime-client.ts` — Normalize `fulfilled` → `accepted` in response parsing
- `packages/core/src/bootstrap/types.ts` — Add JSDoc to `IlpSendResult`
- `packages/core/src/bootstrap/agent-runtime-client.test.ts` — Add field compatibility tests (file exists with 5 tests)

Files NOT modified:
- `packages/core/src/bootstrap/BootstrapService.ts` — Consumers unchanged (normalization at boundary)
- `packages/core/src/spsp/IlpSpspClient.ts` — Consumers unchanged
- `packages/core/src/bootstrap/RelayMonitor.ts` — Uses IlpSpspClient (indirect)

### Technical Constraints

**Cross-repo coordination:** This fix is one-sided (crosstown only). It makes crosstown tolerant of both field names. A corresponding fix in agent-runtime (returning `accepted` instead of `fulfilled`) could also be done but is not required.

**No breaking changes:** The `IlpSendResult` interface itself keeps the `accepted` field name. Only the parsing logic changes.

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x
**File:** `packages/core/src/bootstrap/agent-runtime-client.test.ts`

**Expected new test count:** ~5 new tests
- Mock `fetch` to return various response shapes
- Verify `IlpSendResult.accepted` is correctly set

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
- `packages/core/src/bootstrap/agent-runtime-client.ts` — Modified: normalize `fulfilled` → `accepted` in response parsing
- `packages/core/src/bootstrap/types.ts` — Modified: updated JSDoc on `IlpSendResult` interface
- `packages/core/src/bootstrap/agent-runtime-client.test.ts` — Modified: added 5 field name compatibility tests

### Debug Log References
None — no issues encountered during implementation.

### Completion Notes
- Normalized `data.accepted ?? data.fulfilled ?? false` at the boundary in `AgentRuntimeClient.sendIlpPacket()`
- All 4 consumers (`BootstrapService.performSpspHandshake`, `BootstrapService.announceViaIlp`, `IlpSpspClient.requestSpspInfo`, `RelayMonitor`) use `.accepted` — no changes needed
- 5 new tests added covering: accepted=true, fulfilled=true, fulfilled=false, neither field, both fields (accepted takes precedence)
- Full test suite: 1018 tests passed (40 files)
- Lint: no new errors (1 pre-existing error in `packages/bls/src/storage/createEventStore.test.ts` — unrelated)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft from INTEGRATION-GAPS.md (Gap 6) | PO (Claude Opus 4.6) |
| 2026-02-09 | 1.0 | Implementation complete — field name normalization + tests | Dev (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is clean, minimal, and well-targeted. The fix correctly normalizes the `fulfilled` → `accepted` field at the boundary layer (`AgentRuntimeClient.sendIlpPacket()`), avoiding changes to all four downstream consumers. The `data.accepted ?? data.fulfilled ?? false` coalescing pattern is idiomatic and handles all combinations correctly. The explicit `as Record<string, unknown>` cast followed by field-level casts is appropriate for parsing an external HTTP response. No code smells, no unnecessary abstractions.

### Refactoring Performed

None required. The implementation is appropriately scoped and clean.

### Compliance Check

- Coding Standards: ✓ Follows project conventions (co-located tests, Vitest, AAA pattern)
- Project Structure: ✓ Files modified in correct locations per source tree
- Testing Strategy: ✓ Unit tests co-located with source, >80% coverage for changed code, mocks fetch correctly
- All ACs Met: ✓ All 8 acceptance criteria verified (see traceability below)

### Acceptance Criteria Traceability

| AC | Description | Validating Evidence |
|----|-------------|-------------------|
| 1 | Field name aligned | `agent-runtime-client.ts:61` — `data.accepted ?? data.fulfilled ?? false` normalizes both names |
| 2 | BootstrapService Phase 2 detects FULFILL | `BootstrapService.ts:410` — checks `ilpResult.accepted`, which is now correctly populated |
| 3 | BootstrapService Phase 3 detects FULFILL/REJECT | `BootstrapService.ts:505` — checks `ilpResult.accepted`, correctly populated |
| 4 | RelayMonitor detects FULFILL | Uses `IlpSpspClient` → `AgentRuntimeClient` — normalization at boundary |
| 5 | IlpSpspClient detects FULFILL/REJECT | `IlpSpspClient.ts:119` — checks `ilpResult.accepted`, correctly populated |
| 6 | Existing tests pass | Full suite: 1018/1018 tests passing (40 files) |
| 7 | Backward compatibility | Coalescing handles `accepted`, `fulfilled`, both, or neither |
| 8 | Unit tests verify both field names | 5 new tests in `agent-runtime-client.test.ts:144-205` cover all combinations |

### Improvements Checklist

- [x] All acceptance criteria validated with test coverage
- [x] Boundary normalization pattern is correct and idiomatic
- [x] JSDoc on `IlpSendResult` documents the field name discrepancy
- [x] No changes needed to downstream consumers (verified by grep)

### Security Review

No security concerns. The change is a field name normalization on an already-parsed HTTP response body. No new attack surface introduced. The `as boolean` cast on the coalesced value is safe since `??` with a `false` fallback guarantees a boolean.

### Performance Considerations

No performance impact. The change replaces a direct cast with a nullish coalescing chain — negligible overhead.

### Files Modified During Review

None — no refactoring was needed.

### Gate Status

Gate: PASS → docs/qa/gates/8.6-fix-ilp-send-result-field-name-mismatch.yml
Risk profile: Low — small diff (80 lines), no auth/security/payment logic changed, full backward compatibility

### Recommended Status

✓ Ready for Done
