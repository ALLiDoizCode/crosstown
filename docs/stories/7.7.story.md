# Story 7.7: Parse TOKEN_NETWORK Environment Variables

## Status

Done

## Story

**As a** node operator deploying on EVM chains,
**I want** the Docker entrypoint to parse `TOKEN_NETWORK_*` environment variables,
**so that** settlement negotiation can include `tokenNetworkAddress` in SPSP responses, enabling the connector to use TokenNetwork contracts for multi-token payment channels.

## Acceptance Criteria

1. `TOKEN_NETWORK_*` environment variables parsed in `parseConfig()` following the same pattern as `SETTLEMENT_ADDRESS_*` and `PREFERRED_TOKEN_*`
2. Parsed token networks stored in `settlementInfo.tokenNetworks` as `Record<string, string>` (chain → TokenNetwork contract address)
3. `tokenNetworks` field added to `SpspRequestSettlementInfo` interface in `packages/core/src/events/builders.ts`
4. When no `TOKEN_NETWORK_*` env vars are set, `tokenNetworks` is `undefined` (backward compatible)
5. Token network addresses validated as non-empty strings (no format validation — addresses vary by chain)
6. Unit tests for `TOKEN_NETWORK_*` env var parsing
7. `ownTokenNetworks` in `SettlementNegotiationConfig` (built in `main()`) populated from parsed `tokenNetworks` instead of hard-coded `undefined`

## Tasks / Subtasks

- [x] Task 1: Add `tokenNetworks` field to `SpspRequestSettlementInfo` (AC: 3)
  - [x] In `packages/core/src/events/builders.ts`, find the `SpspRequestSettlementInfo` interface (near `preferredTokens` field):
    - Add `tokenNetworks?: Record<string, string>;` field after `preferredTokens`
    - Add JSDoc: `/** Maps chain identifier to TokenNetwork contract address (EVM only) */`

- [x] Task 2: Add `TOKEN_NETWORK_*` parsing to `parseConfig()` (AC: 1, 2, 4, 5)
  - [x] In `docker/src/entrypoint.ts` `parseConfig()`:
    - After the existing `settlementAddresses` and `preferredTokens` declarations (look for `const preferredTokens: Record<string, string> = {};`), add:
      ```typescript
      const tokenNetworks: Record<string, string> = {};
      ```
    - Inside the `for (const chain of supportedChains)` loop, after the `PREFERRED_TOKEN_*` parsing (`if (token) preferredTokens[chain] = token;`):
      ```typescript
      const tokenNet = env[`TOKEN_NETWORK_${envKey}`];
      if (tokenNet) tokenNetworks[chain] = tokenNet;
      ```
    - In the `settlementInfo` object (look for `...(Object.keys(preferredTokens).length > 0 && { preferredTokens }),`), add after it:
      ```typescript
      ...(Object.keys(tokenNetworks).length > 0 && { tokenNetworks }),
      ```

- [x] Task 3: Wire `tokenNetworks` through to `SettlementNegotiationConfig` (AC: 7)
  - [x] In `docker/src/entrypoint.ts` `main()`, find `ownTokenNetworks: undefined,` inside the `settlementConfig` object:
    - Change `ownTokenNetworks: undefined,` to:
      ```typescript
      ownTokenNetworks: config.settlementInfo.tokenNetworks,
      ```

- [x] Task 4: Add missing env var keys to test cleanup (AC: 6)
  - [x] In `docker/src/entrypoint.test.ts`:
    - Verify `TOKEN_NETWORK_EVM_BASE_8453` is already in `envKeysToClean` array (confirmed present)
    - Add `TOKEN_NETWORK_XRP_MAINNET` to `envKeysToClean` (needed for multi-chain test)
    - Add `SETTLEMENT_ADDRESS_XRP_MAINNET` to `envKeysToClean` (needed for multi-chain test — Task 5 test 2 sets this env var)

- [x] Task 5: Write unit tests for TOKEN_NETWORK parsing (AC: 6)
  - [x] In `docker/src/entrypoint.test.ts`, add tests inside the `describe('parseConfig', ...)` block:
    - Test: single chain — `TOKEN_NETWORK_EVM_BASE_8453=0xTOKEN_NET` with `SUPPORTED_CHAINS=evm:base:8453` creates `settlementInfo.tokenNetworks: { "evm:base:8453": "0xTOKEN_NET" }`
    - Test: multiple chains — env setup (note: `SETTLEMENT_ADDRESS_*` vars required per chain to avoid console warnings; `SETTLEMENT_ADDRESS_XRP_MAINNET` must be in `envKeysToClean` — see Task 4):
      ```
      SUPPORTED_CHAINS=evm:base:8453,xrp:mainnet
      SETTLEMENT_ADDRESS_EVM_BASE_8453=0xADDR1
      SETTLEMENT_ADDRESS_XRP_MAINNET=rXRP_ADDR
      TOKEN_NETWORK_EVM_BASE_8453=0xTOKEN_NET_BASE
      TOKEN_NETWORK_XRP_MAINNET=rTOKEN_NET_XRP
      ```
      Expect `settlementInfo.tokenNetworks` equals `{ "evm:base:8453": "0xTOKEN_NET_BASE", "xrp:mainnet": "rTOKEN_NET_XRP" }`
    - Test: no TOKEN_NETWORK vars with `SUPPORTED_CHAINS=evm:base:8453` and `SETTLEMENT_ADDRESS_EVM_BASE_8453=0xADDR` → `settlementInfo.tokenNetworks` is `undefined` (key absent from object)
    - Test: empty string `TOKEN_NETWORK_EVM_BASE_8453=` is ignored → `tokenNetworks` is `undefined`

- [x] Task 6: Run full test suite and lint
  - [x] Run `pnpm test` — all existing tests pass plus new tests
  - [x] Run `pnpm lint` — no new lint errors

## Dev Notes

### Integration Gap Addressed
[Source: INTEGRATION-GAPS.md#gap-12]

**Gap 12: Missing Token Network Parsing from Env Vars**
- The entrypoint parses `SUPPORTED_CHAINS`, `SETTLEMENT_ADDRESS_*`, and `PREFERRED_TOKEN_*`
- But does NOT parse `TOKEN_NETWORK_*` environment variables
- These are needed for EVM `TokenNetwork` contract addresses (used for multi-token payment channels)
- Without this, settlement negotiation can't include `tokenNetworkAddress` in responses
- Story 7.6 QA identified this as an improvement item (see 7.6 QA Results, issue #2)

### Previous Story Insights (from 7.6)
[Source: docs/stories/7.6.story.md#qa-results]

Story 7.6 QA (Quinn) explicitly identified this gap:
> **(LOW) Missing TOKEN_NETWORK_* env var parsing** — `parseConfig()` builds `settlementInfo` with `supportedChains`, `settlementAddresses`, and `preferredTokens` from env vars, but does not parse `TOKEN_NETWORK_*` env vars. The `SettlementNegotiationConfig.ownTokenNetworks` is hard-coded to `undefined` in `main()` (line 631).

This story resolves that finding.

### Current Env Var Parsing Pattern
[Source: docker/src/entrypoint.ts, `parseConfig()` function, settlement info block]

The existing parsing loop converts chain IDs to env var keys. Below is the **actual current code** with GAP comments showing where `TOKEN_NETWORK_*` parsing should be added:
```typescript
// Settlement info (optional, only when SUPPORTED_CHAINS is set)
let settlementInfo: SpspRequestSettlementInfo | undefined;
const supportedChainsStr = env['SUPPORTED_CHAINS'];
if (supportedChainsStr) {
  const supportedChains = supportedChainsStr.split(',').map((s) => s.trim()).filter(Boolean);
  const settlementAddresses: Record<string, string> = {};
  const preferredTokens: Record<string, string> = {};
  // GAP: missing `const tokenNetworks: Record<string, string> = {};` here

  for (const chain of supportedChains) {
    // Convert chain id to env var key: "evm:base:8453" -> "EVM_BASE_8453"
    const envKey = chain.replace(/:/g, '_').toUpperCase();
    const addr = env[`SETTLEMENT_ADDRESS_${envKey}`];
    if (addr) settlementAddresses[chain] = addr;
    const token = env[`PREFERRED_TOKEN_${envKey}`];
    if (token) preferredTokens[chain] = token;
    // GAP: TOKEN_NETWORK_${envKey} is NOT parsed here
  }

  // Warn for chains without a settlement address
  for (const chain of supportedChains) {
    if (!settlementAddresses[chain]) {
      console.warn(`[Config] Warning: chain "${chain}" listed in SUPPORTED_CHAINS but no SETTLEMENT_ADDRESS_* env var found`);
    }
  }

  settlementInfo = {
    ilpAddress,
    supportedChains,
    ...(Object.keys(settlementAddresses).length > 0 && { settlementAddresses }),
    ...(Object.keys(preferredTokens).length > 0 && { preferredTokens }),
    // GAP: tokenNetworks not included
  };
}
```

**Chain-to-env-key conversion:** `evm:base:8453` → `EVM_BASE_8453`

### Data Models

**SpspRequestSettlementInfo (needs tokenNetworks field added)**
[Source: packages/core/src/events/builders.ts, `SpspRequestSettlementInfo` interface]
```typescript
export interface SpspRequestSettlementInfo {
  ilpAddress?: string;
  supportedChains?: string[];
  settlementAddresses?: Record<string, string>;
  preferredTokens?: Record<string, string>;
  // MISSING: tokenNetworks?: Record<string, string>;
}
```

**SettlementNegotiationConfig (already has ownTokenNetworks)**
[Source: packages/core/src/types.ts, `SettlementNegotiationConfig` interface]
```typescript
export interface SettlementNegotiationConfig {
  ownSupportedChains: string[];
  ownSettlementAddresses: Record<string, string>;
  ownPreferredTokens?: Record<string, string>;
  ownTokenNetworks?: Record<string, string>;  // Already exists — just needs to be populated
  initialDeposit?: string;
  settlementTimeout?: number;
  channelOpenTimeout?: number;
  pollInterval?: number;
}
```

**Config interface (no changes needed)**
[Source: docker/src/entrypoint.ts, `Config` interface]

The `Config.settlementInfo` field is typed as `SpspRequestSettlementInfo | undefined`. Once `SpspRequestSettlementInfo` gains the `tokenNetworks` field, the parsed value will flow through automatically. No changes to the `Config` interface itself.

**Current hard-coded undefined in main()**
[Source: docker/src/entrypoint.ts, `main()` function, `settlementConfig` block]
```typescript
if (config.settlementInfo) {
  settlementConfig = {
    ownSupportedChains: config.settlementInfo.supportedChains,
    ownSettlementAddresses: config.settlementInfo.settlementAddresses ?? {},
    ownPreferredTokens: config.settlementInfo.preferredTokens,
    ownTokenNetworks: undefined,  // <-- This must use config.settlementInfo.tokenNetworks
    initialDeposit: config.initialDeposit ?? '0',
    settlementTimeout: config.settlementTimeout ?? 86400,
    channelOpenTimeout: 30000,
    pollInterval: 1000,
  };
}
```

### File Locations

Files to modify:
- `packages/core/src/events/builders.ts` — Add `tokenNetworks` field to `SpspRequestSettlementInfo` interface
- `docker/src/entrypoint.ts` — Add `TOKEN_NETWORK_*` parsing in `parseConfig()`, wire through in `main()`
- `docker/src/entrypoint.test.ts` — Add ~4 tests for `TOKEN_NETWORK_*` parsing

Files NOT modified:
- `packages/core/src/types.ts` — `SettlementNegotiationConfig.ownTokenNetworks` already exists
- `packages/core/src/spsp/` — No changes needed
- `packages/core/src/spsp/settlement.ts` — Already uses `ownTokenNetworks` from config
- `packages/core/src/spsp/negotiateAndOpenChannel.ts` — Already passes `ownTokenNetworks` through

### Technical Constraints

**Env var naming convention:** Follows the established pattern `TOKEN_NETWORK_${chain.replace(/:/g, '_').toUpperCase()}`. Examples:
- Chain `evm:base:8453` → `TOKEN_NETWORK_EVM_BASE_8453`
- Chain `xrp:mainnet` → `TOKEN_NETWORK_XRP_MAINNET` (would be empty for non-EVM chains)

**Conditional spread pattern:** The `settlementInfo` object uses conditional spread to avoid including empty objects:
```typescript
...(Object.keys(tokenNetworks).length > 0 && { tokenNetworks }),
```
This ensures `tokenNetworks` is `undefined` (absent from object) when no `TOKEN_NETWORK_*` env vars are set.

**Scope:** This is a small, focused config-parsing change. It unblocks the full pipeline from env var → `parseConfig()` → `Config.settlementInfo.tokenNetworks` → `SettlementNegotiationConfig.ownTokenNetworks` → `negotiateAndOpenChannel()` → `tokenNetworkAddress` in SPSP responses.

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x
**File:** `docker/src/entrypoint.test.ts`
**Existing test patterns:** The test file uses `vi.stubGlobal('fetch', vi.fn())`, `savedEnv`/`envKeysToClean` pattern, `beforeEach`/`afterEach` for env var management.

**Expected new test count:** ~4 new tests

**Test cleanup:** `TOKEN_NETWORK_EVM_BASE_8453` is already in the `envKeysToClean` array. `TOKEN_NETWORK_XRP_MAINNET` must be added for the multi-chain test. Also add `SETTLEMENT_ADDRESS_XRP_MAINNET` if not already present.

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/events/builders.ts` | Modified | Added `tokenNetworks?: Record<string, string>` field with JSDoc to `SpspRequestSettlementInfo` interface |
| `docker/src/entrypoint.ts` | Modified | Added `TOKEN_NETWORK_*` env var parsing in `parseConfig()` loop, conditional spread in `settlementInfo` object, wired `tokenNetworks` through to `SettlementNegotiationConfig` in `main()` |
| `docker/src/entrypoint.test.ts` | Modified | Added `TOKEN_NETWORK_XRP_MAINNET` and `SETTLEMENT_ADDRESS_XRP_MAINNET` to `envKeysToClean`, added 4 unit tests for TOKEN_NETWORK parsing |

### Debug Log References
None — implementation was straightforward with no issues encountered.

### Completion Notes
- All 6 tasks completed with zero issues
- 4 new tests added, all 1013 tests passing
- No new dependencies introduced
- Pre-existing lint error in `packages/bls/src/storage/createEventStore.test.ts` (unrelated `@typescript-eslint/no-empty-function`) — not introduced by this story
- Implementation follows the exact same pattern as existing `SETTLEMENT_ADDRESS_*` and `PREFERRED_TOKEN_*` parsing

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The code precisely follows the established `SETTLEMENT_ADDRESS_*` and `PREFERRED_TOKEN_*` env var parsing pattern — identical structure for declaration, loop parsing, and conditional spread. The change is minimal, focused, and backward-compatible. No refactoring needed.

### Refactoring Performed

None required. The implementation is clean, idiomatic, and follows existing patterns exactly.

### Compliance Check

- Coding Standards: ✓ TypeScript strict, no `any`, consistent naming
- Project Structure: ✓ All modifications in expected locations per source tree
- Testing Strategy: ✓ Unit tests with proper env var cleanup, co-located test file, 4 edge-case-covering tests
- All ACs Met: ✓ All 7 acceptance criteria verified (see traceability below)

### Acceptance Criteria Traceability

| AC | Requirement | Verification |
|----|-------------|-------------|
| 1 | `TOKEN_NETWORK_*` parsed in `parseConfig()` following same pattern | `entrypoint.ts:150,159-160` — identical pattern to `SETTLEMENT_ADDRESS_*` and `PREFERRED_TOKEN_*` |
| 2 | Stored in `settlementInfo.tokenNetworks` as `Record<string, string>` | `entrypoint.ts:150,175` — declared as `Record<string, string>`, spread into `settlementInfo` |
| 3 | `tokenNetworks` field added to `SpspRequestSettlementInfo` | `builders.ts:55-56` — `tokenNetworks?: Record<string, string>` with JSDoc |
| 4 | When no `TOKEN_NETWORK_*` vars set, `tokenNetworks` is `undefined` | Test: "tokenNetworks is undefined when no TOKEN_NETWORK_* env vars are set" passes |
| 5 | Token network addresses validated as non-empty strings | `entrypoint.ts:159-160` — truthiness check (`if (tokenNet)`) rejects empty strings |
| 6 | Unit tests for `TOKEN_NETWORK_*` parsing | 4 tests: single chain, multi-chain, no vars, empty string |
| 7 | `ownTokenNetworks` populated from parsed `tokenNetworks` | `entrypoint.ts:635` — `ownTokenNetworks: config.settlementInfo.tokenNetworks` replaces `undefined` |

### Improvements Checklist

All items addressed — no outstanding issues.

- [x] Verified env var cleanup includes all new keys (`TOKEN_NETWORK_XRP_MAINNET`, `SETTLEMENT_ADDRESS_XRP_MAINNET`)
- [x] Verified conditional spread prevents empty object in `settlementInfo`
- [x] Verified backward compatibility (no `tokenNetworks` key when env vars absent)
- [x] Verified JSDoc on new interface field

### Security Review

No security concerns. This is config parsing with no user-facing input, no network calls, and no authentication changes. Token network addresses are opaque strings passed through without interpretation.

### Performance Considerations

No performance concerns. The parsing loop adds one additional `env[]` lookup per supported chain — negligible overhead.

### Files Modified During Review

None — no modifications were needed.

### Gate Status

Gate: PASS → docs/qa/gates/7.7-parse-token-network-environment-variables.yml
Risk profile: N/A (low-risk config parsing, no risk assessment warranted)
NFR assessment: N/A (no NFR concerns identified)

### Recommended Status

✓ Ready for Done

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft from INTEGRATION-GAPS.md (Gap 12) | PO (Claude Opus 4.6) |
| 2026-02-09 | 0.2 | Architecture review: corrected SpspRequestSettlementInfo location (builders.ts not types.ts), verified line references against current code, added previous story insights from 7.6 QA, clarified Config interface doesn't need changes, added conditional spread pattern note | SM (Claude Opus 4.6) |
| 2026-02-09 | 0.3 | QA validation fixes: replaced brittle line number refs with contextual anchors, added explicit multi-chain test env var setup, updated Dev Notes code snippet to match actual source (includes warning loop, env-key comment), added TOKEN_NETWORK_XRP_MAINNET to test cleanup | QA (Claude Opus 4.6) |
| 2026-02-09 | 0.4 | Validation fixes: added SETTLEMENT_ADDRESS_XRP_MAINNET to Task 4 cleanup (was missing — multi-chain test sets it), clarified settlement address requirement in Task 5 multi-chain test | QA (Claude Opus 4.6) |
| 2026-02-09 | 1.0 | Implementation complete: all 6 tasks done, 4 new tests, 1013 total tests passing, no new lint errors | Dev (Claude Opus 4.6) |
