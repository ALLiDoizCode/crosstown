# Story 5.7: Kubernetes Manifest Example

## Status

Done

## Story

**As a** DevOps engineer deploying to Kubernetes,
**I want** example K8s manifests for the BLS,
**so that** I can deploy it alongside agent-runtime in a cluster.

## Acceptance Criteria

1. Create `/packages/bls/examples/k8s/` directory
2. Manifests include:
   - `deployment.yaml` - BLS Deployment with resource limits and volume mount
   - `service.yaml` - ClusterIP Service exposing port 3100
   - `configmap.yaml` - Non-secret configuration
   - `secret.yaml` - Template for secrets (NOSTR_SECRET_KEY)
   - `pvc.yaml` - PersistentVolumeClaim for event storage
3. Deployment includes:
   - Liveness probe: `/health`
   - Readiness probe: `/health`
   - Resource requests/limits (CPU: 100m/500m, Memory: 128Mi/256Mi)
   - Volume mount at `/data` from PVC
4. PVC configured with:
   - Storage class placeholder (user configurable)
   - Default size: 1Gi (configurable)
   - Access mode: ReadWriteOnce
5. README with `kubectl apply` instructions
6. Kustomize base for easy customization (optional)

## Tasks / Subtasks

- [x] Task 1: Create K8s directory structure and Deployment manifest (AC: 1, 2, 3)
  - [x] Create `packages/bls/examples/k8s/` directory
  - [x] Create `packages/bls/examples/k8s/deployment.yaml` with:
    - `apiVersion: apps/v1`, `kind: Deployment`
    - Metadata: `name: bls`, appropriate labels (`app: bls`, `app.kubernetes.io/name: bls`, `app.kubernetes.io/part-of: agent-society`)
    - `replicas: 1` (SQLite is single-writer, no horizontal scaling)
    - Pod template with container spec:
      - Image: `di3twater/agent-society-bls:latest`
      - Container port: `3100` (named `http`)
      - Resource requests: `cpu: 100m`, `memory: 128Mi`
      - Resource limits: `cpu: 500m`, `memory: 256Mi`
      - Environment variables from ConfigMap (`bls-config`) and Secret (`bls-secret`)
      - `envFrom` referencing the ConfigMap and Secret
      - Volume mount: `/data` from PVC
    - Liveness probe: `httpGet` on `/health` port `http`, `initialDelaySeconds: 10`, `periodSeconds: 30`, `timeoutSeconds: 5`, `failureThreshold: 3`
    - Readiness probe: `httpGet` on `/health` port `http`, `initialDelaySeconds: 5`, `periodSeconds: 10`, `timeoutSeconds: 5`, `failureThreshold: 3`
    - Volume referencing PVC `bls-data`

- [x] Task 2: Create Service manifest (AC: 2)
  - [x] Create `packages/bls/examples/k8s/service.yaml` with:
    - `apiVersion: v1`, `kind: Service`
    - `type: ClusterIP`
    - Selector matching Deployment pod labels (`app: bls`)
    - Port: `port: 3100`, `targetPort: http`, `protocol: TCP`, `name: http`
  - [x] Include comments explaining how other services (e.g., ILP connector) can reach BLS at `http://bls:3100/handle-payment`

- [x] Task 3: Create ConfigMap manifest (AC: 2)
  - [x] Create `packages/bls/examples/k8s/configmap.yaml` with:
    - `apiVersion: v1`, `kind: ConfigMap`
    - Data keys for non-secret BLS configuration:
      - `NODE_ID: my-node`
      - `ILP_ADDRESS: g.agent-society.my-node`
      - `BLS_PORT: "3100"`
      - `DATA_DIR: /data`
    - Include commented-out optional variables: `BLS_BASE_PRICE_PER_BYTE`, `OWNER_PUBKEY`, `BLS_KIND_OVERRIDES`
    - Include comments explaining each variable

- [x] Task 4: Create Secret manifest template (AC: 2)
  - [x] Create `packages/bls/examples/k8s/secret.yaml` with:
    - `apiVersion: v1`, `kind: Secret`
    - `type: Opaque`
    - `stringData` section with `NOSTR_SECRET_KEY` placeholder
    - Include comments warning this is a template — never commit real secrets
    - Include instructions for generating a secret key (`openssl rand -hex 32`)
    - Include note about using external secret management (e.g., Sealed Secrets, External Secrets Operator) in production

- [x] Task 5: Create PersistentVolumeClaim manifest (AC: 2, 4)
  - [x] Create `packages/bls/examples/k8s/pvc.yaml` with:
    - `apiVersion: v1`, `kind: PersistentVolumeClaim`
    - `accessModes: [ReadWriteOnce]`
    - `resources.requests.storage: 1Gi`
    - Commented-out `storageClassName` with note explaining user should set this to their cluster's storage class
    - Include comments about sizing guidance (1Gi is suitable for moderate event storage; increase for high-traffic nodes)

- [x] Task 6: Create Kustomize base (AC: 6)
  - [x] Create `packages/bls/examples/k8s/kustomization.yaml` with:
    - `apiVersion: kustomize.config.k8s.io/v1beta1`, `kind: Kustomization`
    - `resources` listing all manifest files (deployment, service, configmap, secret, pvc)
    - `commonLabels` with `app.kubernetes.io/name: bls` and `app.kubernetes.io/part-of: agent-society`
    - Include comments explaining how to use as a Kustomize base for overlays

- [x] Task 7: Update BLS README with Kubernetes section (AC: 5)
  - [x] Add a "Kubernetes" section to `packages/bls/README.md` after the "Docker Compose" section
  - [x] Include quickstart instructions:
    1. Edit `secret.yaml` with real `NOSTR_SECRET_KEY`
    2. Edit `configmap.yaml` with desired `NODE_ID` and `ILP_ADDRESS`
    3. Apply with `kubectl apply -f packages/bls/examples/k8s/`
    4. Or use Kustomize: `kubectl apply -k packages/bls/examples/k8s/`
  - [x] Explain how to customize with Kustomize overlays
  - [x] Reference the example directory location

- [x] Task 8: Validate all YAML manifests (AC: 2, 3, 4)
  - [x] Verify all YAML files are syntactically valid
  - [x] Confirm Kubernetes API versions are current and stable (`apps/v1`, `v1`)
  - [x] Verify resource field names, structure, and indentation are correct
  - [x] Ensure label selectors match between Deployment, Service, and pod template
  - [x] Verify probe configuration values match Dockerfile health check parameters
  - [x] Cross-reference environment variable names with `loadBlsConfigFromEnv()` in `packages/bls/src/config.ts`

## Dev Notes

### Previous Story Insights
[Source: docs/stories/5.6.story.md#dev-agent-record]

From Story 5.6 implementation:
- 771 tests passing, 0 failures after Story 5.6
- Docker Compose example created at `packages/bls/examples/docker-compose.yml`
- `.env.example` created at `packages/bls/examples/.env.example`
- Docker Compose section added to `packages/bls/README.md`
- No issues encountered during 5.6 implementation
- Compose file uses Compose Specification format (no `version` key)
- Health check mirrors Dockerfile exactly: `interval: 30s`, `timeout: 5s`, `start_period: 10s`, `retries: 3`

From Story 5.5 implementation:
[Source: docs/stories/5.6.story.md#dev-notes]
- Image published to Docker Hub: `di3twater/agent-society-bls`
- Available tags: `latest` (main), `X.Y.Z` (semver from `bls-v*` tags), `sha-<short>` (Git SHA)
- Multi-arch: `linux/amd64`, `linux/arm64`

From Story 5.2 implementation:
[Source: docs/stories/5.6.story.md#dev-notes]
- Dockerfile at `packages/bls/Dockerfile`
- Base image: `node:20-alpine`
- Runs as non-root `node` user
- Container health check: `wget -q --spider http://localhost:3100/health` (every 30s, 5s timeout, 10s start period, 3 retries)
- Default port: `3100`, default data dir: `/data`

### Docker Hub Configuration
[Source: docs/epics/epic-5-standalone-bls-docker.md#configuration]

| Setting | Value |
|---------|-------|
| Docker Hub Organization | `di3twater` |
| Image Name | `agent-society-bls` |
| Full Image Reference | `di3twater/agent-society-bls` |
| Default Port | `3100` |
| Data Volume | `/data` |

### BLS Environment Variables
[Source: packages/bls/src/config.ts, packages/bls/README.md]

Complete list of environment variables parsed by `loadBlsConfigFromEnv()`:

**Required:**
| Variable | Validation | Description |
|----------|-----------|-------------|
| `NODE_ID` | Non-empty string | Unique node identifier |
| `NOSTR_SECRET_KEY` | 64-char lowercase hex (`/^[0-9a-f]{64}$/`) | Nostr secret key |
| `ILP_ADDRESS` | Must match `/^g\.[a-zA-Z0-9.-]+$/` | Node's ILP address |

**Optional:**
| Variable | Default | Validation | Description |
|----------|---------|-----------|-------------|
| `BLS_PORT` | `3100` | Integer 1-65535 | HTTP port |
| `BLS_BASE_PRICE_PER_BYTE` | `10` | Positive integer (bigint) | Base price per byte |
| `OWNER_PUBKEY` | -- | 64-char lowercase hex | Owner pubkey for payment bypass |
| `DATA_DIR` | `/data` | String path | SQLite database directory |
| `BLS_KIND_OVERRIDES` | -- | JSON object `{"kind":"price"}` | Kind-specific price overrides |

**Pricing Variable Aliases** (fallback chain):
- `BLS_BASE_PRICE_PER_BYTE` > `RELAY_BASE_PRICE_PER_BYTE` > `BASE_PRICE_PER_BYTE`
- `BLS_KIND_OVERRIDES` > `RELAY_KIND_OVERRIDES` > `KIND_OVERRIDES`

**Important:** The ConfigMap should contain non-secret variables (`NODE_ID`, `ILP_ADDRESS`, `BLS_PORT`, `DATA_DIR`, and optionally `BLS_BASE_PRICE_PER_BYTE`, `OWNER_PUBKEY`, `BLS_KIND_OVERRIDES`). The Secret should contain only `NOSTR_SECRET_KEY`.

### Dockerfile Health Check Reference
[Source: packages/bls/Dockerfile]

The Dockerfile defines:
```dockerfile
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD wget -q --spider http://localhost:3100/health || exit 1
```

The Kubernetes probes should align with this:
- **Liveness probe**: `initialDelaySeconds: 10` (matches `--start-period=10s`), `periodSeconds: 30` (matches `--interval=30s`), `timeoutSeconds: 5` (matches `--timeout=5s`), `failureThreshold: 3` (matches `--retries=3`)
- **Readiness probe**: Can use tighter intervals since it affects traffic routing — `initialDelaySeconds: 5`, `periodSeconds: 10`, `timeoutSeconds: 5`, `failureThreshold: 3`

Both probes use `httpGet` on path `/health` and port `http` (named port 3100).

### BLS Endpoints
[Source: packages/bls/README.md#endpoints]

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/health` | GET | Health check -- returns `{ status, nodeId, pubkey, ilpAddress, timestamp }` |
| `/handle-payment` | POST | Verify ILP payment and process event storage |

### Existing README Structure
[Source: packages/bls/README.md]

Current README sections:
1. Quick Start (docker pull + docker run)
2. Docker Hub (link + available tags table)
3. Docker Compose (quickstart + integration)
4. Environment Variables (table + aliases + details)
5. Endpoints (/health, /handle-payment, ILP error codes)

The Kubernetes section should be added after "Docker Compose" and before "Environment Variables" for logical flow (Quick Start > Docker Hub > Docker Compose > Kubernetes > Environment Variables > Endpoints).

### File Locations
[Source: docs/architecture/9-source-tree.md]

New files to create:
- `packages/bls/examples/k8s/deployment.yaml` -- BLS Deployment
- `packages/bls/examples/k8s/service.yaml` -- ClusterIP Service
- `packages/bls/examples/k8s/configmap.yaml` -- Non-secret configuration
- `packages/bls/examples/k8s/secret.yaml` -- Secret template
- `packages/bls/examples/k8s/pvc.yaml` -- PersistentVolumeClaim
- `packages/bls/examples/k8s/kustomization.yaml` -- Kustomize base

Existing file to modify:
- `packages/bls/README.md` -- Add Kubernetes deployment section

### Kubernetes Resource Specifications
[Source: docs/epics/epic-5-standalone-bls-docker.md#story-57]

The epic specifies these exact resource values:
- CPU request: `100m`, CPU limit: `500m`
- Memory request: `128Mi`, Memory limit: `256Mi`
- PVC size: `1Gi`
- PVC access mode: `ReadWriteOnce`
- Service type: `ClusterIP`
- Service port: `3100`

### SQLite Scaling Constraint
[Source: docs/epics/epic-5-standalone-bls-docker.md#out-of-scope]

SQLite is a single-writer database. The Deployment should use `replicas: 1` and the PVC uses `ReadWriteOnce` access mode. Horizontal scaling is explicitly out of scope for this epic. Include a comment in the deployment manifest noting this constraint.

### Scope Boundaries

**In Scope (this story):**
- `packages/bls/examples/k8s/deployment.yaml` -- Deployment manifest
- `packages/bls/examples/k8s/service.yaml` -- Service manifest
- `packages/bls/examples/k8s/configmap.yaml` -- ConfigMap manifest
- `packages/bls/examples/k8s/secret.yaml` -- Secret template
- `packages/bls/examples/k8s/pvc.yaml` -- PersistentVolumeClaim manifest
- `packages/bls/examples/k8s/kustomization.yaml` -- Kustomize base
- `packages/bls/README.md` -- Update with Kubernetes documentation

**Out of Scope:**
- BLS contract documentation (Story 5.8)
- Helm charts (could be a future enhancement)
- Ingress/NetworkPolicy manifests (cluster-specific)
- Modifying the Dockerfile or BLS source code
- Modifying the GitHub Actions workflow
- Horizontal Pod Autoscaler (SQLite is single-writer)

### Testing

**Test Approach:** This story is documentation/configuration only. There is no runtime application code to unit test. Validation is done through:

1. **YAML syntax validation** -- Ensure all manifest files are valid YAML
2. **Kubernetes API version validation** -- Confirm `apiVersion` and `kind` are correct and stable
3. **Label selector consistency** -- Verify Deployment, Service, and pod template labels match
4. **Environment variable cross-reference** -- Verify all env var names match `loadBlsConfigFromEnv()` in `packages/bls/src/config.ts`
5. **Kustomize validation** -- `kubectl kustomize packages/bls/examples/k8s/` renders without errors (if kubectl available)
6. **README review** -- Deployment instructions are clear and accurate

**Test Standards:**
[Source: docs/architecture/13-test-strategy-and-standards.md]
- Framework: Vitest 1.x (not applicable for YAML/documentation files)
- No new unit tests needed for this story (no TypeScript changes)
- Existing test suite (771 tests) should continue to pass with no regressions

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### File List

| File | Action | Description |
|------|--------|-------------|
| `packages/bls/examples/k8s/deployment.yaml` | Created | BLS Deployment with resource limits, probes, volume mount |
| `packages/bls/examples/k8s/service.yaml` | Created | ClusterIP Service exposing port 3100 |
| `packages/bls/examples/k8s/configmap.yaml` | Created | Non-secret configuration (NODE_ID, ILP_ADDRESS, BLS_PORT, DATA_DIR) |
| `packages/bls/examples/k8s/secret.yaml` | Created | Secret template for NOSTR_SECRET_KEY |
| `packages/bls/examples/k8s/pvc.yaml` | Created | PersistentVolumeClaim (1Gi, ReadWriteOnce) |
| `packages/bls/examples/k8s/kustomization.yaml` | Created | Kustomize base for easy customization |
| `packages/bls/README.md` | Modified | Added Kubernetes section with quickstart, Kustomize overlays, and manifest table |

### Debug Log References

No issues encountered during implementation.

### Completion Notes

- All 6 K8s manifests created with correct API versions, labels, and selectors
- YAML syntax validated for all files
- Label selectors verified consistent across Deployment, Service, and pod template
- Liveness/readiness probes aligned with Dockerfile health check parameters
- Environment variables cross-referenced with `loadBlsConfigFromEnv()` in config.ts
- ConfigMap contains non-secret variables; Secret contains only NOSTR_SECRET_KEY
- PVC configured with ReadWriteOnce access, 1Gi storage, commented-out storageClassName
- Kustomize base includes all 5 manifest files with commonLabels
- README updated with Kubernetes section between Docker Compose and Environment Variables
- Full test suite passes: 771 tests, 0 failures, no regressions
- No new dependencies added
- No TypeScript source code modified

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. All 6 Kubernetes manifests are well-structured, follow K8s best practices, and use stable API versions (`apps/v1`, `v1`). Comments are helpful and appropriate — SQLite single-writer constraint is documented in the Deployment, secret management warnings are thorough, and sizing guidance is practical. The README Kubernetes section integrates cleanly with the existing documentation structure and provides clear, actionable quickstart instructions.

### Refactoring Performed

None required. This is a documentation/configuration-only story with no application code changes.

### Compliance Check

- Coding Standards: ✓ N/A (no TypeScript changes; YAML follows consistent formatting)
- Project Structure: ✓ Files placed in `packages/bls/examples/k8s/` as specified
- Testing Strategy: ✓ No unit tests required (configuration-only story); 771 existing tests pass with 0 regressions
- All ACs Met: ✓ All 6 acceptance criteria fully satisfied (see traceability below)

### AC Traceability

| AC | Requirement | Status | Evidence |
|----|-------------|--------|----------|
| 1 | Create `/packages/bls/examples/k8s/` directory | ✓ | Directory exists with 6 manifest files |
| 2 | Manifests include deployment, service, configmap, secret, pvc | ✓ | All 5 required manifests + kustomization.yaml present |
| 3 | Deployment includes probes, resource limits, volume mount | ✓ | Liveness/readiness probes aligned with Dockerfile, CPU 100m/500m, Memory 128Mi/256Mi, /data volume mount |
| 4 | PVC configured correctly | ✓ | ReadWriteOnce, 1Gi default, commented-out storageClassName |
| 5 | README with kubectl apply instructions | ✓ | Kubernetes section added with quickstart and Kustomize overlay examples |
| 6 | Kustomize base (optional) | ✓ | `kustomization.yaml` with all 5 resources and commonLabels |

### Improvements Checklist

All items verified — no changes required:

- [x] YAML syntax valid across all 6 manifest files
- [x] Kubernetes API versions are current and stable (`apps/v1`, `v1`, `kustomize.config.k8s.io/v1beta1`)
- [x] Label selectors consistent across Deployment, Service, and pod template
- [x] Probe parameters aligned with Dockerfile HEALTHCHECK
- [x] Environment variables cross-referenced with `loadBlsConfigFromEnv()` in `config.ts`
- [x] Secret template includes proper security warnings and external secret manager references
- [x] SQLite single-writer constraint documented (replicas: 1)

### Security Review

No security concerns. The secret manifest is correctly structured as a template with clear warnings against committing real secrets. It references three external secret management solutions (Sealed Secrets, External Secrets Operator, HashiCorp Vault) for production use. `NOSTR_SECRET_KEY` is the only value in the Secret resource; all non-sensitive config is in the ConfigMap.

### Performance Considerations

No performance concerns. Resource limits are reasonable for a lightweight Node.js application with SQLite. The readiness probe uses tighter intervals (5s initial, 10s period) than the liveness probe (10s initial, 30s period), which is appropriate for traffic routing.

### Files Modified During Review

None. No refactoring was necessary.

### Gate Status

Gate: PASS → docs/qa/gates/5.7-kubernetes-manifest-example.yml

### Recommended Status

✓ Ready for Done — All acceptance criteria met, all manifests valid, full test suite passing.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-07 | 1.0 | Implementation complete | Dev (Claude Opus 4.6) |
| 2026-02-07 | 1.0-qa | QA review — PASS | Quinn (Test Architect) |
