# Story 9.5: Validate Package Contents

## Status

Done

## Story

**As a** library publisher,
**I want** to run `npm pack` for each publishable package, verify that the resulting tarballs contain only the expected files, and test that the packages install and import correctly in a fresh project,
**so that** I can confirm the packages are correctly configured before publishing to npm and consumers will have a clean, working install experience.

## Acceptance Criteria

1. `npm pack` succeeds for `@crosstown/bls`, `@crosstown/core`, and `@crosstown/relay` without errors
2. Each tarball contains ONLY: `dist/` directory contents, `README.md`, and `package.json` — no source files (`src/`), no test files (`*.test.ts`), no `tsconfig.json`, no `tsup.config.ts`, no `node_modules/`
3. TypeScript declaration files (`.d.ts`) are present in `dist/` within each tarball
4. A fresh project can `npm install` from the local tarballs (using file: protocol or `npm install ./tarball.tgz`)
5. TypeScript imports resolve correctly in the fresh project: `import { NostrPeerDiscovery } from '@crosstown/core'` compiles without errors
6. The `@crosstown/relay` tarball declares `@crosstown/bls` and `@crosstown/core` as dependencies with `^1.0.0` (not `workspace:*`)
7. No LICENSE file is expected in tarballs (no LICENSE file exists in the repo; this is a known gap — the epic AC mentions LICENSE but the repo has none to include)
8. All tarballs are cleaned up after validation (not committed to the repo)

## Tasks / Subtasks

- [x] Task 1: Build all packages before packing (AC: 1, 3)
  - [x] Run `pnpm build` to ensure all packages have fresh `dist/` output
  - [x] Verify `dist/` directories exist in `packages/bls`, `packages/core`, `packages/relay`
  - [x] Verify `.d.ts` files are generated in each `dist/` directory

- [x] Task 2: Run `npm pack` for each package (AC: 1)
  - [x] Run `npm pack` in `packages/bls/` — produces `crosstown-bls-1.0.0.tgz`
  - [x] Run `npm pack` in `packages/core/` — produces `crosstown-core-1.0.0.tgz`
  - [x] Run `npm pack` in `packages/relay/` — produces `crosstown-relay-1.0.0.tgz`
  - [x] Verify all three commands exit with code 0

- [x] Task 3: Inspect tarball contents for each package (AC: 2, 3, 6)
  - [x] Run `tar tzf <tarball>` for each tarball and capture the file listing
  - [x] **bls**: Verify contains `package/dist/index.js`, `package/dist/index.d.ts`, `package/dist/index.js.map`, `package/dist/entrypoint.js`, `package/dist/entrypoint.d.ts`, `package/dist/entrypoint.js.map`, `package/README.md`, `package/package.json` — and NOTHING else
  - [x] **core**: Verify contains `package/dist/index.js`, `package/dist/index.d.ts`, `package/dist/index.js.map`, `package/README.md`, `package/package.json` — and NOTHING else
  - [x] **relay**: Verify contains `package/dist/index.js`, `package/dist/index.d.ts`, `package/dist/index.js.map`, `package/README.md`, `package/package.json` — and NOTHING else
  - [x] For all tarballs: Verify NO `src/` directory, NO `*.test.ts` files, NO `tsconfig.json`, NO `tsup.config.ts`, NO `node_modules/`
  - [x] **relay**: Inspect `package/package.json` inside tarball — verify `dependencies` has `"@crosstown/bls": "^1.0.0"` and `"@crosstown/core": "^1.0.0"` (not `workspace:*`)

- [x] Task 4: Test install from tarballs in a fresh project (AC: 4, 5)
  - [x] Create a temporary directory outside the workspace (e.g., `/tmp/crosstown-pack-test/`)
  - [x] Initialize a minimal Node.js project: `npm init -y` with `"type": "module"`
  - [x] Add a `tsconfig.json` with `"moduleResolution": "bundler"` or `"node16"` and `"module": "ESNext"`, `"target": "ES2020"`, `"strict": true`
  - [x] Install TypeScript as a dev dependency: `npm install -D typescript`
  - [x] Copy all three tarballs to the temp directory
  - [x] Install packages from tarballs: `npm install ./crosstown-bls-1.0.0.tgz ./crosstown-core-1.0.0.tgz ./crosstown-relay-1.0.0.tgz`
  - [x] Verify install succeeds without errors
  - [x] Create a test file `test-imports.ts` that imports key exports from each package:
    ```typescript
    import { NostrPeerDiscovery, NostrSpspClient, SocialTrustManager } from '@crosstown/core';
    import { NostrRelayServer, InMemoryEventStore } from '@crosstown/relay';
    import { createBlsServer, loadBlsConfigFromEnv } from '@crosstown/bls';
    import type { IlpPeerInfo } from '@crosstown/core';
    import type { RelayConfig } from '@crosstown/relay';
    import type { BlsEnvConfig } from '@crosstown/bls';
    ```
  - [x] Run `npx tsc --noEmit` on the test file — verify it compiles without type errors
  - [x] Clean up temp directory

- [x] Task 5: Clean up tarballs from package directories (AC: 8)
  - [x] Delete `packages/bls/crosstown-bls-1.0.0.tgz`
  - [x] Delete `packages/core/crosstown-core-1.0.0.tgz`
  - [x] Delete `packages/relay/crosstown-relay-1.0.0.tgz`
  - [x] Verify no `.tgz` files remain in the workspace

## Dev Notes

### Previous Story Insights
[Source: docs/stories/9.4.story.md — Dev Agent Record]

Story 9.4 resolved all `workspace:*` references to `^1.0.0` in publishable packages. Key insights:
- `pnpm build` passes for core, bls, relay. `ui-prototypes` build failure is pre-existing (TS6133 unused variable errors) and unrelated to this epic.
- `pnpm test`: 1020 passed, 2 failed — both failures are **pre-existing** (`SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` have `subscribeMany` call signature assertion mismatches unrelated to this epic).
- `workspace:*` references were replaced with `^1.0.0` in `relay/package.json` (dependencies) and `core/package.json` (devDependencies). Private packages (`examples`, `docker`) retain `workspace:*`.
- The workspace reference resolution was a prerequisite for this story because `npm pack` does NOT transform `workspace:*` like `pnpm publish` does. Since `^1.0.0` is now in place, `npm pack` will produce correct tarballs.

### Package Configuration Summary
[Source: packages/bls/package.json, packages/core/package.json, packages/relay/package.json]

All three packages share these key fields:
- `"version": "1.0.0"` (set in Story 9.3)
- `"type": "module"` (ESM-only)
- `"files": ["dist"]` — this is what controls what `npm pack` includes. npm automatically includes `package.json` and `README.md` regardless of the `files` field.
- `"main": "./dist/index.js"`, `"module": "./dist/index.js"`, `"types": "./dist/index.d.ts"`
- `"exports": { ".": { "types": "./dist/index.d.ts", "import": "./dist/index.js" } }`
- `"publishConfig": { "access": "public" }`
- `"license": "MIT"`, `"repository"`, `"author"` (set in Story 9.1)

**bls** has no internal workspace dependencies.
**core** has `@crosstown/relay` as a devDependency (`^1.0.0`) — devDependencies are NOT included in published packages.
**relay** depends on `@crosstown/bls: "^1.0.0"` and `@crosstown/core: "^1.0.0"` in production dependencies.

### Build System
[Source: packages/*/tsup.config.ts]

All packages use tsup with identical config (except bls which has two entry points):
```typescript
defineConfig({
  entry: ['src/index.ts'],  // bls: ['src/index.ts', 'src/entrypoint.ts']
  format: ['esm'],
  dts: true,         // Generates .d.ts files
  sourcemap: true,   // Generates .js.map files
  clean: true,       // Cleans dist/ before build
  outDir: 'dist',
})
```

Expected `dist/` contents per package:
- **bls**: `index.js`, `index.d.ts`, `index.js.map`, `entrypoint.js`, `entrypoint.d.ts`, `entrypoint.js.map`
- **core**: `index.js`, `index.d.ts`, `index.js.map`
- **relay**: `index.js`, `index.d.ts`, `index.js.map`

### How `npm pack` Works
[Source: npm documentation]

- `npm pack` creates a tarball of the package as it would be published
- Respects the `"files"` field in `package.json` to determine what to include
- Always includes: `package.json`, `README.md` (and `README`), `LICENSE` (and variants), `CHANGELOG` (and variants)
- The tarball is created in the current working directory. For scoped packages, npm strips the `@` and replaces `/` with `-`, so `@crosstown/bls@1.0.0` becomes `crosstown-bls-1.0.0.tgz`
- Files inside the tarball are prefixed with `package/`

### LICENSE File Note
[Source: repo file system scan]

There is no `LICENSE` file in the repository root or in any package directory. The epic AC states package contents should contain `LICENSE`, but since no such file exists, tarballs will not include one. The `"license": "MIT"` field exists in all package.json files. This is a known gap that may need to be addressed separately (adding a LICENSE file to the repo), but is out of scope for this validation story.

### Verified Package Exports for Import Test
[Source: packages/bls/src/index.ts, packages/core/src/index.ts, packages/relay/src/index.ts]

The test imports in Task 4 use these verified named exports:
- **core**: `NostrPeerDiscovery`, `NostrSpspClient`, `SocialTrustManager` (value exports); `IlpPeerInfo` (type export)
- **relay**: `NostrRelayServer`, `InMemoryEventStore` (value exports); `RelayConfig` (type export). Note: there is NO `WebSocketServer` export — the class is named `NostrRelayServer`.
- **bls**: `createBlsServer`, `loadBlsConfigFromEnv` (value exports); `BlsEnvConfig` (type export)

### Fresh Project Test Setup
[Source: docs/architecture/3-tech-stack.md]

When testing installs in a fresh project:
- The project must be `"type": "module"` since all packages are ESM-only (`"format": ['esm']`)
- TypeScript `moduleResolution` must be `"bundler"` or `"node16"` to resolve the `exports` field
- TypeScript `module` should be `"ESNext"` or `"Node16"`
- Target at least `"ES2020"` for modern JavaScript features
- The fresh project needs TypeScript installed to verify type resolution

### What NOT to Change
[Source: docs/epics/epic-9-npm-package-publishing.md]

This story is read-only validation — NO changes to any source files, package.json files, build configs, or test suites. The only artifacts produced are temporary tarballs and a temporary test project, all of which are cleaned up.

### File Locations
[Source: docs/architecture/9-source-tree.md]

```
packages/
├── bls/            # @crosstown/bls — npm pack here
│   ├── dist/       # Build output (must exist before pack)
│   ├── README.md   # Included in tarball automatically
│   └── package.json
├── core/           # @crosstown/core — npm pack here
│   ├── dist/
│   ├── README.md
│   └── package.json
└── relay/          # @crosstown/relay — npm pack here
    ├── dist/
    ├── README.md
    └── package.json
```

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **No new unit tests required** — this story is a validation/QA activity, not a code change
- **Validation is the test:** The entire story IS a test — `npm pack`, tarball inspection, and fresh-project install are the verification steps
- **Expected pre-existing test results:** If running `pnpm test` as a sanity check: 1020 passed, 2 pre-existing failures (`SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` subscribeMany signature mismatches)

### Project Structure Notes
[Source: docs/architecture/9-source-tree.md]

No structural conflicts. This story creates only temporary artifacts (tarballs, temp test project) that are cleaned up. No permanent file changes.

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes
- All 5 tasks completed successfully. All acceptance criteria (AC 1-8) verified.
- **bls tarball** contains 2 additional chunk files (`chunk-ZRLV7CGG.js`, `chunk-ZRLV7CGG.js.map`) from tsup code-splitting between entry points. These are valid `dist/` contents per AC 2.
- **npm cache permission issue** (EACCES) encountered during fresh project install — worked around with `--cache /tmp/npm-cache-test`.
- **Third-party type errors** from transitive dependencies (x402, @solana/kit, @ardrive/turbo-sdk) required `skipLibCheck: true` in the test tsconfig — standard consumer practice. Our package types resolve correctly.
- **No source files modified** — this is a read-only validation story. Only the story file itself was updated.

### File List
No source files created, modified, or deleted. Only temporary artifacts (tarballs, temp test project) were created and cleaned up.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-11 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-11 | 0.2 | Fix import symbols (WebSocketServer→NostrRelayServer), add bls import test, add verified exports note, clarify scoped tarball naming | QA (Claude Opus 4.6) |
| 2026-02-11 | 1.0 | All tasks completed — build, pack, inspect, fresh install, cleanup all pass | Dev (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent quality for a read-only validation story. No source code was modified — the entire story IS the test. The dev agent executed all 5 tasks correctly and documented results thoroughly including edge cases (bls chunk files from code-splitting, npm cache EACCES workaround, skipLibCheck for transitive type errors). All 8 acceptance criteria independently verified by QA.

**Independent verification performed:**
1. `pnpm build` — bls, core, relay all build successfully (ui-prototypes failure is pre-existing, unrelated)
2. `npm pack` — all three packages produce valid tarballs (exit code 0)
3. Tarball contents inspection:
   - **bls**: 10 files — `dist/` (index.js, index.d.ts, index.js.map, entrypoint.js, entrypoint.d.ts, entrypoint.js.map, chunk-ZRLV7CGG.js, chunk-ZRLV7CGG.js.map), README.md, package.json. No src/, no test files, no config files.
   - **core**: 5 files — `dist/` (index.js, index.d.ts, index.js.map), README.md, package.json. Clean.
   - **relay**: 5 files — `dist/` (index.js, index.d.ts, index.js.map), README.md, package.json. Clean.
4. Relay tarball package.json confirms `"@crosstown/bls": "^1.0.0"` and `"@crosstown/core": "^1.0.0"` (not workspace:*)
5. Fresh project install (`npm install ./crosstown-*.tgz`) succeeds — 822 transitive packages installed
6. TypeScript compilation test (`npx tsc --noEmit`) passes — all imports from all three packages resolve correctly
7. Cleanup complete — no tarballs left in workspace
8. Test suite: 1020 passed, 2 failed (pre-existing subscribeMany assertion mismatches, unrelated)

### Refactoring Performed

None — this is a read-only validation story with no source code to refactor.

### Compliance Check

- Coding Standards: ✓ — No code changes; story is validation-only
- Project Structure: ✓ — No structural changes; only temporary artifacts created and cleaned up
- Testing Strategy: ✓ — The story itself IS the test; no new unit tests required per strategy doc
- All ACs Met: ✓ — All 8 acceptance criteria independently verified

### Improvements Checklist

All items verified — no changes required:

- [x] AC1: `npm pack` succeeds for all three packages
- [x] AC2: Tarballs contain only dist/, README.md, package.json (no src/, test files, configs, node_modules)
- [x] AC3: TypeScript declaration files (.d.ts) present in dist/
- [x] AC4: Fresh project installs from local tarballs successfully
- [x] AC5: TypeScript imports resolve correctly (NostrPeerDiscovery, NostrSpspClient, SocialTrustManager, NostrRelayServer, InMemoryEventStore, createBlsServer, loadBlsConfigFromEnv, and type imports)
- [x] AC6: Relay tarball declares bls and core with ^1.0.0 (not workspace:*)
- [x] AC7: No LICENSE file expected (documented known gap)
- [x] AC8: All tarballs cleaned up after validation

### Security Review

No security concerns. This story performs read-only validation with no code changes. The tarballs do not include source code, test files, or configuration files that could leak implementation details. The `skipLibCheck: true` used in the fresh project test is standard consumer practice for transitive dependency type conflicts and does not affect our package type safety.

### Performance Considerations

No performance concerns. This is a one-time validation activity with no runtime impact.

### Files Modified During Review

No source files modified. Only the QA Results section of this story file was appended.

### Gate Status

Gate: PASS → docs/qa/gates/9.5-validate-package-contents.yml
Risk profile: N/A (read-only validation story, no code risk)
NFR assessment: N/A (no code changes)

### Recommended Status

✓ Ready for Done — All acceptance criteria verified independently. Clean validation with no issues found.
