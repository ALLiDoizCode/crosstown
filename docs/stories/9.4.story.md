# Story 9.4: Resolve Workspace References

## Status

Done

## Story

**As a** library publisher,
**I want** to replace `workspace:*` references in publishable packages' dependencies with `^1.0.0` version ranges,
**so that** when these packages are published to npm, their dependency declarations resolve to real npm versions rather than pnpm workspace specifiers that don't work outside the monorepo.

## Acceptance Criteria

1. `packages/relay/package.json` dependencies list `"@crosstown/bls": "^1.0.0"` (was `workspace:*`)
2. `packages/relay/package.json` dependencies list `"@crosstown/core": "^1.0.0"` (was `workspace:*`)
3. `packages/core/package.json` devDependencies list `"@crosstown/relay": "^1.0.0"` (was `workspace:*`)
4. Private/non-published packages (`examples`, `docker`) retain `workspace:*` references unchanged — they are never published and rely on local workspace resolution
5. No changes to any source code, exports, build configuration, or non-workspace dependency versions
6. `pnpm install` succeeds (pnpm resolves `^1.0.0` to local workspace packages when available)
7. `pnpm build` succeeds with no errors across all packages
8. `pnpm test` passes with no regressions

## Tasks / Subtasks

- [x] Task 1: Update `@crosstown/relay` production dependencies (AC: 1, 2, 5)
  - [x] Open `packages/relay/package.json`
  - [x] Change `"@crosstown/bls": "workspace:*"` to `"@crosstown/bls": "^1.0.0"` (line 39)
  - [x] Change `"@crosstown/core": "workspace:*"` to `"@crosstown/core": "^1.0.0"` (line 40)
  - [x] Verify no other fields were modified

- [x] Task 2: Update `@crosstown/core` dev dependencies (AC: 3, 5)
  - [x] Open `packages/core/package.json`
  - [x] Change `"@crosstown/relay": "workspace:*"` to `"@crosstown/relay": "^1.0.0"` (line 45)
  - [x] Verify no other fields were modified

- [x] Task 3: Verify private packages retain `workspace:*` (AC: 4)
  - [x] Confirm `packages/examples/package.json` still has `"@crosstown/core": "workspace:*"` and `"@crosstown/relay": "workspace:*"` in dependencies
  - [x] Confirm `docker/package.json` still has `"@crosstown/core": "workspace:*"` and `"@crosstown/relay": "workspace:*"` in dependencies

- [x] Task 4: Run `pnpm install` to verify lockfile updates (AC: 6)
  - [x] Run `pnpm install` — should succeed with updated lockfile
  - [x] pnpm should resolve `^1.0.0` to local workspace packages (both `core` and `bls` are at `1.0.0`, satisfying `^1.0.0`)

- [x] Task 5: Run build and test validation (AC: 7, 8)
  - [x] Run `pnpm build` — all packages build successfully (core, bls, relay pass; ui-prototypes pre-existing TS6133 failure)
  - [x] Run `pnpm test` — 1020 passed, 2 pre-existing failures (no regressions)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/9.3.story.md — Dev Agent Record]

Story 9.3 (Version Bump to 1.0.0) bumped all three publishable packages to `1.0.0`. Key insights:
- `pnpm build` passes for core, bls, relay. `ui-prototypes` build failure is pre-existing (TS6133 unused variable errors) and unrelated to this epic.
- `pnpm test`: 1020 passed, 2 failed — both failures are **pre-existing** (`SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` have `subscribeMany` call signature assertion mismatches unrelated to this epic).
- These pre-existing failures should be expected again in this story's validation.
- Story 9.3 explicitly deferred `workspace:*` → `^1.0.0` resolution to this story (9.4).

### Workspace Reference Resolution — Why This Works
[Source: docs/epics/epic-9-npm-package-publishing.md, pnpm workspace documentation]

**The problem:** `workspace:*` is a pnpm-specific protocol. When a package.json with `workspace:*` is published to npm, pnpm's `publish` command automatically replaces `workspace:*` with the resolved version. However, `npm pack` (used in Story 9.5) does NOT do this transformation. By switching to `^1.0.0` now, both `npm pack` and `pnpm publish` will produce correct tarballs.

**Why pnpm still works locally:** pnpm workspace resolution has a specific behavior: when a dependency version range (like `^1.0.0`) matches a local workspace package version, pnpm resolves it to the local workspace package rather than fetching from the registry. Since all three packages are now at `1.0.0` (from Story 9.3), `^1.0.0` will match and resolve locally. This means development and testing continue to work identically.

**Private packages keep `workspace:*`:** `@crosstown/examples` and `@crosstown/docker` are `"private": true` and will never be published. There is no reason to change their references — `workspace:*` is correct for private, workspace-only packages.

### Current Workspace References — Complete Inventory
[Source: packages/relay/package.json, packages/core/package.json, packages/examples/package.json, docker/package.json]

**Publishable packages (CHANGE these):**
| Package | Field | Current | Target |
|---------|-------|---------|--------|
| `packages/relay/package.json` | `dependencies["@crosstown/bls"]` | `workspace:*` | `^1.0.0` |
| `packages/relay/package.json` | `dependencies["@crosstown/core"]` | `workspace:*` | `^1.0.0` |
| `packages/core/package.json` | `devDependencies["@crosstown/relay"]` | `workspace:*` | `^1.0.0` |

**Private packages (DO NOT change):**
| Package | Field | Value | Reason |
|---------|-------|-------|--------|
| `packages/examples/package.json` | `dependencies["@crosstown/core"]` | `workspace:*` | `"private": true` — never published |
| `packages/examples/package.json` | `dependencies["@crosstown/relay"]` | `workspace:*` | `"private": true` — never published |
| `docker/package.json` | `dependencies["@crosstown/core"]` | `workspace:*` | `"private": true` — never published |
| `docker/package.json` | `dependencies["@crosstown/relay"]` | `workspace:*` | `"private": true` — never published |

### File Locations

Files to modify:
- `packages/relay/package.json` — Change 2 workspace references in `dependencies`
- `packages/core/package.json` — Change 1 workspace reference in `devDependencies`

Files NOT modified:
- `packages/bls/package.json` — Has no workspace references (standalone, no internal deps)
- `packages/examples/package.json` — Private, keeps `workspace:*`
- `docker/package.json` — Private, keeps `workspace:*`
- `package.json` (root) — No workspace references in dependencies
- All source files (`src/**`) — No code changes
- All test files — No test changes

### What NOT to Change
[Source: docs/epics/epic-9-npm-package-publishing.md]

- Package names — no changes
- Package versions — no changes (already `1.0.0` from Story 9.3)
- Public API surface — no exports added or removed
- Build system (tsup) — no changes
- Test suites — no changes
- Non-workspace dependencies or their versions — no changes
- Private package workspace references — no changes

### Technical Constraints

- **JSON-only changes:** This story only modifies the dependency version specifier in package.json files. No TypeScript code changes.
- **Exact change:** Only the version specifier changes from `"workspace:*"` to `"^1.0.0"` for 3 specific entries. No other fields are touched.
- **pnpm lockfile:** After changing version specifiers, `pnpm install` must be run to update `pnpm-lock.yaml`. The lockfile change is expected and correct.
- **Semantic versioning range:** `^1.0.0` means `>=1.0.0 <2.0.0` — this is the standard range for semver-compatible updates.

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **Test framework:** Vitest 1.x
- **No new tests required for this story** — dependency version specifier changes don't require unit tests
- **Validation:** Run `pnpm install`, `pnpm build`, and `pnpm test` to confirm no regressions
- **Expected results:** ~1020 tests pass, 2 pre-existing failures (same as Stories 9.1, 9.2, 9.3):
  - `SocialPeerDiscovery.test.ts` — `subscribeMany` call signature assertion mismatch
  - `RelayMonitor.test.ts` — `subscribeMany` call signature assertion mismatch

### Project Structure Notes
[Source: docs/architecture/9-source-tree.md]

No structural conflicts identified. The three publishable packages are:
```
packages/
├── core/     # @crosstown/core — change devDependencies
├── bls/      # @crosstown/bls — no workspace refs, no changes
├── relay/    # @crosstown/relay — change dependencies
└── examples/ # @crosstown/examples — private, no changes
docker/       # @crosstown/docker — private, no changes
```

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/relay/package.json` | Modified | Changed `@crosstown/bls` and `@crosstown/core` from `workspace:*` to `^1.0.0` |
| `packages/core/package.json` | Modified | Changed `@crosstown/relay` devDependency from `workspace:*` to `^1.0.0` |
| `pnpm-lock.yaml` | Modified | Lockfile updated by `pnpm install` after dependency version changes |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No issues encountered.

### Completion Notes
- All 5 tasks completed successfully
- 3 workspace references updated across 2 package.json files
- Private packages (`examples`, `docker`) verified unchanged
- `pnpm install` succeeded — `^1.0.0` resolves to local workspace packages
- `pnpm build` passes for all publishable packages (core, bls, relay); ui-prototypes build failure is pre-existing (TS6133)
- `pnpm test`: 1020 passed, 2 failed — both failures are pre-existing (`SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` `subscribeMany` call signature mismatches), same as Stories 9.1–9.3

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-11 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-11 | 1.0 | Implementation complete — all workspace refs resolved | Dev (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

This is a minimal, surgical change — exactly 3 version specifier edits in 2 package.json files plus a lockfile update. The implementation precisely matches the acceptance criteria with no unnecessary modifications.

The diff is clean: `packages/relay/package.json` has `@crosstown/bls` and `@crosstown/core` changed from `workspace:*` to `^1.0.0` in `dependencies`, and `packages/core/package.json` has `@crosstown/relay` changed from `workspace:*` to `^1.0.0` in `devDependencies`. No other fields were modified.

### Refactoring Performed

None required. The changes are JSON-only configuration edits with no code to refactor.

### Compliance Check

- Coding Standards: ✓ — No source code changes; package.json edits follow standard semver patterns
- Project Structure: ✓ — No structural changes; file locations unchanged
- Testing Strategy: ✓ — No new tests required for version specifier changes; validation via `pnpm install`, `pnpm build`, `pnpm test` all confirmed
- All ACs Met: ✓ — See detailed verification below

### AC Verification

| AC | Status | Evidence |
|----|--------|----------|
| 1. relay/package.json `@crosstown/bls`: `^1.0.0` | ✓ | Verified at line 39 |
| 2. relay/package.json `@crosstown/core`: `^1.0.0` | ✓ | Verified at line 40 |
| 3. core/package.json devDeps `@crosstown/relay`: `^1.0.0` | ✓ | Verified at line 45 |
| 4. Private packages retain `workspace:*` | ✓ | `examples/package.json` lines 26-27, `docker/package.json` lines 14-15 both confirmed `workspace:*` |
| 5. No source code changes | ✓ | `git diff --name-only` shows only `package.json` and `pnpm-lock.yaml` |
| 6. `pnpm install` succeeds | ✓ | Completed successfully; `^1.0.0` resolves to local workspace packages |
| 7. `pnpm build` succeeds | ✓ | core, bls, relay all build cleanly; ui-prototypes failure is pre-existing (TS6133) |
| 8. `pnpm test` passes, no regressions | ✓ | 1020 passed, 2 failed — both pre-existing (`SocialPeerDiscovery.test.ts`, `RelayMonitor.test.ts` subscribeMany signature mismatches) |

### Improvements Checklist

All items handled — no remaining work needed:

- [x] Verified all 3 workspace references correctly updated
- [x] Verified private packages unchanged
- [x] Verified `pnpm install` succeeds with local resolution
- [x] Verified all 3 publishable packages build successfully
- [x] Verified 1020 tests pass with only pre-existing failures

### Security Review

No security concerns. Changes are limited to dependency version specifiers in package.json files. No new dependencies introduced, no code changes, no API surface modifications.

### Performance Considerations

No performance impact. The `^1.0.0` semver range resolves identically to `workspace:*` within the pnpm workspace — both resolve to the local package. At publish time, `^1.0.0` correctly declares the version constraint for npm consumers.

### Files Modified During Review

None. No modifications were needed.

### Gate Status

Gate: PASS → docs/qa/gates/9.4-resolve-workspace-references.yml

### Recommended Status

✓ Ready for Done
