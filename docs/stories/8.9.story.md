# Story 8.9: Bootstrap Cleanup — Fulfillment Generation, Phase 4 Flow, Health Check

## Status

Done
## Story

**As a** node operator,
**I want** the BLS to stop generating unnecessary fulfillment values, the Phase 4 flow to be correctly documented, and the health check to report channel status,
**so that** the bootstrap system follows its design contracts and provides accurate observability.

## Acceptance Criteria

1. BLS `/handle-payment` handler no longer returns `fulfillment` field in HTTP responses (agent-runtime computes fulfillment, not BLS)
2. `HandlePaymentAcceptResponse` type updated to remove `fulfillment` field
3. `generateFulfillment()` function deprecated with `@deprecated` JSDoc (cannot be removed — used by `BusinessLogicServer` in relay/bls packages)
4. Phase 4 (RelayMonitor) flow documented: bootstrap node initiates reverse SPSP to newly discovered peers (current behavior), not peer-initiated as originally planned
5. Health endpoint includes `peerCount` and `channelCount` when bootstrap is complete
6. Unit tests verify fulfillment is not in BLS response
7. Health endpoint test verifies peer/channel counts

## Tasks / Subtasks

- [x] Task 1: Remove `fulfillment` from BLS `/handle-payment` responses (AC: 1, 2, 3)
  - [x] In `docker/src/entrypoint.ts`:
    - Remove `fulfillment: generateFulfillment(event.id)` from the SPSP response object (line 502)
    - Remove `fulfillment: generateFulfillment(event.id)` from the generic event storage response (line 546)
    - Keep `accept: true`, `metadata`, and `data` fields
  - [x] In `packages/relay/src/bls/types.ts` (line 55-63):
    - Remove the `fulfillment` field from `HandlePaymentAcceptResponse` interface
    - Remove the JSDoc comment for that field
  - [x] In `docker/src/entrypoint.ts`:
    - Remove the `generateFulfillment` import from `@agent-society/relay` (line 63)
  - [x] In `packages/relay/src/bls/BusinessLogicServer.ts` (line 21-24):
    - Add `@deprecated` JSDoc to `generateFulfillment()`: "Deprecated: agent-runtime computes fulfillment from SHA256(toon_bytes). BLS should not generate fulfillment."
    - Do NOT remove the function — it is still called at lines 140 and 206 within `BusinessLogicServer.handlePayment()`
    - Do NOT modify `packages/bls/src/bls/BusinessLogicServer.ts` — same function exists there and is also still in use

- [x] Task 2: Update health endpoint with peer/channel counts (AC: 5)
  - [x] In `docker/src/entrypoint.ts`, update `createBlsServer()` signature (line 334):
    - Add parameter: `getBootstrapCounts?: () => { peerCount: number; channelCount: number }`
  - [x] In `docker/src/entrypoint.ts`, health endpoint (line 346):
    - When `getBootstrapPhase` reports `'ready'` and `getBootstrapCounts` is provided:
      - Spread `getBootstrapCounts()` into the health response JSON
    - When bootstrap is not ready or `getBootstrapCounts` is not provided:
      - Omit `peerCount` and `channelCount`
  - [x] In `docker/src/entrypoint.ts`, `main()` function — wire up counters:
    - **Important: execution order.** The `createBlsServer()` call (line 671) runs before the bootstrap listener (line 722), but the getter is a closure that reads the counters lazily at request time, so declare the counters before both.
    - Add closure-scoped counters before the `createBlsServer()` call (before line 671):
      ```typescript
      let peerCount = 0;
      let channelCount = 0;
      ```
    - Pass `() => ({ peerCount, channelCount })` as the `getBootstrapCounts` argument to `createBlsServer()` (line 671)
    - In the existing event listener switch cases (line 722-746), add counter increments:
      - `case 'bootstrap:peer-registered':` add `peerCount++;`
      - `case 'bootstrap:channel-opened':` add `channelCount++;`

- [x] Task 3: Document Phase 4 flow inversion (AC: 4)
  - [x] In `docs/epics/epic-8-nostr-network-bootstrap.md`:
    - Add a note to Phase 3/Phase 4 section (after line 86) clarifying that:
      - The bootstrap node initiates reverse SPSP handshakes when it discovers new kind:10032 events on its relay
      - This is handled by `RelayMonitor` (Story 8.4)
      - The original plan had peers responding to announcements in the same FULFILL, but the current design uses a separate round-trip
      - Current design rationale: cleaner separation of concerns (relay monitoring vs SPSP handling), allows independent retry on handshake failure
    - Update flow diagram if present to match actual implementation

- [x] Task 4: Write unit tests for fulfillment removal (AC: 6)
  - [x] In `docker/src/entrypoint.test.ts`:
    - Test: BLS `/handle-payment` SPSP response does NOT contain `fulfillment` field
    - Test: BLS `/handle-payment` generic event response does NOT contain `fulfillment` field
    - Note: Existing tests mock `generateFulfillment` (lines 681 and 941 via `mockGenerateFulfillment.mockReturnValue(...)`) but do NOT assert on `fulfillment` in response bodies. These mock setups should be removed since `generateFulfillment` will no longer be called from entrypoint.

- [x] Task 5: Write unit test for health endpoint peer/channel counts (AC: 7)
  - [x] In `docker/src/entrypoint.test.ts`:
    - Test: health endpoint returns `peerCount` and `channelCount` when `getBootstrapPhase` returns `'ready'` and `getBootstrapCounts` is provided
    - Test: health endpoint omits `peerCount` and `channelCount` when `getBootstrapPhase` returns a non-ready phase (e.g., `'discovering'`)

- [x] Task 6: Run full test suite and lint
  - [x] Run `pnpm test` — all existing tests pass plus new tests
  - [x] Run `pnpm lint` — no new lint errors

## Dev Notes

### Integration Gaps Addressed
[Source: INTEGRATION-GAPS.md]

**Gap 7: BLS Generates Fulfillment (Should Be Removed) — MINOR**

Current code in `docker/src/entrypoint.ts`:
```typescript
fulfillment: generateFulfillment(event.id),
```

Per the Unified Deployment Plan:
- "Fulfillment = SHA256(toon_bytes). Computed by agent-runtime (not BLS)."
- "Remove fulfillment from responses" (Phase 2)

The BLS's fulfillment is returned in the HTTP response but agent-runtime ignores it and computes its own (`packet-handler.ts:79`). The BLS shouldn't compute fulfillment at all.

**Gap 10: RelayMonitor Inverts Phase 4 Flow — ARCHITECTURAL**

Expected flow (per plan): peer announces kind:10032 as paid ILP PREPARE -> bootstrap responds with SPSP in same FULFILL.

Actual flow: peer announces -> bootstrap reads relay -> bootstrap INITIATES paid SPSP -> peer responds. This requires an extra round-trip but is cleaner architecturally. Decision: document actual flow, don't change implementation.

**Gap 13: No Health Check for Bootstrap Phase — MINOR**

The health endpoint has `bootstrapPhase` but doesn't include `peerCount` or `channelCount`. Deploy scripts can't verify bootstrap completeness.

### Current Fulfillment Generation
[Source: packages/relay/src/bls/BusinessLogicServer.ts:21-24]

The `generateFulfillment()` function is defined in `packages/relay/src/bls/BusinessLogicServer.ts`:
```typescript
export function generateFulfillment(eventId: string): string {
  const hash = createHash('sha256').update(eventId).digest();
  return hash.toString('base64');
}
```

This function is imported and called at two points in `docker/src/entrypoint.ts` `/handle-payment`:
1. SPSP response (kind:23194 handler) — line 502
2. Generic event storage response — line 546

**Other callers (DO NOT remove function):**
- `packages/relay/src/bls/BusinessLogicServer.ts` lines 140, 206 — used within `handlePayment()` method
- `packages/bls/src/bls/BusinessLogicServer.ts` lines 140, 206 — duplicate package, same usage

Agent-runtime ignores the BLS fulfillment and computes: `SHA256(toon_bytes)` in `packet-handler.ts:79`.

### HandlePaymentAcceptResponse Type
[Source: packages/relay/src/bls/types.ts:55-63]

```typescript
export interface HandlePaymentAcceptResponse {
  accept: true;
  /** Base64-encoded fulfillment (SHA-256 of event.id) */
  fulfillment: string;
  metadata?: {
    eventId: string;
    storedAt: number;
  };
}
```

Remove the `fulfillment` field and its JSDoc from this interface. The type is also duplicated in `packages/bls/src/bls/types.ts:55-63` — that copy is NOT modified by this story (separate package, separate concern).

### Current Health Endpoint
[Source: docker/src/entrypoint.ts:346-355]

```typescript
app.get('/health', (c: Context) => {
  return c.json({
    status: 'healthy',
    nodeId: config.nodeId,
    pubkey: config.pubkey,
    ilpAddress: config.ilpAddress,
    timestamp: Date.now(),
    ...(getBootstrapPhase && { bootstrapPhase: getBootstrapPhase() }),
  });
});
```

Missing: `peerCount` and `channelCount` fields.

### Bootstrap Event Listener (Counter Location)
[Source: docker/src/entrypoint.ts:722-746]

The `main()` function already registers a `bootstrapService.on()` listener that handles `bootstrap:peer-registered` and `bootstrap:channel-opened` events (for logging). Add counter increments inside the existing switch cases rather than registering a second listener:

**Execution order:** `createBlsServer()` (line 671) runs before the bootstrap listener (line 722), but the getter is a closure read lazily at HTTP request time. Declare counters before both so the closure captures them.

```typescript
// Add before createBlsServer() call (before line 671):
let peerCount = 0;
let channelCount = 0;

// Pass getter to createBlsServer() at line 671:
// ..., () => ({ peerCount, channelCount })

// Inside existing case 'bootstrap:peer-registered' (line ~727):
peerCount++;

// Inside existing case 'bootstrap:channel-opened' (line ~730):
channelCount++;
```

### Existing Test Mocks
[Source: docker/src/entrypoint.test.ts]

The test file mocks `generateFulfillment` at the module level (line 16: `mockGenerateFulfillment: vi.fn()`) and sets return values in `beforeEach` blocks (lines 681, 941). After removing the `fulfillment` call from entrypoint.ts:

- The `mockGenerateFulfillment` hoisted mock can remain (it won't be called, which is harmless)
- Remove `mockGenerateFulfillment.mockReturnValue(...)` from `beforeEach` blocks (lines 681, 941) — these are dead setup
- No existing tests assert `body.fulfillment` in response bodies, so no test assertions need modification

### File Locations

Files to modify:
- `docker/src/entrypoint.ts` — Remove fulfillment from responses, add peer/channel counts to health
- `docker/src/entrypoint.test.ts` — Update tests, remove dead mock setup
- `packages/relay/src/bls/types.ts` — Remove `fulfillment` from `HandlePaymentAcceptResponse`
- `packages/relay/src/bls/BusinessLogicServer.ts` — Add `@deprecated` to `generateFulfillment()`
- `docs/epics/epic-8-nostr-network-bootstrap.md` — Document Phase 4 flow

Files NOT modified:
- `packages/core/src/bootstrap/` — No changes
- `packages/core/src/spsp/` — No changes
- `packages/bls/src/bls/types.ts` — Separate package; not modified in this story
- `packages/bls/src/bls/BusinessLogicServer.ts` — Separate package; not modified in this story

### Technical Constraints

**Removing `fulfillment` from entrypoint responses is safe:** Agent-runtime computes its own fulfillment from `SHA256(toon_bytes)`. The BLS-generated fulfillment in the HTTP response is ignored. Removing it has no functional impact.

**`generateFulfillment()` cannot be deleted:** It is still actively used by `BusinessLogicServer.handlePayment()` in both `packages/relay` and `packages/bls`. Only deprecate via JSDoc.

**Tracking peer/channel counts:** The entrypoint already listens to bootstrap events at line 722. Add closure-scoped counters (`peerCount`, `channelCount`) and increment them in the existing `bootstrap:peer-registered` and `bootstrap:channel-opened` switch cases. Pass a getter function to `createBlsServer()` so the health endpoint can read the counts.

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x
**Test File:** `docker/src/entrypoint.test.ts`

**Expected new test count:** 4 new tests
1. SPSP response has no `fulfillment` field
2. Generic event response has no `fulfillment` field
3. Health endpoint returns counts when bootstrap ready
4. Health endpoint omits counts when bootstrap not ready

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

No debug issues encountered. All 1022 tests passed on first run. Pre-existing lint error in `packages/bls/src/storage/createEventStore.test.ts` (not related to this story).

### Completion Notes List

- Removed `fulfillment: generateFulfillment(event.id)` from both SPSP and generic event responses in entrypoint.ts
- Removed `fulfillment` field and JSDoc from `HandlePaymentAcceptResponse` interface in relay types
- Removed `generateFulfillment` import from entrypoint.ts
- Added `@deprecated` JSDoc to `generateFulfillment()` in BusinessLogicServer.ts (function retained — still used internally)
- Added `getBootstrapCounts` parameter to `createBlsServer()` for lazy health endpoint counts
- Health endpoint spreads `peerCount`/`channelCount` only when `bootstrapPhase === 'ready'`
- Added closure-scoped counters in `main()` with increments in existing bootstrap event listener
- Documented Phase 4 flow inversion in epic-8 doc with rationale
- Removed dead `mockGenerateFulfillment.mockReturnValue()` calls from test beforeEach blocks
- Added 4 new tests: 2 for fulfillment absence, 2 for health endpoint counts

### File List

- `docker/src/entrypoint.ts` — Modified (removed fulfillment from responses, added health counts)
- `docker/src/entrypoint.test.ts` — Modified (removed dead mock setup, added 4 new tests)
- `packages/relay/src/bls/types.ts` — Modified (removed fulfillment from HandlePaymentAcceptResponse)
- `packages/relay/src/bls/BusinessLogicServer.ts` — Modified (added @deprecated to generateFulfillment)
- `docs/epics/epic-8-nostr-network-bootstrap.md` — Modified (documented Phase 4 flow inversion)

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is solid overall. The core changes — removing fulfillment from entrypoint responses, adding health endpoint counts, documenting Phase 4 flow — are correct and well-tested. One **critical build-breaking issue** was found and fixed during review: removing `fulfillment` from `HandlePaymentAcceptResponse` as a required field broke the `BusinessLogicServer` class in the relay package, which still uses it. The fix makes `fulfillment` optional with a `@deprecated` tag, preserving backward compatibility while signaling intent.

Code follows existing patterns well. The closure-based counter approach for health endpoint counts is clean and avoids shared mutable state across modules. The health endpoint correctly only reports counts when `bootstrapPhase === 'ready'`.

### Refactoring Performed

- **File**: `packages/relay/src/bls/types.ts`
  - **Change**: Made `fulfillment` field optional (`fulfillment?: string`) instead of fully removing it, added `@deprecated` JSDoc
  - **Why**: The original change (full removal) caused a TypeScript build error in `packages/relay/src/bls/BusinessLogicServer.ts` at lines 140-148 and 206-208, where `handlePayment()` returns objects with `fulfillment` property. The relay package `tsup build` failed with `TS2353: Object literal may only specify known properties, and 'fulfillment' does not exist in type 'HandlePaymentAcceptResponse'`.
  - **How**: Making the field optional satisfies both consumers: the entrypoint (which no longer sends it) and `BusinessLogicServer` (which still does). The `@deprecated` tag signals future removal intent consistent with AC 3's deprecation approach.

### Compliance Check

- Coding Standards: ✓ — kebab-case files, camelCase functions, PascalCase types, no `any` usage, ESLint passes cleanly
- Project Structure: ✓ — Co-located test files, proper package boundaries respected
- Testing Strategy: ✓ — 4 new tests added per spec, AAA pattern followed, all mocks use Vitest built-in, no live relay dependencies
- All ACs Met: ✓ — See traceability below

**AC Traceability:**

| AC | Status | Validation |
|----|--------|------------|
| 1. BLS `/handle-payment` no longer returns `fulfillment` | ✓ | `generateFulfillment` import removed from entrypoint.ts; response objects at lines 502-508 and 545-551 have no `fulfillment` |
| 2. `HandlePaymentAcceptResponse` type updated | ✓ | `fulfillment` changed to optional+deprecated in `packages/relay/src/bls/types.ts:57-58` (QA fix: was fully removed but broke relay build) |
| 3. `generateFulfillment()` deprecated with JSDoc | ✓ | `@deprecated` tag added at `packages/relay/src/bls/BusinessLogicServer.ts:21-22` |
| 4. Phase 4 flow documented | ✓ | "Phase 4 Implementation Note" section added to `docs/epics/epic-8-nostr-network-bootstrap.md:88-101` |
| 5. Health endpoint includes `peerCount`/`channelCount` | ✓ | `getBootstrapCounts` parameter added to `createBlsServer()`; health endpoint spreads counts when `bootstrapPhase === 'ready'` |
| 6. Unit tests verify fulfillment not in response | ✓ | Tests "SPSP response does NOT contain fulfillment field" and "generic event response does NOT contain fulfillment field" in entrypoint.test.ts |
| 7. Health endpoint test verifies counts | ✓ | Tests "returns peerCount and channelCount when bootstrap phase is ready" and "omits peerCount and channelCount when bootstrap phase is not ready" |

### Improvements Checklist

- [x] Fixed build-breaking type error in `HandlePaymentAcceptResponse` — made `fulfillment` optional instead of removing it entirely (packages/relay/src/bls/types.ts)
- [ ] Consider adding a test that verifies `BusinessLogicServer.handlePayment()` still includes `fulfillment` in its responses (ensures the deprecated path works until intentionally removed)
- [ ] In a future story, fully remove `fulfillment` from `BusinessLogicServer.handlePayment()` and the `HandlePaymentAcceptResponse` type (requires updating all callers in both relay and bls packages)

### Security Review

No security concerns. The fulfillment removal is safe because agent-runtime already computes its own fulfillment from `SHA256(toon_bytes)` and ignores the BLS value. The health endpoint enhancement only adds operational counts — no sensitive data exposed.

### Performance Considerations

No performance concerns. The closure-based counters are O(1) reads. The health endpoint change adds negligible overhead (one string comparison + one function call).

### Files Modified During Review

- `packages/relay/src/bls/types.ts` — Changed `fulfillment` from removed to optional+deprecated (build fix)

Dev should update the File List to include this modification.

### Gate Status

Gate: PASS → docs/qa/gates/8.9-bootstrap-cleanup-fulfillment-phase4-health.yml
Risk profile: Low — cleanup story, no new features, limited blast radius
NFR assessment: All pass — no security/performance/reliability concerns

### Recommended Status

✓ Ready for Done — All ACs met, all tests passing (52 docker + 50 relay BLS), lint clean, build-breaking type error fixed during review.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft from INTEGRATION-GAPS.md (Gaps 7, 10, 13) | PO (Claude Opus 4.6) |
| 2026-02-09 | 0.2 | Validation fixes: corrected line numbers, added exact file paths for type/function definitions, added missing template sections, specified other callers of generateFulfillment, added counter implementation details, clarified existing test mock state | QA (Claude Opus 4.6) |
| 2026-02-09 | 0.3 | Clarified Task 2 counter declaration ordering — counters must be declared before createBlsServer() call since the getter is a lazy closure | QA (Claude Opus 4.6) |
| 2026-02-09 | 1.0 | Implementation complete — all 6 tasks done, 4 new tests added, 1022 tests passing | Dev (Claude Opus 4.6) |
