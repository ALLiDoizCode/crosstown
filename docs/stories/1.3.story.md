# Story 1.3: Event Parser and Builder Utilities

## Status

Done

## Story

**As a** library consumer,
**I want** utilities to parse Nostr events into typed objects and build events from typed data,
**so that** I don't have to manually handle event serialization.

## Acceptance Criteria

1. `parseIlpPeerInfo(event: NostrEvent): IlpPeerInfo` parses kind:10032 events
2. `buildIlpPeerInfoEvent(info: IlpPeerInfo, secretKey): NostrEvent` creates signed kind:10032 events
3. `parseSpspInfo(event: NostrEvent): SpspInfo` parses kind:10047 events
4. `buildSpspInfoEvent(info: SpspInfo, secretKey): NostrEvent` creates signed kind:10047 events
5. Parsers throw descriptive errors for malformed events
6. Unit tests cover valid parsing, error cases, and round-trip (build → parse)

## Tasks / Subtasks

- [x] Task 1: Create events directory structure (AC: 1-4)
  - [x] Create `packages/core/src/events/` directory
  - [x] Create `packages/core/src/events/index.ts` for module exports

- [x] Task 2: Create custom error class for parsing errors (AC: 5)
  - [x] Create `packages/core/src/errors.ts`
  - [x] Define `CrosstownError` base class extending Error with `code` and `cause` properties
  - [x] Define `InvalidEventError` extending `CrosstownError` for parsing failures
  - [x] Export error classes from `packages/core/src/index.ts`

- [x] Task 3: Create parsers module (AC: 1, 3, 5)
  - [x] Create `packages/core/src/events/parsers.ts`
  - [x] Implement `parseIlpPeerInfo(event: NostrEvent): IlpPeerInfo`
    - Validate event kind is 10032
    - Parse JSON content
    - Validate required fields (ilpAddress, btpEndpoint, assetCode, assetScale)
    - Return typed IlpPeerInfo object
    - Throw InvalidEventError with descriptive message for failures
  - [x] Implement `parseSpspInfo(event: NostrEvent): SpspInfo`
    - Validate event kind is 10047
    - Parse JSON content
    - Validate required fields (destinationAccount, sharedSecret)
    - Return typed SpspInfo object
    - Throw InvalidEventError with descriptive message for failures

- [x] Task 4: Create builders module (AC: 2, 4)
  - [x] Create `packages/core/src/events/builders.ts`
  - [x] Implement `buildIlpPeerInfoEvent(info: IlpPeerInfo, secretKey: Uint8Array): NostrEvent`
    - Create event with kind 10032
    - Serialize IlpPeerInfo to JSON content
    - Set created_at to current Unix timestamp
    - Sign event using nostr-tools `finalizeEvent()`
    - Return complete signed NostrEvent
  - [x] Implement `buildSpspInfoEvent(info: SpspInfo, secretKey: Uint8Array): NostrEvent`
    - Create event with kind 10047
    - Serialize SpspInfo to JSON content
    - Set created_at to current Unix timestamp
    - Sign event using nostr-tools `finalizeEvent()`
    - Return complete signed NostrEvent

- [x] Task 5: Export from events module and package index (AC: 1-4)
  - [x] Export all parsers and builders from `packages/core/src/events/index.ts`
  - [x] Update `packages/core/src/index.ts` to re-export from events module

- [x] Task 6: Write parser unit tests (AC: 5, 6)
  - [x] Create `packages/core/src/events/parsers.test.ts`
  - [x] Test parseIlpPeerInfo with valid event returns correct IlpPeerInfo
  - [x] Test parseIlpPeerInfo throws for wrong event kind
  - [x] Test parseIlpPeerInfo throws for invalid JSON content
  - [x] Test parseIlpPeerInfo throws for missing required fields
  - [x] Test parseSpspInfo with valid event returns correct SpspInfo
  - [x] Test parseSpspInfo throws for wrong event kind
  - [x] Test parseSpspInfo throws for invalid JSON content
  - [x] Test parseSpspInfo throws for missing required fields

- [x] Task 7: Write builder unit tests (AC: 6)
  - [x] Create `packages/core/src/events/builders.test.ts`
  - [x] Test buildIlpPeerInfoEvent creates valid signed event with kind 10032
  - [x] Test buildIlpPeerInfoEvent content contains correct serialized IlpPeerInfo
  - [x] Test buildSpspInfoEvent creates valid signed event with kind 10047
  - [x] Test buildSpspInfoEvent content contains correct serialized SpspInfo
  - [x] Test signature verification using nostr-tools `verifyEvent()`

- [x] Task 8: Write round-trip tests in `builders.test.ts` (AC: 6)
  - [x] Test build → parse round-trip for IlpPeerInfo preserves all data
  - [x] Test build → parse round-trip for SpspInfo preserves all data

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.2.story.md#dev-agent-record]

- All 4 event kind constants are defined in `packages/core/src/constants.ts`:
  - `ILP_PEER_INFO_KIND = 10032`
  - `SPSP_INFO_KIND = 10047`
  - `SPSP_REQUEST_KIND = 23194`
  - `SPSP_RESPONSE_KIND = 23195`
- All 4 TypeScript interfaces are defined in `packages/core/src/types.ts`:
  - `IlpPeerInfo`, `SpspInfo`, `SpspRequest`, `SpspResponse`
- Package exports are properly configured in `packages/core/src/index.ts`
- Uses ESM (`"type": "module"`) - use `.js` extension in imports
- TypeScript strict mode is enabled

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create for this story:
```
packages/core/src/
├── errors.ts                    # Custom error classes (new)
├── events/
│   ├── index.ts                 # Module exports (new)
│   ├── parsers.ts               # Parse functions (new)
│   ├── parsers.test.ts          # Parser tests (new)
│   ├── builders.ts              # Build functions (new)
│   └── builders.test.ts         # Builder tests (new)
└── index.ts                     # Package exports (update existing)
```

### Data Models
[Source: docs/architecture/4-data-models.md]

**IlpPeerInfo** (kind:10032):
- `ilpAddress`: string - ILP address of the peer's connector
- `btpEndpoint`: string - BTP WebSocket endpoint URL
- `settlementEngine`: string | undefined - Settlement engine identifier
- `assetCode`: string - Asset code (e.g., "USD", "XRP")
- `assetScale`: number - Asset scale (decimal places)

**SpspInfo** (kind:10047):
- `destinationAccount`: string - ILP address to send payment to
- `sharedSecret`: string - Base64-encoded shared secret for STREAM

**NostrEvent (from nostr-tools)**:
- `id`: string - Event hash
- `pubkey`: string - Author public key
- `kind`: number - Event kind
- `content`: string - Event content (JSON for ILP events)
- `tags`: string[][] - Event tags
- `created_at`: number - Unix timestamp
- `sig`: string - Schnorr signature

### Event Content Format
[Source: CLAUDE.md#event-kinds-proposed-nips]

Events store ILP data as JSON in the `content` field:
- kind:10032 content: `{"ilpAddress":"...","btpEndpoint":"...","assetCode":"...","assetScale":9}`
- kind:10047 content: `{"destinationAccount":"...","sharedSecret":"..."}`

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

Error class pattern:
```typescript
class CrosstownError extends Error {
  constructor(
    message: string,
    public code: string,
    public cause?: Error
  ) {
    super(message);
    this.name = 'CrosstownError';
  }
}

class InvalidEventError extends CrosstownError {
  constructor(message: string, cause?: Error) {
    super(message, 'INVALID_EVENT', cause);
    this.name = 'InvalidEventError';
  }
}
```

Error codes to use:
- `INVALID_EVENT` - For malformed events, wrong kind, invalid JSON, missing fields

### nostr-tools Usage
[Source: docs/architecture/3-tech-stack.md, docs/architecture/12-coding-standards.md]

**Key nostr-tools functions for this story:**

1. **Event building with `finalizeEvent()`**:
```typescript
import { finalizeEvent } from 'nostr-tools/pure';

const event = finalizeEvent({
  kind: 10032,
  content: JSON.stringify(ilpPeerInfo),
  tags: [],
  created_at: Math.floor(Date.now() / 1000),
}, secretKey);
```

2. **Event verification with `verifyEvent()`**:
```typescript
import { verifyEvent } from 'nostr-tools/pure';

const isValid = verifyEvent(event); // Returns boolean
```

3. **Type imports**:
```typescript
import type { NostrEvent, EventTemplate } from 'nostr-tools/pure';
// Or from 'nostr-tools' if using full bundle
```

**Critical Rules:**
- Use nostr-tools types - don't redefine NostrEvent
- Signature verification is NOT in scope for parsers - parsers only validate event kind and JSON content structure. Signature verification is deferred to consuming code (e.g., discovery/SPSP modules) which will call `verifyEvent()` before parsing.

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case | `parsers.ts`, `builders.ts` |
| Functions | camelCase | `parseIlpPeerInfo`, `buildSpspInfoEvent` |
| Interfaces | PascalCase | `IlpPeerInfo`, `SpspInfo` |
| Constants | UPPER_SNAKE_CASE | `ILP_PEER_INFO_KIND` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards instead
- Export from index.ts - all public APIs exported from package index
- Use nostr-tools types - don't redefine Nostr event types

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**File Convention:** `*.test.ts` co-located with source files

**Location:** Same directory as source file:
- `packages/core/src/events/parsers.test.ts`
- `packages/core/src/events/builders.test.ts`

**Test Requirements:**
- Follow AAA pattern (Arrange, Act, Assert)
- All public exports have tests
- Edge cases and error conditions covered
- >80% coverage for public APIs

**Test Data Strategy:**
- Use factory functions for test fixtures
- Create helper to generate valid test events
- Use nostr-tools to generate real keypairs for signing

**Example test structure:**
```typescript
import { describe, it, expect } from 'vitest';
import { generateSecretKey, getPublicKey } from 'nostr-tools/pure';

describe('parseIlpPeerInfo', () => {
  it('parses valid kind:10032 event', () => {
    // Arrange
    const secretKey = generateSecretKey();
    const event = createTestIlpPeerInfoEvent(secretKey);

    // Act
    const result = parseIlpPeerInfo(event);

    // Assert
    expect(result.ilpAddress).toBe('g.example.connector');
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story draft | SM |
| 2026-02-05 | 0.2 | Clarified signature verification scope and round-trip test location | SM |
| 2026-02-05 | 1.0 | Implementation complete - all tasks done, tests passing | Dev Agent |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no blocking issues encountered during implementation.

### Completion Notes List

- All 4 event functions implemented: `parseIlpPeerInfo`, `parseSpspInfo`, `buildIlpPeerInfoEvent`, `buildSpspInfoEvent`
- Used ES2022 Error cause pattern for error chaining
- Parser functions validate: event kind, JSON parsing, required fields, optional field types
- Builder functions use `nostr-tools/pure` `finalizeEvent()` for signing
- 29 new tests added (19 parser tests, 10 builder tests including 3 round-trip tests)
- All tests pass (49 total in core package)
- Build and lint pass

### File List

| File | Status | Description |
|------|--------|-------------|
| `packages/core/src/errors.ts` | New | CrosstownError base class and InvalidEventError |
| `packages/core/src/events/index.ts` | New | Events module exports |
| `packages/core/src/events/parsers.ts` | New | parseIlpPeerInfo and parseSpspInfo functions |
| `packages/core/src/events/builders.ts` | New | buildIlpPeerInfoEvent and buildSpspInfoEvent functions |
| `packages/core/src/events/parsers.test.ts` | New | 19 parser unit tests |
| `packages/core/src/events/builders.test.ts` | New | 10 builder unit tests including round-trips |
| `packages/core/src/index.ts` | Modified | Added exports for errors and events modules |

---

## QA Results

### Review Date: 2026-02-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The event parser and builder utilities are well-designed with clean separation of concerns, proper type safety, and comprehensive error handling. Key observations:

- **Error handling**: Uses ES2022 error cause chaining pattern correctly. `InvalidEventError` provides descriptive messages for all failure modes.
- **Type safety**: Uses `unknown` with type guards (no `any`). The `isObject` type guard is well-implemented.
- **Code organization**: Clean module structure with parsers and builders in separate files, re-exported through index.
- **nostr-tools integration**: Correctly uses `finalizeEvent` from `nostr-tools/pure` and properly imports types.

### Refactoring Performed

None required. The implementation is clean and follows project standards.

### Compliance Check

- Coding Standards: ✓ Follows naming conventions, no `any` usage, exports from index
- Project Structure: ✓ Files in correct locations, co-located tests
- Testing Strategy: ✓ AAA pattern, factory functions for fixtures, comprehensive coverage
- All ACs Met: ✓ All 6 acceptance criteria fully implemented

### Improvements Checklist

All items pass - no changes required.

- [x] Parser validates event kind
- [x] Parser validates JSON structure
- [x] Parser validates required fields with descriptive errors
- [x] Parser validates optional field types
- [x] Builder creates properly signed events
- [x] Round-trip tests verify data preservation
- [x] Error class follows project pattern with cause chaining

### Security Review

No security concerns. This story implements data parsing/serialization with no network operations, authentication, or sensitive data handling. The parsers properly validate all inputs before constructing typed objects.

### Performance Considerations

No concerns. Functions are simple JSON parsing/serialization operations. No loops, recursion, or heavy computation.

### Files Modified During Review

None - no refactoring performed.

### Test Coverage Analysis

| Module | Tests | Coverage |
|--------|-------|----------|
| `parsers.ts` | 19 tests | Complete - all public functions and error paths |
| `builders.ts` | 10 tests | Complete - includes 3 round-trip tests |

**Requirements Traceability:**

| AC | Test Coverage |
|----|---------------|
| AC1: `parseIlpPeerInfo` | ✓ 11 tests (valid, errors, edge cases) |
| AC2: `buildIlpPeerInfoEvent` | ✓ 4 tests (structure, content, signature) |
| AC3: `parseSpspInfo` | ✓ 8 tests (valid, errors, edge cases) |
| AC4: `buildSpspInfoEvent` | ✓ 3 tests (structure, content, signature) |
| AC5: Descriptive errors | ✓ Tests verify error messages for all failure modes |
| AC6: Unit tests with round-trip | ✓ 3 round-trip tests confirming data preservation |

### Gate Status

Gate: PASS → docs/qa/gates/1.3-event-parser-and-builder-utilities.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria met, tests passing (49 total in core package), lint clean, implementation follows project standards.
