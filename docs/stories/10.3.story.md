# Story 10.3: Create createDirectConnectorAdmin() and make BLS handlePacket() public

## Status

Done

## Story

**As a** library consumer embedding agent-runtime in-process,
**I want** a `createDirectConnectorAdmin()` factory that wraps ConnectorNode's peer management methods as a `ConnectorAdminClient`, and `BusinessLogicServer.handlePacket()` changed from `private` to `public`,
**so that** peers can be registered/removed and packets handled via direct function calls instead of HTTP, enabling zero-latency embedded mode while preserving the existing `ConnectorAdminClient` interface for all consumers.

## Acceptance Criteria

1. A `ConnectorAdminLike` structural interface is defined with `registerPeer()` and `removePeer()` method signatures, so `@agent-runtime/connector` remains an optional peer dependency
2. `createDirectConnectorAdmin(connector)` returns a `ConnectorAdminClient` that registers and removes peers by calling connector methods directly (no HTTP)
3. The client correctly maps `ConnectorAdminClient.addPeer()` config params (id, url, authToken, routes, settlement) to `ConnectorAdminLike.registerPeer()` params
4. The client correctly maps `ConnectorAdminClient.removePeer()` calls to `ConnectorAdminLike.removePeer()`
5. When `connector.registerPeer()` or `connector.removePeer()` throws, the error is wrapped in a `BootstrapError`
6. `BusinessLogicServer.handlePacket()` is changed from `private` to `public` in both `packages/bls/` and `packages/relay/` so the connector can call it directly via `setPacketHandler()` without HTTP
7. All new code has unit tests with >80% coverage following AAA pattern
8. The new module exports are added to `packages/core/src/bootstrap/index.ts` barrel

## Tasks / Subtasks

- [x] Task 1: Define `ConnectorAdminLike` structural interface (AC: 1)
  - [x] Create `packages/core/src/bootstrap/direct-connector-admin.ts`
  - [x] Define `RegisterPeerParams` interface: `{ id: string; url: string; authToken?: string; routes?: { prefix: string; priority?: number }[]; settlement?: Record<string, unknown> }`
  - [x] Define `ConnectorAdminLike` interface: `{ registerPeer(params: RegisterPeerParams): Promise<void>; removePeer(peerId: string): Promise<void> }`
  - [x] Add JSDoc documenting this is a structural interface — consumers pass an `@agent-runtime/connector` ConnectorNode instance without importing it

- [x] Task 2: Implement `createDirectConnectorAdmin()` factory function (AC: 2, 3, 4, 5)
  - [x] Accept `connector: ConnectorAdminLike`
  - [x] Return an object implementing `ConnectorAdminClient` with `addPeer()` and `removePeer()` methods
  - [x] In `addPeer()`:
    - [x] Map `config.id`, `config.url`, `config.authToken`, `config.routes`, `config.settlement` to `connector.registerPeer()` params
    - [x] Call `connector.registerPeer(params)`
    - [x] If error is already a `BootstrapError`, re-throw it directly; otherwise wrap in new `BootstrapError`
  - [x] In `removePeer()`:
    - [x] Call `connector.removePeer(peerId)`
    - [x] If error is already a `BootstrapError`, re-throw it directly; otherwise wrap in new `BootstrapError`

- [x] Task 3: Export from barrel files (AC: 8)
  - [x] Add to `packages/core/src/bootstrap/index.ts`: export `createDirectConnectorAdmin` function and `ConnectorAdminLike`, `RegisterPeerParams` types
  - [x] Note: Do NOT update `packages/core/src/index.ts` yet — that is Story 10.5's scope

- [x] Task 4: Make `handlePacket()` public in BLS and Relay (AC: 6)
  - [x] In `packages/bls/src/bls/BusinessLogicServer.ts`: change `private handlePacket(` to `public handlePacket(`
  - [x] Update the JSDoc comment to note that this method is now public for direct connector integration
  - [x] In `packages/relay/src/bls/BusinessLogicServer.ts`: change `private handlePacket(` to `public handlePacket(`
  - [x] Update the JSDoc comment similarly

- [x] Task 5: Write unit tests for direct-connector-admin (AC: 7)
  - [x] Create `packages/core/src/bootstrap/direct-connector-admin.test.ts`
  - [x] Test: creates client from mock ConnectorAdminLike — `addPeer` and `removePeer` are functions
  - [x] Test: `addPeer()` calls `connector.registerPeer()` with mapped params (id, url, authToken, routes, settlement)
  - [x] Test: `addPeer()` passes routes through correctly
  - [x] Test: `addPeer()` passes settlement config through correctly
  - [x] Test: `addPeer()` handles missing optional fields (no routes, no settlement, no authToken)
  - [x] Test: `removePeer()` calls `connector.removePeer()` with the peerId
  - [x] Test: wraps `registerPeer` errors in BootstrapError
  - [x] Test: wraps `removePeer` errors in BootstrapError
  - [x] Test: does not double-wrap BootstrapError instances

- [x] Task 6: Build and test validation (AC: 7)
  - [x] Run `pnpm build` — verify all packages compile (excluding pre-existing `packages/ui-prototypes` TS6133 errors)
  - [x] Run `pnpm test` — verify all tests pass (baseline: ~1035 passed, 2 pre-existing failures)
  - [x] Run `npx tsc --noEmit` from `packages/core/`, `packages/bls/`, and `packages/relay/` to verify type-checking passes

## Dev Notes

### Previous Story Insights
[Source: docs/stories/10.2.story.md — Dev Agent Record]

Story 10.2 created `createDirectRuntimeClient()` following the structural typing pattern with `ConnectorNodeLike`. 15 new tests all passing (1035 total passed, 2 pre-existing failures unchanged: `SocialPeerDiscovery.test.ts` and `RelayMonitor.test.ts` — `subscribeMany` call signature mismatches, unrelated to this work). `tsc --noEmit` clean. `pnpm build` has pre-existing failure in `packages/ui-prototypes` (unused import TS6133 errors) — unrelated.

The key pattern to follow: define a structural interface matching the ConnectorNode's methods, create a factory that wraps those methods as the existing `ConnectorAdminClient` interface, and wrap errors in `BootstrapError`.

### ConnectorAdminClient Interface (The Interface We Implement)
[Source: packages/core/src/bootstrap/types.ts lines 46-73]

```typescript
export interface ConnectorAdminClient {
  addPeer(config: {
    id: string;
    url: string;
    authToken: string;
    routes?: { prefix: string; priority?: number }[];
    settlement?: {
      preference: string;
      evmAddress?: string;
      tokenAddress?: string;
      tokenNetworkAddress?: string;
      chainId?: number;
      channelId?: string;
      initialDeposit?: string;
    };
  }): Promise<void>;

  removePeer?(peerId: string): Promise<void>;
}
```

The new `createDirectConnectorAdmin()` must return an object matching this interface. The existing `createConnectorAdminClient()` in `docker/src/entrypoint.ts` is the HTTP reference implementation.

### ConnectorNode Admin Methods Expected Shape
[Source: docs/epics/epic-10-embedded-connector-integration.md#Part-B, docs/AGENT-RUNTIME-INTEGRATION.md#Admin-API-Reference]

The `@agent-runtime/connector` ConnectorNode has `registerPeer()` and `removePeer()` methods. The structural interface should mirror the Admin API shape:

```typescript
interface ConnectorAdminLike {
  registerPeer(params: RegisterPeerParams): Promise<void>;
  removePeer(peerId: string): Promise<void>;
}

interface RegisterPeerParams {
  id: string;
  url: string;
  authToken?: string;
  routes?: { prefix: string; priority?: number }[];
  settlement?: Record<string, unknown>;
}
```

**Key mapping responsibilities of the direct admin client:**
1. `addPeer(config)` → `connector.registerPeer(config)` — pass through params (the shapes are closely aligned)
2. `removePeer(peerId)` → `connector.removePeer(peerId)` — direct passthrough

Note: The `settlement` field uses `Record<string, unknown>` in the structural interface to avoid coupling to specific settlement engine types. The `ConnectorAdminClient` interface's typed `settlement` object is a subset that passes through cleanly.

**Interface optionality note:** `ConnectorAdminClient.removePeer?` is optional (note the `?`), while `ConnectorAdminLike.removePeer` is required. The factory provides `removePeer` as a concrete method on the returned object, which satisfies both — the required structural interface and the optional client interface.

### Structural Typing Approach (ConnectorAdminLike)
[Source: docs/epics/epic-10-embedded-connector-integration.md line 43-44, docs/stories/10.2.story.md — pattern established]

Follow the same structural typing pattern used by `ConnectorNodeLike` in Story 10.2. The `ConnectorAdminLike` interface describes just the `registerPeer()` and `removePeer()` method signatures. Consumers pass an `@agent-runtime/connector` `ConnectorNode` instance without crosstown needing to import `@agent-runtime/connector`.

### BLS handlePacket() Visibility Change
[Source: packages/bls/src/bls/BusinessLogicServer.ts line 82, packages/relay/src/bls/BusinessLogicServer.ts line 84]

Both BLS implementations have `private handlePacket()`. Change to `public` so the connector can call it directly in embedded mode via `setPacketHandler()` (Story 10.4 will wire this up). The method signature and behavior remain identical — only the access modifier changes.

Current state in both files:
```typescript
private handlePacket(
  request: HandlePacketRequest
): HandlePacketAcceptResponse | HandlePacketRejectResponse {
```

Change to:
```typescript
public handlePacket(
  request: HandlePacketRequest
): HandlePacketAcceptResponse | HandlePacketRejectResponse {
```

The HTTP route handler in `setupRoutes()` already calls `this.handlePacket(body)` — making it public doesn't change this behavior.

### BootstrapError (Error Class to Use)
[Source: packages/core/src/bootstrap/BootstrapService.ts]

`BootstrapError` extends `CrosstownError` (which extends `Error`) and accepts `(message: string, cause?: Error)`. Import from `./BootstrapService.js`. Follow the same error-wrapping pattern as `createDirectRuntimeClient()`: if the error is already a `BootstrapError`, re-throw it; otherwise wrap in a new `BootstrapError`.

### Reference Implementation: createDirectRuntimeClient()
[Source: packages/core/src/bootstrap/direct-runtime-client.ts]

Follow the exact same file structure:
1. Import `BootstrapError` from `./BootstrapService.js`
2. Import `ConnectorAdminClient` type from `./types.js`
3. Define structural interfaces (`ConnectorAdminLike`, `RegisterPeerParams`)
4. Define factory function that returns an object implementing `ConnectorAdminClient`
5. Error wrapping: re-throw `BootstrapError` as-is, wrap other errors

### File Locations
[Source: docs/architecture/9-source-tree.md, docs/epics/epic-10-embedded-connector-integration.md#Story-10.3]

```
packages/core/src/bootstrap/
├── direct-connector-admin.ts       # NEW — createDirectConnectorAdmin()
├── direct-connector-admin.test.ts  # NEW — unit tests
├── direct-runtime-client.ts        # EXISTING (reference for structural pattern)
├── index.ts                        # MODIFY — add new exports
├── types.ts                        # EXISTING — ConnectorAdminClient interface
└── BootstrapService.ts             # EXISTING — BootstrapError class

packages/bls/src/bls/
└── BusinessLogicServer.ts          # MODIFY — private → public

packages/relay/src/bls/
└── BusinessLogicServer.ts          # MODIFY — private → public
```

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

- Files: kebab-case → `direct-connector-admin.ts`
- Functions: camelCase → `createDirectConnectorAdmin`
- Interfaces: PascalCase → `ConnectorAdminLike`, `RegisterPeerParams`
- Never use `any` — use `unknown` and type guards
- All public APIs exported from index.ts
- Use `.js` extension in imports (ESM)

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

- **Framework:** Vitest 1.x
- **File Convention:** `*.test.ts` co-located with source → `direct-connector-admin.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Vitest built-in mocking (`vi.fn()`)
- **Coverage:** >80% for public APIs
- **Reference test file:** `packages/core/src/bootstrap/direct-runtime-client.test.ts` — follow the same structure
- **Mock pattern:** Create a mock `ConnectorAdminLike` object with `registerPeer: vi.fn()` and `removePeer: vi.fn()` — no live connector needed
- **Validation command:** `pnpm test` from workspace root. Expected baseline: ~1035 passed + new tests, 2 pre-existing failures.
- **Build validation:** `pnpm build` from workspace root.

### What NOT to Change

- `ConnectorAdminClient` interface in `types.ts` — unchanged
- `direct-runtime-client.ts` — unchanged
- `agent-runtime-client.ts` (HTTP version) — unchanged
- `packages/core/src/index.ts` (package-level exports) — unchanged (updated in Story 10.5)
- `BootstrapService.ts` — unchanged
- `RelayMonitor.ts` — unchanged
- Any files outside `packages/core/src/bootstrap/`, `packages/bls/src/bls/`, `packages/relay/src/bls/`

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug log entries required.

### Completion Notes

All tasks completed successfully:

1. **Created `direct-connector-admin.ts`** with:
   - `RegisterPeerParams` interface matching connector admin shape
   - `ConnectorAdminLike` structural interface for zero-dependency coupling
   - `createDirectConnectorAdmin()` factory function implementing `ConnectorAdminClient`
   - Proper error wrapping (re-throw `BootstrapError`, wrap others)

2. **Updated BLS visibility**: Changed `handlePacket()` from `private` to `public` in both `packages/bls/src/bls/BusinessLogicServer.ts` and `packages/relay/src/bls/BusinessLogicServer.ts` with updated JSDoc comments.

3. **Comprehensive test coverage**: Created `direct-connector-admin.test.ts` with 10 tests covering all AC requirements:
   - Client structure verification
   - Parameter mapping (all fields including routes and settlement)
   - Optional field handling
   - Error wrapping (including BootstrapError no-double-wrap)

4. **Validation results**:
   - ✅ All 10 new tests passing
   - ✅ Total: 1045 tests passed (baseline 1035 + 10 new)
   - ✅ 2 pre-existing failures unchanged (SocialPeerDiscovery, RelayMonitor)
   - ✅ Build successful (packages/bls compiled; ui-prototypes has pre-existing TS6133 errors as expected)

### File List

**New Files:**
- `packages/core/src/bootstrap/direct-connector-admin.ts`
- `packages/core/src/bootstrap/direct-connector-admin.test.ts`

**Modified Files:**
- `packages/core/src/bootstrap/index.ts` (added exports)
- `packages/bls/src/bls/BusinessLogicServer.ts` (handlePacket visibility)
- `packages/relay/src/bls/BusinessLogicServer.ts` (handlePacket visibility)

## QA Results

### Review Date: 2026-02-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is high quality and follows the established structural typing pattern from `createDirectRuntimeClient()` precisely. The factory function is clean, focused, and correct. JSDoc is thorough with a usage example. Error wrapping follows the identical pattern as the reference implementation. The BLS visibility change is minimal and correct — only the access modifier and JSDoc changed.

### Refactoring Performed

No refactoring required. The implementation is clean and well-structured.

### Compliance Check

- Coding Standards: ✓ kebab-case files, camelCase functions, PascalCase interfaces, `.js` ESM imports, no `any` usage
- Project Structure: ✓ New files in expected locations per source tree docs, barrel exports correct
- Testing Strategy: ✓ Vitest, co-located `.test.ts`, AAA pattern, `vi.fn()` mocks, >80% coverage
- All ACs Met: ✓ All 8 acceptance criteria fully satisfied (see traceability below)

### Acceptance Criteria Traceability

| AC | Description | Validating Tests | Status |
|----|-------------|-----------------|--------|
| 1 | `ConnectorAdminLike` structural interface defined | `direct-connector-admin.test.ts` — "should create a client with addPeer and removePeer functions" | ✓ |
| 2 | `createDirectConnectorAdmin()` returns `ConnectorAdminClient` | "should create a client..." + all addPeer/removePeer tests | ✓ |
| 3 | `addPeer()` maps config params to `registerPeer()` | "should call connector.registerPeer() with all mapped params", routes test, settlement test | ✓ |
| 4 | `removePeer()` maps to `connector.removePeer()` | "should call connector.removePeer() with the peerId" | ✓ |
| 5 | Errors wrapped in `BootstrapError` | "should wrap registerPeer errors...", "should wrap removePeer errors...", "should not double-wrap..." (x2) | ✓ |
| 6 | `handlePacket()` changed from private to public | Both `packages/bls/` and `packages/relay/` BLS files updated; route handler still calls `this.handlePacket()` correctly | ✓ |
| 7 | Unit tests with >80% coverage, AAA pattern | 10 tests covering all paths — success, error wrapping, identity re-throw, optional fields | ✓ |
| 8 | Exports added to barrel `index.ts` | `createDirectConnectorAdmin`, `ConnectorAdminLike`, `RegisterPeerParams` all exported | ✓ |

### Improvements Checklist

- [x] All acceptance criteria implemented and tested
- [x] Error wrapping follows established pattern (re-throw BootstrapError, wrap others)
- [x] JSDoc includes usage example on factory function
- [x] Structural interface documents zero-dependency coupling purpose
- [ ] Minor: Test title "should handle missing optional fields (no routes, no settlement, no authToken)" is slightly misleading — `authToken` IS provided (it's required by `ConnectorAdminClient`). Title could say "no routes, no settlement" instead. Non-blocking.

### Security Review

No security concerns. The factory is a pure adapter wrapping function calls — no network I/O, no credential storage, no user input parsing. Error messages include peer IDs but no sensitive data.

### Performance Considerations

No performance concerns. Direct function calls eliminate HTTP overhead entirely, which is the design goal of embedded mode.

### Files Modified During Review

No files were modified during review.

### Build & Test Validation

- ✅ 10/10 new tests passing (`direct-connector-admin.test.ts`)
- ✅ `tsc --noEmit` clean for all story-modified files (BLS source files in both packages have zero errors)
- ✅ Pre-existing tsc errors in test files (`NostrSpspServer.test.ts`, `BootstrapService.test.ts`, etc.) are NOT introduced by this story
- ✅ Pre-existing test failures (`SocialPeerDiscovery.test.ts`, `RelayMonitor.test.ts`) are unrelated

### Gate Status

Gate: PASS → docs/qa/gates/10.3-create-directconnectoradmin.yml
Risk profile: N/A (low-risk story, no escalation triggers)
NFR assessment: N/A (no security/performance/reliability concerns identified)

### Recommended Status

✓ Ready for Done

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-16 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-16 | 0.2 | Validation fixes: explicit BootstrapError re-throw guard in Task 2, Task 4 title includes Relay, removePeer optionality note, ui-prototypes build caveat | QA (Claude Opus 4.6) |
