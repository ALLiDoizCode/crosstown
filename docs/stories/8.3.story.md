# Story 8.3: Publish Peer Announcements as Paid ILP Packets

## Status

Done

## Story

**As a** peer node,
**I want** to publish my kind:10032 event as a paid ILP packet after bootstrap,
**so that** the bootstrap node earns routing fees and the event is stored on its relay.

## Acceptance Criteria

1. kind:10032 published as TOON-encoded ILP PREPARE via `POST /ilp/send`
2. Destination is bootstrap peer's ILP address
3. Amount calculated from standard event pricing (byte-based)
4. FULFILL response treated as confirmation of relay storage (relay read-back is an integration concern)
5. Other peers can subsequently read the event from the relay
6. Publish only happens after own SPSP handshake is complete
7. Failure to publish logged as WARNING (non-fatal — peer is still operational)
8. Unit test verifies TOON encoding of kind:10032 event

## Dev Notes

### Previous Story Insights
[Source: docs/stories/8.2.story.md#dev-agent-record]

From Story 8.2 (Send SPSP Handshakes as ILP Packets via Agent-Runtime):
- 984 tests passing (27 new), 0 failures
- ESLint: 1 pre-existing error in packages/bls (not introduced by Story 8.2)
- `IlpSpspClient` follows DI pattern for TOON encoder/decoder injection (same as `BootstrapService`)
- Reused `AgentRuntimeClient` and `PUBKEY_REGEX` from bootstrap module (no duplication)
- Return type `SpspInfo & { settlement?: SettlementNegotiationResult }` matches `NostrSpspClient` for drop-in compatibility
- Default timeout 30000ms (vs NostrSpspClient's 10000ms) to account for on-chain channel opening
- Retry logic: 1 retry on network/timeout errors, immediate throw on explicit REJECT (SpspError vs SpspTimeoutError)
- QA noted: `NostrSpspClient` still has a local `PUBKEY_REGEX` duplicate (line 18) — consider importing from bootstrap/types in a future cleanup story

### Existing Phase 3 Implementation (Reference)
[Source: packages/core/src/bootstrap/BootstrapService.ts:475-505]

The `BootstrapService.announceViaIlp()` private method **already implements** the core logic for publishing kind:10032 as a paid ILP packet:

```typescript
private async announceViaIlp(result: BootstrapResult): Promise<void> {
  if (!this.agentRuntimeClient || !this.toonEncoder) {
    return;
  }

  // Build kind:10032 event
  const ilpInfoEvent = buildIlpPeerInfoEvent(this.ownIlpInfo, this.secretKey);

  // TOON-encode the event
  const toonBytes = this.toonEncoder(ilpInfoEvent);
  const base64Toon = Buffer.from(toonBytes).toString('base64');

  // Calculate amount: base price per byte * TOON byte length
  // Use a standard pricing of 10 units per byte as default
  const amount = String(BigInt(toonBytes.length) * 10n);

  // Send as paid ILP PREPARE
  const ilpResult = await this.agentRuntimeClient.sendIlpPacket({
    destination: result.peerInfo.ilpAddress,
    amount,
    data: base64Toon,
  });

  if (ilpResult.accepted) {
    console.log(`[Bootstrap] Announced to ${result.registeredPeerId} via ILP`);
  } else {
    console.warn(`[Bootstrap] Announce rejected by ${result.registeredPeerId}: ...`);
  }
}
```

This method is already called in `BootstrapService.bootstrap()` (lines 280-294) during Phase 3, after all SPSP handshakes complete. **However**, the current implementation has several gaps relative to the AC:

1. **Hardcoded pricing** (`10n` units/byte) instead of configurable pricing (AC 3)
2. **No FULFILL verification** — the method logs success but doesn't emit an event or log fulfillment metadata (AC 4)
3. **No event emission** for announce success/failure (monitoring gap)
4. **No tests specific to peer announcement** — existing Phase 3 tests only verify the call happens and amount > 0 (AC 8 needs TOON encoding verification)

### Data Models
[Source: packages/core/src/types.ts, packages/core/src/events/builders.ts]

**IlpPeerInfo (kind:10032 content):**
```typescript
interface IlpPeerInfo {
  ilpAddress: string;
  btpEndpoint: string;
  settlementEngine?: string; // deprecated
  assetCode: string;
  assetScale: number;
  supportedChains?: string[];
  settlementAddresses?: Record<string, string>;
  preferredTokens?: Record<string, string>;
  tokenNetworks?: Record<string, string>;
}
```

**buildIlpPeerInfoEvent(info, secretKey) -> NostrEvent:**
[Source: packages/core/src/events/builders.ts:18-31]
Builds a signed kind:10032 event with `content: JSON.stringify(info)`.

**AgentRuntimeClient.sendIlpPacket():**
[Source: packages/core/src/bootstrap/types.ts:115-122]
```typescript
interface AgentRuntimeClient {
  sendIlpPacket(params: {
    destination: string;
    amount: string;
    data: string; // base64-encoded TOON
    timeout?: number;
  }): Promise<IlpSendResult>;
}
```

**IlpSendResult:**
[Source: packages/core/src/bootstrap/types.ts:104-110]
```typescript
interface IlpSendResult {
  accepted: boolean;
  fulfillment?: string;
  data?: string;
  code?: string;
  message?: string;
}
```

**BootstrapResult:**
[Source: packages/core/src/bootstrap/types.ts:27-40]
```typescript
interface BootstrapResult {
  knownPeer: KnownPeer;
  peerInfo: IlpPeerInfo;       // includes peerInfo.ilpAddress (the destination)
  registeredPeerId: string;
  channelId?: string;
  negotiatedChain?: string;
  settlementAddress?: string;
}
```

### API Specifications

**Agent-Runtime `POST /ilp/send`:**
[Source: docs/epics/epic-8-nostr-network-bootstrap.md, packages/core/src/bootstrap/agent-runtime-client.ts]

```
POST /ilp/send
Content-Type: application/json

{
  "destination": "g.peer1",        // ILP address of the bootstrap peer
  "amount": "3250",                // TOON byte count * basePricePerByte
  "data": "<base64-encoded-TOON>", // TOON-encoded kind:10032 Nostr event
}

Response (FULFILL):
{
  "accepted": true,
  "fulfillment": "<base64>",
  "data": null  // No response data expected for event storage
}

Response (REJECT):
{
  "accepted": false,
  "code": "F06",
  "message": "Insufficient amount"
}
```

**BLS `/handle-payment` receiving side:**
[Source: docker/src/entrypoint.ts:372-410]

For non-SPSP events (like kind:10032), the BLS:
1. Base64 decode -> TOON bytes
2. `decodeEventFromToon(toonBytes)` -> Nostr event
3. Price check: `BigInt(body.amount) >= pricingService.calculatePriceFromBytes(toonBytes, event.kind)`
4. **Self-write bypass**: if `event.pubkey === config.pubkey`, skip payment verification (line 374)
5. On sufficient payment: `eventStore.store(event)` -> FULFILL with `eventId` in metadata
6. On insufficient payment: REJECT with `F06 Insufficient amount` and `required`/`received` metadata

**Critical**: The pricing must match what the receiving BLS expects. The receiving BLS uses `PricingService.calculatePriceFromBytes(toonBytes, event.kind)` which is `BigInt(toonBytes.length) * basePricePerByte`. The default `basePricePerByte` is `10n` (from `BASE_PRICE_PER_BYTE` env var). kind:10032 has **no kind override** in the entrypoint pricing config — only kind:23194 (SPSP request) has an override at `basePricePerByte / 2n`.

### Pricing Strategy
[Source: docker/src/entrypoint.ts:436-442, packages/relay/src/pricing/PricingService.ts:56-59]

The pricing formula is:
```
price = BigInt(toonBytes.length) * pricePerByte
```

Where `pricePerByte`:
- For kind:10032: `basePricePerByte` (default `10n`, from `BASE_PRICE_PER_BYTE` env var)
- For kind:23194: `basePricePerByte / 2n` (half price for SPSP requests)
- For other kinds: `basePricePerByte`

The current `announceViaIlp()` hardcodes `10n` as the price per byte. This should instead be configurable via a new `basePricePerByte` config parameter on the `BootstrapServiceConfig`, defaulting to `10n`. This ensures the sender's price calculation matches the receiver's expected price.

### File Locations
[Source: docs/architecture/9-source-tree.md (note: bootstrap/ dir added in Epic 8.1), packages/core/src/]

**Files to modify:**
- `packages/core/src/bootstrap/BootstrapService.ts` — Enhance `announceViaIlp()` with configurable pricing, FULFILL verification, announce event emission
- `packages/core/src/bootstrap/BootstrapService.test.ts` — Add tests for TOON encoding, pricing, FULFILL verification, and event emission for announce
- `packages/core/src/bootstrap/types.ts` — Add `basePricePerByte` to `BootstrapServiceConfig`, add `bootstrap:announced` and `bootstrap:announce-failed` event types

**Files to modify (entrypoint wiring):**
- `docker/src/entrypoint.ts` — Pass `basePricePerByte` from config to bootstrap service config

**Files NOT modified:**
- `packages/core/src/spsp/` — SPSP client/server unchanged
- `packages/core/src/events/builders.ts` — `buildIlpPeerInfoEvent` already exists and works correctly
- `packages/relay/src/pricing/` — Pricing service unchanged (it's on the receiving side)
- `packages/core/src/index.ts` — No new public exports needed (BootstrapService is already exported)

### Technical Constraints

**TOON DI pattern (same as Stories 8.1/8.2):**
[Source: packages/core/src/bootstrap/BootstrapService.ts:67-68]
The `toonEncoder` callback is already injected via DI and used in `announceViaIlp()`. No changes needed to the DI pattern.

**BigInt handling:**
[Source: docs/stories/8.1.story.md#dev-agent-record]
Use `BigInt()` constructor or `0n` literal, not `Math.min`/`Math.max`. The existing `announceViaIlp()` already uses BigInt correctly: `BigInt(toonBytes.length) * 10n`.

**Ordering constraint (AC 6):**
The current bootstrap flow already enforces this — `announceViaIlp()` is called in Phase 3, which only runs after Phase 2 (SPSP handshakes) completes. No ordering changes needed.

**Non-fatal failure (AC 7):**
The current bootstrap flow already wraps `announceViaIlp()` in try/catch with `console.warn`. Need to also emit a `bootstrap:announce-failed` event for monitoring.

**Self-write bypass on receiving side:**
[Source: docker/src/entrypoint.ts:374]
If the bootstrap node publishes its *own* kind:10032 to its own relay, the BLS skips payment verification (`event.pubkey === config.pubkey`). This means peer2 publishing to peer1's relay must pay, but peer1 publishing to its own relay is free. The `announceViaIlp()` method handles this correctly — it sends the ILP packet to each bootstrap peer's ILP address.

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

- Use `BootstrapError` for announce failures (consistent with existing Phase 3 pattern)
- Failures are non-fatal: catch, log as WARNING, emit `bootstrap:announce-failed` event, continue
- No retry logic for announce — if payment is rejected, retrying with the same amount won't help

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x
**File:** `packages/core/src/bootstrap/BootstrapService.test.ts` (existing file, add new test group)

**Existing Phase 3 tests** (in `BootstrapService.test.ts:684-777`):
- "should publish kind:10032 as paid ILP PREPARE after handshakes" — verifies `sendIlpPacket` called with amount > 0
- "should not throw on publish failure (non-fatal)" — verifies REJECT doesn't crash bootstrap
- "should skip Phase 3 when agentRuntimeClient not configured" — backward compat

**New tests needed (AC 8 + enhanced coverage):**
- Test: TOON encoder is called with a kind:10032 event containing own ILP info
- Test: amount is calculated as `BigInt(toonBytes.length) * basePricePerByte`
- Test: destination is set to bootstrap peer's ILP address (`result.peerInfo.ilpAddress`)
- Test: configurable `basePricePerByte` is used (non-default value)
- Test: default `basePricePerByte` is `10n` when not specified
- Test: `bootstrap:announced` event emitted on FULFILL with peerId
- Test: `bootstrap:announce-failed` event emitted on REJECT with peerId and reason
- Test: announce only happens after Phase 2 handshake (ordering — already tested implicitly by existing Phase 3 tests)

**Expected new test count:** ~7 new tests
**Total expected:** 984 (baseline from 8.2) + ~7 = ~991

**Test patterns to follow:**
[Source: packages/core/src/bootstrap/BootstrapService.test.ts]
```typescript
import { describe, it, expect, vi, beforeEach, type Mock } from 'vitest';
import { generateSecretKey, getPublicKey } from 'nostr-tools/pure';
// ... existing mocks for ws, nostr-tools/pool, discovery ...
```
- Mock `AgentRuntimeClient.sendIlpPacket` with `vi.fn()`
- Mock `toonEncoder` with `vi.fn().mockReturnValue(new Uint8Array([1, 2, 3]))`
- Use `setupWebSocketMock()` helper for simulating relay responses
- Capture events via `service.on((event) => events.push(event))`
- Use `vi.spyOn(console, 'warn')` for log verification

### Scope Boundaries

**In Scope:**
- Enhance `BootstrapService.announceViaIlp()` with configurable pricing via `basePricePerByte`
- Add `basePricePerByte` to `BootstrapServiceConfig` (default: `10n`)
- Add `bootstrap:announced` and `bootstrap:announce-failed` event types to `BootstrapEvent`
- Emit appropriate events on announce success/failure
- Pass `basePricePerByte` from Docker entrypoint config to bootstrap service config
- Unit tests verifying TOON encoding, pricing calculation, event emission
- FULFILL response treated as confirmation of storage (AC 4) — emit `bootstrap:announced` event and log fulfillment metadata

**Out of Scope:**
- Changes to `IlpSpspClient` or `NostrSpspClient` (Story 8.2 scope)
- Relay event read-back verification (AC 5 says "other peers CAN read" — this is an integration concern, not unit-testable)
- Relay subscription for discovering new peers (Story 8.4 scope)
- Changing the receiving side's pricing logic (`PricingService` in relay package)
- Retry logic for announce failures (if REJECT, the same amount won't work)
- Refactoring `BootstrapService.performSpspHandshake()` to use `IlpSpspClient` (future optimization)

## Tasks / Subtasks

- [x] Task 1: Add `basePricePerByte` to `BootstrapServiceConfig` and new event types (AC: 3)
  - [x] In `packages/core/src/bootstrap/types.ts`:
    - Add `basePricePerByte?: bigint` to `BootstrapServiceConfig` interface (default: `10n`)
    - Add `bootstrap:announced` event type: `{ type: 'bootstrap:announced'; peerId: string; eventId: string; amount: string }`
    - Add `bootstrap:announce-failed` event type: `{ type: 'bootstrap:announce-failed'; peerId: string; reason: string }`
  - [x] In `packages/core/src/bootstrap/BootstrapService.ts` constructor:
    - Store `basePricePerByte` from config (default `10n` if not provided)

- [x] Task 2: Enhance `announceViaIlp()` method (AC: 1, 2, 3, 4, 7)
  - [x] Replace hardcoded `10n` with `this.basePricePerByte` for price calculation (AC: 3)
  - [x] Use `result.peerInfo.ilpAddress` as destination (already done, verify) (AC: 2)
  - [x] On FULFILL: emit `bootstrap:announced` event with `peerId`, `eventId` (the locally-built kind:10032 event's `id` field, not from FULFILL response data), and `amount` (AC: 4)
  - [x] On REJECT: emit `bootstrap:announce-failed` event with `peerId` and reason string (AC: 7)
  - [x] Log FULFILL metadata (fulfillment, eventId) at INFO level for verification (AC: 4)
  - [x] In the `bootstrap()` method's Phase 3 loop, the catch block now emits `bootstrap:announce-failed` event **before** the `console.warn`. This handles thrown exceptions (e.g., network errors) that bypass the REJECT path inside `announceViaIlp()`.

- [x] Task 3: Wire `basePricePerByte` in Docker entrypoint (AC: 3)
  - [x] In `docker/src/entrypoint.ts`, add `basePricePerByte: config.basePricePerByte` to the `BootstrapService` constructor's config object literal (alongside the existing `ownIlpAddress`, `toonEncoder`, `toonDecoder` properties)

- [x] Task 4: Write unit tests for peer announcement (AC: 8)
  - [x] Add new `describe('Phase 3: Peer Announcement', ...)` test group in `BootstrapService.test.ts`:
    - [x] Test: toonEncoder is called with kind:10032 event containing own ILP info (AC: 1, 8)
    - [x] Test: ILP packet destination is bootstrap peer's ILP address (`result.peerInfo.ilpAddress`) (AC: 2)
    - [x] Test: amount = `BigInt(toonBytes.length) * basePricePerByte` with default pricing (AC: 3)
    - [x] Test: custom `basePricePerByte` is used when configured (AC: 3)
    - [x] Test: `bootstrap:announced` event emitted on FULFILL (AC: 4)
    - [x] Test: `bootstrap:announce-failed` event emitted on REJECT (AC: 7)
    - [x] Test: `bootstrap:announce-failed` event emitted on network error (AC: 7)

- [x] Task 5: Run full test suite and lint (AC: 8)
  - [x] Run `pnpm test` — 991 tests passing (7 new), 0 failures
  - [x] Run `pnpm lint` — no new lint errors (1 pre-existing error in packages/bls)
  - [x] Verify no regressions in any package

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/bootstrap/types.ts` | Modified | Add `basePricePerByte` to config, add announce event types |
| `packages/core/src/bootstrap/BootstrapService.ts` | Modified | Configurable pricing, FULFILL verification, announce events |
| `packages/core/src/bootstrap/BootstrapService.test.ts` | Modified | ~7 new tests for TOON encoding, pricing, events |
| `docker/src/entrypoint.ts` | Modified | Pass `basePricePerByte` to bootstrap service config |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes
- 991 tests passing (7 new), 0 failures
- ESLint: 1 pre-existing error in packages/bls (not introduced by Story 8.3)
- Build: pre-existing DTS error in `SocialPeerDiscovery.ts` importing from old `../bootstrap.js` path (not introduced by this story, exists since 8.1 bootstrap module refactor)
- `basePricePerByte` added to `BootstrapServiceConfig` as optional bigint (default `10n`)
- `announceViaIlp()` now uses configurable pricing, emits `bootstrap:announced` on FULFILL and `bootstrap:announce-failed` on REJECT
- Catch block in `bootstrap()` Phase 3 loop now emits `bootstrap:announce-failed` for network errors before logging
- Docker entrypoint passes `basePricePerByte` from config and handles new event types in event listener
- Entrypoint event listener updated with cases for `bootstrap:announced` and `bootstrap:announce-failed`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-09 | 0.2 | QA validation fixes: clarify AC4 wording (FULFILL=confirmation), fix catch-block event emission (verify→add), clarify eventId source, fix source-tree reference | QA (Claude Opus 4.6) |
| 2026-02-09 | 0.3 | QA validation v2: clarify catch-block insertion point (exact lines 286-292, before console.warn at line 287), clarify Task 3 entrypoint config object location (lines 447-456) | QA (Claude Opus 4.6) |
| 2026-02-09 | 1.0 | Implementation complete: configurable pricing, announce events, 7 new tests (991 total) | Dev (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is clean and well-structured. The `announceViaIlp()` method at `BootstrapService.ts:483-526` properly handles the three paths: early return (no client/encoder), FULFILL (emit `bootstrap:announced`), and REJECT (emit `bootstrap:announce-failed`). The catch block in `bootstrap()` at lines 288-301 correctly emits `bootstrap:announce-failed` for thrown exceptions (network errors) before logging, which is a good pattern for ensuring events fire even on unexpected failures.

The `basePricePerByte` config follows the existing DI pattern: optional in the interface, defaulted in the constructor (`types.ts:155`, `BootstrapService.ts:105`). BigInt handling is correct throughout — no `Math` operations, proper `BigInt()` constructor usage.

Docker entrypoint changes are appropriately scoped: `basePricePerByte` wired at line 456, event listener handles both new event types at lines 529-533. The bootstrap service construction was moved earlier (line 446) to support the health endpoint phase getter, which is a sensible reorganization.

### Refactoring Performed

No refactoring performed. The implementation is clean and follows established patterns from Stories 8.1 and 8.2.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, camelCase functions, PascalCase types, no `any` usage, proper error handling
- Project Structure: ✓ Co-located tests, exports via index.ts, types in separate types.ts file
- Testing Strategy: ✓ Vitest, AAA pattern, mocked SimplePool/WebSocket, >80% coverage for new code, 7 new tests
- All ACs Met: ✓ All 8 acceptance criteria verified (see traceability below)

### AC Traceability

1. **AC 1** (kind:10032 as TOON-encoded ILP PREPARE): `BootstrapService.ts:489-502` builds the event, TOON-encodes, sends via `sendIlpPacket`. Test: "should call toonEncoder with kind:10032 event containing own ILP info" (line 794)
2. **AC 2** (destination is peer's ILP address): `BootstrapService.ts:500` uses `result.peerInfo.ilpAddress`. Test: "should set destination to bootstrap peer ILP address" (line 827)
3. **AC 3** (amount from standard pricing): `BootstrapService.ts:496` uses `BigInt(toonBytes.length) * this.basePricePerByte`. Tests: default pricing (line 854) and custom pricing (line 884)
4. **AC 4** (FULFILL = confirmation): `BootstrapService.ts:505-514` logs fulfillment metadata and emits `bootstrap:announced`. Test: "should emit bootstrap:announced event on FULFILL" (line 915)
5. **AC 5** (other peers can read): Out of scope for unit tests (integration concern). The event is stored server-side via the BLS `/handle-payment` endpoint, which is already tested in the relay package.
6. **AC 6** (publish after handshake): `BootstrapService.ts:282-301` — Phase 3 runs after Phase 2 in the `bootstrap()` method. Existing Phase 3 ordering tests verify this implicitly.
7. **AC 7** (failure logged as WARNING): `BootstrapService.ts:288-300` catch block emits `bootstrap:announce-failed` and logs via `console.warn`. Tests: REJECT (line 950), network error (line 984)
8. **AC 8** (unit test verifies TOON encoding): Test at line 794 asserts `toonEncoder` is called with a kind:10032 event whose content contains `ownIlpInfo`.

### Improvements Checklist

- [x] All 7 new tests passing (991 total, 0 failures)
- [x] `basePricePerByte` properly configurable with `10n` default
- [x] Event emission for both success and failure paths
- [x] Catch block emits event before logging (correct ordering)
- [ ] Entrypoint test `envKeysToClean` still missing `SUPPORTED_CHAINS` and `SETTLEMENT_ADDRESS_*` vars (carried from 8.2 QA, low severity)
- [ ] `PUBKEY_REGEX` duplication in `NostrSpspClient.ts` still present (carried from 8.1/8.2 QA, low severity — future cleanup story)

### Security Review

No security concerns. The `announceViaIlp()` method sends signed events (via `buildIlpPeerInfoEvent` which uses the node's secret key). Payment amounts are calculated server-side using BigInt, preventing overflow. No user input is directly passed to ILP packets without going through the TOON encoder.

### Performance Considerations

No performance concerns. The announce phase is linear in the number of bootstrap peers (typically 1-3). No retry logic for announce failures, which is the correct design choice since a REJECT with the same amount won't succeed.

### Files Modified During Review

None. No refactoring was necessary.

### Gate Status

Gate: PASS → docs/qa/gates/8.3-publish-peer-announcements-as-paid-ilp-packets.yml
Risk profile: Standard (no escalation triggers)

### Recommended Status

✓ Ready for Done
