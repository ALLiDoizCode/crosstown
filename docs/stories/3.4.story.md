# Story 3.4: Trust Score to Credit Limit Mapping

## Status

Done

## Story

**As an** agent developer,
**I want** to map trust scores to ILP credit limits,
**so that** I can automatically configure peer credit based on social trust.

## Acceptance Criteria

1. `CreditLimitConfig` interface defined with: `maxCredit`, `minCredit`, `curve` (linear/exponential)
2. `calculateCreditLimit(trustScore: TrustScore, config?): number` function implemented
3. Linear curve: `minCredit + (maxCredit - minCredit) * score`
4. Exponential curve: `minCredit + (maxCredit - minCredit) * score^2`
5. Unit tests verify credit calculations for various scores and configs

## Tasks / Subtasks

- [x] Task 1: Define CreditLimitConfig interface (AC: 1)
  - [x] Create interface in `packages/core/src/types.ts`
  - [x] Add `maxCredit: number` (maximum credit limit in asset units)
  - [x] Add `minCredit: number` (minimum credit limit in asset units)
  - [x] Add `curve: 'linear' | 'exponential'` (mapping function type)
  - [x] Export from `packages/core/src/index.ts`

- [x] Task 2: Define DEFAULT_CREDIT_LIMIT_CONFIG constant (AC: 1)
  - [x] Create `DEFAULT_CREDIT_LIMIT_CONFIG` constant in `packages/core/src/trust/creditLimit.ts`
  - [x] Set sensible defaults: `maxCredit: 1000000`, `minCredit: 0`, `curve: 'linear'`
  - [x] Export constant from trust module index
  - [x] Export from `packages/core/src/index.ts`

- [x] Task 3: Implement calculateCreditLimit function - linear curve (AC: 2, 3)
  - [x] Create `calculateCreditLimit(trustScore: TrustScore, config?: Partial<CreditLimitConfig>): number` function in `packages/core/src/trust/creditLimit.ts`
  - [x] Merge provided config with DEFAULT_CREDIT_LIMIT_CONFIG using spread operator
  - [x] Implement linear formula: `minCredit + (maxCredit - minCredit) * score`
  - [x] Extract `score` from TrustScore object for calculation
  - [x] Return calculated credit limit as integer (floor)

- [x] Task 4: Implement calculateCreditLimit function - exponential curve (AC: 4)
  - [x] Add exponential curve support to `calculateCreditLimit`
  - [x] Implement exponential formula: `minCredit + (maxCredit - minCredit) * score^2`
  - [x] Use `Math.pow(score, 2)` for exponential calculation
  - [x] Select formula based on `config.curve` value

- [x] Task 5: Handle edge cases in calculateCreditLimit (AC: 2)
  - [x] Handle score of 0 (returns minCredit)
  - [x] Handle score of 1 (returns maxCredit)
  - [x] Handle score outside [0, 1] range (clamp to valid range)
  - [x] Handle negative minCredit/maxCredit (clamp result to 0 minimum)
  - [x] Handle minCredit > maxCredit (swap values or return minCredit)

- [x] Task 6: Export calculateCreditLimit from package (AC: 2)
  - [x] Export `calculateCreditLimit` from `packages/core/src/trust/index.ts`
  - [x] Export from `packages/core/src/index.ts`

- [x] Task 7: Write unit tests for CreditLimitConfig interface (AC: 1, 5)
  - [x] Test CreditLimitConfig interface has all required fields
  - [x] Test DEFAULT_CREDIT_LIMIT_CONFIG has sensible values
  - [x] Test curve field accepts 'linear' and 'exponential' values

- [x] Task 8: Write unit tests for linear curve calculation (AC: 3, 5)
  - [x] Test score 0 returns minCredit
  - [x] Test score 1 returns maxCredit
  - [x] Test score 0.5 returns midpoint ((maxCredit + minCredit) / 2)
  - [x] Test score 0.25 returns correct linear interpolation
  - [x] Test with custom minCredit and maxCredit values
  - [x] Test default config is used when none provided

- [x] Task 9: Write unit tests for exponential curve calculation (AC: 4, 5)
  - [x] Test score 0 returns minCredit
  - [x] Test score 1 returns maxCredit
  - [x] Test score 0.5 returns minCredit + (maxCredit - minCredit) * 0.25
  - [x] Test score 0.7071 (~sqrt(0.5)) returns approximately midpoint
  - [x] Test exponential curve produces lower values than linear for same score < 1

- [x] Task 10: Write unit tests for edge cases (AC: 5)
  - [x] Test with TrustScore object containing various breakdown values
  - [x] Test partial config merges with defaults
  - [x] Test minCredit equals maxCredit returns that value
  - [x] Test result is always a non-negative integer
  - [x] Test with very large maxCredit values (no overflow)

- [x] Task 11: Write unit tests for integration with TrustScore (AC: 2, 5)
  - [x] Test with TrustScore from computeTrustScore (high trust scenario)
  - [x] Test with TrustScore from computeTrustScore (low trust scenario)
  - [x] Test with TrustScore from computeTrustScore (medium trust scenario)
  - [x] Verify credit limits make sense relative to trust scores

## Dev Notes

### Previous Story Insights
[Source: docs/stories/3.3.story.md#dev-agent-record]

From Story 3.3 implementation:
- `TrustScore` interface defined with `score`, `socialDistance`, `mutualFollowerCount`, `breakdown`
- `computeTrustScore()` method returns `TrustScore` object
- Score is always in range [0, 1] where 1.0 = maximum trust
- DEFAULT_TRUST_CONFIG exported from trust module
- 295 tests currently passing in core package
- Pattern for config merging: `{ ...DEFAULT_CONFIG, ...providedConfig }`
- Floor results to integers when dealing with credit amounts

### Data Models
[Source: docs/architecture/4-data-models.md#45-trustscore]

**TrustScore** interface (already implemented):
```typescript
interface TrustScore {
  score: number;           // 0-1 overall trust score
  socialDistance: number;  // Hops in follow graph
  mutualFollowerCount: number;  // Count of mutual followers
  breakdown: TrustBreakdown;    // Component score details
}
```

**CreditLimitConfig** interface to implement:
```typescript
interface CreditLimitConfig {
  maxCredit: number;           // Maximum credit limit in asset units
  minCredit: number;           // Minimum credit limit in asset units
  curve: 'linear' | 'exponential';  // Mapping function type
}
```

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create/modify for this story:
```
packages/core/src/
├── types.ts                       # Add CreditLimitConfig interface (modify)
├── index.ts                       # Add exports for CreditLimitConfig, DEFAULT_CREDIT_LIMIT_CONFIG, calculateCreditLimit (modify)
├── trust/
│   ├── index.ts                   # Add exports for DEFAULT_CREDIT_LIMIT_CONFIG, calculateCreditLimit (modify)
│   ├── creditLimit.ts             # Create new file with calculateCreditLimit function and DEFAULT_CREDIT_LIMIT_CONFIG
│   └── creditLimit.test.ts        # Create new file with tests
```

### Algorithm Design

**Linear Credit Limit Formula:**
```typescript
function calculateCreditLimit(trustScore: TrustScore, config?: Partial<CreditLimitConfig>): number {
  const mergedConfig = { ...DEFAULT_CREDIT_LIMIT_CONFIG, ...config };
  const { minCredit, maxCredit, curve } = mergedConfig;
  const { score } = trustScore;

  // Clamp score to [0, 1]
  const clampedScore = Math.max(0, Math.min(1, score));

  let creditLimit: number;
  if (curve === 'linear') {
    // Linear: minCredit + (maxCredit - minCredit) * score
    creditLimit = minCredit + (maxCredit - minCredit) * clampedScore;
  } else {
    // Exponential: minCredit + (maxCredit - minCredit) * score^2
    creditLimit = minCredit + (maxCredit - minCredit) * Math.pow(clampedScore, 2);
  }

  // Return as non-negative integer
  return Math.max(0, Math.floor(creditLimit));
}
```

**Curve Comparison:**
| Score | Linear (0-1M) | Exponential (0-1M) |
|-------|---------------|---------------------|
| 0.0   | 0             | 0                   |
| 0.25  | 250,000       | 62,500              |
| 0.5   | 500,000       | 250,000             |
| 0.75  | 750,000       | 562,500             |
| 1.0   | 1,000,000     | 1,000,000           |

The exponential curve provides a more conservative credit allocation, requiring higher trust for larger credit limits. This is suitable for risk-averse peering policies.

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Interfaces | PascalCase | `CreditLimitConfig` |
| Functions | camelCase | `calculateCreditLimit` |
| Constants | UPPER_SNAKE_CASE | `DEFAULT_CREDIT_LIMIT_CONFIG` |
| Type literals | lowercase with quotes | `'linear' | 'exponential'` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards
- Export from index.ts for public APIs
- Co-located test files (creditLimit.test.ts)

### Testing Requirements
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**Test Structure:**
```typescript
import { describe, it, expect } from 'vitest';
import { calculateCreditLimit, DEFAULT_CREDIT_LIMIT_CONFIG } from '../trust/index.js';
import type { TrustScore, CreditLimitConfig } from '../types.js';

describe('calculateCreditLimit', () => {
  // Helper to create TrustScore objects for testing
  const createTrustScore = (score: number): TrustScore => ({
    score,
    socialDistance: 1,
    mutualFollowerCount: 5,
    breakdown: {
      socialDistanceScore: score,
      mutualFollowersScore: score,
      reputationScore: 0.5,
    },
  });

  describe('linear curve', () => {
    it('should return minCredit when score is 0', () => {
      const trustScore = createTrustScore(0);
      const config: CreditLimitConfig = { minCredit: 100, maxCredit: 1000, curve: 'linear' };
      expect(calculateCreditLimit(trustScore, config)).toBe(100);
    });

    it('should return maxCredit when score is 1', () => {
      const trustScore = createTrustScore(1);
      const config: CreditLimitConfig = { minCredit: 100, maxCredit: 1000, curve: 'linear' };
      expect(calculateCreditLimit(trustScore, config)).toBe(1000);
    });
  });
});
```

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

This function is a pure calculation with no external dependencies, so error handling is minimal:
- Invalid scores (outside [0, 1]) are clamped to valid range
- Negative results are clamped to 0
- No exceptions thrown - function always returns a valid non-negative integer

### Security Considerations
[Source: docs/architecture/14-security.md]

- No pubkey validation needed (operates on TrustScore, not raw pubkeys)
- No network calls - pure computation
- Results are deterministic and reproducible
- Credit limits should be treated as suggestions; actual connector credit policies may apply additional constraints

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - implementation completed without issues.

### Completion Notes
- All 11 tasks completed successfully
- 34 new tests added in `creditLimit.test.ts`
- All 329 tests passing (295 existing + 34 new)
- Linting passes
- Implementation follows coding standards and existing patterns

### File List
| File | Action | Description |
|------|--------|-------------|
| packages/core/src/types.ts | Modified | Added CreditLimitConfig interface |
| packages/core/src/trust/creditLimit.ts | Created | calculateCreditLimit function and DEFAULT_CREDIT_LIMIT_CONFIG constant |
| packages/core/src/trust/creditLimit.test.ts | Created | 34 unit tests for credit limit functionality |
| packages/core/src/trust/index.ts | Modified | Export calculateCreditLimit and DEFAULT_CREDIT_LIMIT_CONFIG |
| packages/core/src/index.ts | Modified | Export CreditLimitConfig type, calculateCreditLimit, DEFAULT_CREDIT_LIMIT_CONFIG |

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation that precisely matches the acceptance criteria. The `calculateCreditLimit` function is a clean, pure computation with proper JSDoc documentation, defensive edge case handling, and follows the established config merge pattern from `SocialTrustManager`. The code is well-structured at 63 lines with clear separation between config handling, score clamping, curve calculation, and result sanitization.

### Refactoring Performed

None required - implementation is clean and follows all coding standards.

### Compliance Check

- Coding Standards: ✓ PascalCase interface, camelCase function, UPPER_SNAKE_CASE constant, no `any` usage
- Project Structure: ✓ Co-located test file, proper exports from index.ts files
- Testing Strategy: ✓ Vitest framework, 34 comprehensive tests, >80% coverage
- All ACs Met: ✓ All 5 acceptance criteria fully implemented and tested

### Improvements Checklist

All implementation requirements met - no action items.

### Security Review

No concerns. Pure computation with no network calls, no secrets, no external dependencies. Operates on validated TrustScore objects only.

### Performance Considerations

O(1) time complexity. No allocations beyond the return value. Suitable for high-frequency calls.

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: PASS → docs/qa/gates/3.4-trust-score-to-credit-limit-mapping.yml

### Recommended Status

✓ Ready for Done

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM |
| 2026-02-06 | 1.0 | Implementation complete | Dev Agent (James) |
| 2026-02-06 | 1.1 | QA review complete - PASS | Quinn (Test Architect) |
