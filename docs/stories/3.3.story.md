# Story 3.3: Configurable Trust Score Calculator

## Status

Done

## Story

**As an** agent developer,
**I want** to configure how trust scores are computed from multiple signals,
**so that** I can tune trust derivation for my use case.

## Acceptance Criteria

1. `TrustConfig` interface defined with weights for: `socialDistance`, `mutualFollowers`, `reputation`
2. `computeTrustScore(fromPubkey, toPubkey, config?): Promise<TrustScore>` method added
3. `TrustScore` type includes: `score` (0-1), `socialDistance`, `mutualFollowerCount`, `breakdown`
4. Default config provides sensible weights (e.g., distance=0.5, mutuals=0.3, reputation=0.2)
5. Score of 1.0 = maximum trust, 0.0 = no trust
6. Unit tests verify score calculation with various configs and inputs

## Tasks / Subtasks

- [x] Task 1: Define TrustConfig interface (AC: 1, 4)
  - [x] Create interface in `packages/core/src/types.ts`
  - [x] Add `socialDistanceWeight: number` (weight for social distance component, 0-1)
  - [x] Add `mutualFollowersWeight: number` (weight for mutual followers component, 0-1)
  - [x] Add `reputationWeight: number` (weight for reputation component, 0-1)
  - [x] Add `maxSocialDistance: number` (distance beyond which trust = 0, default 3)
  - [x] Add `maxMutualFollowers: number` (mutual count for max contribution, default 10)
  - [x] Export from `packages/core/src/index.ts`

- [x] Task 2: Define TrustScore interface (AC: 3)
  - [x] Create interface in `packages/core/src/types.ts`
  - [x] Add `score: number` (overall trust score 0-1)
  - [x] Add `socialDistance: number` (raw social distance from getSocialDistance)
  - [x] Add `mutualFollowerCount: number` (count of mutual followers)
  - [x] Add `breakdown: TrustBreakdown` (component scores)
  - [x] Define `TrustBreakdown` interface with `socialDistanceScore`, `mutualFollowersScore`, `reputationScore` (all 0-1)
  - [x] Export both types from `packages/core/src/index.ts`

- [x] Task 3: Define default TrustConfig constant (AC: 4)
  - [x] Create `DEFAULT_TRUST_CONFIG` constant in `SocialTrustManager.ts`
  - [x] Set sensible default weights: `socialDistanceWeight: 0.5`, `mutualFollowersWeight: 0.3`, `reputationWeight: 0.2`
  - [x] Set `maxSocialDistance: 3` (matches getSocialDistance default)
  - [x] Set `maxMutualFollowers: 10` (10+ mutuals = max contribution)
  - [x] Export constant from trust module index

- [x] Task 4: Implement social distance scoring function (AC: 2, 5)
  - [x] Create private method `calculateSocialDistanceScore(distance: number, maxDistance: number): number`
  - [x] Distance 0 (same identity) = score 1.0
  - [x] Distance 1 (direct follow) = score 1.0
  - [x] Distance 2 = score 0.5 (linear decay)
  - [x] Distance 3 = score 0.33 (linear decay)
  - [x] Distance >= maxDistance or Infinity = score 0.0
  - [x] Formula: `distance === 0 || distance === 1 ? 1.0 : distance >= maxDistance ? 0.0 : 1 - (distance - 1) / (maxDistance - 1)`

- [x] Task 5: Implement mutual followers scoring function (AC: 2, 5)
  - [x] Create private method `calculateMutualFollowersScore(count: number, maxCount: number): number`
  - [x] 0 mutual followers = score 0.0
  - [x] Score scales linearly up to maxCount
  - [x] maxCount or more mutual followers = score 1.0
  - [x] Formula: `Math.min(count / maxCount, 1.0)`

- [x] Task 6: Implement reputation scoring function (AC: 2, 5)
  - [x] Create private method `calculateReputationScore(): number`
  - [x] For MVP, return placeholder value of 0.5 (neutral reputation)
  - [x] Add TODO comment: "Implement NIP-57 zap-based reputation in future story"
  - [x] This allows the weight to still influence the final score

- [x] Task 7: Implement computeTrustScore method (AC: 2, 3, 4, 5)
  - [x] Add method signature: `computeTrustScore(fromPubkey: string, toPubkey: string, config?: Partial<TrustConfig>): Promise<TrustScore>`
  - [x] Merge provided config with DEFAULT_TRUST_CONFIG using spread operator
  - [x] Validate both pubkeys using existing `validatePubkey()` method
  - [x] Call `getSocialDistance(fromPubkey, toPubkey)` to get raw distance
  - [x] Call `getMutualFollowers(fromPubkey, toPubkey)` to get mutual list
  - [x] Calculate component scores using helper methods
  - [x] Compute weighted average: `score = (distScore * distWeight + mutualScore * mutualWeight + repScore * repWeight)`
  - [x] Normalize weights if they don't sum to 1.0 (divide by sum of weights)
  - [x] Handle edge case: if totalWeight is 0, return score of 0.0
  - [x] Clamp final score to [0, 1] range
  - [x] Return TrustScore object with all fields populated

- [x] Task 8: Handle edge case - same pubkey (AC: 2, 5)
  - [x] If fromPubkey === toPubkey, return score of 1.0 (maximum self-trust)
  - [x] Set socialDistance to 0, mutualFollowerCount to 0
  - [x] Set all breakdown scores to 1.0

- [x] Task 9: Export DEFAULT_TRUST_CONFIG from package (AC: 4)
  - [x] Export `DEFAULT_TRUST_CONFIG` from `packages/core/src/trust/index.ts`
  - [x] Export from `packages/core/src/index.ts`

- [x] Task 10: Write unit tests for TrustConfig and TrustScore types (AC: 1, 3, 6)
  - [x] Test TrustConfig interface has all required fields
  - [x] Test TrustScore interface has all required fields
  - [x] Test DEFAULT_TRUST_CONFIG has sensible values
  - [x] Test weights in DEFAULT_TRUST_CONFIG sum to 1.0

- [x] Task 11: Write unit tests for social distance scoring (AC: 5, 6)
  - [x] Test distance 0 returns score 1.0
  - [x] Test distance 1 returns score 1.0
  - [x] Test distance 2 returns score ~0.5
  - [x] Test distance 3 returns score ~0.33
  - [x] Test distance >= maxDistance returns score 0.0
  - [x] Test Infinity distance returns score 0.0

- [x] Task 12: Write unit tests for mutual followers scoring (AC: 5, 6)
  - [x] Test 0 mutual followers returns score 0.0
  - [x] Test 5 mutual followers with maxCount=10 returns score 0.5
  - [x] Test 10 mutual followers with maxCount=10 returns score 1.0
  - [x] Test 20 mutual followers with maxCount=10 returns score 1.0 (capped)

- [x] Task 13: Write unit tests for computeTrustScore basic functionality (AC: 2, 6)
  - [x] Test method exists and returns TrustScore object
  - [x] Test method calls getSocialDistance internally
  - [x] Test method calls getMutualFollowers internally
  - [x] Test returned TrustScore has all required fields

- [x] Task 14: Write unit tests for computeTrustScore with default config (AC: 4, 6)
  - [x] Test direct follow (distance=1) with 0 mutuals calculates correctly
  - [x] Test direct follow (distance=1) with 5 mutuals calculates correctly
  - [x] Test follow-of-follow (distance=2) with 10 mutuals calculates correctly
  - [x] Test no connection (Infinity) with 0 mutuals returns score 0.0

- [x] Task 15: Write unit tests for computeTrustScore with custom config (AC: 1, 6)
  - [x] Test custom weights are applied correctly
  - [x] Test socialDistanceWeight=1.0 (only distance matters)
  - [x] Test mutualFollowersWeight=1.0 (only mutuals matter)
  - [x] Test partial config merges with defaults

- [x] Task 16: Write unit tests for edge cases (AC: 6)
  - [x] Test same pubkey returns score 1.0
  - [x] Test invalid pubkey throws TrustCalculationError
  - [x] Test handles relay failures gracefully (returns low score, not error)
  - [x] Test config with all weights set to 0 returns score 0.0

- [x] Task 17: Write unit tests for score bounds (AC: 5, 6)
  - [x] Test score is always >= 0.0
  - [x] Test score is always <= 1.0
  - [x] Test maximum trust scenario returns score close to 1.0
  - [x] Test minimum trust scenario returns score close to 0.0

## Dev Notes

### Previous Story Insights
[Source: docs/stories/3.2.story.md#dev-agent-record]

From Story 3.2 implementation:
- `SocialTrustManager` class has `getSocialDistance()` and `getMutualFollowers()` methods
- Private `validatePubkey()` method validates 64-char lowercase hex pubkeys
- Private `getFollowsForPubkey()` method queries kind:3 events by author
- Private `getFollowersForPubkey()` method queries kind:3 events with `'#p'` filter
- Uses `Promise.all()` for parallel queries
- 263 tests currently passing in core package
- Test helper `createKind3Event()` exists for creating mock events
- Graceful relay failure handling pattern: catch errors, return empty/default values

### Data Models
[Source: docs/architecture/4-data-models.md#45-trustscore]

**TrustScore** interface to implement:
```typescript
interface TrustScore {
  score: number;           // 0-1 overall trust score
  socialDistance: number;  // Hops in follow graph (from getSocialDistance)
  mutualFollowerCount: number;  // Count from getMutualFollowers
  breakdown: TrustBreakdown;    // Component score details
}

interface TrustBreakdown {
  socialDistanceScore: number;   // 0-1 contribution from social distance
  mutualFollowersScore: number;  // 0-1 contribution from mutual followers
  reputationScore: number;       // 0-1 contribution from reputation
}
```

**TrustConfig** interface to implement:
```typescript
interface TrustConfig {
  socialDistanceWeight: number;   // Weight for distance component (0-1)
  mutualFollowersWeight: number;  // Weight for mutuals component (0-1)
  reputationWeight: number;       // Weight for reputation component (0-1)
  maxSocialDistance: number;      // Distance at which trust = 0
  maxMutualFollowers: number;     // Mutual count for max contribution
}
```

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to modify for this story:
```
packages/core/src/
├── types.ts                       # Add TrustConfig, TrustScore, TrustBreakdown interfaces (modify)
├── index.ts                       # Add exports for new types and DEFAULT_TRUST_CONFIG (modify)
├── trust/
│   ├── index.ts                   # Add DEFAULT_TRUST_CONFIG export (modify)
│   ├── SocialTrustManager.ts      # Add computeTrustScore method (modify)
│   └── SocialTrustManager.test.ts # Add tests for computeTrustScore (modify)
```

No new files need to be created - extending existing files.

### Algorithm Design

**Weighted Trust Score Formula:**
```typescript
// Normalize weights (ensure they sum to 1.0)
const totalWeight = config.socialDistanceWeight + config.mutualFollowersWeight + config.reputationWeight;

// Calculate component scores
const distScore = calculateSocialDistanceScore(distance, config.maxSocialDistance);
const mutualScore = calculateMutualFollowersScore(mutualCount, config.maxMutualFollowers);
const repScore = calculateReputationScore(); // 0.5 for MVP

// Weighted average
const score = (
  distScore * config.socialDistanceWeight +
  mutualScore * config.mutualFollowersWeight +
  repScore * config.reputationWeight
) / totalWeight;

// Clamp to [0, 1]
return Math.max(0, Math.min(1, score));
```

**Social Distance Score Function:**
```typescript
function calculateSocialDistanceScore(distance: number, maxDistance: number): number {
  if (distance === Infinity) return 0;
  if (distance <= 1) return 1.0;  // Same identity or direct follow
  if (distance >= maxDistance) return 0;
  // Linear decay from 1.0 at distance 1 to 0.0 at maxDistance
  return 1 - (distance - 1) / (maxDistance - 1);
}
```

**Mutual Followers Score Function:**
```typescript
function calculateMutualFollowersScore(count: number, maxCount: number): number {
  return Math.min(count / maxCount, 1.0);
}
```

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

- Invalid pubkey format → throw `TrustCalculationError` (reuse existing `validatePubkey()`)
- Relay query failures → handle gracefully (getSocialDistance returns Infinity, getMutualFollowers returns [])
- When underlying methods fail gracefully, computeTrustScore should return a low score, not throw

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Interfaces | PascalCase | `TrustConfig`, `TrustScore` |
| Constants | UPPER_SNAKE_CASE | `DEFAULT_TRUST_CONFIG` |
| Methods | camelCase | `computeTrustScore` |
| Private methods | camelCase | `calculateSocialDistanceScore` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards
- Always mock SimplePool in tests - no live relay dependencies
- Follow AAA pattern (Arrange, Act, Assert)

### Testing Requirements
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**Test Structure:**
```typescript
import { vi, describe, it, expect, beforeEach } from 'vitest';
import type { SimplePool } from 'nostr-tools/pool';
import type { VerifiedEvent } from 'nostr-tools/pure';
import { SocialTrustManager, DEFAULT_TRUST_CONFIG } from '../trust/index.js';
import type { TrustConfig, TrustScore } from '../types.js';

// Reuse existing mock setup from previous tests
vi.mock('nostr-tools/pool', () => ({
  SimplePool: vi.fn().mockImplementation(() => ({
    querySync: vi.fn(),
    close: vi.fn(),
  })),
}));

describe('computeTrustScore', () => {
  let manager: SocialTrustManager;
  let mockPool: { querySync: ReturnType<typeof vi.fn> };

  beforeEach(() => {
    vi.clearAllMocks();
    mockPool = new SimplePool() as unknown as { querySync: ReturnType<typeof vi.fn> };
    manager = new SocialTrustManager(['wss://relay.example.com'], mockPool as unknown as SimplePool);
  });

  it('should return TrustScore with all fields', async () => {
    // Arrange: Mock getSocialDistance to return 1, getMutualFollowers to return []
    // ...

    // Act
    const result = await manager.computeTrustScore(pubkeyA, pubkeyB);

    // Assert
    expect(result).toHaveProperty('score');
    expect(result).toHaveProperty('socialDistance');
    expect(result).toHaveProperty('mutualFollowerCount');
    expect(result).toHaveProperty('breakdown');
  });
});
```

### Security Considerations
[Source: docs/architecture/14-security.md]

- Validate all pubkeys as 64-character hex before use
- Only queries public follow lists (kind:3 events) - no secrets involved
- Results are deterministic and reproducible
- No external network calls beyond existing relay queries

### Performance Considerations

- `computeTrustScore` makes two internal calls: `getSocialDistance` and `getMutualFollowers`
- Both methods already handle relay queries internally
- Could optimize by running both in parallel with `Promise.all()`
- For MVP, sequential calls are acceptable for clarity

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

| File | Action | Description |
|------|--------|-------------|
| packages/core/src/types.ts | Modified | Added TrustConfig, TrustBreakdown, and TrustScore interfaces |
| packages/core/src/index.ts | Modified | Added exports for TrustConfig, TrustBreakdown, TrustScore, and DEFAULT_TRUST_CONFIG |
| packages/core/src/trust/index.ts | Modified | Added export for DEFAULT_TRUST_CONFIG |
| packages/core/src/trust/SocialTrustManager.ts | Modified | Added DEFAULT_TRUST_CONFIG constant, calculateSocialDistanceScore, calculateMutualFollowersScore, calculateReputationScore, and computeTrustScore methods |
| packages/core/src/trust/SocialTrustManager.test.ts | Modified | Added 32 new tests for computeTrustScore functionality covering types, scoring functions, default config, custom config, edge cases, and score bounds |

### Completion Notes

- All 17 tasks completed successfully
- 32 new tests added for computeTrustScore (75 total in SocialTrustManager.test.ts)
- 295 total tests passing across all packages
- ESLint passes with no errors
- TrustConfig interface allows full customization of trust calculation weights
- TrustScore provides detailed breakdown of how score was computed
- DEFAULT_TRUST_CONFIG uses sensible defaults: distance=0.5, mutuals=0.3, reputation=0.2
- Reputation scoring returns placeholder 0.5 with TODO for NIP-57 zap-based implementation
- Edge cases handled: same pubkey returns 1.0, zero weights returns 0.0, relay failures gracefully degrade

### Debug Log References

None - implementation completed without errors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM |
| 2026-02-06 | 0.2 | Fixed Task 4 formula to match Dev Notes; added zero-weight edge case handling in Task 7 and test in Task 16 | SM |
| 2026-02-06 | 1.0 | Implementation complete - all 17 tasks done, 295 tests passing | Dev Agent |

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation following established patterns from Story 3.1 and 3.2. The `computeTrustScore` method integrates cleanly with existing `getSocialDistance` and `getMutualFollowers` methods. Code is well-documented with clear JSDoc comments. The weighted scoring algorithm is mathematically correct with proper normalization.

**Highlights:**
- Clean separation of scoring functions (social distance, mutual followers, reputation)
- Proper config merging with spread operator
- Comprehensive edge case handling (same pubkey, zero weights, relay failures)
- Type-safe implementation with full TypeScript interfaces

### Refactoring Performed

None required - implementation is clean and follows project patterns.

### Compliance Check

- Coding Standards: ✓ PascalCase interfaces, camelCase methods, UPPER_SNAKE_CASE constant, no `any` usage
- Project Structure: ✓ Types in types.ts, exports from index.ts, co-located tests
- Testing Strategy: ✓ Vitest, AAA pattern, SimplePool mocked, >80% coverage
- All ACs Met: ✓ All 6 acceptance criteria verified with tests

### Improvements Checklist

All items completed by dev - no outstanding issues.

- [x] TrustConfig interface with all required fields (AC1)
- [x] computeTrustScore method with correct signature (AC2)
- [x] TrustScore type with score, socialDistance, mutualFollowerCount, breakdown (AC3)
- [x] DEFAULT_TRUST_CONFIG with sensible weights summing to 1.0 (AC4)
- [x] Score bounds [0, 1] with 1.0 = max trust, 0.0 = no trust (AC5)
- [x] Comprehensive unit tests (32 new tests, 295 total passing) (AC6)

### Security Review

No security concerns. Implementation:
- Validates all pubkeys before processing
- Only queries public kind:3 events
- No secrets or credentials involved
- Deterministic, reproducible results

### Performance Considerations

Sequential calls to `getSocialDistance` and `getMutualFollowers` are acceptable for MVP clarity. Each method already handles its own relay queries efficiently.

**Future optimization opportunity:** Could parallelize the two calls with `Promise.all()` if performance becomes a concern.

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: PASS → docs/qa/gates/3.3-configurable-trust-score-calculator.yml

### Recommended Status

✓ Ready for Done - All acceptance criteria met, comprehensive test coverage, clean implementation
