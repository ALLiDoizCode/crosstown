# Story 4.3: TOON Encoding for Events

## Status

Done

## Story

**As a** library developer,
**I want** utilities to encode/decode Nostr events in TOON format,
**so that** events can be embedded in ILP packets.

## Acceptance Criteria

1. `encodeEventToToon(event: NostrEvent): Uint8Array` function implemented
2. `decodeEventFromToon(data: Uint8Array): NostrEvent` function implemented
3. Encoding preserves all event fields including signature
4. Round-trip (encode → decode) produces identical event
5. Unit tests verify encoding/decoding for various event types

## Tasks / Subtasks

- [x] Task 1: Add @toon-format/toon dependency (AC: 1, 2)
  - [x] Add `@toon-format/toon` to `packages/relay/package.json` dependencies
  - [x] Run `pnpm install` to update lockfile
  - [x] Verify build still passes with new dependency

- [x] Task 2: Create TOON encoder module (AC: 1)
  - [x] Create `packages/relay/src/toon/index.ts` for exports
  - [x] Create `packages/relay/src/toon/encoder.ts`
  - [x] Import `encode` from `@toon-format/toon`
  - [x] Import `RelayError` from `../storage/index.js`
  - [x] Create `ToonEncodeError` class extending `RelayError` with code `'TOON_ENCODE_ERROR'`
  - [x] Implement `encodeEventToToon(event: NostrEvent): Uint8Array`:
    - Wrap `encode()` call in try/catch
    - On success: Convert TOON string to Uint8Array using `TextEncoder`
    - On failure: Throw `ToonEncodeError` with descriptive message and original error as cause
    - Return Uint8Array

- [x] Task 3: Create TOON decoder module (AC: 2)
  - [x] Create `packages/relay/src/toon/decoder.ts`
  - [x] Import `decode` from `@toon-format/toon`
  - [x] Implement `decodeEventFromToon(data: Uint8Array): NostrEvent`:
    - Convert Uint8Array to string using `TextDecoder`
    - Parse TOON string to object using `decode()`
    - Validate the decoded object has required NostrEvent fields
    - Return as NostrEvent

- [x] Task 4: Add event validation (AC: 2, 3)
  - [x] Create validation helper to verify decoded object is a valid NostrEvent:
    - Check `id` is a string (64-char hex)
    - Check `pubkey` is a string (64-char hex)
    - Check `kind` is a number
    - Check `content` is a string
    - Check `tags` is an array of string arrays
    - Check `created_at` is a number
    - Check `sig` is a string (128-char hex)
  - [x] Throw `ToonError` with descriptive message on validation failure
  - [x] Create `ToonError` class extending `RelayError` with code `'TOON_DECODE_ERROR'`

- [x] Task 5: Update package exports (AC: 1, 2)
  - [x] Export `encodeEventToToon` from `packages/relay/src/toon/index.ts`
  - [x] Export `decodeEventFromToon` from `packages/relay/src/toon/index.ts`
  - [x] Export `ToonError` from `packages/relay/src/toon/index.ts`
  - [x] Export `ToonEncodeError` from `packages/relay/src/toon/index.ts`
  - [x] Export all toon module exports from `packages/relay/src/index.ts`

- [x] Task 6: Write unit tests for encoder (AC: 1, 3, 5)
  - [x] Create `packages/relay/src/toon/toon.test.ts`
  - [x] Test encoding a simple kind:1 event
  - [x] Test encoding an event with empty tags
  - [x] Test encoding an event with multiple tags (including #e, #p tags)
  - [x] Test encoding an event with special characters in content (newlines, quotes, unicode)
  - [x] Test encoding ILP event kinds (10032, 10047)
  - [x] Verify output is Uint8Array
  - [x] Verify output is smaller than JSON.stringify for events with many uniform tags (e.g., follow list)
  - [x] Test ToonEncodeError is thrown for invalid input (e.g., circular references)

- [x] Task 7: Write unit tests for decoder (AC: 2, 3, 5)
  - [x] Test decoding a simple encoded event
  - [x] Test decoding event with empty tags
  - [x] Test decoding event with multiple tags
  - [x] Test decoding event with special characters in content
  - [x] Test decoding ILP event kinds (10032, 10047)
  - [x] Test error thrown for invalid TOON data
  - [x] Test error thrown for malformed event (missing fields)
  - [x] Test error thrown for invalid field types

- [x] Task 8: Write round-trip tests (AC: 3, 4, 5)
  - [x] Test round-trip for kind:0 (profile metadata) event
  - [x] Test round-trip for kind:1 (text note) event with content
  - [x] Test round-trip for kind:3 (follow list) event with many tags
  - [x] Test round-trip for kind:7 (reaction) event
  - [x] Test round-trip for kind:10032 (ILP Peer Info) event
  - [x] Test round-trip for kind:10047 (SPSP Info) event
  - [x] Verify decoded event is deeply equal to original event
  - [x] Verify event signature is preserved

- [x] Task 9: Add integration with existing types (AC: 1, 2, 3)
  - [x] Ensure encoder/decoder work with `nostr-tools` NostrEvent type
  - [x] Add JSDoc comments explaining purpose and usage
  - [x] Document that this is used for embedding events in ILP packets

## Dev Notes

### Previous Story Insights
[Source: docs/stories/4.2.story.md#dev-agent-record]

From Story 4.2 implementation:
- `better-sqlite3` v11.x used instead of v9.x due to Node.js v24.12.0 compatibility
- Pattern: Create dedicated module directories with index.ts for exports
- Pattern: Use `RelayError` class for relay-specific errors with error codes
- 437 tests total in repository after Story 4.2
- All new modules exported from both module-level and package-level index.ts files

### Why TOON?
[Source: docs/ILP-GATED-RELAY.md#event-transport-ilp-packet--toon]

TOON (Token-Oriented Object Notation) is used for encoding Nostr events in ILP packets because:
- Compact encoding reduces bytes (and cost, if priced per-byte)
- Lossless JSON round-trip (Nostr events are JSON)
- Well-specified with implementations in multiple languages
- TOON's sweet spot is uniform arrays of objects, which matches Nostr event tags structure

### ILP-Gated Relay Write Flow
[Source: docs/ILP-GATED-RELAY.md#write-path-paid, docs/architecture/7-core-workflows.md#73-ilp-gated-relay-write-flow]

The TOON encoder/decoder is used in the ILP-gated write path:
```
Agent creates Nostr event
       ↓
Agent TOON-encodes event → Uint8Array
       ↓
Agent sends ILP STREAM payment with TOON payload
       ↓
BLS receives packet, decodes TOON → Nostr event
       ↓
BLS calculates price, verifies payment
       ↓
BLS stores event, returns FULFILL
```

### TOON Library
[Source: https://github.com/toon-format/toon]

Official TypeScript package: `@toon-format/toon`

```typescript
import { encode, decode } from '@toon-format/toon';

// Encode to TOON string
const toonString = encode(data);

// Decode from TOON string
const decoded = decode(toonString);
```

The package provides lossless round-trip conversion for JSON-compatible data structures.

### NostrEvent Structure
[Source: docs/architecture/4-data-models.md#46-nostrevent-external]

NostrEvent from nostr-tools:
```typescript
interface NostrEvent {
  id: string;         // Event hash (64-char hex)
  pubkey: string;     // Author public key (64-char hex)
  kind: number;       // Event kind
  content: string;    // Event content
  tags: string[][];   // Event tags
  created_at: number; // Unix timestamp
  sig: string;        // Schnorr signature (128-char hex)
}
```

All 7 fields must be preserved through encode/decode cycle.

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create for this story:
```
packages/relay/src/
└── toon/
    ├── index.ts           # Module exports
    ├── encoder.ts         # encodeEventToToon function
    ├── decoder.ts         # decodeEventFromToon function
    └── toon.test.ts       # Unit tests (co-located)
```

### Tech Stack
[Source: docs/architecture/3-tech-stack.md]

| Technology | Version | Purpose |
|------------|---------|---------|
| @toon-format/toon | latest | TOON encode/decode |
| nostr-tools | 2.x | NostrEvent types |
| Vitest | 1.x | Unit testing |
| TypeScript | 5.3.x | Language |

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md, docs/stories/4.2.story.md#file-list]

**RelayError Import:** The `RelayError` class was created in Story 4.2 and is exported from the storage module:
```typescript
import { RelayError } from '../storage/index.js';
```

Create `ToonError` class for TOON-specific errors:
```typescript
import { RelayError } from '../storage/index.js';

export class ToonError extends RelayError {
  constructor(message: string, cause?: Error) {
    super(message, 'TOON_DECODE_ERROR', cause);
    this.name = 'ToonError';
  }
}
```

For encoding errors, use code `'TOON_ENCODE_ERROR'`:
```typescript
export class ToonEncodeError extends RelayError {
  constructor(message: string, cause?: Error) {
    super(message, 'TOON_ENCODE_ERROR', cause);
    this.name = 'ToonEncodeError';
  }
}
```

Error scenarios:
- Invalid TOON format (malformed TOON string)
- Missing required NostrEvent fields
- Invalid field types (e.g., kind is not a number)
- Corrupted Uint8Array input

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case | `encoder.ts`, `decoder.ts` |
| Functions | camelCase | `encodeEventToToon`, `decodeEventFromToon` |
| Constants | UPPER_SNAKE_CASE | N/A for this story |
| Error classes | PascalCase | `ToonError` |

### Testing Requirements
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**Test File Location:** Co-located with source (`packages/relay/src/toon/toon.test.ts`)

**Test Pattern:**
```typescript
import { describe, it, expect } from 'vitest';
import { encodeEventToToon, decodeEventFromToon, ToonError, ToonEncodeError } from './index.js';
import type { NostrEvent } from 'nostr-tools/pure';

describe('TOON Encoding', () => {
  const createTestEvent = (overrides: Partial<NostrEvent> = {}): NostrEvent => ({
    id: 'a'.repeat(64),
    pubkey: 'b'.repeat(64),
    kind: 1,
    content: 'Hello, world!',
    tags: [],
    created_at: 1234567890,
    sig: 'c'.repeat(128),
    ...overrides,
  });

  it('should encode an event to Uint8Array', () => {
    const event = createTestEvent();
    const encoded = encodeEventToToon(event);
    expect(encoded).toBeInstanceOf(Uint8Array);
    expect(encoded.length).toBeGreaterThan(0);
  });

  it('should decode an encoded event back to original', () => {
    const event = createTestEvent();
    const encoded = encodeEventToToon(event);
    const decoded = decodeEventFromToon(encoded);
    expect(decoded).toEqual(event);
  });
});
```

**Coverage Requirement:** >80% for public APIs

### Security Considerations
[Source: docs/architecture/14-security.md]

- Validate all decoded event fields before returning
- Don't trust incoming TOON data - treat as untrusted input
- Verify hex string lengths for id, pubkey, sig
- Ensure tags is an array of arrays

### Test Event Fixtures

Create factory functions for common event types:

```typescript
// Kind 1: Text Note
const createTextNote = (): NostrEvent => ({
  id: 'a'.repeat(64),
  pubkey: 'b'.repeat(64),
  kind: 1,
  content: 'Hello, Nostr!',
  tags: [['e', 'event-id'], ['p', 'pubkey-ref']],
  created_at: 1234567890,
  sig: 'c'.repeat(128),
});

// Kind 10032: ILP Peer Info
const createIlpPeerInfo = (): NostrEvent => ({
  id: 'd'.repeat(64),
  pubkey: 'e'.repeat(64),
  kind: 10032,
  content: JSON.stringify({
    ilpAddress: 'g.agent.alice',
    btpEndpoint: 'ws://localhost:8080',
    assetCode: 'USD',
    assetScale: 9,
  }),
  tags: [],
  created_at: 1234567890,
  sig: 'f'.repeat(128),
});

// Kind 3: Follow List (many tags)
const createFollowList = (): NostrEvent => ({
  id: 'g'.repeat(64),
  pubkey: 'h'.repeat(64),
  kind: 3,
  content: '',
  tags: Array.from({ length: 50 }, (_, i) => ['p', 'i'.repeat(64) + i.toString().padStart(2, '0')]),
  created_at: 1234567890,
  sig: 'j'.repeat(128),
});
```

## File List

| File | Status | Description |
|------|--------|-------------|
| `packages/relay/package.json` | Modified | Added `@toon-format/toon` dependency |
| `packages/relay/src/toon/index.ts` | Created | Module exports for TOON encoding/decoding |
| `packages/relay/src/toon/encoder.ts` | Created | `encodeEventToToon` function and `ToonEncodeError` class |
| `packages/relay/src/toon/decoder.ts` | Created | `decodeEventFromToon` function, `ToonError` class, and validation |
| `packages/relay/src/toon/toon.test.ts` | Created | 30 unit tests for encoding, decoding, and round-trip |
| `packages/relay/src/index.ts` | Modified | Added exports for toon module |
| `pnpm-lock.yaml` | Modified | Updated with @toon-format/toon dependency |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

No debug issues encountered.

### Completion Notes

- All 9 tasks completed successfully
- 30 new tests added (467 total in repository, up from 437)
- Build passes, linting passes, all tests pass
- TOON encoding/decoding works correctly with nostr-tools NostrEvent type
- Validation ensures all 7 NostrEvent fields are present and properly formatted
- Error classes extend RelayError with appropriate error codes
- Test fixtures use valid hex characters only (0-9, a-f) for id/pubkey/sig fields

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. The TOON encoding/decoding module is well-structured, following the established patterns from Story 4.2. The code demonstrates:
- Clean separation of concerns (encoder.ts, decoder.ts, index.ts)
- Proper error handling with custom error classes extending RelayError
- Comprehensive input validation for untrusted TOON data
- Good JSDoc documentation explaining purpose and usage

### Refactoring Performed

None required - the implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ Follows naming conventions (kebab-case files, PascalCase classes, camelCase functions)
- Project Structure: ✓ Module organized correctly in packages/relay/src/toon/ with co-located tests
- Testing Strategy: ✓ 30 tests co-located in toon.test.ts, using factory functions for fixtures
- All ACs Met: ✓ All 5 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Proper module structure with index.ts exports
- [x] Error classes extend RelayError with appropriate error codes
- [x] Validation covers all 7 NostrEvent fields
- [x] Hex string length validation for id, pubkey, sig
- [x] Comprehensive test coverage for edge cases
- [ ] Consider exporting validateNostrEventFields for external use (future enhancement)

### Security Review

The decoder includes thorough input validation:
- Validates object type before field access
- Validates all 7 NostrEvent fields with correct types
- Validates hex string lengths (64 for id/pubkey, 128 for sig)
- Validates tags structure (array of string arrays)
- Treats TOON data as untrusted input per security guidelines

No security concerns identified.

### Performance Considerations

- TOON encoding is efficient for the target use case (ILP packets)
- Test confirms reasonable output size for large uniform arrays (follow lists)
- TextEncoder/TextDecoder used for efficient string/Uint8Array conversion

No performance concerns identified.

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: PASS -> docs/qa/gates/4.3-toon-encoding-for-events.yml

### Recommended Status

✓ Ready for Done

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM |
| 2026-02-06 | 0.2 | Added explicit RelayError import path from storage module, added ToonEncodeError class for encoding failures | SM |
| 2026-02-06 | 1.0 | Implementation complete - all tasks done, 30 tests passing | Dev Agent |
| 2026-02-06 | 1.1 | QA review complete - PASS | Quinn (Test Architect) |
