# Story 6.1: Genesis Peer Configuration

## Status

Done

## Story

**As a** node operator,
**I want** a hardcoded list of well-known genesis peers shipped with the package,
**so that** new nodes can bootstrap into the network without external configuration.

## Acceptance Criteria

1. Create `packages/core/src/discovery/genesis-peers.json` with initial genesis peer entries
2. Schema: `[{ "pubkey": "hex64", "relayUrl": "wss://...", "ilpAddress": "g.xxx", "btpEndpoint": "ws://..." }]`
3. Create `GenesisPeerLoader` that imports and validates the JSON at build time
4. Validation: pubkey format (64-char hex), relay URL format (wss:// or ws://), ILP address format (g.xxx), BTP endpoint format (wss:// or ws://)
5. Invalid entries are logged and skipped, not fatal
6. Genesis peers are mergeable with runtime-provided peers (env var `ADDITIONAL_PEERS` as JSON)
7. Unit tests verify loading, validation, and merge behavior

## Tasks / Subtasks

- [x] Task 1: Define GenesisPeer type and genesis-peers.json schema (AC: 1, 2)
  - [x] Create `packages/core/src/discovery/genesis-peers.json` with at least one example genesis peer entry matching the schema: `[{ "pubkey": "hex64", "relayUrl": "wss://...", "ilpAddress": "g.xxx", "btpEndpoint": "ws://..." }]`
  - [x] Define `GenesisPeer` interface in `packages/core/src/discovery/GenesisPeerLoader.ts` with fields: `pubkey: string`, `relayUrl: string`, `ilpAddress: string`, `btpEndpoint: string`
  - [x] Ensure the JSON file uses a placeholder/example peer entry (clearly documented as example, not a real node)

- [x] Task 2: Implement GenesisPeerLoader class with validation (AC: 3, 4, 5)
  - [x] Create `packages/core/src/discovery/GenesisPeerLoader.ts`
  - [x] Import genesis-peers.json using TypeScript JSON import (with `resolveJsonModule`)
  - [x] Implement `loadGenesisPeers(): GenesisPeer[]` static method that:
    - Reads the imported JSON array
    - Validates each entry against the schema
    - Logs and skips invalid entries (non-fatal)
    - Deduplicates by pubkey (last valid entry wins)
    - Returns array of valid `GenesisPeer` objects
  - [x] Implement validation functions:
    - `isValidPubkey(pubkey: string): boolean` — 64-char lowercase hex (`/^[0-9a-f]{64}$/`)
    - `isValidRelayUrl(url: string): boolean` — starts with `wss://` or `ws://`
    - `isValidIlpAddress(address: string): boolean` — matches `/^g\.[a-zA-Z0-9.-]+$/`
    - `isValidBtpEndpoint(url: string): boolean` — starts with `wss://` or `ws://`
  - [x] Note: `PUBKEY_REGEX` is duplicated in `NostrPeerDiscovery.ts` and `bootstrap.ts` — define it locally here too for now; a shared validation utility can be extracted in a future refactor
  - [x] Use `console.warn` for logging skipped invalid entries (consistent with existing bootstrap logging pattern)

- [x] Task 3: Implement ADDITIONAL_PEERS merge functionality (AC: 6)
  - [x] Add `loadAdditionalPeers(json: string): GenesisPeer[]` static method to `GenesisPeerLoader`:
    - Parses JSON string as array of peer objects
    - Validates each entry using the same validation functions
    - Logs and skips invalid entries
    - Returns array of valid `GenesisPeer` objects
  - [x] Add `loadAllPeers(additionalPeersJson?: string): GenesisPeer[]` static method:
    - Loads genesis peers from JSON
    - If `additionalPeersJson` is provided, parses and validates additional peers
    - Merges both lists, deduplicating by pubkey (additional peers take priority for overrides)
    - Returns combined array
  - [x] Handle malformed JSON gracefully (log warning, return only genesis peers)

- [x] Task 4: Export GenesisPeerLoader from package (AC: 3)
  - [x] Add `GenesisPeerLoader` export to `packages/core/src/discovery/index.ts`
  - [x] Add `GenesisPeerLoader` and `GenesisPeer` type export to `packages/core/src/index.ts`

- [x] Task 5: Write unit tests (AC: 7)
  - [x] Create `packages/core/src/discovery/GenesisPeerLoader.test.ts`
  - [x] Test: `loadGenesisPeers()` returns valid entries from JSON
  - [x] Test: Invalid pubkey entries are skipped (not 64-char hex)
  - [x] Test: Invalid relay URL entries are skipped (not ws:// or wss://)
  - [x] Test: Invalid ILP address entries are skipped (doesn't match `g.xxx` pattern)
  - [x] Test: Invalid BTP endpoint entries are skipped
  - [x] Test: `loadAdditionalPeers()` parses valid JSON string
  - [x] Test: `loadAdditionalPeers()` handles malformed JSON gracefully
  - [x] Test: `loadAllPeers()` merges genesis and additional peers
  - [x] Test: `loadAllPeers()` deduplicates by pubkey (additional peers override genesis)
  - [x] Test: `loadAllPeers()` works with no additional peers
  - [x] Test: Empty genesis peers JSON returns empty array
  - [x] Test: Entries with missing fields are skipped
  - [x] Test: Duplicate pubkeys within genesis-peers.json are deduplicated (last entry wins)
  - [x] Verify `console.warn` is called for invalid entries (use `vi.spyOn`)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/5.7.story.md#dev-agent-record]

From Story 5.7 implementation:
- 771 tests passing, 0 failures after Story 5.7
- Story 5.7 was documentation/configuration only (K8s manifests)
- No TypeScript source code was modified in Epic 5

From the overall Epic 5 context:
- The BLS package (`packages/bls/`) was created as a standalone package
- Docker image published: `di3twater/crosstown-bls`
- BLS config validation uses regex patterns similar to what this story needs (pubkey: `/^[0-9a-f]{64}$/`, ILP address: `/^g\.[a-zA-Z0-9.-]+$/`)
[Source: packages/bls/src/config.ts]

### Existing Code Patterns
[Source: packages/core/src/discovery/NostrPeerDiscovery.ts]

The existing `NostrPeerDiscovery` class in the same directory uses:
- `PUBKEY_REGEX = /^[0-9a-f]{64}$/` for pubkey validation — reuse this exact pattern
- `SimplePool` from `nostr-tools/pool` for relay communication
- Co-located test files (e.g., `NostrPeerDiscovery.test.ts`)
- Exports through `packages/core/src/discovery/index.ts`

[Source: packages/core/src/bootstrap.ts]

The existing `BootstrapService` defines:
- `KnownPeer` interface: `{ pubkey: string, relayUrl: string, btpEndpoint: string }` — the new `GenesisPeer` is similar but adds `ilpAddress`
- `BootstrapConfig.knownPeers: KnownPeer[]` — the genesis peer system will eventually feed into this
- `PUBKEY_REGEX = /^[0-9a-f]{64}$/` — same validation pattern

### Data Models
[Source: docs/architecture/4-data-models.md#ilp-peer-info, docs/epics/epic-6-decentralized-peer-discovery.md#story-61]

**GenesisPeer schema** (from epic):
```json
[{
  "pubkey": "hex64",
  "relayUrl": "wss://...",
  "ilpAddress": "g.xxx",
  "btpEndpoint": "ws://..."
}]
```

This is distinct from `IlpPeerInfo` (which has `ilpAddress`, `btpEndpoint`, `settlementEngine`, `assetCode`, `assetScale`) and from `KnownPeer` (which has `pubkey`, `relayUrl`, `btpEndpoint` but no `ilpAddress`).

### Validation Rules
[Source: docs/epics/epic-6-decentralized-peer-discovery.md#story-61]

| Field | Validation | Regex/Pattern |
|-------|-----------|---------------|
| `pubkey` | 64-char lowercase hex | `/^[0-9a-f]{64}$/` |
| `relayUrl` | WebSocket URL | starts with `wss://` or `ws://` |
| `ilpAddress` | ILP address format | `/^g\.[a-zA-Z0-9.-]+$/` |
| `btpEndpoint` | WebSocket URL | starts with `wss://` or `ws://` |

### File Locations
[Source: docs/architecture/9-source-tree.md, docs/epics/epic-6-decentralized-peer-discovery.md]

New files to create:
- `packages/core/src/discovery/genesis-peers.json` — Genesis peer data
- `packages/core/src/discovery/GenesisPeerLoader.ts` — Loader class with validation
- `packages/core/src/discovery/GenesisPeerLoader.test.ts` — Unit tests

Existing files to modify:
- `packages/core/src/discovery/index.ts` — Add GenesisPeerLoader export
- `packages/core/src/index.ts` — Add GenesisPeerLoader and GenesisPeer exports

### Package Dependencies
[Source: packages/core/package.json]

No new dependencies are needed for this story. The genesis-peers.json is imported directly via TypeScript's `resolveJsonModule`. Validation logic uses only standard JavaScript regex.

Current `@crosstown/core` dependencies:
- `nostr-tools: ^2.20.0`
- `ws: ^8.18.0`

### Environment Variables
[Source: docs/epics/epic-6-decentralized-peer-discovery.md#story-61]

- `ADDITIONAL_PEERS` (optional): JSON array string of additional peer objects matching the GenesisPeer schema. Parsed by `loadAdditionalPeers()` or `loadAllPeers()`. The `GenesisPeerLoader` does NOT read this env var directly — it accepts the JSON string as a parameter, leaving env var reading to the caller (e.g., the Docker entrypoint in Story 6.5).

### Error Handling Pattern
[Source: packages/core/src/errors.ts, packages/core/src/bootstrap.ts]

The existing codebase uses:
- Custom error classes extending `CrosstownError` for throwable errors
- `console.warn` for non-fatal warnings (e.g., skipped peers in bootstrap)
- `console.log` for informational messages

For this story, invalid genesis peer entries should use `console.warn` (non-fatal, logged and skipped). No new error class is needed since validation failures are handled gracefully, not thrown.

### Scope Boundaries

**In Scope (this story):**
- `genesis-peers.json` with example/placeholder entries
- `GenesisPeerLoader` class with load, validate, and merge methods
- Unit tests for all validation and merge scenarios
- Package exports

**Out of Scope:**
- ArDrive peer registry (Story 6.2)
- Bootstrap service refactoring (Story 6.3)
- Social graph discovery (Story 6.4)
- Docker entrypoint integration (Story 6.5)
- Reading `ADDITIONAL_PEERS` env var directly (caller responsibility)
- Modifying the existing `BootstrapService` or `KnownPeer` interface

### Testing

**Test Framework:** Vitest 1.x
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Standards:**
- Co-located test file: `packages/core/src/discovery/GenesisPeerLoader.test.ts`
- Follow AAA pattern (Arrange, Act, Assert)
- Mock `console.warn` using `vi.spyOn(console, 'warn')` to verify warning logs
- No live relay dependencies
- Use factory functions for test fixtures (valid/invalid peer objects)

**Test Approach:**
- Pure unit tests — no mocking of external services needed
- Validation functions are pure functions, easily testable
- JSON import can be tested by validating the actual genesis-peers.json content
- Merge behavior tested with constructed peer arrays

**Coverage Goals:** >80% line coverage for public methods

**Existing test suite:** 771 tests should continue to pass with no regressions

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action |
|------|--------|
| `packages/core/src/discovery/genesis-peers.json` | Created |
| `packages/core/src/discovery/GenesisPeerLoader.ts` | Created |
| `packages/core/src/discovery/GenesisPeerLoader.test.ts` | Created |
| `packages/core/src/discovery/index.ts` | Modified |
| `packages/core/src/index.ts` | Modified |

### Debug Log References
No debug issues encountered.

### Completion Notes
- All 5 tasks and all subtasks completed
- 32 new unit tests added (803 total, up from 771)
- All validation functions exported for testability
- Genesis peers JSON uses placeholder/example entry with clearly fake pubkey
- `PUBKEY_REGEX` defined locally as noted in story (future refactor to shared util)
- `console.warn` used for all non-fatal validation failures
- No new dependencies required
- Full regression suite passes (803/803)

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is clean, well-structured, and follows established project patterns. The `GenesisPeerLoader` is implemented as a const object with three methods (`loadGenesisPeers`, `loadAdditionalPeers`, `loadAllPeers`) plus four exported validation helpers. Code is concise at ~113 lines with clear separation of concerns: type definition, validation, deduplication, and loading logic.

Key strengths:
- Type guard pattern (`isValidGenesisPeer`) prevents unsafe `unknown` data from propagating
- Exported granular validators (`isValidPubkey`, `isValidRelayUrl`, etc.) are more reusable than the private patterns in `NostrPeerDiscovery.ts` and `bootstrap.ts`
- Deduplication via `Map<string, GenesisPeer>` is straightforward and correct (last entry wins)
- Graceful degradation: invalid entries are logged and skipped, never fatal
- No external dependencies required — pure validation logic + JSON import

### Refactoring Performed

None — code quality is sufficient; no refactoring warranted.

### Compliance Check

- Coding Standards: ✓ TypeScript strict types, camelCase functions, UPPER_SNAKE_CASE constants, no `any` usage
- Project Structure: ✓ Co-located test file, exports through `discovery/index.ts` and `core/index.ts`
- Testing Strategy: ✓ Vitest, AAA pattern, factory fixture (`validPeer()`), `vi.spyOn` for console.warn, >80% coverage
- All ACs Met: ✓ All 7 acceptance criteria verified (see details below)

**AC Verification:**
1. ✓ `genesis-peers.json` created with initial genesis peer entry
2. ✓ Schema matches `[{ "pubkey": "hex64", "relayUrl": "wss://...", "ilpAddress": "g.xxx", "btpEndpoint": "ws://..." }]`
3. ✓ `GenesisPeerLoader` imports and validates JSON at build time
4. ✓ All four validation functions implemented with correct patterns
5. ✓ Invalid entries logged (`console.warn`) and skipped, not fatal
6. ✓ `loadAllPeers()` merges genesis with runtime-provided peers, deduplicates by pubkey
7. ✓ 32 unit tests verify loading, validation, and merge behavior

### Improvements Checklist

- [x] All acceptance criteria implemented and tested
- [x] Exports correctly wired through index files
- [x] Graceful error handling for malformed JSON
- [x] Deduplication logic correct (additional peers override genesis)
- [ ] PUBKEY_REGEX is duplicated across 3 files (`GenesisPeerLoader.ts`, `NostrPeerDiscovery.ts`, `bootstrap.ts`) — extract to shared validation utility in future refactor (noted in story, acceptable tech debt)

### Security Review

No security concerns. This code handles static/local JSON configuration only — no network I/O, no user-facing input parsing beyond the `ADDITIONAL_PEERS` JSON string (which is validated). Validation is strict (regex-based) and rejects anything not matching expected patterns.

### Performance Considerations

No performance concerns. Peer loading is a one-time startup operation. The genesis JSON is imported at build time (bundled). Deduplication uses a `Map` (O(n)). Typical peer lists will be in the single digits.

### Files Modified During Review

None — no files modified by QA.

### Gate Status

Gate: PASS → docs/qa/gates/6.1-genesis-peer-configuration.yml

### Recommended Status

✓ Ready for Done

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-07 | 0.2 | Validation fixes: AC4 adds BTP endpoint validation, dedup within genesis JSON, PUBKEY_REGEX reuse note, extra test case | Validation (Claude Opus 4.6) |
| 2026-02-07 | 1.0 | Implementation complete — all tasks done, 32 tests added, 803 total passing | Dev (Claude Opus 4.6) |
