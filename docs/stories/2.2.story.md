# Story 2.2: Static SPSP Info Publishing

## Status

Done

## Story

**As an** agent developer,
**I want** to publish my SPSP parameters to Nostr,
**so that** peers can discover my payment endpoint.

## Acceptance Criteria

1. `NostrSpspServer` class created with constructor accepting relay URLs, keypair, and optional SimplePool
2. `publishSpspInfo(info: SpspInfo): Promise<void>` method publishes kind:10047 replaceable event
3. Event is signed with provided secret key
4. Event is published to all configured relays
5. Method waits for at least one relay confirmation before resolving
6. Unit tests verify event construction and publishing flow

## Tasks / Subtasks

- [x] Task 1: Create NostrSpspServer class structure (AC: 1)
  - [x] Create `packages/core/src/spsp/NostrSpspServer.ts` file
  - [x] Create `packages/core/src/spsp/NostrSpspServer.test.ts` file
  - [x] Define `NostrSpspServer` class with private `relayUrls`, `secretKey`, and `pool` fields
  - [x] Constructor accepts `relayUrls: string[]`, `secretKey: Uint8Array`, and optional `pool?: SimplePool`
  - [x] Create `SimplePool` instance if not provided (same pattern as `NostrSpspClient`)
  - [x] Export class from `packages/core/src/spsp/index.ts`

- [x] Task 2: Implement publishSpspInfo method (AC: 2, 3, 4, 5)
  - [x] Method signature: `async publishSpspInfo(info: SpspInfo): Promise<void>`
  - [x] Use `buildSpspInfoEvent(info, secretKey)` from `events/builders.ts` to create signed event (AC: 3)
  - [x] Use `pool.publish(relayUrls, event)` to publish to all relays (AC: 4)
  - [x] Handle publish result - wait for at least one relay confirmation (AC: 5)
  - [x] Throw `SpspError` if no relay confirms within timeout

- [x] Task 3: Handle relay publish confirmations (AC: 5)
  - [x] `pool.publish()` returns array of promises for each relay
  - [x] Use `Promise.any()` to resolve when first relay confirms
  - [x] Catch `AggregateError` if all relays fail - throw `SpspError` with details
  - [x] Consider adding optional timeout parameter (default: 10s per architecture)

- [x] Task 4: Update module exports (AC: 1)
  - [x] Export `NostrSpspServer` from `packages/core/src/spsp/index.ts`
  - [x] Export `NostrSpspServer` from `packages/core/src/index.ts`

- [x] Task 5: Write unit tests for class instantiation (AC: 1, 6)
  - [x] Test NostrSpspServer can be instantiated with relay URLs and secret key
  - [x] Test NostrSpspServer can be instantiated with custom SimplePool
  - [x] Test constructor stores relays and secret key correctly

- [x] Task 6: Write unit tests for publishSpspInfo happy path (AC: 2, 3, 4, 6)
  - [x] Test publishes kind:10047 event with correct content
  - [x] Test event is signed (verifiable signature)
  - [x] Test event contains correct destinationAccount and sharedSecret
  - [x] Test publish is called on all configured relays
  - [x] Test resolves when at least one relay confirms

- [x] Task 7: Write unit tests for publishSpspInfo error handling (AC: 5, 6)
  - [x] Test throws SpspError when all relays fail
  - [x] Test throws SpspError with cause chain on relay errors
  - [x] Test timeout behavior (if implemented)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/2.1.story.md#dev-agent-record]

From Story 2.1 (Static SPSP Info Query):
- Package uses ESM (`"type": "module"`) - use `.js` extension in imports
- TypeScript strict mode is enabled
- 112 tests currently pass in core package
- Test helpers cast through `unknown` for `VerifiedEvent` type: `as unknown as VerifiedEvent`
- `NostrSpspClient` class provides established pattern for constructor and SimplePool usage
- `buildSpspInfoEvent()` function already exists in `packages/core/src/events/builders.ts`
- `SpspInfo` type already defined in `packages/core/src/types.ts`
- `SPSP_INFO_KIND = 10047` constant already exported from `packages/core/src/constants.ts`
- PUBKEY_REGEX pattern duplicated locally - consider using for validation if needed

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to create/modify for this story:
```
packages/core/src/
├── index.ts                            # Add NostrSpspServer export (modify)
├── spsp/                               # Existing directory
│   ├── index.ts                        # Add NostrSpspServer export (modify)
│   ├── NostrSpspServer.ts              # Main server class (create)
│   └── NostrSpspServer.test.ts         # Tests (create)
```

### Data Models
[Source: docs/architecture/4-data-models.md#42-spspinfo]

**SpspInfo (kind:10047):**
```typescript
export interface SpspInfo {
  /** ILP address to send payment to */
  destinationAccount: string;
  /** Base64-encoded shared secret for STREAM protocol */
  sharedSecret: string;
}
```

This interface already exists in `packages/core/src/types.ts` [Source: packages/core/src/types.ts:26-31]

### Event Building
[Source: packages/core/src/events/builders.ts]

The `buildSpspInfoEvent` function already exists and handles:
- Creating a kind:10047 event
- Serializing SpspInfo to JSON content
- Signing with the provided secret key
- Setting `created_at` to current timestamp

Usage:
```typescript
import { buildSpspInfoEvent } from '../events/index.js';

const event = buildSpspInfoEvent(info, secretKey);
// Returns a signed NostrEvent ready for publishing
```

### nostr-tools SimplePool Publish API
[Source: https://github.com/nbd-wtf/nostr-tools, docs/architecture/3-tech-stack.md]

**SimplePool.publish() for publishing events:**
```typescript
import { SimplePool } from 'nostr-tools/pool';
import type { NostrEvent } from 'nostr-tools/pure';

// pool.publish() returns array of promises (one per relay)
const publishPromises = pool.publish(relayUrls, signedEvent);

// Wait for at least one relay to confirm (AC: 5)
try {
  await Promise.any(publishPromises);
  // At least one relay confirmed
} catch (error) {
  if (error instanceof AggregateError) {
    // All relays failed
    throw new SpspError('Failed to publish to any relay', error.errors[0]);
  }
  throw error;
}
```

**Important:** `pool.publish()` returns immediately with an array of Promises, one for each relay. Each promise resolves when that relay acknowledges the event.

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

**Error scenarios for publishSpspInfo:**
- All relays fail to acknowledge → throw `SpspError` with cause
- Timeout waiting for confirmation → throw `SpspError` with timeout message

**SpspError class (already exists):**
```typescript
export class SpspError extends CrosstownError {
  constructor(message: string, cause?: Error) {
    super(message, 'SPSP_FAILED', cause);
    this.name = 'SpspError';
  }
}
```

### Keypair Handling
[Source: nostr-tools documentation]

The constructor should accept `secretKey: Uint8Array` which is the 32-byte secp256k1 secret key. This is passed directly to `buildSpspInfoEvent()` for signing.

The pubkey is derived from the secret key when signing, so there's no need to separately accept or validate the pubkey.

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case (but we use PascalCase for class files per existing pattern) | `NostrSpspServer.ts` |
| Classes | PascalCase | `NostrSpspServer` |
| Methods | camelCase | `publishSpspInfo` |
| Constants | UPPER_SNAKE_CASE | `SPSP_INFO_KIND` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards
- Always mock SimplePool in tests - no live relay dependencies
- Export from index.ts - all public APIs exported from package index
- Use nostr-tools types - don't redefine event types

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**File:** `packages/core/src/spsp/NostrSpspServer.test.ts`

**Test pattern from NostrSpspClient.test.ts:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import type { SimplePool } from 'nostr-tools/pool';
import { NostrSpspServer } from './NostrSpspServer.js';
import { SpspError } from '../errors.js';

const MOCK_RELAY_URLS = ['wss://relay1.example.com', 'wss://relay2.example.com'];

// Generate a mock 32-byte secret key
const MOCK_SECRET_KEY = new Uint8Array(32).fill(1);

const mockPool = {
  publish: vi.fn(),
} as unknown as SimplePool;

describe('NostrSpspServer', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  // Tests here...
});
```

**Mocking pool.publish():**
```typescript
// Mock successful publish (at least one relay confirms)
vi.mocked(mockPool.publish).mockReturnValue([
  Promise.resolve('ok'),
  Promise.resolve('ok'),
]);

// Mock all relays failing
vi.mocked(mockPool.publish).mockReturnValue([
  Promise.reject(new Error('relay1 failed')),
  Promise.reject(new Error('relay2 failed')),
]);

// Mock one relay succeeding, one failing
vi.mocked(mockPool.publish).mockReturnValue([
  Promise.resolve('ok'),
  Promise.reject(new Error('relay2 failed')),
]);
```

**Test Requirements:**
- Follow AAA pattern (Arrange, Act, Assert)
- Mock all SimplePool calls
- Test success, partial success, and all-fail paths
- >80% coverage for new class

### Replaceable Event Behavior
[Source: NIP-01, docs/architecture/4-data-models.md]

Kind 10047 is a replaceable event (kinds 10000-19999). When a new event is published:
- Relays should replace any existing kind:10047 event from the same pubkey
- Only the most recent event (by `created_at`) is retained
- This is automatic relay behavior - no special handling needed in our code

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No issues encountered during implementation.

### Completion Notes
- Implementation followed `NostrSpspClient` pattern for constructor and SimplePool usage
- Used `buildSpspInfoEvent()` from events/builders.ts for event creation and signing
- `Promise.any()` pattern used for relay confirmation (resolves when first relay confirms)
- `AggregateError` handling for all-relay-failure case
- Optional timeout parameter not implemented - `pool.publish()` promises resolve/reject based on relay response, timeout would need to be added at application level if needed
- 17 new tests added (5 constructor, 7 happy path, 5 error handling)
- Total tests now: 129 (up from 112)

### File List
| File | Action |
|------|--------|
| packages/core/src/spsp/NostrSpspServer.ts | Created |
| packages/core/src/spsp/NostrSpspServer.test.ts | Created |
| packages/core/src/spsp/index.ts | Modified |
| packages/core/src/index.ts | Modified |

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation that closely follows the established `NostrSpspClient` pattern. The code is clean, well-documented, and adheres to project conventions. The implementation is minimal and focused - exactly what the story requires with no unnecessary complexity.

**Strengths:**
- Follows existing patterns from `NostrSpspClient` for constructor/SimplePool handling
- Proper reuse of `buildSpspInfoEvent()` from events/builders.ts
- Correct `Promise.any()` usage for relay confirmation handling
- Comprehensive error handling with proper cause chaining
- Well-structured tests covering all acceptance criteria

### Refactoring Performed

None required. The implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, no `any` usage, proper naming conventions
- Project Structure: ✓ Files in correct locations, exports properly chained
- Testing Strategy: ✓ 17 new tests, AAA pattern, mocked SimplePool, comprehensive coverage
- All ACs Met: ✓ All 6 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] AC1: `NostrSpspServer` class created with correct constructor signature
- [x] AC2: `publishSpspInfo(info: SpspInfo): Promise<void>` implemented
- [x] AC3: Event signed with provided secret key (verified via `verifyEvent()`)
- [x] AC4: Event published to all configured relays
- [x] AC5: Waits for at least one relay confirmation via `Promise.any()`
- [x] AC6: Comprehensive unit tests (17 tests) covering all paths
- [ ] Consider adding configurable timeout parameter (noted in Dev Notes as future enhancement)

### Security Review

No security concerns. The implementation:
- Uses proper cryptographic signing via `nostr-tools/pure`
- Does not store secrets in plaintext beyond required runtime use
- Properly handles the secret key as `Uint8Array`

### Performance Considerations

No performance concerns:
- `Promise.any()` efficiently resolves on first successful relay confirmation
- No unnecessary blocking or sequential operations
- Correct handling of partial relay failures (doesn't wait for all to fail)

### Files Modified During Review

None - no refactoring was required.

### Gate Status

Gate: PASS → docs/qa/gates/2.2-static-spsp-info-publishing.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria are met with comprehensive test coverage. The implementation follows established patterns and coding standards.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM |
| 2026-02-06 | 1.0 | Implementation complete | Dev Agent (James) |
| 2026-02-06 | 1.1 | QA Review - PASS | Quinn (Test Architect) |
