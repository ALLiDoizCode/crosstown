# Story 5.4: Volume-Based Event Storage

## Status

Done

## Story

**As a** BLS operator,
**I want** the standalone BLS to persist events to a mounted volume,
**so that** events survive container restarts.

## Acceptance Criteria

1. BLS uses SQLite database for event storage
2. Database file stored at configurable path (default: `/data/events.db`)
3. Container expects volume mount at `/data`
4. Events persisted after successful payment verification
5. Database schema matches existing `SqliteEventStore` implementation
6. Graceful handling if volume not mounted (logs warning, uses in-memory fallback)
7. Environment variable `DATA_DIR` allows customizing data path
8. Unit tests verify persistence across simulated restarts

## Tasks / Subtasks

- [x] Task 1: Create helper function `createEventStore(dataDir: string)` in new file (AC: 1, 2, 6)
  - [x] Create new file `packages/bls/src/storage/createEventStore.ts`
  - [x] Implement `createEventStore(dataDir: string): { eventStore: SqliteEventStore | InMemoryEventStore; storageSummary: string }` — return concrete union type (not `EventStore`) so callers can call `close()` without optional chaining (both concrete classes define non-optional `close()`, whereas `EventStore` declares `close?(): void`)
  - [x] Encapsulate the directory-check, fallback decision, and store creation logic in this function
  - [x] Return the created store instance and a human-readable summary string for logging
  - [x] This function should NOT call `process.exit` — it handles errors by falling back, making it testable
  - [x] Export `createEventStore` from `packages/bls/src/storage/index.ts`

- [x] Task 2: Integrate `createEventStore` into entrypoint (AC: 2, 6, 7)
  - [x] In `entrypoint.ts`, replace direct `SqliteEventStore` construction with `createEventStore(dataDir)` import from `./storage/index.js`
  - [x] Log the `storageSummary` returned by `createEventStore` on startup
  - [x] If `dataDir` is not writable/does not exist, `createEventStore` already logs a warning and returns `InMemoryEventStore`
  - [x] Ensure graceful shutdown still calls `eventStore.close()` for both store types (InMemoryEventStore already has a no-op `close()`)

- [x] Task 3: Write unit tests for in-memory fallback behavior (AC: 6)
  - [x] Add tests to `packages/bls/src/storage/createEventStore.test.ts`
  - [x] Test: When `dataDir` points to a non-existent directory, `createEventStore` returns an `InMemoryEventStore` and a warning summary
  - [x] Test: When `dataDir` points to a read-only directory, `createEventStore` returns an `InMemoryEventStore` and a warning summary
  - [x] Test: When `dataDir` points to a writable directory, `createEventStore` returns a `SqliteEventStore` with correct `dbPath`
  - [x] Test: Verify the summary string includes the storage type and path

- [x] Task 4: Write unit tests for persistence across simulated restarts (AC: 5, 8)
  - [x] Create test file: `packages/bls/src/storage/persistence.test.ts`
  - [x] Test: Store events using `SqliteEventStore` with a file path, close the store, create a new `SqliteEventStore` with the same path, and verify stored events are retrievable via `get()` and `query()`
  - [x] Test: Verify database schema (events table, indexes) matches the existing `SqliteEventStore` implementation — open the `.db` file with `better-sqlite3` and query `sqlite_master`
  - [x] Test: Store multiple events, close and reopen, verify all events survive
  - [x] Test: Store a replaceable event, close and reopen, store a newer replaceable event, verify only the latest is kept
  - [x] Clean up test database files in `afterEach` (same pattern as `SqliteEventStore.test.ts`: `unlinkSync` if `existsSync`)

- [x] Task 5: Update startup logging to include storage mode (AC: 6)
  - [x] Add storage summary line to the startup log block in `entrypoint.ts` (e.g., `Storage:           SQLite (/data/events.db)` or `Storage:           in-memory (volatile)`)
  - [x] Ensure the warning message for in-memory fallback is distinct and attention-getting

- [x] Task 6: Verify existing behavior is preserved (AC: 1, 2, 3, 4, 5, 7)
  - [x] Confirm `DATA_DIR` environment variable is already parsed in `config.ts` (default: `/data`) — no changes needed
  - [x] Confirm `VOLUME /data` is already declared in the Dockerfile — no changes needed
  - [x] Confirm database path is `${dataDir}/events.db` — already set in current entrypoint
  - [x] Confirm events are persisted after payment verification — `BusinessLogicServer.store()` calls `eventStore.store()` on success
  - [x] Confirm schema matches architecture spec — `SqliteEventStore` creates the exact schema from `docs/architecture/8-database-schema.md`
  - [x] Run `pnpm test` — all existing tests must pass plus new persistence tests

## Dev Notes

### Previous Story Insights
[Source: docs/stories/5.3.story.md#dev-agent-record]

From Story 5.3 implementation:
- `loadBlsConfigFromEnv()` is a pure function that throws errors (not `process.exit`), making it testable
- `dataDir` defaults to `/data` in `config.ts` (line 98: `process.env['DATA_DIR'] ?? '/data'`)
- Pricing delegation uses `propagateUnprefixedEnvVars()` bridge
- 761 tests passing after Story 5.3

From Story 5.2 implementation:
[Source: docs/stories/5.2.story.md#dev-agent-record]
- Dockerfile declares `VOLUME /data` (line 70) and `ENV DATA_DIR=/data` (line 63)
- Data directory created and owned by `node` user: `RUN mkdir -p /data && chown node:node /data`
- Image is 147MB; runs as non-root `node` user

### Current Entrypoint Event Store Initialization
[Source: packages/bls/src/entrypoint.ts, lines 50-52]

```typescript
// Create event store with SQLite
const dbPath = `${dataDir}/events.db`;
const eventStore = new SqliteEventStore(dbPath);
```

Currently the entrypoint creates a `SqliteEventStore` unconditionally with no fallback. If the directory does not exist or is not writable, `better-sqlite3` will throw `SqliteError: unable to open database file` — causing the container to crash.

The primary change for this story is adding a **directory check** before creating the store and falling back to `InMemoryEventStore` if the directory is not available, with a clear warning log.

### EventStore Interface
[Source: packages/bls/src/storage/EventStore.ts]

```typescript
export interface EventStore {
  store(event: NostrEvent): void;
  get(id: string): NostrEvent | undefined;
  query(filters: Filter[]): NostrEvent[];
  close?(): void;
}
```

Both `SqliteEventStore` and `InMemoryEventStore` implement this interface. The BLS (`BusinessLogicServer`) depends only on the `EventStore` interface — specifically calling `store()` — so swapping implementations is transparent.

**Important:** `close?()` is optional on the `EventStore` interface, but both concrete classes (`SqliteEventStore` and `InMemoryEventStore`) define non-optional `close()`. The `createEventStore` function returns `SqliteEventStore | InMemoryEventStore` (concrete union) rather than `EventStore` so that `entrypoint.ts` can call `eventStore.close()` in the shutdown handler without optional chaining or a type error.

### SqliteEventStore Constructor
[Source: packages/bls/src/storage/SqliteEventStore.ts, lines 82-116]

```typescript
constructor(dbPath = ':memory:') {
  try {
    this.db = new Database(dbPath);
    initializeSchema(this.db);
    // ... prepare statements
  } catch (error) {
    throw new BlsBaseError(
      `Failed to initialize database: ${error instanceof Error ? error.message : String(error)}`,
      'STORAGE_ERROR'
    );
  }
}
```

Key observations:
- Default `dbPath` is `:memory:` (in-memory SQLite)
- Constructor throws `BlsBaseError` with code `STORAGE_ERROR` on failure
- Schema is initialized on construction (CREATE TABLE IF NOT EXISTS, indexes)
- All prepared statements are created in constructor

### InMemoryEventStore
[Source: packages/bls/src/storage/InMemoryEventStore.ts]

Simple `Map<string, NostrEvent>`-based store. No persistence. `close()` is a no-op. Fully implements `EventStore` interface.

### Database Schema
[Source: docs/architecture/8-database-schema.md]
[Source: packages/bls/src/storage/SqliteEventStore.ts, lines 10-31]

```sql
CREATE TABLE IF NOT EXISTS events (
  id TEXT PRIMARY KEY,
  pubkey TEXT NOT NULL,
  kind INTEGER NOT NULL,
  content TEXT NOT NULL,
  tags TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  sig TEXT NOT NULL,
  received_at INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_events_pubkey ON events(pubkey);
CREATE INDEX IF NOT EXISTS idx_events_kind ON events(kind);
CREATE INDEX IF NOT EXISTS idx_events_created_at ON events(created_at);
CREATE INDEX IF NOT EXISTS idx_events_pubkey_kind ON events(pubkey, kind);
```

### Dockerfile Volume Configuration
[Source: packages/bls/Dockerfile, lines 62-74]

```dockerfile
ENV DATA_DIR=/data
VOLUME /data
RUN mkdir -p /data && chown node:node /data
USER node
```

Already correctly configured. No Dockerfile changes needed for this story.

### Graceful Shutdown
[Source: packages/bls/src/entrypoint.ts, lines 112-120]

```typescript
const shutdown = () => {
  console.log('Shutting down BLS...');
  server.close();
  eventStore.close();
  process.exit(0);
};
```

`eventStore.close()` already works for both `SqliteEventStore` (closes DB connection) and `InMemoryEventStore` (no-op). No changes needed to shutdown logic — as long as `eventStore` is typed as the concrete union `SqliteEventStore | InMemoryEventStore` (returned by `createEventStore`) rather than `EventStore` (which has `close?()` optional).

### Existing Test Patterns
[Source: packages/bls/src/storage/SqliteEventStore.test.ts]

```typescript
const TEST_DB_PATH = './test-bls-events.db';

afterEach(() => {
  if (store) {
    store.close();
  }
  if (existsSync(TEST_DB_PATH)) {
    unlinkSync(TEST_DB_PATH);
  }
});
```

Follow this exact pattern for persistence tests: use a temp file path, clean up in `afterEach`.

### Scope Boundaries

**In Scope (this story):**
- `packages/bls/src/entrypoint.ts` — import `createEventStore`, replace direct `SqliteEventStore` construction, add storage mode logging
- `packages/bls/src/storage/createEventStore.ts` — new file: extract store creation logic with directory check and fallback
- `packages/bls/src/storage/persistence.test.ts` — new tests for SQLite persistence across restarts
- `packages/bls/src/storage/createEventStore.test.ts` — new tests for fallback behavior
- `packages/bls/src/storage/index.ts` — export `createEventStore`

**Out of Scope:**
- Docker Hub publishing and CI workflow (Story 5.5)
- Docker Compose examples (Story 5.6)
- Kubernetes manifests (Story 5.7)
- BLS contract documentation (Story 5.8)
- Changing the Dockerfile (already complete in Story 5.2)
- Changing `config.ts` (`DATA_DIR` parsing already exists from Story 5.3)
- Changing the `EventStore` interface
- Changing `SqliteEventStore` or `InMemoryEventStore` implementations

### Testing

**Test File Location:** `packages/bls/src/storage/persistence.test.ts` (co-located with storage modules)
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x with built-in mocking
[Source: docs/architecture/3-tech-stack.md]

**Test Standards:**
- Follow AAA pattern (Arrange, Act, Assert)
- >80% coverage for new public APIs
- Clean up test DB files in `afterEach` (pattern from `SqliteEventStore.test.ts`)
- Test both SQLite persistence path and in-memory fallback path
- For directory access checks, use real temp directories (`fs.mkdtempSync`) rather than mocking `fs`
- For read-only directory tests, use `fs.chmodSync` to set permissions (note: may not work on all CI platforms — mark as platform-specific if needed)

**Key Test Scenarios:**
1. SQLite store persists events across close/reopen cycles
2. Database schema and indexes survive close/reopen
3. Replaceable events maintain correct semantics across restarts
4. Non-writable directory triggers InMemoryEventStore fallback with warning
5. Non-existent directory triggers InMemoryEventStore fallback with warning
6. Writable directory creates SqliteEventStore at correct path

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `packages/bls/src/storage/createEventStore.ts` | Created | Helper function with directory-check, fallback to InMemoryEventStore, and summary string |
| `packages/bls/src/storage/createEventStore.test.ts` | Created | 5 unit tests for fallback behavior (non-existent dir, read-only dir, writable dir, summary strings) |
| `packages/bls/src/storage/persistence.test.ts` | Created | 5 persistence tests (close/reopen cycles, query after restart, multiple events, replaceable events, schema verification) |
| `packages/bls/src/storage/index.ts` | Modified | Added export of `createEventStore` and `CreateEventStoreResult` type |
| `packages/bls/src/entrypoint.ts` | Modified | Replaced direct `SqliteEventStore` construction with `createEventStore(dataDir)`, added storage summary to startup log |

### Debug Log References
None — no issues encountered during implementation.

### Completion Notes
- All 6 tasks completed successfully
- 10 new tests added (5 createEventStore + 5 persistence)
- Full test suite: 771 tests passing (32 files), up from 761 baseline
- `createEventStore` returns concrete union type `SqliteEventStore | InMemoryEventStore` for type-safe `close()` calls
- No changes needed to Dockerfile, config.ts, EventStore interface, or concrete store implementations
- Graceful shutdown works for both store types without modification

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The `createEventStore` helper is clean, focused, and well-separated from the entrypoint. The function encapsulates directory-check + fallback logic without calling `process.exit`, making it fully testable. The concrete union return type (`SqliteEventStore | InMemoryEventStore`) is a thoughtful design choice that avoids optional chaining on `close()` in the shutdown handler. The entrypoint integration is minimal and correct — a textbook extract-and-delegate refactoring.

Key strengths:
- **Clean separation**: Store creation logic extracted to a single-responsibility helper
- **Type safety**: Concrete union return type eliminates optional chaining for `close()`
- **Defensive fallback**: Two-stage check (existence → writability) with clear warning messages
- **No process.exit**: Helper is pure-ish (only side effect is `console.warn`), making it testable
- **Test patterns**: Follows established patterns from `SqliteEventStore.test.ts` exactly

### Refactoring Performed

No refactoring performed. The implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ camelCase functions, PascalCase types, co-located tests, no `any`, uses `nostr-tools` types
- Project Structure: ✓ New files follow existing `packages/bls/src/storage/` layout, exports from `index.ts`
- Testing Strategy: ✓ Vitest, co-located tests, AAA pattern, >80% coverage on new APIs, cleanup in `afterEach`
- All ACs Met: ✓ All 8 acceptance criteria verified (see traceability below)

### AC Traceability

| AC | Requirement | Validation |
|----|-------------|------------|
| 1 | SQLite for event storage | `createEventStore` creates `SqliteEventStore` when dir is writable |
| 2 | Configurable path (default `/data/events.db`) | `dbPath = ${dataDir}/events.db`; `config.ts` defaults `dataDir` to `/data` |
| 3 | Container expects volume mount at `/data` | Dockerfile line 70: `VOLUME /data` (verified, no changes needed) |
| 4 | Events persisted after payment verification | `BusinessLogicServer.store()` → `eventStore.store()` chain unchanged |
| 5 | Schema matches SqliteEventStore | Persistence test verifies tables + all 4 indexes via `sqlite_master` |
| 6 | Graceful in-memory fallback with warning | Two fallback paths tested: non-existent dir, non-writable dir |
| 7 | `DATA_DIR` env var | `config.ts` line 98: `process.env['DATA_DIR'] ?? '/data'` (pre-existing) |
| 8 | Unit tests for persistence | 5 persistence tests + 5 createEventStore tests = 10 new tests |

### Improvements Checklist

- [x] All acceptance criteria implemented and tested
- [x] Both fallback paths (non-existent, non-writable) covered
- [x] Persistence across close/reopen cycles verified
- [x] Replaceable event semantics verified across restarts
- [x] Schema preservation verified via raw `sqlite_master` query
- [ ] Minor: `createEventStore.test.ts` line 67 — SQLite store created in "summary for SQLite" test is not explicitly closed (`closeStore = () => {}` is a no-op); store will be GC'd but best practice is to close explicitly. Low priority — not a correctness issue.
- [ ] Minor: Consider adding a test for when `SqliteEventStore` constructor throws (e.g., corrupted DB file) to verify `createEventStore` handles the exception. Currently the `BlsBaseError` would propagate unhandled. Low priority — the crash behavior is acceptable for a corrupted DB.

### Security Review

No security concerns. The `createEventStore` function uses `accessSync` for permission checks, which is appropriate for startup-time validation. No user-controlled input reaches SQL queries — the `dataDir` comes from a trusted env var. The existing `SqliteEventStore` uses prepared statements and parameterized queries throughout.

### Performance Considerations

No performance concerns. The `existsSync`/`accessSync` calls happen once at startup. SQLite WAL mode is not explicitly enabled but is not needed for a single-writer BLS container. No regression from the refactoring.

### Files Modified During Review

None — no modifications made.

### Gate Status

Gate: PASS → docs/qa/gates/5.4-volume-based-event-storage.yml

### Recommended Status

✓ Ready for Done

All 8 acceptance criteria are met. 10 new tests added (771 total, all passing). Implementation is clean, well-tested, and follows established patterns. The two minor suggestions above are improvements, not blockers.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-07 | 0.2 | QA validation fixes: made createEventStore file extraction definitive (not optional), specified concrete union return type for close() type safety, split fallback tests to own file, added import guidance | QA (Claude Opus 4.6) |
| 2026-02-07 | 0.3 | Reordered tasks: createEventStore helper (Task 1) now precedes entrypoint integration (Task 2); consolidated logging into Task 5; verification moved to Task 6 | QA (Claude Opus 4.6) |
| 2026-02-07 | 1.0 | Implementation complete: createEventStore helper, entrypoint integration, 10 new tests (771 total), all passing | Dev (Claude Opus 4.6) |
