# Story 11.2: Implement HttpConnectorAdmin

**Epic:** Epic 11 - @crosstown/client HTTP Mode Support
**Created:** 2026-02-20
**Updated:** 2026-02-20 (Validation fixes applied)
**Dependencies:** Story 11.1 (HttpRuntimeClient - for error handling patterns and HTTP client approach)

---

## Status

Done

---

## Story

**As a** Crosstown agent developer,
**I want** to manage ILP peers via the connector's admin API,
**so that** I can add/remove peers when using HTTP mode.

---

## Acceptance Criteria

1. ✅ HttpConnectorAdmin class implements `ConnectorAdminClient` interface (same as DirectConnectorAdmin)
2. ✅ `addPeer(config)` sends HTTP POST to connector admin API with peer config and returns success/failure
3. ✅ `removePeer(peerId)` sends HTTP DELETE to connector admin API and returns success (optional method)
4. ✅ Request validation ensures peer config is valid before sending (id, url, authToken required)
5. ✅ Error handling distinguishes network errors from admin API errors (unauthorized, peer not found, conflict)
6. ✅ Unit tests achieve ≥90% coverage with mocked HTTP client
7. ✅ No live HTTP requests in unit tests (all HTTP mocked)

---

## Tasks / Subtasks

### Implementation Tasks

- [x] **Task 1: Create HttpConnectorAdmin class structure** (AC: 1)
  - [x] Create `packages/client/src/adapters/HttpConnectorAdmin.ts`
  - [x] Implement `ConnectorAdminClient` interface from `@crosstown/core/bootstrap/types`
  - [x] Add constructor accepting `adminUrl: string` and optional `httpClient`
  - [x] Export from `packages/client/src/adapters/index.ts`

- [x] **Task 2: Implement addPeer() method** (AC: 2, 4)
  - [x]Validate peer config parameters (id, url, authToken required; routes and settlement optional)
  - [x]Validate `id`: non-empty string
  - [x]Validate `url`: non-empty string, valid BTP URL format (starts with 'btp+ws://' or 'btp+wss://')
  - [x]Validate `authToken`: non-empty string
  - [x]Validate `routes` (if provided): array of objects with `prefix` (string) and optional `priority` (number)
  - [x]Validate `settlement` (if provided): object with valid settlement parameters
  - [x]Construct HTTP POST request to `${adminUrl}/admin/peers` endpoint
  - [x]Set headers: `Content-Type: application/json`
  - [x]Send JSON body with peer config: `{ id, url, authToken, routes?, settlement? }`
  - [x]Parse response and handle success (201 Created) or error (4xx/5xx)
  - [x]Return void on success or throw on error

- [x] **Task 3: Implement removePeer() method (optional)** (AC: 3)
  - [x]Validate peerId parameter (non-empty string)
  - [x]Construct HTTP DELETE request to `${adminUrl}/admin/peers/${peerId}`
  - [x]Handle success (204 No Content) or error (404 Not Found, 500)
  - [x]Return void on success or throw on error

- [x] **Task 4: Implement error handling** (AC: 5)
  - [x]Catch network errors (connection refused, timeout) → throw `NetworkError` (from errors.ts)
  - [x]Handle 401 Unauthorized → throw `UnauthorizedError` (create new error class)
  - [x]Handle 404 Not Found (removePeer) → throw `PeerNotFoundError` (create new error class)
  - [x]Handle 409 Conflict (addPeer duplicate) → throw `PeerAlreadyExistsError` (create new error class)
  - [x]Handle 5xx errors → throw `ConnectorError` (from errors.ts)
  - [x]Provide clear error messages for each error type with context

- [x] **Task 5: Create additional error classes** (AC: 5)
  - [x]Create `UnauthorizedError` in `packages/client/src/errors.ts` extending `CrosstownClientError`
  - [x]Create `PeerNotFoundError` in `packages/client/src/errors.ts` extending `CrosstownClientError`
  - [x]Create `PeerAlreadyExistsError` in `packages/client/src/errors.ts` extending `CrosstownClientError`
  - [x]Export all new error classes from `packages/client/src/errors.ts`

- [x] **Task 6: Add comprehensive unit tests** (AC: 6, 7)
  - [x]Create `packages/client/src/adapters/HttpConnectorAdmin.test.ts`
  - [x]Test addPeer() success (201 Created)
  - [x]Test addPeer() duplicate (409 Conflict) → throw
  - [x]Test addPeer() validation error (invalid id) → throw
  - [x]Test addPeer() validation error (invalid url) → throw
  - [x]Test addPeer() validation error (missing authToken) → throw
  - [x]Test addPeer() network error → throw
  - [x]Test removePeer() success (204 No Content)
  - [x]Test removePeer() not found (404) → throw
  - [x]Test removePeer() validation error (empty peerId) → throw
  - [x]Test removePeer() network error → throw
  - [x]Test unauthorized error (401) → throw
  - [x]Test trailing slash in adminUrl → normalized
  - [x]Mock HTTP client using `vi.fn()` - no live HTTP requests
  - [x]Verify ≥90% code coverage

### Documentation Tasks

- [x] **Task 7: Add JSDoc comments**
  - [x]Document HttpConnectorAdmin class with usage example
  - [x]Document addPeer() method with parameter descriptions
  - [x]Document removePeer() method with parameter descriptions
  - [x]Document error scenarios and exception types
  - [x]Include example showing both embedded and HTTP mode admin clients

---

## Dev Notes

### Relevant Architecture Context

**Package Location:**
- File: `packages/client/src/adapters/HttpConnectorAdmin.ts`
- Export from: `packages/client/src/adapters/index.ts`
- Package structure created in Story 11.1

**Interface to Implement:**

From `@crosstown/core/src/bootstrap/types.ts` (lines 60-87):

```typescript
/**
 * Callback interface for connector Admin API operations.
 * Matches the agent-runtime admin API shape: POST /admin/peers
 */
export interface ConnectorAdminClient {
  /**
   * Add a peer to the connector via the admin API.
   * @param config - Peer configuration matching the agent-runtime API shape
   */
  addPeer(config: {
    id: string;
    url: string;
    authToken: string;
    routes?: { prefix: string; priority?: number }[];
    settlement?: {
      preference: string;
      evmAddress?: string;
      tokenAddress?: string;
      tokenNetworkAddress?: string;
      chainId?: number;
      channelId?: string;
      initialDeposit?: string;
    };
  }): Promise<void>;

  /**
   * Remove a peer from the connector via the admin API.
   * Optional — not all callers will implement peer removal.
   * @param peerId - The peer ID to remove
   */
  removePeer?(peerId: string): Promise<void>;
}
```

**IMPORTANT NOTES:**
- The `addPeer()` method takes a **complex config object**, NOT `IlpPeerInfo`
- The `removePeer()` method is **OPTIONAL** (note the `?` in the interface)
- There is **NO `getPeers()` method** in the interface (removed from original story draft)
- Parameter name is `peerId` (not `pubkey`) for consistency with connector API

**HTTP Admin API Specification:**

From `docs/architecture/6-external-apis.md` (lines 42-46):

The connector admin API is available at port `:8081`:

1. **Add Peer:**
   - **Endpoint:** `POST ${adminUrl}/admin/peers`
   - **Headers:** `Content-Type: application/json`
   - **Request Body:**
     ```json
     {
       "id": "nostr-abc123",
       "url": "btp+ws://alice.example.com:3000",
       "authToken": "secret-token-abc123",
       "routes": [
         {
           "prefix": "g.crosstown.alice",
           "priority": 1
         }
       ],
       "settlement": {
         "preference": "raiden",
         "evmAddress": "0x1234...",
         "tokenNetworkAddress": "0x5678...",
         "chainId": 84532
       }
     }
     ```
   - **Response:** `201 Created` (success) or `409 Conflict` (duplicate peer)

2. **Remove Peer:**
   - **Endpoint:** `DELETE ${adminUrl}/admin/peers/:id`
   - **Response:** `204 No Content` (success) or `404 Not Found` (peer not found)

**IMPORTANT:** There is no `GET /admin/peers` endpoint in the agent-runtime connector admin API. Peer listing functionality is not part of the current interface.

**Error Handling Strategy:**

Per `docs/architecture/11-error-handling-strategy.md`:
- Use typed error classes extending `CrosstownClientError` (defined in Story 11.1)
- Network errors → throw `NetworkError` (with retry context)
- Admin API errors:
  - 401 Unauthorized → `UnauthorizedError` (new error class)
  - 404 Not Found → `PeerNotFoundError` (new error class)
  - 409 Conflict → `PeerAlreadyExistsError` (new error class)
  - 500 Server Error → `ConnectorError` (from Story 11.1)

**Existing Patterns to Follow:**

See `DirectConnectorAdmin` in `@crosstown/core/src/bootstrap/direct-connector-admin.ts` (lines 56-96) for reference implementation. The HTTP client should have identical behavior but use HTTP requests instead of direct method calls.

**HTTP Client:**

Use Node.js built-in `fetch` (same as HttpRuntimeClient from Story 11.1):
- Modern, promise-based API
- No additional dependencies
- Easy to mock in tests

**Input Validation:**

Validate inputs before sending HTTP requests:
- `id`: Non-empty string
- `url`: Non-empty string, valid BTP URL format (starts with 'btp+ws://' or 'btp+wss://')
- `authToken`: Non-empty string
- `routes` (optional): Array of objects with `prefix` (non-empty string) and optional `priority` (number)
- `settlement` (optional): Object with valid settlement parameters
- `peerId` (removePeer): Non-empty string

**Constructor Design:**

```typescript
export interface HttpConnectorAdminConfig {
  adminUrl: string;               // Required: 'http://localhost:8081'
  timeout?: number;               // Optional: default 30000ms
  httpClient?: typeof fetch;      // Optional: for testing (inject mock)
}

export class HttpConnectorAdmin implements ConnectorAdminClient {
  private readonly adminUrl: string;
  private readonly timeout: number;
  private readonly httpClient: typeof fetch;

  constructor(config: HttpConnectorAdminConfig) {
    this.adminUrl = config.adminUrl.replace(/\/$/, ''); // Remove trailing slash
    this.timeout = config.timeout ?? 30000;
    this.httpClient = config.httpClient ?? fetch;
  }

  async addPeer(config: {
    id: string;
    url: string;
    authToken: string;
    routes?: { prefix: string; priority?: number }[];
    settlement?: {
      preference: string;
      evmAddress?: string;
      tokenAddress?: string;
      tokenNetworkAddress?: string;
      chainId?: number;
      channelId?: string;
      initialDeposit?: string;
    };
  }): Promise<void> {
    // Implementation here
  }

  async removePeer(peerId: string): Promise<void> {
    // Implementation here
  }
}
```

**Important Implementation Notes:**

- Admin URL is separate from runtime URL (port 8081 vs 8080)
- Admin API may require authentication in production (future enhancement)
- removePeer() is optional in the interface but should be implemented for HTTP mode
- HTTP DELETE endpoint uses `:id` parameter (not `:pubkey`)
- URL normalization: remove trailing slash from adminUrl in constructor
- Error messages should include context (peer ID, endpoint, status code)

**Relationship to Story 11.1:**

This story follows the same patterns established in Story 11.1 (HttpRuntimeClient):
- Error class hierarchy (CrosstownClientError base)
- HTTP client dependency injection for testing
- Input validation before HTTP requests
- Structured error handling (network vs API errors)
- Unit test mocking strategy (vi.fn())

---

### Testing

**Test Framework:** Vitest ^1.x

**Test File Location:** `packages/client/src/adapters/HttpConnectorAdmin.test.ts`

**Testing Standards:**

From `docs/architecture/13-test-strategy-and-standards.md`:
- Co-located `*.test.ts` files next to source
- Use Vitest built-in mocking (`vi.fn()`, `vi.mock()`)
- Follow AAA pattern (Arrange, Act, Assert)
- No live HTTP requests in unit tests
- Coverage requirement: >90% for public APIs

**Mocking Strategy:**

Mock the HTTP client using dependency injection (same pattern as HttpRuntimeClient):

```typescript
import { describe, it, expect, vi } from 'vitest';
import { HttpConnectorAdmin } from './HttpConnectorAdmin';

describe('HttpConnectorAdmin', () => {
  const mockPeerConfig = {
    id: 'nostr-abc123',
    url: 'btp+ws://alice.example.com:3000',
    authToken: 'secret-token-abc123',
    routes: [{ prefix: 'g.crosstown.alice', priority: 1 }],
  };

  it('should add peer successfully', async () => {
    // Arrange
    const mockFetch = vi.fn().mockResolvedValue({
      ok: true,
      status: 201,
    });

    const admin = new HttpConnectorAdmin({
      adminUrl: 'http://localhost:8081',
      httpClient: mockFetch as any,
    });

    // Act
    await admin.addPeer(mockPeerConfig);

    // Assert
    expect(mockFetch).toHaveBeenCalledWith(
      'http://localhost:8081/admin/peers',
      expect.objectContaining({
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(mockPeerConfig),
      })
    );
  });

  it('should throw on duplicate peer (409 Conflict)', async () => {
    // Arrange
    const mockFetch = vi.fn().mockResolvedValue({
      ok: false,
      status: 409,
      statusText: 'Conflict',
    });

    const admin = new HttpConnectorAdmin({
      adminUrl: 'http://localhost:8081',
      httpClient: mockFetch as any,
    });

    // Act & Assert
    await expect(admin.addPeer(mockPeerConfig)).rejects.toThrow('Peer already exists');
  });
});
```

**Test Cases to Cover:**

1. ✅ addPeer() success (201 Created)
2. ✅ addPeer() duplicate peer (409 Conflict) → throw PeerAlreadyExistsError
3. ✅ addPeer() validation error (invalid id) → throw ValidationError
4. ✅ addPeer() validation error (invalid url) → throw ValidationError
5. ✅ addPeer() validation error (missing authToken) → throw ValidationError
6. ✅ addPeer() network error → throw NetworkError
7. ✅ removePeer() success (204 No Content)
8. ✅ removePeer() not found (404) → throw PeerNotFoundError
9. ✅ removePeer() validation error (empty peerId) → throw ValidationError
10. ✅ removePeer() network error → throw NetworkError
11. ✅ Unauthorized error (401) → throw UnauthorizedError
12. ✅ Trailing slash in adminUrl → normalized

**Coverage Target:** ≥90% line coverage

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-02-20 | 1.1 | Validation fixes applied - corrected interface signature, removed getPeers(), updated HTTP API spec | Claude (Validation Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug log entries required - implementation completed without issues.

### Completion Notes List

- Successfully implemented `HttpConnectorAdmin` class with full `ConnectorAdminClient` interface
- Created three new error classes: `UnauthorizedError`, `PeerNotFoundError`, `PeerAlreadyExistsError`
- All 29 unit tests passing with comprehensive coverage (100% of test cases from AC)
- Extended error test suite with 12 additional tests for new error classes (21 total error tests)
- All code passes ESLint validation (no TypeScript `any` types, proper typing throughout)
- Client package test suite: 92 tests passing (includes HttpRuntimeClient from Story 11.1)
- Implementation follows patterns from Story 11.1 (HttpRuntimeClient) for consistency
- JSDoc documentation complete with usage examples and error scenarios

### File List

**Modified Files:**
- `packages/client/src/errors.ts` - Added UnauthorizedError, PeerNotFoundError, PeerAlreadyExistsError
- `packages/client/src/errors.test.ts` - Added 12 tests for new error classes
- `packages/client/src/adapters/index.ts` - Exported HttpConnectorAdmin and HttpConnectorAdminConfig

**Created Files:**
- `packages/client/src/adapters/HttpConnectorAdmin.ts` - Main implementation (333 lines, fully documented)
- `packages/client/src/adapters/HttpConnectorAdmin.test.ts` - Unit tests (29 tests, 100% mock coverage)

---

## QA Results

### Review Date: 2026-02-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation with comprehensive test coverage and clean architecture. The HttpConnectorAdmin class properly implements the ConnectorAdminClient interface with robust error handling, thorough input validation, and well-structured code. All acceptance criteria met with production-ready quality.

### Refactoring Performed

During review, identified and addressed a DRY violation to improve maintainability:

- **File**: `packages/client/src/adapters/HttpConnectorAdmin.ts`
  - **Change**: Extracted duplicate network error handling logic into `handleNetworkError()` private method
  - **Why**: Both `addPeer()` and `removePeer()` had identical network error detection logic (30+ lines duplicated), violating DRY principle
  - **How**: Created `handleNetworkError(error, url, operation)` method that centralizes timeout detection, connection error handling, CrosstownClientError re-throwing, and unknown error wrapping. This reduces code from ~60 lines to ~30 lines while improving maintainability and consistency.
  - **Verification**: All 29 tests still passing, ESLint clean

### Compliance Check

- Coding Standards: ✓ No ESLint errors on HttpConnectorAdmin.ts, proper TypeScript types, no `any` usage
- Project Structure: ✓ Files in correct locations (adapters/, proper barrel exports from index.ts)
- Testing Strategy: ✓ Co-located test files, Vitest framework, AAA pattern, >90% coverage achieved
- All ACs Met: ✓ All 7 acceptance criteria fully satisfied

### Improvements Checklist

All improvements handled during review:

- [x] Refactored network error handling to eliminate DRY violation (HttpConnectorAdmin.ts:272-302)
- [x] Verified all tests passing after refactoring (29/29 tests pass)
- [x] Confirmed ESLint compliance maintained
- [x] Validated error handling completeness (all error types covered)

### Security Review

**Status:** PASS

Security best practices properly implemented:
- ✅ Input validation before HTTP requests prevents injection attacks
- ✅ BTP URL format validation (must start with 'btp+ws://' or 'btp+wss://')
- ✅ URL encoding of peerId in DELETE endpoint (`encodeURIComponent`)
- ✅ All required fields validated (id, url, authToken)
- ✅ Optional fields validated when present (routes, settlement)
- ✅ No secrets or sensitive data in error messages
- ✅ AbortSignal.timeout prevents hanging requests (configurable, default 30s)
- ✅ Proper error context without exposing internal implementation details

### Performance Considerations

**Status:** PASS

Performance characteristics appropriate for HTTP admin operations:
- ✅ Configurable timeout (default 30s) suitable for admin operations
- ✅ HTTP client uses Node.js built-in fetch with automatic connection pooling
- ✅ URL normalization (trailing slash removal) done once in constructor
- ✅ No blocking operations or performance bottlenecks
- ✅ Validation happens before HTTP request (fail-fast pattern)
- ✅ Response body parsing errors handled gracefully (don't block error reporting)

### Files Modified During Review

Refactored for improved quality:
- `packages/client/src/adapters/HttpConnectorAdmin.ts` - Extracted `handleNetworkError()` method to eliminate code duplication

No other files modified. File List in Dev Agent Record section is accurate and complete.

### Gate Status

Gate: **PASS** → `docs/qa/gates/11.2-implement-httpconnectoradmin.yml`

### Recommended Status

**✓ Ready for Done**

All acceptance criteria met, code refactored for optimal quality, comprehensive test coverage (29 tests), zero blocking issues. Production-ready implementation following all architectural guidelines and coding standards.

---

**End of Story 11.2**
