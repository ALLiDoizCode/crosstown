# Story 8.2: Send SPSP Handshakes as ILP Packets via Agent-Runtime

## Status

Done

## Story

**As a** BLS developer,
**I want** the SPSP client to send handshake requests as ILP packets through agent-runtime's `POST /ilp/send`,
**so that** all peer-to-peer communication uses the ILP network (with 0-amount for bootstrap, paid for post-bootstrap).

## Acceptance Criteria

1. SPSP request sent as ILP PREPARE via `POST /ilp/send`
2. TOON encoding of kind:23194 event matches BLS `/handle-payment` expectations
3. Amount configurable: 0 for bootstrap, standard pricing for post-bootstrap
4. FULFILL data decoded as SpspResponse (with settlement fields from Epic 7)
5. REJECT data decoded as error with code and message
6. Timeout configurable per handshake (accounts for on-chain channel opening time)
7. `AGENT_RUNTIME_URL` env var validated on startup
8. Retry logic: 1 retry on timeout, no retry on explicit REJECT
9. Unit tests for TOON encoding, response parsing, error handling

## Tasks / Subtasks

- [x] Task 1: Create `IlpSpspClient` class in `packages/core/src/spsp/IlpSpspClient.ts` (AC: 1, 2, 3, 4, 5, 6, 8)
  - [x] Define constructor accepting `AgentRuntimeClient`, `secretKey: Uint8Array`, and optional config object:
    ```typescript
    interface IlpSpspClientConfig {
      defaultTimeout?: number;     // Default: 30000ms (accounts for on-chain channel opening)
      toonEncoder: (event: NostrEvent) => Uint8Array;
      toonDecoder: (bytes: Uint8Array) => NostrEvent;
    }
    ```
  - [x] Implement `requestSpspInfo(recipientPubkey, peerIlpAddress, options?)` method:
    - `options.amount?: string` — ILP amount (`'0'` for bootstrap, calculated price for post-bootstrap) (AC: 3)
    - `options.timeout?: number` — Per-handshake timeout in ms (AC: 6)
    - `options.settlementInfo?: SpspRequestSettlementInfo` — Settlement preferences
  - [x] Validate `recipientPubkey` format (64-char lowercase hex) — throw `SpspError` on invalid (reuse `PUBKEY_REGEX` from `../bootstrap/types.js`)
  - [x] Build kind:23194 SPSP request event using `buildSpspRequestEvent(recipientPubkey, secretKey, settlementInfo?)` from `../events/index.js` (AC: 1)
  - [x] TOON-encode the event using injected `toonEncoder` callback (AC: 2)
  - [x] Send via `agentRuntimeClient.sendIlpPacket({ destination: peerIlpAddress, amount, data: base64Toon, timeout })` (AC: 1)
  - [x] On FULFILL with `data`: decode response (base64 -> TOON -> Nostr event -> `parseSpspResponse()`) (AC: 4)
    - Extract `SpspInfo` fields: `destinationAccount`, `sharedSecret`
    - Extract settlement fields if present: `negotiatedChain`, `settlementAddress`, `tokenAddress`, `tokenNetworkAddress`, `channelId`, `settlementTimeout`
    - Return `SpspInfo & { settlement?: SettlementNegotiationResult }`
  - [x] On REJECT: throw `SpspError` with code and message from response (AC: 5)
  - [x] On timeout: retry once, then throw `SpspTimeoutError(message, recipientPubkey)` — note: constructor requires `recipientPubkey` as 2nd arg (AC: 8)
  - [x] On explicit REJECT: throw immediately, no retry (AC: 8)
  - [x] Wrap TOON decode failures in `SpspError` (malformed response data)

- [x] Task 2: Add retry logic to `IlpSpspClient` (AC: 8)
  - [x] Detect timeout vs explicit reject:
    - Timeout: standard `Error` from `agentRuntimeClient` network errors (fetch failures), or agent-runtime returning a timeout-related error
    - Explicit REJECT: `ilpResult.accepted === false` with a code (e.g., `F06`, `F00`)
  - [x] On timeout: log warning, retry once with same parameters
  - [x] On explicit REJECT: throw `SpspError` immediately with `code` and `message`
  - [x] After retry failure: throw `SpspTimeoutError(message, recipientPubkey)` with descriptive message

- [x] Task 3: Export `IlpSpspClient` from SPSP module and core package (AC: all)
  - [x] Add `export { IlpSpspClient } from './IlpSpspClient.js';` to `packages/core/src/spsp/index.ts`
  - [x] Add `IlpSpspClient` to exports in `packages/core/src/index.ts`

- [x] Task 4: Update Docker entrypoint to validate `AGENT_RUNTIME_URL` on startup (AC: 7)
  - [x] In `parseConfig()`, when `AGENT_RUNTIME_URL` is set, validate it is a valid URL using `new URL()`
  - [x] Throw descriptive error on invalid URL format: `"AGENT_RUNTIME_URL is not a valid URL: {value}"`
  - [x] Log at INFO level when ILP-first flow is enabled: already done in `main()` (search for "ILP-first flow" log message)

- [x] Task 5: Write unit tests for `IlpSpspClient` in `packages/core/src/spsp/IlpSpspClient.test.ts` (AC: 9)
  - [x] **Constructor tests:**
    - Test: creates instance with required parameters
    - Test: throws if toonEncoder or toonDecoder not provided
  - [x] **TOON encoding tests (AC: 2, 9):**
    - Test: SPSP request event is TOON-encoded before sending
    - Test: toonEncoder is called with the built kind:23194 event
    - Test: base64 encoding of TOON bytes is correct
  - [x] **ILP send tests (AC: 1):**
    - Test: sends ILP packet via agentRuntimeClient.sendIlpPacket()
    - Test: destination is set to peer's ILP address
    - Test: amount defaults to '0' when not specified
    - Test: amount is set to provided value for paid handshakes
    - Test: timeout is passed through to sendIlpPacket
  - [x] **Response parsing tests (AC: 4, 9):**
    - Test: FULFILL data decoded as SpspResponse (base64 -> TOON -> Nostr -> parseSpspResponse)
    - Test: returns SpspInfo with destinationAccount and sharedSecret
    - Test: returns settlement fields when present in response
    - Test: returns no settlement when response lacks settlement fields
    - Test: malformed TOON response data throws SpspError
  - [x] **REJECT handling tests (AC: 5, 9):**
    - Test: REJECT response throws SpspError with code and message
    - Test: no retry on explicit REJECT
  - [x] **Timeout and retry tests (AC: 6, 8):**
    - Test: default timeout is 30000ms
    - Test: custom timeout is passed through
    - Test: retries once on network/timeout error
    - Test: throws SpspTimeoutError after retry failure
    - Test: does not retry on explicit REJECT
  - [x] **Validation tests:**
    - Test: throws SpspError for invalid recipientPubkey format
    - Test: passes settlementInfo to buildSpspRequestEvent

- [x] Task 6: Update Docker entrypoint `AGENT_RUNTIME_URL` validation test (AC: 7)
  - [x] In existing entrypoint test file or inline in entrypoint: test that invalid `AGENT_RUNTIME_URL` throws on `parseConfig()`
  - [x] Test that valid `AGENT_RUNTIME_URL` is accepted and stored in config

- [x] Task 7: Run full test suite and lint (AC: 9)
  - [x] Run `pnpm test` — baseline is 959 tests from Story 8.1; expect ~979 (959 + ~20 new). All must pass.
  - [x] Run `pnpm lint` — no new lint errors (1 pre-existing error in packages/bls is expected)
  - [x] Verify no regressions in any package

## Dev Notes

### Previous Story Insights
[Source: docs/stories/8.1.story.md#dev-agent-record]

From Story 8.1 (Rewrite Bootstrap Service for ILP-First Flow):
- 959 tests passing (20 new tests added), 0 failures
- ESLint: 1 pre-existing error in packages/bls (not introduced by Story 8.1)
- `PUBKEY_REGEX` is duplicated — defined in `bootstrap/types.ts:10` (exported) but redefined locally in `BootstrapService.ts:323`. Import from types instead of redefining.
- TOON encoder/decoder are injected via DI callbacks to avoid circular dependency (core -> relay). `IlpSpspClient` should follow the same DI pattern.
- `AgentRuntimeClient` interface and `createAgentRuntimeClient()` factory already exist in `packages/core/src/bootstrap/agent-runtime-client.ts` — reuse them, do NOT create a new client.
- BigInt handling note: use `BigInt()` constructor or `0n` literal, not `Math.min`/`Math.max`
- The `BootstrapService.performSpspHandshake()` method (lines 378-469) already implements SPSP-over-ILP for bootstrap. `IlpSpspClient` extracts and generalizes this pattern into a reusable client that works for both bootstrap (0-amount) and post-bootstrap (paid) handshakes.

### Data Models
[Source: packages/core/src/types.ts]

**SpspRequest (kind:23194, encrypted content):**
```typescript
interface SpspRequest {
  requestId: string;
  timestamp: number;
  ilpAddress?: string;
  supportedChains?: string[];
  settlementAddresses?: Record<string, string>;
  preferredTokens?: Record<string, string>;
}
```

**SpspResponse (kind:23195, encrypted content):**
```typescript
interface SpspResponse {
  requestId: string;
  destinationAccount: string;
  sharedSecret: string;
  negotiatedChain?: string;
  settlementAddress?: string;
  tokenAddress?: string;
  tokenNetworkAddress?: string;
  channelId?: string;
  settlementTimeout?: number;
}
```

**SpspInfo:**
```typescript
interface SpspInfo {
  destinationAccount: string;
  sharedSecret: string;
}
```

**SettlementNegotiationResult:**
```typescript
interface SettlementNegotiationResult {
  negotiatedChain: string;
  settlementAddress: string;
  tokenAddress?: string;
  tokenNetworkAddress?: string;
  channelId?: string;
  settlementTimeout?: number;
}
```

**SpspRequestSettlementInfo (for buildSpspRequestEvent):**
[Source: packages/core/src/events/builders.ts:46]
```typescript
interface SpspRequestSettlementInfo {
  ilpAddress?: string;
  supportedChains?: string[];
  settlementAddresses?: Record<string, string>;
  preferredTokens?: Record<string, string>;
}
```

**AgentRuntimeClient (reuse from bootstrap):**
[Source: packages/core/src/bootstrap/types.ts:115]
```typescript
interface AgentRuntimeClient {
  sendIlpPacket(params: {
    destination: string;
    amount: string;
    data: string; // base64-encoded TOON
    timeout?: number;
  }): Promise<IlpSendResult>;
}
```

**IlpSendResult:**
[Source: packages/core/src/bootstrap/types.ts:104]
```typescript
interface IlpSendResult {
  accepted: boolean;
  fulfillment?: string;
  data?: string; // base64-encoded response TOON
  code?: string;
  message?: string;
}
```

### API Specifications

**Agent-Runtime `POST /ilp/send`:**
[Source: docs/epics/epic-8-nostr-network-bootstrap.md, packages/core/src/bootstrap/agent-runtime-client.ts]

```
POST /ilp/send
Content-Type: application/json

{
  "destination": "g.peer1",        // ILP address of the target
  "amount": "0",                   // "0" for bootstrap, ">0" for paid
  "data": "<base64-encoded-TOON>", // TOON-encoded kind:23194 Nostr event
  "timeout": 30000                 // Optional timeout in ms
}

Response (FULFILL):
{
  "accepted": true,
  "fulfillment": "<base64>",
  "data": "<base64-encoded-response-TOON>"  // TOON of kind:23195
}

Response (REJECT):
{
  "accepted": false,
  "code": "F06",
  "message": "Insufficient amount"
}
```

**BLS `POST /handle-payment` (what the receiving BLS expects):**
[Source: docker/src/entrypoint.ts:258-403]

The receiving BLS decodes the ILP packet data as:
1. Base64 decode -> TOON bytes
2. `decodeEventFromToon(toonBytes)` -> Nostr event
3. If `event.kind === SPSP_REQUEST_KIND` (23194): parse SPSP request, generate response, TOON-encode response, return as `data` in FULFILL
4. Amount check: `BigInt(body.amount) >= price` (price calculated from `pricingService.calculatePriceFromBytes()`)

The TOON encoding done by `IlpSpspClient` must match what `decodeEventFromToon()` expects on the receiving end. Use the same `encodeEventToToon()` from `@crosstown/relay` (injected via DI).

### Component Specifications

**Existing `NostrSpspClient` (`packages/core/src/spsp/NostrSpspClient.ts`):**
[Source: packages/core/src/spsp/NostrSpspClient.ts:1-178]
- Sends SPSP requests via direct Nostr relay publish (kind:23194)
- Subscribes to relay for kind:23195 response
- Returns `SpspInfo & { settlement?: SettlementNegotiationResult }`
- The `IlpSpspClient` should return the same type for drop-in compatibility
- Key difference: `IlpSpspClient` sends via ILP (`POST /ilp/send`) instead of relay publish
- Key difference: `IlpSpspClient` receives response as ILP FULFILL data instead of relay subscription

**`BootstrapService.performSpspHandshake()` (reference implementation):**
[Source: packages/core/src/bootstrap/BootstrapService.ts:378-469]
- Already implements the core SPSP-over-ILP pattern:
  1. `buildSpspRequestEvent()` -> kind:23194 event
  2. `toonEncoder(event)` -> TOON bytes -> base64
  3. `agentRuntimeClient.sendIlpPacket()` with amount='0'
  4. On FULFILL: base64 -> TOON bytes -> `toonDecoder()` -> `parseSpspResponse()`
- This is the pattern to extract into `IlpSpspClient`
- After Story 8.2, `BootstrapService` could optionally be refactored to use `IlpSpspClient` internally (out of scope for this story)

**Event building functions:**
[Source: packages/core/src/events/builders.ts]
- `buildSpspRequestEvent(recipientPubkey, secretKey, settlementInfo?)` -> `{ event, requestId }`
- `parseSpspResponse(event, secretKey, senderPubkey)` -> `SpspResponse`

**Error classes to use:**
[Source: packages/core/src/errors.ts]
- `SpspError` (code: `SPSP_FAILED`) — for REJECT, validation, and parse errors
- `SpspTimeoutError` (code: `SPSP_TIMEOUT`) — for timeout after retry exhausted
- Do NOT use `BootstrapError` — that's specific to bootstrap module

### File Locations
[Source: docs/architecture/source-tree.md, packages/core/src/]

**Files to create:**
- `packages/core/src/spsp/IlpSpspClient.ts` — ILP-based SPSP client
- `packages/core/src/spsp/IlpSpspClient.test.ts` — Unit tests

**Files to modify:**
- `packages/core/src/spsp/index.ts` — Add `IlpSpspClient` export
- `packages/core/src/index.ts` — Add `IlpSpspClient` to package exports
- `docker/src/entrypoint.ts` — Add `AGENT_RUNTIME_URL` validation in `parseConfig()`

**Files NOT modified:**
- `packages/core/src/spsp/NostrSpspClient.ts` — Existing relay-based client unchanged
- `packages/core/src/bootstrap/` — Bootstrap module unchanged (it already works; refactoring to use IlpSpspClient is out of scope)
- `packages/core/src/events/` — Event builders/parsers unchanged
- `packages/relay/` — TOON encoding unchanged (injected via DI)
- `packages/bls/` — BLS package unchanged

### Technical Constraints

**TOON DI pattern (same as Story 8.1):**
[Source: packages/core/src/bootstrap/BootstrapService.ts:67-68, docker/src/entrypoint.ts:447-448]
The `@crosstown/core` package does NOT depend on `@crosstown/relay`. TOON encoding functions must be injected via DI callbacks rather than imported directly:
```typescript
toonEncoder: (event: NostrEvent) => Uint8Array;
toonDecoder: (bytes: Uint8Array) => NostrEvent;
```
The Docker entrypoint (which imports from both packages) passes these in:
```typescript
import { encodeEventToToon, decodeEventFromToon } from '@crosstown/relay';
// ...
toonEncoder: encodeEventToToon,
toonDecoder: decodeEventFromToon,
```

**Return type compatibility:**
`IlpSpspClient.requestSpspInfo()` should return `SpspInfo & { settlement?: SettlementNegotiationResult }` — the exact same type as `NostrSpspClient.requestSpspInfo()`. This enables future refactoring where callers can switch between the two clients without changing their code.

**Timeout considerations:**
Default timeout should be 30000ms (not 10000ms like `NostrSpspClient`) because ILP-routed SPSP may involve on-chain channel opening during the handshake, which can take 2-4 seconds on Base L2. The timeout must be configurable per-handshake via the `options` parameter.
[Source: docs/epics/epic-8-nostr-network-bootstrap.md#risk-mitigation]

**Retry scope:**
Only retry on timeout/network errors. Do NOT retry on explicit ILP REJECT (e.g., `F06 Insufficient Amount`) — those indicate a problem that retrying won't fix.

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

- Use `SpspError` for all SPSP-specific failures (REJECT, parse errors, validation)
- Use `SpspTimeoutError` for timeout after retry exhausted (includes `recipientPubkey` for debugging)
- Wrap TOON decode failures in `SpspError`: malformed response data is a protocol error
- Network errors from `agentRuntimeClient` bubble up as standard `Error` (fetch failures, etc.) — catch and re-throw as `SpspError` for consistent error types in the SPSP module
- Include `cause` chain for debugging: `new SpspError('message', originalError)`

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x
**File Convention:** Co-located `*.test.ts` in `packages/core/src/spsp/`
**Mocking:**
- Mock `AgentRuntimeClient` with `vi.fn()` for `sendIlpPacket()`
- Mock `toonEncoder` and `toonDecoder` callbacks with `vi.fn()`
- Use `generateSecretKey()` / `getPublicKey()` from `nostr-tools/pure` for test keys
- Follow existing patterns from `NostrSpspClient.test.ts` for test structure — key imports:
  ```typescript
  import { describe, it, expect, vi, beforeEach } from 'vitest';
  import { generateSecretKey, getPublicKey } from 'nostr-tools/pure';
  import { nip44 } from 'nostr-tools';
  import { SpspError, SpspTimeoutError } from '../errors.js';
  ```
- Use `nip44` for creating encrypted test events

**Test Standards:**
- Follow AAA pattern (Arrange, Act, Assert)
- Never connect to live relays or agent-runtime
- Console spy for log verification: `vi.spyOn(console, 'warn')`
- Test both happy path and error paths

**Expected test count:** ~20 tests covering:
- Constructor validation (~2 tests)
- TOON encoding (~3 tests)
- ILP send (~4 tests)
- Response parsing (~4 tests)
- REJECT handling (~2 tests)
- Timeout and retry (~4 tests)
- Validation (~2 tests)

### Scope Boundaries

**In Scope:**
- New `IlpSpspClient` class for sending SPSP requests as ILP packets
- Reusable for both bootstrap (0-amount) and post-bootstrap (paid) handshakes
- Retry logic: 1 retry on timeout, no retry on explicit REJECT
- `AGENT_RUNTIME_URL` validation in Docker entrypoint
- Unit tests with mocked AgentRuntimeClient

**Out of Scope:**
- Refactoring `BootstrapService` to use `IlpSpspClient` internally (future optimization)
- Changes to `NostrSpspClient` (still used for direct relay SPSP)
- Changes to TOON encoding/decoding
- Changes to BLS `/handle-payment` endpoint (already handles SPSP via ILP from Story 8.1)
- Integration tests with live agent-runtime
- Publishing kind:10032 as paid ILP packet (Story 8.3)
- Reverse registration and cross-peer discovery (Story 8.4)

## File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/spsp/IlpSpspClient.ts` | Created | ILP-based SPSP client using POST /ilp/send |
| `packages/core/src/spsp/IlpSpspClient.test.ts` | Created | Unit tests for IlpSpspClient |
| `packages/core/src/spsp/index.ts` | Modified | Add IlpSpspClient export |
| `packages/core/src/index.ts` | Modified | Add IlpSpspClient to package exports |
| `docker/src/entrypoint.ts` | Modified | Add AGENT_RUNTIME_URL validation in parseConfig() |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1 | Initial story draft | SM (Claude Opus 4.6) |
| 2026-02-08 | 0.2 | QA validation fixes: SpspTimeoutError constructor signature, test baseline counts, test import patterns, BootstrapError→Error correction, removed brittle line ref | QA (Claude Opus 4.6) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

No debug issues encountered.

### Completion Notes

- 984 tests passing (25 new IlpSpspClient tests + 2 entrypoint AGENT_RUNTIME_URL tests = 27 new), 0 failures
- ESLint: 1 pre-existing error in packages/bls (not introduced by this story)
- `IlpSpspClient` follows same DI pattern as `BootstrapService` for TOON encoder/decoder injection
- Reused `AgentRuntimeClient` and `PUBKEY_REGEX` from bootstrap module (no duplication)
- Return type `SpspInfo & { settlement?: SettlementNegotiationResult }` matches `NostrSpspClient` for drop-in compatibility
- Default timeout 30000ms (vs NostrSpspClient's 10000ms) to account for on-chain channel opening
- Retry logic: 1 retry on network/timeout errors, immediate throw on explicit REJECT (SpspError vs SpspTimeoutError)

### File List

| File | Action | Description |
|------|--------|-------------|
| `packages/core/src/spsp/IlpSpspClient.ts` | Created | ILP-based SPSP client with retry logic |
| `packages/core/src/spsp/IlpSpspClient.test.ts` | Created | 25 unit tests for IlpSpspClient |
| `packages/core/src/spsp/index.ts` | Modified | Added IlpSpspClient, IlpSpspClientConfig, IlpSpspRequestOptions exports |
| `packages/core/src/index.ts` | Modified | Added IlpSpspClient, IlpSpspClientConfig, IlpSpspRequestOptions to package exports |
| `docker/src/entrypoint.ts` | Modified | Added AGENT_RUNTIME_URL URL validation in parseConfig() |
| `docker/src/entrypoint.test.ts` | Modified | Added 2 tests for AGENT_RUNTIME_URL validation |

## QA Results

### Review Date: 2026-02-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. `IlpSpspClient` cleanly extracts the SPSP-over-ILP pattern from `BootstrapService.performSpspHandshake()` into a reusable, well-tested client class. The code follows established DI patterns (TOON encoder/decoder injection), reuses existing interfaces (`AgentRuntimeClient`, `PUBKEY_REGEX` from bootstrap/types), and returns the same `SpspInfo & { settlement?: SettlementNegotiationResult }` type as `NostrSpspClient` for drop-in compatibility. The retry logic is correctly scoped: 1 retry on network/timeout errors, immediate throw on explicit REJECT with proper `SpspError` vs `SpspTimeoutError` differentiation.

The Docker entrypoint changes for `AGENT_RUNTIME_URL` validation are clean and well-integrated. The entrypoint also gained bootstrap event listener logging, settlement info parsing, and health endpoint phase reporting — these go slightly beyond the story's stated scope (AC 7 was just URL validation) but are coherent additions from the broader Epic 8 integration.

### Refactoring Performed

None. Code quality is high as-delivered. No refactoring needed.

### Compliance Check

- Coding Standards: ✓ Follows AAA test pattern, proper TypeScript types, consistent error handling
- Project Structure: ✓ Co-located test files, proper barrel exports, module separation
- Testing Strategy: ✓ 25 unit tests with mocked dependencies, no live relays, proper vitest patterns
- All ACs Met: ✓ All 9 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Reused `AgentRuntimeClient` from bootstrap (no duplication) — addresses Story 8.1 Dev Notes
- [x] Reused `PUBKEY_REGEX` from bootstrap/types (no duplication) — addresses 8.1 QA concern CODE-001
- [x] TOON DI pattern consistent with BootstrapService
- [x] Return type matches NostrSpspClient for drop-in compatibility
- [x] Proper error cause chaining throughout
- [ ] Consider adding `AGENT_RUNTIME_URL` to `envKeysToClean` for settlement-related env vars in entrypoint tests (SUPPORTED_CHAINS, SETTLEMENT_ADDRESS_*, etc.) — currently only AGENT_RUNTIME_URL is cleaned between tests
- [ ] The `NostrSpspClient` still has a local `PUBKEY_REGEX` duplicate (line 18) — consider importing from bootstrap/types in a future cleanup story

### Security Review

No security concerns. NIP-44 encryption is handled by `buildSpspRequestEvent`/`parseSpspResponse` from the events module. Secret keys are passed through correctly. TOON decode failures are wrapped in `SpspError` (no information leakage). `AGENT_RUNTIME_URL` is validated as a proper URL before use.

### Performance Considerations

No performance concerns. Default 30000ms timeout appropriately accounts for on-chain channel opening latency. Retry loop is bounded at 2 attempts maximum. Buffer operations for base64/TOON encoding are straightforward and minimal.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/8.2-send-spsp-handshakes-as-ilp-packets.yml

### Recommended Status

✓ Ready for Done
