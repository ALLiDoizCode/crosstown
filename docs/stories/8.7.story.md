# Story 8.7: TOON + NIP-44 Round-Trip Integration Test

## Status

Done

## Story

**As a** developer maintaining the SPSP-over-ILP flow,
**I want** an integration test that verifies the full TOON + NIP-44 encode/decode round-trip for SPSP handshakes,
**so that** I can catch encoding/encryption issues that would silently break the settlement handshake.

## Acceptance Criteria

1. Integration test exercises the full encode → send → receive → decode cycle for kind:23194 (SPSP request with settlement fields)
2. Integration test exercises the full encode → send → receive → decode cycle for kind:23195 (SPSP response with settlement fields)
3. NIP-44 encryption preserved: encrypted content decrypts correctly after TOON round-trip
4. Settlement fields (supportedChains, settlementAddresses, preferredTokens, negotiatedChain, channelId, etc.) survive the full round-trip intact
5. TOON encoding preserves NIP-44 encrypted content byte-for-byte (no mangling of ciphertext)
6. Test uses real `nostr-tools` cryptography (no mocked encryption)
7. Test uses real TOON encoder/decoder from `packages/relay`
8. Test file located at `packages/core/src/spsp/ilp-spsp-roundtrip.test.ts`

## Tasks / Subtasks

- [x] Task 0: Add cross-package devDependency (AC: 7)
  - [x] Add `"@agent-society/relay": "workspace:*"` to `packages/core/package.json` `devDependencies`
  - [x] Run `pnpm install` to link the workspace dependency

- [x] Task 1: Create integration test file (AC: 8)
  - [x] Create `packages/core/src/spsp/ilp-spsp-roundtrip.test.ts` (co-located per project test convention)
  - [x] Import TOON encoder/decoder: `import { encodeEventToToon, decodeEventFromToon } from '@agent-society/relay'`
  - [x] Import event builders: `import { buildSpspRequestEvent, buildSpspResponseEvent } from '../events/builders.js'`
  - [x] Import event parsers: `import { parseSpspRequest, parseSpspResponse } from '../events/parsers.js'`
  - [x] Import NIP-44 encryption: `import { nip44 } from 'nostr-tools'`
  - [x] Import key generation: `import { generateSecretKey, getPublicKey } from 'nostr-tools/pure'`

- [x] Task 2: Write SPSP request round-trip test (AC: 1, 3, 4, 5, 6, 7)
  - [x] Test: "SPSP request with settlement survives TOON + NIP-44 round-trip"
    1. Generate sender and receiver keypairs using `generateSecretKey()` and `getPublicKey()`
    2. Build kind:23194 event: `const { event, requestId } = buildSpspRequestEvent(receiverPubkey, senderSecretKey, settlementInfo)` — note: returns `SpspRequestEventResult`, destructure to get `event`
       - Settlement fields:
       - `supportedChains: ["evm:base:8453", "xrp:mainnet"]`
       - `settlementAddresses: { "evm:base:8453": "0xSENDER_ADDR" }`
       - `preferredTokens: { "evm:base:8453": "0xTOKEN" }`
    3. TOON-encode the event: `const toonBytes = encodeEventToToon(event)`
    4. Simulate ILP transport — base64 encode: `Buffer.from(toonBytes).toString('base64')` (simulates `AgentRuntimeClient` encoding TOON bytes into ILP PREPARE data)
    5. Simulate BLS receive — base64 decode: `Buffer.from(base64, 'base64')` (simulates BLS extracting TOON bytes from ILP packet)
    6. TOON-decode: `const decodedEvent = decodeEventFromToon(new Uint8Array(decoded))`
    7. Verify `decodedEvent.kind === 23194`
    8. Verify `decodedEvent.content === event.content` (NIP-44 ciphertext preserved byte-for-byte)
    9. Parse and decrypt: `parseSpspRequest(decodedEvent, receiverSecretKey, senderPubkey)` — note: requires 3 args (event, secretKey, senderPubkey)
    10. Verify all settlement fields match original input (`supportedChains`, `settlementAddresses`, `preferredTokens`)

- [x] Task 3: Write SPSP response round-trip test (AC: 2, 3, 4, 5, 6, 7)
  - [x] Test: "SPSP response with settlement survives TOON + NIP-44 round-trip"
    1. Generate responder and requester keypairs using `generateSecretKey()` and `getPublicKey()`
    2. Build kind:23195 event: `buildSpspResponseEvent(response, requesterPubkey, responderSecretKey)` — note: signature is `(response: SpspResponse, senderPubkey: string, secretKey: Uint8Array, requestEventId?: string)`
       - Required SpspResponse fields:
       - `requestId: "test-request-id"`
       - `destinationAccount: "g.responder.test"`
       - `sharedSecret: "<base64-encoded-secret>"`
       - Settlement fields:
       - `negotiatedChain: "evm:base:8453"`
       - `settlementAddress: "0xRESPONDER_ADDR"`
       - `tokenAddress: "0xTOKEN"`
       - `tokenNetworkAddress: "0xTOKEN_NETWORK"`
       - `channelId: "0xCHANNEL_123"`
       - `settlementTimeout: 86400`
    3. TOON-encode → base64 encode (simulate ILP FULFILL data) → base64 decode (simulate client receive) → TOON-decode
    4. Verify `decodedEvent.content === event.content` (ciphertext preserved byte-for-byte)
    5. Parse and decrypt: `parseSpspResponse(decodedEvent, requesterSecretKey, responderPubkey)` — note: requires 3 args (event, secretKey, senderPubkey)
    6. Verify required fields: `requestId`, `destinationAccount`, `sharedSecret`
    7. Verify all settlement fields match original input (`negotiatedChain`, `settlementAddress`, `tokenAddress`, `tokenNetworkAddress`, `channelId`, `settlementTimeout`)

- [x] Task 4: Write NIP-44 ciphertext preservation test (AC: 5)
  - [x] Test: "TOON encoding preserves NIP-44 ciphertext byte-for-byte"
    1. Create a kind:23194 event with NIP-44 encrypted content
    2. Record the exact `content` string (ciphertext)
    3. TOON-encode → TOON-decode
    4. Assert `decodedEvent.content === originalEvent.content` (strict equality)
    5. This catches any encoding that might mangle base64 ciphertext

- [x] Task 5: Write test for basic SPSP without settlement (backward compat) (AC: 1, 2)
  - [x] Test: "Basic SPSP request/response without settlement survives round-trip"
    1. Generate keypairs using `generateSecretKey()` and `getPublicKey()`
    2. Build kind:23194 with no settlement: `buildSpspRequestEvent(receiverPubkey, senderSecretKey)` (omit 3rd arg)
    3. TOON-encode → base64 → base64 decode → TOON-decode
    4. Parse: `parseSpspRequest(decodedEvent, receiverSecretKey, senderPubkey)`
    5. Verify `requestId` and `timestamp` preserved, no settlement fields present
    6. Build kind:23195 with only required fields: `buildSpspResponseEvent({ requestId: "test-id", destinationAccount: "g.test.receiver", sharedSecret: "<base64-secret>" }, senderPubkey, receiverSecretKey)`
    7. TOON-encode → base64 → base64 decode → TOON-decode
    8. Parse: `parseSpspResponse(decodedEvent, senderSecretKey, receiverPubkey)`
    9. Verify `requestId`, `destinationAccount`, `sharedSecret` preserved, no settlement fields present

- [x] Task 6: Run full test suite and lint
  - [x] Run `pnpm test` — all existing tests pass plus new tests (41 files, 1022 tests passed)
  - [x] Run `pnpm lint` — no new lint errors (1 pre-existing error in packages/bls unrelated to this story)

## Dev Notes

### Integration Gap Addressed
[Source: INTEGRATION-GAPS.md]

**Gap 9: No Integration Test for TOON + NIP-44 Round-Trip**

No test verifies:
1. Build kind:23194 with NIP-44 encrypted settlement data
2. TOON-encode the event
3. Send as ILP PREPARE data
4. Receive at BLS, base64 decode → TOON decode
5. Verify NIP-44 decryption succeeds and settlement fields are intact
6. Build kind:23195 response with NIP-44 encryption
7. TOON-encode response
8. Return in ILP FULFILL data
9. Receive at client, decode, verify fields

**Impact:** If TOON encoding doesn't preserve the NIP-44 encrypted content byte-for-byte, the entire handshake silently fails with decryption errors.

### TOON Encoder/Decoder Location
[Source: packages/relay/src/toon/]

The TOON encoder/decoder lives in `packages/relay`:
- `packages/relay/src/toon/encoder.ts` — `encodeEventToToon(event: NostrEvent): Uint8Array`
- `packages/relay/src/toon/decoder.ts` — `decodeEventFromToon(bytes: Uint8Array): NostrEvent`
- `packages/relay/src/toon/index.ts` — Barrel exports

These are the same functions injected via DI into `BootstrapService` and `IlpSpspClient` as `toonEncoder`/`toonDecoder` callbacks.

### Event Builder/Parser Functions
[Source: packages/core/src/events/builders.ts, parsers.ts]

**Builders:**
- `buildSpspRequestEvent(recipientPubkey: string, secretKey: Uint8Array, settlementInfo?: SpspRequestSettlementInfo)` → `SpspRequestEventResult` (contains `{ event: NostrEvent, requestId: string }` — destructure to get event)
- `buildSpspResponseEvent(response: SpspResponse, senderPubkey: string, secretKey: Uint8Array, requestEventId?: string)` → `NostrEvent`

**Parsers (all require 3 arguments — event, secretKey, senderPubkey):**
- `parseSpspRequest(event: NostrEvent, secretKey: Uint8Array, senderPubkey: string)` → `SpspRequest`
- `parseSpspResponse(event: NostrEvent, secretKey: Uint8Array, senderPubkey: string)` → `SpspResponse`

**Key generation (`nostr-tools/pure`):**
- `generateSecretKey()` → `Uint8Array` (32-byte secret key)
- `getPublicKey(secretKey)` → `string` (64-char hex pubkey)

### NIP-44 Encryption
[Source: packages/core/src/events/builders.ts]

NIP-44 encryption is performed inside the builders using `import { nip44 } from 'nostr-tools'`:
- `nip44.getConversationKey(secretKey, pubkey)` → conversation key
- `nip44.encrypt(plaintext, conversationKey)` → ciphertext string
- `nip44.decrypt(ciphertext, conversationKey)` → plaintext string

**Note:** The API is `nip44.encrypt()` / `nip44.decrypt()` — there is no `.v2.` namespace.

The encrypted content is stored in the event's `content` field as a string. TOON encoding must preserve this string exactly.

### File Locations

Files to create:
- `packages/core/src/spsp/ilp-spsp-roundtrip.test.ts` (co-located with source per project convention)

Files modified:
- `packages/core/package.json` — Add `@agent-society/relay` as devDependency

Files NOT modified:
- `packages/relay/src/toon/` — Used as-is
- `packages/core/src/events/` — Used as-is
- `packages/core/src/spsp/` — Used as-is (except for the new test file)

### Technical Constraints

**Cross-package dependency:** The test is in `packages/core` but imports TOON encoder/decoder from `packages/relay`. `packages/core/package.json` does NOT currently depend on `@agent-society/relay`. Task 0 adds it as a devDependency:
```json
"devDependencies": {
  "@agent-society/relay": "workspace:*",
  ...
}
```
Then import via workspace name: `import { encodeEventToToon, decodeEventFromToon } from '@agent-society/relay'`

**Real cryptography:** This test uses real NIP-44 encryption, not mocks. This is intentional — the point is to verify the encoding preserves real ciphertext.

**No live relays or ILP:** Despite being an "integration test", this test runs entirely in-process. The base64 encode/decode steps simulate the `AgentRuntimeClient` → ILP PREPARE → BLS transport layer, where TOON bytes are base64-encoded into the ILP packet data field.

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Test Framework:** Vitest 1.x
**Location:** `packages/core/src/spsp/ilp-spsp-roundtrip.test.ts` (co-located with source, per project convention: `*.test.ts` next to source files)

Per architecture: integration tests requiring external infrastructure go in `__integration__/` directories. This test doesn't require external infrastructure (no relay, no ILP, no Anvil), so it is co-located as a regular test file.

**Expected new test count:** ~4-5 new tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft from INTEGRATION-GAPS.md (Gap 9) | PO (Claude Opus 4.6) |
| 2026-02-09 | 0.2 | Fix function signatures, NIP-44 API, add cross-package dep, co-locate test file, add required SpspResponse fields to Task 3, detail Task 5 | QA (Claude Opus 4.6) |
| 2026-02-09 | 1.0 | Implementation complete — all tasks verified, 4 tests passing, full regression green (1022 tests) | Dev (Claude Opus 4.6) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `packages/core/package.json` | Modified (prior) | `@agent-society/relay` devDependency already present |
| `packages/core/src/spsp/ilp-spsp-roundtrip.test.ts` | Created (prior) | 4 integration tests for TOON + NIP-44 round-trip |

### Debug Log References
None — all tasks passed on first verification.

### Completion Notes
- All 7 tasks (0–6) verified complete
- 4 new integration tests all passing
- Full regression: 41 test files, 1022 tests passed
- Lint: no new errors (1 pre-existing error in `packages/bls/src/storage/createEventStore.test.ts:67` — unrelated to this story)
- Implementation was already present from a prior session; this run verified correctness and marked tasks complete
- Note: `nip44` import listed in Task 1 subtask is not directly imported in the test file since NIP-44 encryption/decryption is handled internally by the builders/parsers — this is correct behavior

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The test file is well-structured, readable, and thoroughly exercises the full TOON + NIP-44 encode/decode round-trip for both SPSP request (kind:23194) and response (kind:23195) events. All 4 tests follow the AAA pattern with clear comments. The code uses real NIP-44 cryptography as required, not mocks, and the base64 encode/decode steps correctly simulate the ILP transport layer.

Key strengths:
- Each test is self-contained with fresh keypairs — no shared state or ordering dependencies
- Settlement fields are verified with strict equality checks, not loose matching
- Backward compatibility is explicitly tested (basic SPSP without settlement)
- The ciphertext preservation test (test 3) directly validates the core invariant of the story

### Refactoring Performed

No refactoring needed. The implementation is clean and well-structured.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, Vitest framework, co-located test file, camelCase functions, no `any` usage
- Project Structure: ✓ Test file at `packages/core/src/spsp/ilp-spsp-roundtrip.test.ts` per co-location convention. Cross-package devDependency correctly declared.
- Testing Strategy: ✓ Uses Vitest 1.x, co-located with source, follows AAA pattern, no live relays required
- All ACs Met: ✓ All 8 acceptance criteria verified (see traceability below)

**AC Traceability:**
| AC | Requirement | Validating Test |
|----|-------------|-----------------|
| 1 | Full encode/decode for kind:23194 | Test 1: "SPSP request with settlement survives TOON + NIP-44 round-trip" |
| 2 | Full encode/decode for kind:23195 | Test 2: "SPSP response with settlement survives TOON + NIP-44 round-trip" |
| 3 | NIP-44 encryption preserved | Tests 1, 2: `parseSpspRequest`/`parseSpspResponse` decrypt successfully after round-trip |
| 4 | Settlement fields survive round-trip | Tests 1 (supportedChains, settlementAddresses, preferredTokens), 2 (negotiatedChain, settlementAddress, tokenAddress, tokenNetworkAddress, channelId, settlementTimeout) |
| 5 | TOON preserves ciphertext byte-for-byte | Test 3: "TOON encoding preserves NIP-44 ciphertext byte-for-byte" + Tests 1, 2 content assertions |
| 6 | Real nostr-tools cryptography | All tests use `generateSecretKey()`, `getPublicKey()`, and NIP-44 via builders/parsers — no mocked encryption |
| 7 | Real TOON encoder/decoder from packages/relay | All tests import `encodeEventToToon`/`decodeEventFromToon` from `@agent-society/relay` |
| 8 | Test file at correct location | File exists at `packages/core/src/spsp/ilp-spsp-roundtrip.test.ts` ✓ |

### Improvements Checklist

- [x] All 8 ACs fully covered by tests
- [x] Cross-package devDependency correctly declared
- [x] Test uses real cryptography (not mocks)
- [x] Backward compatibility tested (no settlement fields)
- [ ] Consider adding error path test for corrupted TOON bytes (future improvement, not required by ACs)

### Security Review

No security concerns. The test uses real NIP-44 encryption with fresh keypairs generated per test. No secrets are hardcoded or persisted. The shared secret in the response test uses a test value (`Buffer.from('test-shared-secret').toString('base64')`) which is appropriate for testing.

### Performance Considerations

No concerns. All 4 tests complete in ~115ms. No external dependencies, network calls, or disk I/O. Tests are fully in-process.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/8.7-toon-nip44-round-trip-integration-test.yml

### Recommended Status

✓ Ready for Done
