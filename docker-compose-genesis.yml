# Crosstown Genesis Node - Full Local Stack
# Used by deploy-genesis-node.sh
#
# Includes:
# - Anvil (local Ethereum blockchain with auto-deployed contracts)
# - Token Faucet (ETH + AGENT token distribution)
# - ILP Connector (packet routing + payment channels)
# - Crosstown Node (Nostr relay + BLS + bootstrap service)
# - Forgejo (read-only public Git)

networks:
  crosstown-network:
    external: true

volumes:
  crosstown-data:
  connector-data:
  forgejo-data:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Anvil - Local Ethereum Node for Payment Channels
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: crosstown-anvil
    entrypoint: []
    command:
      - sh
      - -c
      - |
        echo "Starting Anvil..."
        anvil --host 0.0.0.0 --port 8545 --chain-id 31337 --accounts 10 --balance 10000 &
        ANVIL_PID=$$!

        echo "Waiting for Anvil to be ready..."
        until cast client --rpc-url http://localhost:8545 2>/dev/null | grep -q 'anvil'; do
          sleep 1
        done

        echo "Deploying contracts..."
        cd /contracts
        forge script script/DeployLocal.s.sol:DeployLocalScript --rpc-url http://localhost:8545 --broadcast --skip-simulation || echo "Deployment failed (non-fatal)"

        echo "Anvil ready with contracts deployed!"
        wait $$ANVIL_PID
    volumes:
      - ../connector/packages/contracts:/contracts
    ports:
      - "8545:8545"
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cast client --rpc-url http://localhost:8545 2>&1 | grep -q 'anvil' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Token Faucet - Provides ETH and AGENT tokens for testing
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  faucet:
    image: crosstown-genesis-faucet:latest
    container_name: crosstown-faucet
    environment:
      PORT: 3500
      RPC_URL: http://anvil:8545

      # Account 1 for ETH (has 10k ETH from Anvil)
      ETH_PRIVATE_KEY: "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"

      # Account 0 (deployer) for AGENT tokens
      TOKEN_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

      # Token address (deterministic from Anvil deployment)
      TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}

      # Amounts to send per request
      ETH_AMOUNT: ${FAUCET_ETH_AMOUNT:-100}
      TOKEN_AMOUNT: ${FAUCET_TOKEN_AMOUNT:-10000}

      # Rate limiting (hours)
      RATE_LIMIT_HOURS: ${FAUCET_RATE_LIMIT_HOURS:-1}

    ports:
      - "3500:3500"
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3500/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Connector - ILP Packet Routing + Payment Channels
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector:
    image: connector:patched
    container_name: crosstown-connector
    environment:
      ENVIRONMENT: development

      # Local delivery to Crosstown BLS
      LOCAL_DELIVERY_URL: http://crosstown:3100

      # Enable BASE blockchain for payment channels
      BASE_ENABLED: "true"
      BASE_RPC_URL: http://anvil:8545
      BASE_CHAIN_ID: "31337"

      # Anvil test account #0 private key (well-known)
      BASE_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

      # Payment channel contract addresses (deterministic from Anvil deployment)
      BASE_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}
      BASE_REGISTRY_ADDRESS: ${BASE_REGISTRY_ADDRESS:-0xe7f1725e7734ce288f8367e1bb143e90bb3f0512}

      # Explorer UI
      EXPLORER_ENABLED: ${EXPLORER_ENABLED:-true}

      # Allow external client BTP connections (peerId → env var BTP_PEER_{ID}_SECRET)
      BTP_PEER_CLIENT_SECRET: "${BTP_CLIENT_SECRET:-open}"

    ports:
      - "3000:3000"   # BTP Server
      - "8080:8080"   # Health check
      - "8081:8081"   # Admin API
      - "3001:3001"   # Explorer UI
    volumes:
      - connector-data:/data
      - ./config/connector-config-with-base.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Crosstown Full Node - BLS + Nostr Relay + Bootstrap
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  crosstown:
    image: crosstown:optimized
    container_name: crosstown-node
    environment:
      # Required Configuration
      NODE_ID: ${NODE_ID:-genesis-node}
      NOSTR_SECRET_KEY: ${NOSTR_SECRET_KEY}
      ILP_ADDRESS: ${ILP_ADDRESS:-g.crosstown.genesis}

      # Connector Integration (External Mode via HTTP)
      CONNECTOR_ADMIN_URL: http://connector:8081
      CONNECTOR_URL: http://connector:8080
      BTP_ENDPOINT: ${BTP_ENDPOINT:-ws://connector:3000}

      # Service Ports
      BLS_PORT: 3100
      WS_PORT: 7100

      # Pricing
      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}

      # Asset
      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # Bootstrap & Peer Discovery
      ARDRIVE_ENABLED: ${ARDRIVE_ENABLED:-true}

      # Settlement (EVM/BASE)
      PEER_EVM_ADDRESS: ${PEER_EVM_ADDRESS:-0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}

      # Settlement Configuration (Payment Channels)
      SUPPORTED_CHAINS: "evm:base:31337"
      SETTLEMENT_ADDRESS_EVM_BASE_31337: ${PEER_EVM_ADDRESS:-0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266}
      PREFERRED_TOKEN_EVM_BASE_31337: ${BASE_TOKEN_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}
      TOKEN_NETWORK_EVM_BASE_31337: ${BASE_TOKEN_NETWORK_ADDRESS:-0xCafac3dD18aC6c6e92c921884f9E4176737C052c}

      # NIP-34 Git Integration (Forgejo)
      FORGEJO_URL: ${FORGEJO_URL:-http://forgejo:3000}
      FORGEJO_TOKEN: ${FORGEJO_TOKEN:-}
      FORGEJO_OWNER: ${FORGEJO_OWNER:-crosstown}

      # Storage
      DATA_DIR: /data

    ports:
      - "3100:3100"   # BLS HTTP API
      - "7100:7100"   # Nostr Relay WebSocket
    volumes:
      - crosstown-data:/data
    networks:
      - crosstown-network
    depends_on:
      connector:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Forgejo - Read-Only Public Git Infrastructure
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  forgejo:
    image: codeberg.org/forgejo/forgejo:14
    container_name: crosstown-forgejo
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=sqlite3
      - FORGEJO__server__DOMAIN=localhost
      - FORGEJO__server__HTTP_PORT=3000
      - FORGEJO__server__ROOT_URL=http://localhost:3004/
      - FORGEJO__security__INSTALL_LOCK=true

      # Read-only public access
      - FORGEJO__service__REQUIRE_SIGNIN_VIEW=false
      - FORGEJO__repository__DISABLE_HTTP_GIT=false
      - FORGEJO__repository__ENABLE_PUSH_CREATE_USER=false
      - FORGEJO__repository__ENABLE_PUSH_CREATE_ORG=false
      - FORGEJO__repository__ENABLE_EDITOR_UPLOAD=false
      - FORGEJO__repository__DISABLE_DOWNLOAD_SOURCE_ARCHIVES=false
      - FORGEJO__service__DISABLE_REGISTRATION=true
      - FORGEJO__service__SHOW_REGISTRATION_BUTTON=false
      - FORGEJO__api__ENABLE_SWAGGER=false
      - FORGEJO__repository__DEFAULT_PRIVATE=false

    ports:
      - "3004:3000"
    volumes:
      - forgejo-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
