# Crosstown + Connector with Base Sepolia Testnet
# Full Payment Channel Testing with Deployed Contracts
#
# Uses deployed payment channel contracts on Base Sepolia testnet
# Contract addresses from testnet-wallets.json

version: '3.8'

networks:
  crosstown-network:
    driver: bridge

volumes:
  crosstown-data:
  connector-data:
  forgejo-data:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Connector (v1.19.1) - ILP Routing + Payment Channels
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector:
    image: connector:1.19.1
    container_name: crosstown-connector
    environment:
      # Environment mode - staging uses testnet
      ENVIRONMENT: staging

      # Local delivery to Crosstown BLS
      LOCAL_DELIVERY_URL: http://crosstown:3100

      # Enable BASE blockchain with Sepolia testnet
      BASE_ENABLED: "true"
      BASE_RPC_URL: "https://sepolia.base.org"
      BASE_CHAIN_ID: "84532"

      # Testnet wallet - Node Bravo from testnet-wallets.json
      BASE_PRIVATE_KEY: "0x32e8ddaedf2f1a5372943579ab9e73aa39e1421fdfa0966a586cf8c66ab5ea2c"

      # Payment channel contracts on Base Sepolia
      BASE_REGISTRY_ADDRESS: "0xCbf6f43A17034e733744cBCc130FfcCA3CF3252C"
      BASE_TOKEN_ADDRESS: "0x39eaF99Cd4965A28DFe8B1455DD42aB49D0836B9"

      # Optional: Enable Explorer UI
      EXPLORER_ENABLED: ${EXPLORER_ENABLED:-true}

    ports:
      - "3000:3000"   # BTP Server
      - "8080:8080"   # Health check
      - "8081:8081"   # Admin API
      - "3001:3001"   # Explorer UI
    volumes:
      - connector-data:/data
      - ./config/connector-config-testnet.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Crosstown Full Node - BLS + Nostr Relay + Bootstrap
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  crosstown:
    image: crosstown:optimized
    container_name: crosstown-node
    environment:
      # Required Configuration
      NODE_ID: ${NODE_ID:-my-crosstown-node}
      NOSTR_SECRET_KEY: ${NOSTR_SECRET_KEY}
      ILP_ADDRESS: ${ILP_ADDRESS:-g.crosstown.my-node}

      # Connector Integration (External Mode via HTTP)
      CONNECTOR_ADMIN_URL: http://connector:8081
      CONNECTOR_URL: http://connector:8080
      BTP_ENDPOINT: ${BTP_ENDPOINT:-ws://connector:3000}

      # Service Ports
      BLS_PORT: 3100
      WS_PORT: 7100

      # Pricing
      BASE_PRICE_PER_BYTE: ${BASE_PRICE_PER_BYTE:-10}
      SPSP_MIN_PRICE: ${SPSP_MIN_PRICE:-5}

      # Asset
      ASSET_CODE: ${ASSET_CODE:-USD}
      ASSET_SCALE: ${ASSET_SCALE:-6}

      # Bootstrap
      ARDRIVE_ENABLED: ${ARDRIVE_ENABLED:-true}

      # Storage
      DATA_DIR: /data

    ports:
      - "3100:3100"   # BLS HTTP API
      - "7100:7100"   # Nostr Relay WebSocket
    volumes:
      - crosstown-data:/data
    networks:
      - crosstown-network
    depends_on:
      connector:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Forgejo - ILP-Gated Git Infrastructure
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  forgejo:
    image: codeberg.org/forgejo/forgejo:14
    container_name: crosstown-forgejo
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=sqlite3
      - FORGEJO__server__DOMAIN=localhost
      - FORGEJO__server__HTTP_PORT=3000
      - FORGEJO__server__ROOT_URL=http://localhost:3003/
      - FORGEJO__security__INSTALL_LOCK=true
    ports:
      - "3003:3000"   # Web UI (HTTP)
      - "2222:22"     # Git over SSH
    volumes:
      - forgejo-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
