# Crosstown Multi-Peer Network with Nostr SPSP Bootstrap
#
# This configuration uses the Nostr SPSP bootstrap flow:
# - Peer1 is genesis (publishes kind:10032, accepts free SPSP)
# - Peers 2-4 discover genesis via Nostr relay
# - SPSP handshake exchanges sharedSecret + opens payment channels
# - Peers automatically register with connector using SPSP sharedSecret
#
# NO manual BTP secrets needed! All peer relationships via Nostr/SPSP.

networks:
  crosstown-network:
    driver: bridge

volumes:
  crosstown-data-peer1:
  crosstown-data-peer2:
  crosstown-data-peer3:
  crosstown-data-peer4:
  connector-data-peer1:
  connector-data-peer2:
  connector-data-peer3:
  connector-data-peer4:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Anvil - Shared Ethereum Node for Payment Channels
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: crosstown-anvil
    entrypoint: []
    command:
      - sh
      - -c
      - |
        echo "Starting Anvil..."
        anvil --host 0.0.0.0 --port 8545 --chain-id 31337 --accounts 10 --balance 10000 &
        ANVIL_PID=$$!
        echo "Waiting for Anvil..."
        until cast client --rpc-url http://localhost:8545 2>/dev/null | grep -q 'anvil'; do sleep 1; done
        echo "Deploying contracts..."
        cd /contracts
        forge script script/DeployLocal.s.sol:DeployLocalScript --rpc-url http://localhost:8545 --broadcast --skip-simulation
        echo "Anvil ready!"
        wait $$ANVIL_PID
    volumes:
      - ../connector/packages/contracts:/contracts
    ports:
      - "8545:8545"
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cast client --rpc-url http://localhost:8545 2>&1 | grep -q 'anvil' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Token Faucet
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  faucet:
    build:
      context: ./packages/faucet
      dockerfile: Dockerfile
    container_name: crosstown-faucet
    environment:
      PORT: 3500
      RPC_URL: http://anvil:8545
      ETH_PRIVATE_KEY: "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"
      TOKEN_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
      TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
      ETH_AMOUNT: "100"
      TOKEN_AMOUNT: "10000"
    ports:
      - "3500:3500"
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PEER 1 - Genesis Node (Bootstrap)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector-peer1:
    image: crosstown/connector:1.20.0-dev
    container_name: crosstown-connector-peer1
    environment:
      ENVIRONMENT: development
      LOCAL_DELIVERY_URL: http://crosstown-peer1:3100
      SETTLEMENT_ENABLED: "true"
      BASE_L2_RPC_URL: http://anvil:8545
      TOKEN_NETWORK_REGISTRY: "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
      M2M_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
      TREASURY_EVM_PRIVATE_KEY: "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
      EXPLORER_ENABLED: "true"
    ports:
      - "3001:3000"
      - "8081:8080"
      - "8091:8081"
      - "3011:3001"
    volumes:
      - connector-data-peer1:/data
      - ./config/connector-config-peer.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  crosstown-peer1:
    image: crosstown:bootstrap
    container_name: crosstown-peer1
    environment:
      # Use bootstrap entrypoint
      ENTRYPOINT: "entrypoint.js"

      # Node identity
      NODE_ID: peer1
      NOSTR_SECRET_KEY: "d5c4f02f7c0f9c8e7a6b5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0a9b8c7d6e5f4a"
      ILP_ADDRESS: "g.crosstown.peer1"

      # Connector integration
      CONNECTOR_ADMIN_URL: http://connector-peer1:8081
      CONNECTOR_URL: http://connector-peer1:8080
      BTP_ENDPOINT: btp+ws://connector-peer1:3000

      # Server ports
      BLS_PORT: "3100"
      WS_PORT: "7100"

      # Pricing
      BASE_PRICE_PER_BYTE: "10"
      SPSP_MIN_PRICE: "0"  # Genesis accepts free bootstrap handshakes

      # Settlement
      PEER_EVM_ADDRESS: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC"
      M2M_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
      TOKEN_NETWORK_REGISTRY: "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
      INITIAL_DEPOSIT: "100000"

      # Genesis peer - no bootstrap needed
      BOOTSTRAP_RELAYS: ""
      BOOTSTRAP_PEERS: ""

      DATA_DIR: /data
    ports:
      - "3101:3100"
      - "7101:7100"
    volumes:
      - crosstown-data-peer1:/data
    networks:
      - crosstown-network
    depends_on:
      connector-peer1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PEER 2 - Bootstraps with Peer 1
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector-peer2:
    image: crosstown/connector:1.20.0-dev
    container_name: crosstown-connector-peer2
    environment:
      ENVIRONMENT: development
      LOCAL_DELIVERY_URL: http://crosstown-peer2:3100
      SETTLEMENT_ENABLED: "true"
      BASE_L2_RPC_URL: http://anvil:8545
      TREASURY_EVM_PRIVATE_KEY: "0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6"
      M2M_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
      TOKEN_NETWORK_REGISTRY: "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
      EXPLORER_ENABLED: "true"
    ports:
      - "3002:3000"
      - "8082:8080"
      - "8092:8081"
      - "3012:3001"
    volumes:
      - connector-data-peer2:/data
      - ./config/connector-config-peer.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    depends_on:
      anvil:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  crosstown-peer2:
    image: crosstown:bootstrap
    container_name: crosstown-peer2
    environment:
      ENTRYPOINT: "entrypoint.js"
      NODE_ID: peer2
      NOSTR_SECRET_KEY: "b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3"
      ILP_ADDRESS: "g.crosstown.peer2"
      CONNECTOR_ADMIN_URL: http://connector-peer2:8081
      CONNECTOR_URL: http://connector-peer2:8080
      BTP_ENDPOINT: btp+ws://connector-peer2:3000
      BLS_PORT: "3100"
      WS_PORT: "7100"
      BASE_PRICE_PER_BYTE: "10"
      PEER_EVM_ADDRESS: "0x90F79bf6EB2c4f870365E785982E1f101E93b906"
      M2M_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
      TOKEN_NETWORK_REGISTRY: "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
      INITIAL_DEPOSIT: "100000"
      # Bootstrap with peer1
      BOOTSTRAP_RELAYS: "ws://crosstown-peer1:7100"
      BOOTSTRAP_PEERS: "719705df863f0190e0c124bbb11dd84b6374d077f66c4912a039324c98dc25e3"
      DATA_DIR: /data
    ports:
      - "3102:3100"
      - "7102:7100"
    volumes:
      - crosstown-data-peer2:/data
    networks:
      - crosstown-network
    depends_on:
      connector-peer2:
        condition: service_healthy
      crosstown-peer1:
        condition: service_healthy
    restart: unless-stopped

# Use similar configurations for peer3 and peer4...
# (Abbreviated for brevity - follow same pattern)
