# Crosstown Peer #2
# Auto-generated by deploy-peers.sh

networks:
  crosstown-network:
    external: true

volumes:
  peer3-crosstown-data:
  peer3-connector-data:
  peer3-forgejo-data:

services:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # ILP Connector for Peer #2
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  connector-peer3:
    image: connector:1.20.0
    container_name: connector-peer3
    labels:
      - "crosstown.group=peer-3"
      - "crosstown.role=connector"
      - "crosstown.tier=application"
    environment:
      ENVIRONMENT: development
      LOCAL_DELIVERY_URL: http://crosstown-peer3:3120

      # Payment channels
      BASE_ENABLED: "true"
      BASE_RPC_URL: http://crosstown-anvil:8545
      BASE_CHAIN_ID: "31337"
      BASE_PRIVATE_KEY: "0x47e179ec197488593b187f80a00eb0da91f1b9d0b13f8733639f19c30a34926a"
      BASE_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
      BASE_REGISTRY_ADDRESS: "0xe7f1725e7734ce288f8367e1bb143e90bb3f0512"

      EXPLORER_ENABLED: "true"

    ports:
      - "3030:3000"
      - "8110:8080"
      - "8111:8081"
      - "3031:3001"
    volumes:
      - peer3-connector-data:/data
      - ./config/connector-config-with-base.yaml:/app/config.yaml:ro
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Forgejo for Peer #2
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  forgejo-peer3:
    image: codeberg.org/forgejo/forgejo:14
    container_name: forgejo-peer3
    labels:
      - "crosstown.group=peer-3"
      - "crosstown.role=git"
      - "crosstown.tier=application"
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=sqlite3
      - FORGEJO__server__DOMAIN=localhost
      - FORGEJO__server__HTTP_PORT=3000
      - FORGEJO__server__ROOT_URL=http://localhost:3024/
      - FORGEJO__security__INSTALL_LOCK=true

      # Read-only public access
      - FORGEJO__service__REQUIRE_SIGNIN_VIEW=false
      - FORGEJO__repository__DISABLE_HTTP_GIT=false
      - FORGEJO__repository__ENABLE_PUSH_CREATE_USER=false
      - FORGEJO__repository__ENABLE_PUSH_CREATE_ORG=false
      - FORGEJO__repository__ENABLE_EDITOR_UPLOAD=false
      - FORGEJO__repository__DISABLE_DOWNLOAD_SOURCE_ARCHIVES=false
      - FORGEJO__service__DISABLE_REGISTRATION=true
      - FORGEJO__service__SHOW_REGISTRATION_BUTTON=false
      - FORGEJO__api__ENABLE_SWAGGER=false
      - FORGEJO__repository__DEFAULT_PRIVATE=false

    ports:
      - "3034:3000"
    volumes:
      - peer3-forgejo-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - crosstown-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Crosstown Node for Peer #2
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  crosstown-peer3:
    image: crosstown:optimized
    container_name: crosstown-peer3
    labels:
      - "crosstown.group=peer-3"
      - "crosstown.role=relay"
      - "crosstown.tier=application"
    environment:
      # Identity
      NODE_ID: peer-3
      NOSTR_SECRET_KEY: 46c748682e0c7462d21f1ccd05ada395ee193fee054e4aec3f931bbedacc25ae
      ILP_ADDRESS: g.crosstown.peer3

      # Connector integration
      CONNECTOR_ADMIN_URL: http://connector-peer3:8081
      CONNECTOR_URL: http://connector-peer3:8080
      BTP_ENDPOINT: ws://connector-peer3:3000

      # Service ports
      BLS_PORT: 3130
      WS_PORT: 7130

      # Pricing
      BASE_PRICE_PER_BYTE: 10
      SPSP_MIN_PRICE: 5
      ASSET_CODE: USD
      ASSET_SCALE: 6

      # Bootstrap from genesis
      BOOTSTRAP_RELAYS: "ws://crosstown-node:7100"
      BOOTSTRAP_PEERS: '[{"pubkey":"aa1857d0ff1fcb1aeb1907b3b98290f3ecb5545473c0b9296fb0b44481deb572","ilpAddress":"g.crosstown.genesis","btpEndpoint":"ws://connector:3000","relay":"ws://crosstown-node:7100"}]'
      ARDRIVE_ENABLED: "true"

      # Payment channels
      PEER_EVM_ADDRESS: "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65"
      M2M_TOKEN_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"

      # Settlement configuration for Anvil
      SUPPORTED_CHAINS: "evm:anvil:31337"
      SETTLEMENT_ADDRESS_EVM_ANVIL_31337: "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65"

      # NIP-34 Git integration (token will be set by init script)
      FORGEJO_URL: http://forgejo-peer3:3000
      FORGEJO_OWNER: crosstown

      # Storage
      DATA_DIR: /data

    ports:
      - "3130:3130"
      - "7130:7130"
    volumes:
      - peer3-crosstown-data:/data
    networks:
      - crosstown-network
    depends_on:
      connector-peer3:
        condition: service_healthy
      forgejo-peer3:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3120/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
